<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>O+ Fichas â€” ProntuÃ¡rio EletrÃ´nico</title>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <!-- Supabase Client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'DM Sans', 'Segoe UI', system-ui, sans-serif; background: #F1F5F9; color: #0F172A; }
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-thumb { background: #CBD5E1; border-radius: 3px; }
    input, select, textarea { font-family: inherit; }
    button { font-family: inherit; }
    .tab-btn { padding: 10px 20px; border: none; border-bottom: 3px solid transparent; background: none; font-size: 14px; font-weight: 700; color: #94A3B8; cursor: pointer; transition: all 0.2s; }
    .tab-btn.active { color: #0EA5E9; border-bottom-color: #0EA5E9; }
    .tab-btn:hover { color: #0EA5E9; }
    .tipo-card { padding: 16px 24px; border-radius: 12px; border: 2px solid #E2E8F0; cursor: pointer; text-align: center; transition: all 0.2s; flex: 1; }
    .tipo-card:hover { border-color: #94A3B8; }
    .tipo-card.selected { border-color: currentColor; }
    
    /* AnimaÃ§Ãµes Realtime */
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    @keyframes slideInRight {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useRef, useCallback } = React;

    // â”€â”€â”€ CONSTANTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const ROLES = { ADMIN: "admin", DENTISTA: "dentista", ORTO: "orto", RECEPCAO: "recepcao" };
    const ROLE_LABELS = { admin: "Administrador", dentista: "Dentista", orto: "Ortodontista", recepcao: "Recepcionista" };
    const RECORD_TYPES = { ORTODONTIA: "ORTODONTIA", GERAL: "GERAL" };
    const MAX_FILE_SIZE = 50 * 1024 * 1024;
    const ALLOWED_FILE_TYPES = ["image/jpeg","image/png","image/webp","image/gif","application/pdf",
      "application/vnd.openxmlformats-officedocument.wordprocessingml.document"];

    const SPECIALTIES = {
      ortodontia: {
        label: "Ortodontia", icon: "ðŸ¦·", color: "#0EA5E9",
        procedures: [
          "InstalaÃ§Ã£o de aparelho fixo","ManutenÃ§Ã£o de aparelho fixo","Troca de fio ortodÃ´ntico",
          "Colagem de braquete","Bandagem","InstalaÃ§Ã£o de aparelho mÃ³vel","Ajuste de aparelho mÃ³vel",
          "ContenÃ§Ã£o fixa","ContenÃ§Ã£o removÃ­vel","Mini-implante ortodÃ´ntico","ElÃ¡stico intermaxilar",
          "Moldagem ortodÃ´ntica","DocumentaÃ§Ã£o ortodÃ´ntica","RemoÃ§Ã£o de aparelho","Expansor palatino",
          "Alinhador transparente",
        ],
      },
      endodontia: {
        label: "Endodontia", icon: "ðŸ”¬", color: "#8B5CF6",
        procedures: [
          "Tratamento de canal - unirradicular","Tratamento de canal - birradicular",
          "Tratamento de canal - multirradicular","Retratamento endodÃ´ntico",
          "Capeamento pulpar direto","Capeamento pulpar indireto","Pulpotomia",
          "Pulpectomia","Drenagem de abscesso","Curativo de demora",
        ],
      },
      periodontia: {
        label: "Periodontia", icon: "ðŸ©º", color: "#10B981",
        procedures: [
          "Raspagem supragengival","Raspagem subgengival","Profilaxia dental",
          "AplicaÃ§Ã£o de flÃºor","Gengivectomia","Gengivoplastia","Cirurgia periodontal",
          "Enxerto gengival","Frenectomia","Sondagem periodontal",
        ],
      },
      protese: {
        label: "PrÃ³tese", icon: "ðŸ—ï¸", color: "#F59E0B",
        procedures: [
          "PrÃ³tese total superior","PrÃ³tese total inferior","PrÃ³tese parcial removÃ­vel",
          "Coroa provisÃ³ria","Coroa definitiva - metalocerÃ¢mica","Coroa definitiva - porcelana pura",
          "Faceta de porcelana","Faceta de resina","PrÃ³tese sobre implante",
          "Moldagem para prÃ³tese","Prova de estrutura metÃ¡lica","Ajuste oclusal",
          "Reembasamento","Conserto de prÃ³tese",
        ],
      },
      implantodontia: {
        label: "Implantodontia", icon: "âš™ï¸", color: "#EC4899",
        procedures: [
          "InstalaÃ§Ã£o de implante","Reabertura de implante","InstalaÃ§Ã£o de cicatrizador",
          "Moldagem sobre implante","InstalaÃ§Ã£o de pilar protÃ©tico","Carga imediata",
          "Enxerto Ã³sseo","Levantamento de seio maxilar","RegeneraÃ§Ã£o Ã³ssea guiada",
        ],
      },
      dentistica: {
        label: "DentÃ­stica", icon: "âœ¨", color: "#06B6D4",
        procedures: [
          "RestauraÃ§Ã£o resina composta - simples","RestauraÃ§Ã£o resina composta - composta",
          "RestauraÃ§Ã£o resina composta - complexa","RestauraÃ§Ã£o amÃ¡lgama",
          "Clareamento caseiro","Clareamento de consultÃ³rio","Clareamento interno",
          "Faceta direta em resina","Ajuste oclusal","Polimento de restauraÃ§Ã£o",
        ],
      },
      cirurgia: {
        label: "Cirurgia", icon: "ðŸ”ª", color: "#EF4444",
        procedures: [
          "Exodontia simples","Exodontia de terceiro molar","Exodontia de raiz residual",
          "Cirurgia de dente incluso","Apicectomia","BiÃ³psia","RemoÃ§Ã£o de cisto",
          "Frenectomia lingual","Frenectomia labial","Sutura","RemoÃ§Ã£o de sutura",
          "Drenagem de abscesso",
        ],
      },
      odontopediatria: {
        label: "Odontopediatria", icon: "ðŸ‘¶", color: "#A78BFA",
        procedures: [
          "AplicaÃ§Ã£o de selante","AplicaÃ§Ã£o de flÃºor","RestauraÃ§Ã£o em dente decÃ­duo",
          "Pulpotomia em decÃ­duo","Pulpectomia em decÃ­duo","Exodontia de decÃ­duo",
          "Mantenedor de espaÃ§o","Coroa de aÃ§o","AdequaÃ§Ã£o do meio bucal",
        ],
      },
    };

    const TOOTH_NUMBERS = [
      [18,17,16,15,14,13,12,11,21,22,23,24,25,26,27,28],
      [48,47,46,45,44,43,42,41,31,32,33,34,35,36,37,38],
    ];

    const WIRE_MATERIALS = ["Nitinol", "AÃ§o"];
    const WIRE_FORMATS = ["Redondo", "Quadrado"];
    const WIRE_GAUGES = ["012","014","016","018","020","16x16","16x22","17x25","19x25","21x25"];

    // â”€â”€â”€ SUPABASE CONFIGURATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const SUPABASE_URL = 'https://bzixxdtbktsztdtpadwh.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ6aXh4ZHRia3RzenRkdHBhZHdoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE0NDcwNjEsImV4cCI6MjA4NzAyMzA2MX0.DqgAyHB_QPzkz21RFXYf-fN1IzxyxoX4mMzqr3KMIww';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Role mapping: LocalStorage â†’ Supabase ENUM
    const ROLE_TO_ENUM = {
      'admin': 'ADMIN',
      'dentista': 'PROFESSIONAL',
      'orto': 'PROFESSIONAL',
      'recepcao': 'RECEPTION'
    };
    const ENUM_TO_ROLE = {
      'ADMIN': 'admin',
      'OWNER': 'admin',
      'PROFESSIONAL': 'dentista',
      'RECEPTION': 'recepcao',
      'MANAGER': 'admin'
    };

    // â”€â”€â”€ UTILITIES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const generateId = () => Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
    const formatDate = (d) => new Date(d).toLocaleDateString("pt-BR");
    const formatDateTime = (d) => new Date(d).toLocaleString("pt-BR");
    const formatDateISO = (d) => new Date(d).toISOString().split("T")[0];
    const fileIcon = (type) => {
      if (type?.startsWith("image/")) return "ðŸ–¼ï¸";
      if (type?.includes("pdf")) return "ðŸ“„";
      return "ðŸ“Ž";
    };
    const formatSize = (bytes) => {
      if (bytes < 1024) return bytes + " B";
      if (bytes < 1048576) return (bytes / 1024).toFixed(1) + " KB";
      return (bytes / 1048576).toFixed(1) + " MB";
    };

    const defaultAnamnesis = {
      allergies: "", medications: "", diseases: "", surgeries: "", familyHistory: "",
      smoker: "NÃ£o", drinker: "NÃ£o", pregnant: "NÃ£o", bloodPressure: "",
      diabetes: "NÃ£o", heartDisease: "NÃ£o", hepatitis: "NÃ£o", hiv: "NÃ£o",
      bleeding: "NÃ£o", healing: "Normal", anesthesiaReaction: "NÃ£o", observations: "",
    };

    // Migrate old inline base64 data to IndexedDB
    const migrateFileToIDB = (item) => {
      if (item && item.data && typeof item.data === "string" && item.data.startsWith("data:")) {
        FileDB.put(item.id, item.data).catch(() => {});
        const { data, ...meta } = item;
        return meta;
      }
      return item;
    };

    const migratePatient = (p) => ({
      ...p,
      codigo: p.codigo || "",
      responsavel_clinico_id: p.responsavel_clinico_id || "",
      responsavel_orto_id: p.responsavel_orto_id || "",
      responsavelHistory: p.responsavelHistory || [],
      documents: (p.documents || []).map(migrateFileToIDB),
      arrivalControl: p.arrivalControl || null,
      financeiro: p.financeiro || { orcamento_total: 0, pagamentos: [] },
      records: (p.records || []).map(r => ({
        ...r,
        tipo_atendimento: r.tipo_atendimento || (r.specialty === "ortodontia" ? "ORTODONTIA" : "GERAL"),
        dentista_atendente_id: r.dentista_atendente_id || "",
        dentista_responsavel_no_momento_id: r.dentista_responsavel_no_momento_id || "",
        atendimento_fora_da_responsabilidade: r.atendimento_fora_da_responsabilidade || false,
        motivo_fora: r.motivo_fora || "",
        photos: (r.photos || []).map(migrateFileToIDB),
        wireInfo: r.wireInfo?.upper ? r.wireInfo : { upper: { material: r.wireInfo?.material || "", format: r.wireInfo?.format || "", gauge: r.wireInfo?.gauge || "" }, lower: { material: "", format: "", gauge: "" } },
      })),
    });

    // Default admin stub (no credentials â€” auth is handled by Supabase)
    const DEFAULT_ADMIN = {
      id: "admin1", name: "Administrador", login: "",
      role: "admin", specialty: "", active: true, createdAt: new Date().toISOString(),
    };

    // â”€â”€â”€ INDEXEDDB FILE STORAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Files are stored in IndexedDB to avoid localStorage size limits.
    // Only metadata (id, name, type, size) is kept in state/localStorage.
    const FileDB = (() => {
      const DB_NAME = "dental_files_db";
      const STORE = "files";
      const open = () => new Promise((resolve, reject) => {
        const req = indexedDB.open(DB_NAME, 1);
        req.onupgradeneeded = () => req.result.createObjectStore(STORE);
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => reject(req.error);
      });
      return {
        put: async (id, data) => { const db = await open(); return new Promise((res, rej) => { const tx = db.transaction(STORE, "readwrite"); tx.objectStore(STORE).put(data, id); tx.oncomplete = () => res(); tx.onerror = () => rej(tx.error); }); },
        get: async (id) => { const db = await open(); return new Promise((res, rej) => { const tx = db.transaction(STORE, "readonly"); const req = tx.objectStore(STORE).get(id); req.onsuccess = () => res(req.result); req.onerror = () => rej(req.error); }); },
        del: async (id) => { const db = await open(); return new Promise((res, rej) => { const tx = db.transaction(STORE, "readwrite"); tx.objectStore(STORE).delete(id); tx.oncomplete = () => res(); tx.onerror = () => rej(tx.error); }); },
      };
    })();

    // â”€â”€â”€ SIGNATURE PAD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function SignaturePad({ value, onChange, label }) {
      const canvasRef = useRef(null);
      const [isDrawing, setIsDrawing] = useState(false);
      const [hasDrawn, setHasDrawn] = useState(false);
      useEffect(() => {
        const canvas = canvasRef.current;
        if (!canvas) return;
        const ctx = canvas.getContext("2d");
        const rect = canvas.parentElement.getBoundingClientRect();
        canvas.width = rect.width; canvas.height = 160;
        ctx.fillStyle = "#FAFBFC"; ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.strokeStyle = "#E2E8F0"; ctx.lineWidth = 1; ctx.setLineDash([4,4]);
        ctx.beginPath(); ctx.moveTo(20, 120); ctx.lineTo(canvas.width - 20, 120); ctx.stroke(); ctx.setLineDash([]);
        if (value) {
          const img = new Image();
          img.onload = () => { ctx.fillStyle="#FAFBFC"; ctx.fillRect(0,0,canvas.width,canvas.height); ctx.drawImage(img,0,0,canvas.width,canvas.height); setHasDrawn(true); };
          img.src = value;
        }
      }, []);
      const getPos = (e) => { const c=canvasRef.current, r=c.getBoundingClientRect(), t=e.touches?e.touches[0]:e; return { x:(t.clientX-r.left)*(c.width/r.width), y:(t.clientY-r.top)*(c.height/r.height) }; };
      const startDraw = (e) => { e.preventDefault(); const ctx=canvasRef.current.getContext("2d"), pos=getPos(e); ctx.beginPath(); ctx.moveTo(pos.x,pos.y); ctx.strokeStyle="#1E293B"; ctx.lineWidth=2.5; ctx.lineCap="round"; ctx.lineJoin="round"; setIsDrawing(true); setHasDrawn(true); };
      const draw = (e) => { e.preventDefault(); if(!isDrawing) return; const ctx=canvasRef.current.getContext("2d"), pos=getPos(e); ctx.lineTo(pos.x,pos.y); ctx.stroke(); };
      const endDraw = (e) => { if(e) e.preventDefault(); setIsDrawing(false); if(canvasRef.current && hasDrawn) onChange(canvasRef.current.toDataURL("image/png")); };
      const clearSig = () => { const c=canvasRef.current, ctx=c.getContext("2d"); ctx.fillStyle="#FAFBFC"; ctx.fillRect(0,0,c.width,c.height); ctx.strokeStyle="#E2E8F0"; ctx.lineWidth=1; ctx.setLineDash([4,4]); ctx.beginPath(); ctx.moveTo(20,120); ctx.lineTo(c.width-20,120); ctx.stroke(); ctx.setLineDash([]); setHasDrawn(false); onChange(""); };
      return (
        <div style={{ marginBottom: 14 }}>
          <label style={{ display:"block", fontSize:13, fontWeight:600, color:"#475569", marginBottom:6 }}>{label || "Assinatura do Paciente"}</label>
          <div style={{ position:"relative", borderRadius:12, border:"1.5px solid #CBD5E1", overflow:"hidden", background:"#FAFBFC" }}>
            <canvas ref={canvasRef} style={{ display:"block", width:"100%", height:160, cursor:"crosshair", touchAction:"none" }}
              onMouseDown={startDraw} onMouseMove={draw} onMouseUp={endDraw} onMouseLeave={endDraw}
              onTouchStart={startDraw} onTouchMove={draw} onTouchEnd={endDraw} />
            <div style={{ position:"absolute", bottom:8, left:12, fontSize:10, color:"#94A3B8", pointerEvents:"none" }}>Assine acima da linha</div>
            <button onClick={clearSig} style={{ position:"absolute", top:8, right:8, background:"rgba(255,255,255,0.9)", border:"1px solid #E2E8F0", borderRadius:6, padding:"4px 10px", fontSize:11, color:"#64748B", cursor:"pointer", fontWeight:600 }}>Limpar</button>
          </div>
        </div>
      );
    }

    // â”€â”€â”€ REUSABLE UI COMPONENTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function Modal({ isOpen, onClose, title, children, wide }) {
      if (!isOpen) return null;
      return (
        <div style={{ position:"fixed", inset:0, zIndex:1000, display:"flex", alignItems:"center", justifyContent:"center", background:"rgba(15,23,42,0.6)", backdropFilter:"blur(4px)" }} onClick={onClose}>
          <div onClick={e=>e.stopPropagation()} style={{ background:"#fff", borderRadius:16, width:wide?"90%":"min(560px,92%)", maxWidth:wide?900:560, maxHeight:"88vh", overflow:"hidden", display:"flex", flexDirection:"column", boxShadow:"0 25px 60px rgba(0,0,0,0.2)" }}>
            <div style={{ padding:"20px 24px", borderBottom:"1px solid #E2E8F0", display:"flex", justifyContent:"space-between", alignItems:"center", flexShrink:0 }}>
              <h2 style={{ margin:0, fontSize:18, fontWeight:700, color:"#0F172A" }}>{title}</h2>
              <button onClick={onClose} style={{ background:"#F1F5F9", border:"none", borderRadius:8, width:32, height:32, cursor:"pointer", fontSize:18, display:"flex", alignItems:"center", justifyContent:"center", color:"#64748B" }}>Ã—</button>
            </div>
            <div style={{ padding:24, overflowY:"auto", flex:1 }}>{children}</div>
          </div>
        </div>
      );
    }
    function Input({ label, ...props }) {
      return (<div style={{ marginBottom:14 }}>
        {label && <label style={{ display:"block", fontSize:13, fontWeight:600, color:"#475569", marginBottom:5 }}>{label}</label>}
        <input {...props} style={{ width:"100%", padding:"10px 14px", borderRadius:10, border:"1.5px solid #CBD5E1", fontSize:14, outline:"none", transition:"border 0.2s", boxSizing:"border-box", background:"#F8FAFC", ...props.style }} />
      </div>);
    }
    function Textarea({ label, ...props }) {
      return (<div style={{ marginBottom:14 }}>
        {label && <label style={{ display:"block", fontSize:13, fontWeight:600, color:"#475569", marginBottom:5 }}>{label}</label>}
        <textarea {...props} style={{ width:"100%", padding:"10px 14px", borderRadius:10, border:"1.5px solid #CBD5E1", fontSize:14, outline:"none", minHeight:70, resize:"vertical", boxSizing:"border-box", background:"#F8FAFC", fontFamily:"inherit", ...props.style }} />
      </div>);
    }
    function Select({ label, options, ...props }) {
      return (<div style={{ marginBottom:14 }}>
        {label && <label style={{ display:"block", fontSize:13, fontWeight:600, color:"#475569", marginBottom:5 }}>{label}</label>}
        <select {...props} style={{ width:"100%", padding:"10px 14px", borderRadius:10, border:"1.5px solid #CBD5E1", fontSize:14, outline:"none", background:"#F8FAFC", boxSizing:"border-box", ...props.style }}>
          {options.map(o => <option key={o.value} value={o.value}>{o.label}</option>)}
        </select>
      </div>);
    }
    function Badge({ text, color }) {
      return (<span style={{ display:"inline-flex", alignItems:"center", gap:4, background:color+"18", color, border:`1px solid ${color}40`, borderRadius:8, padding:"4px 10px", fontSize:12, fontWeight:600, margin:"2px 4px 2px 0" }}>{text}</span>);
    }
    // SVG tooth shapes for visual odontogram
    const ToothSVG = ({ type, number, isSelected, onClick }) => {
      const baseColor = isSelected ? "#0EA5E9" : "#B8C5D6";
      const fillColor = isSelected ? "#0EA5E920" : "transparent";
      
      // Determine tooth type based on number
      const getToothType = (num) => {
        const lastDigit = num % 10;
        if (lastDigit === 8 || lastDigit === 7 || lastDigit === 6) return "molar";
        if (lastDigit === 5 || lastDigit === 4) return "premolar";
        if (lastDigit === 3) return "canine";
        return "incisor"; // 1, 2
      };
      
      const toothType = getToothType(number);
      const isUpper = number >= 11 && number <= 28;
      
      // SVG paths for different tooth types
      const paths = {
        molar: isUpper 
          ? "M5,15 L5,8 Q5,5 8,5 L22,5 Q25,5 25,8 L25,15 Q25,18 22,18 L20,18 L20,35 Q20,38 17,38 L13,38 Q10,38 10,35 L10,18 L8,18 Q5,18 5,15 Z M11,18 L11,32 L13,32 L13,18 Z M17,18 L17,32 L19,32 L19,18 Z"
          : "M5,5 Q5,2 8,2 L22,2 Q25,2 25,5 L25,12 Q25,15 22,15 L20,15 L20,25 Q20,30 18,32 Q16,34 15,34 Q14,34 12,32 Q10,30 10,25 L10,15 L8,15 Q5,15 5,12 Z M11,15 L11,24 Q11,27 13,29 L13,15 Z M17,15 L17,29 Q19,27 19,24 L19,15 Z",
        premolar: isUpper
          ? "M7,15 L7,8 Q7,5 10,5 L20,5 Q23,5 23,8 L23,15 Q23,18 20,18 L18,18 L18,35 Q18,38 15,38 Q12,38 12,35 L12,18 L10,18 Q7,18 7,15 Z M13,18 L13,33 L17,33 L17,18 Z"
          : "M7,5 Q7,2 10,2 L20,2 Q23,2 23,5 L23,12 Q23,15 20,15 L18,15 L18,28 Q18,32 15,34 Q12,32 12,28 L12,15 L10,15 Q7,15 7,12 Z M13,15 L13,27 Q13,29 15,30 Q17,29 17,27 L17,15 Z",
        canine: isUpper
          ? "M10,12 L10,6 Q10,3 13,3 L17,3 Q20,3 20,6 L20,12 Q20,15 18,17 L16,17 L16,36 Q16,39 15,39 Q14,39 14,36 L14,17 L12,17 Q10,15 10,12 Z"
          : "M10,4 Q10,2 13,2 L17,2 Q20,2 20,4 L20,10 Q20,13 18,15 L16,15 L16,30 Q16,33 15,34 Q14,33 14,30 L14,15 L12,15 Q10,13 10,10 Z",
        incisor: isUpper
          ? "M9,12 L9,6 Q9,3 12,3 L18,3 Q21,3 21,6 L21,12 Q21,15 18,15 L17,15 L17,35 Q17,38 15,38 Q13,38 13,35 L13,15 L12,15 Q9,15 9,12 Z"
          : "M10,5 Q10,2 13,2 L17,2 Q20,2 20,5 L20,11 Q20,14 17,14 L16,14 L16,30 Q16,33 15,34 Q14,33 14,30 L14,14 L13,14 Q10,14 10,11 Z",
      };
      
      return (
        <g onClick={onClick} style={{ cursor: "pointer" }}>
          <path d={paths[toothType]} fill={fillColor} stroke={baseColor} strokeWidth="1.5" />
        </g>
      );
    };

    function ToothChart({ selected, onToggle }) {
      const upperTeeth = [18,17,16,15,14,13,12,11,21,22,23,24,25,26,27,28];
      const lowerTeeth = [48,47,46,45,44,43,42,41,31,32,33,34,35,36,37,38];
      
      return (<div style={{ marginBottom:14 }}>
        <label style={{ display:"block", fontSize:13, fontWeight:600, color:"#475569", marginBottom:8 }}>Dentes Envolvidos</label>
        <div style={{ background:"#F8FAFC", borderRadius:12, padding:"20px 12px", border:"1px solid #E2E8F0" }}>
          {/* Upper Arch */}
          <svg viewBox="0 0 480 50" style={{ width:"100%", height:"auto", marginBottom:8 }}>
            {upperTeeth.map((tooth, idx) => (
              <g key={tooth} transform={`translate(${idx * 30}, 0)`}>
                <ToothSVG 
                  number={tooth} 
                  isSelected={selected.includes(tooth)} 
                  onClick={() => onToggle(tooth)}
                />
                <text 
                  x="15" 
                  y="48" 
                  textAnchor="middle" 
                  fontSize="9" 
                  fontWeight="600"
                  fill="#64748B"
                >
                  {tooth}
                </text>
              </g>
            ))}
          </svg>
          
          {/* Divider */}
          <div style={{ borderTop:"1.5px dashed #CBD5E1", margin:"12px 0" }} />
          
          {/* Lower Arch */}
          <svg viewBox="0 0 480 50" style={{ width:"100%", height:"auto", marginTop:8 }}>
            {lowerTeeth.map((tooth, idx) => (
              <g key={tooth} transform={`translate(${idx * 30}, 10)`}>
                <text 
                  x="15" 
                  y="-2" 
                  textAnchor="middle" 
                  fontSize="9" 
                  fontWeight="600"
                  fill="#64748B"
                >
                  {tooth}
                </text>
                <ToothSVG 
                  number={tooth} 
                  isSelected={selected.includes(tooth)} 
                  onClick={() => onToggle(tooth)}
                />
              </g>
            ))}
          </svg>
        </div>
      </div>);
    }

    // â”€â”€â”€ FILE THUMBNAIL (lazy loads from IndexedDB) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function FileThumb({ fileId, cache, loadFn, type, name, onClick, style }) {
      const [loaded, setLoaded] = useState(false);
      useEffect(() => { if (fileId && !cache[fileId]) { loadFn(fileId); } }, [fileId]);
      const src = cache[fileId];
      if (type?.startsWith("image/")) {
        return src ? <img src={src} alt={name} onClick={onClick} style={{ width:"100%", height:"100%", objectFit:"cover", display:"block", cursor:onClick?"pointer":"default", ...style }} />
          : <div style={{ width:"100%", height:"100%", display:"flex", alignItems:"center", justifyContent:"center", background:"#F1F5F9", fontSize:10, color:"#94A3B8", ...style }}>Carregando...</div>;
      }
      return <div onClick={onClick} style={{ width:"100%", height:"100%", background:"#F8FAFC", display:"flex", alignItems:"center", justifyContent:"center", fontSize:28, cursor:"pointer", ...style }}>{fileIcon(type)}</div>;
    }

    // â”€â”€â”€ MAIN APP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function App() {
      // â”€â”€ Auth State â”€â”€
      const [users, setUsers] = useState(() => {
        try { const u = JSON.parse(localStorage.getItem("dental_users")); return u && u.length ? u : [DEFAULT_ADMIN]; } catch { return [DEFAULT_ADMIN]; }
      });
      const [currentUser, setCurrentUser] = useState(() => {
        try { return JSON.parse(localStorage.getItem("dental_session")); } catch { return null; }
      });
      const [loginForm, setLoginForm] = useState({ login: "", password: "" });
      const [loginError, setLoginError] = useState("");

      // â”€â”€ Data State â”€â”€
      const [patients, setPatients] = useState([]);
      const [loadingPatients, setLoadingPatients] = useState(true);
      const [auditLogs, setAuditLogs] = useState(() => {
        try { return JSON.parse(localStorage.getItem("dental_audit")) || []; } catch { return []; }
      });
      
      // â”€â”€ Realtime State â”€â”€
      const [syncing, setSyncing] = useState(false);
      const [notifications, setNotifications] = useState([]);
      const [realtimeChannels, setRealtimeChannels] = useState([]);

      // â”€â”€ Navigation â”€â”€
      const [view, setView] = useState("list");
      const [selectedPatient, setSelectedPatient] = useState(null);
      const [searchTerm, setSearchTerm] = useState("");
      const [patientTab, setPatientTab] = useState("orto");
      const [auditFilter, setAuditFilter] = useState("");
      const [docDateFilter, setDocDateFilter] = useState("");

      // â”€â”€ Modals â”€â”€
      const [showNewPatient, setShowNewPatient] = useState(false);
      const [showNewRecord, setShowNewRecord] = useState(false);
      const [showAnamnesis, setShowAnamnesis] = useState(false);
      const [editingAnamnesis, setEditingAnamnesis] = useState(false);
      const [viewingSignature, setViewingSignature] = useState(null);
      const [viewingPhoto, setViewingPhoto] = useState(null);
      const [showChangeResp, setShowChangeResp] = useState(false);
      const [showRespCheck, setShowRespCheck] = useState(false);
      const [showUserForm, setShowUserForm] = useState(false);
      const [showUploadDoc, setShowUploadDoc] = useState(false);
      const [showArrivalControl, setShowArrivalControl] = useState(false);
      const [arrivalPatientId, setArrivalPatientId] = useState(null);

      // â”€â”€ Forms â”€â”€
      const [npForm, setNpForm] = useState({ codigo:"", name:"", birthDate:"", phone:"", email:"", cpf:"", address:"", responsavel_clinico_id:"", responsavel_orto_id:"" });
      const emptyNrForm = { date:formatDateISO(new Date()), tipo_atendimento:"", specialty:"", procedures:[], teeth:[], notes:"", nextAppointment:"", signature:"", photos:[], wireInfo:{upper:{material:"",format:"",gauge:""},lower:{material:"",format:"",gauge:""}} };
      const [nrForm, setNrForm] = useState({...emptyNrForm});
      const [anamnesisForm, setAnamnesisForm] = useState({...defaultAnamnesis});
      const [userForm, setUserForm] = useState({ id:"", name:"", login:"", password:"", role:"dentista", active:true });
      const [editingUserId, setEditingUserId] = useState(null);
      const [respForm, setRespForm] = useState({ responsavel_clinico_id:"", responsavel_orto_id:"" });
      const [respCheckMotivo, setRespCheckMotivo] = useState("");
      const [pendingRecord, setPendingRecord] = useState(null);
      const [arrivalForm, setArrivalForm] = useState({ dentista_id: "" });
      const [showFinanceiro, setShowFinanceiro] = useState(false);
      const [financeiroForm, setFinanceiroForm] = useState({ data: formatDateISO(new Date()), valor: "", forma_pagamento: "avista", observacao: "" });
      const [editingOrcamento, setEditingOrcamento] = useState(false);
      const [tempOrcamento, setTempOrcamento] = useState("");
      const [showRelatorio, setShowRelatorio] = useState(false);
      const [relatorioFilters, setRelatorioFilters] = useState({ profissional_id: "", data_inicio: formatDateISO(new Date(new Date().getFullYear(), new Date().getMonth(), 1)), data_fim: formatDateISO(new Date()), busca: "" });
      const [relatorioSort, setRelatorioSort] = useState({ field: "date", direction: "desc" });

      // â”€â”€ Refs â”€â”€
      const photoInputRef = useRef(null);
      const docInputRef = useRef(null);

      // â”€â”€ Supabase Session Restore â”€â”€
      useEffect(() => {
        const restoreSession = async () => {
          const { data: { session } } = await supabase.auth.getSession();
          if (session?.user) {
            // Buscar perfil do usuÃ¡rio
            const { data: profile } = await supabase
              .from('profiles')
              .select('*')
              .eq('user_id', session.user.id)
              .single();
            
            if (profile) {
              const localUser = {
                id: profile.user_id,
                name: profile.full_name || session.user.email,
                login: session.user.email,
                role: ENUM_TO_ROLE[profile.role] || 'recepcao',
                specialty: '',
                active: true,
                clinic_id: profile.clinic_id,
                createdAt: profile.created_at
              };
              setCurrentUser(localUser);
            }
          } else {
            setLoadingPatients(false);
          }
        };
        restoreSession();
      }, []);

      // â”€â”€ MigraÃ§Ã£o de Dados Antigos â”€â”€
      const migrateOldDataToSupabase = async () => {
        try {
          const oldPatients = JSON.parse(localStorage.getItem("dental_patients")) || [];
          if (oldPatients.length === 0) return { migrated: 0, errors: 0 };
          
          let migrated = 0;
          let errors = 0;
          
          for (const oldPatient of oldPatients) {
            try {
              // Inserir paciente no Supabase
              const { data, error } = await supabase
                .from('patients')
                .insert({
                  clinic_id: currentUser.clinic_id,
                  name: oldPatient.name,
                  birth_date: oldPatient.birthDate || null,
                  phone: oldPatient.phone || '',
                  email: oldPatient.email || '',
                  cpf: oldPatient.cpf || '',
                  notes: ''
                })
                .select()
                .single();
              
              if (error) throw error;
              
              // Salvar dados relacionados no LocalStorage com novo ID
              if (oldPatient.anamnesis) saveLocalData('anamnesis', data.id, oldPatient.anamnesis);
              if (oldPatient.records) saveLocalData('records', data.id, oldPatient.records);
              if (oldPatient.documents) saveLocalData('documents', data.id, oldPatient.documents);
              if (oldPatient.responsavelHistory) saveLocalData('responsavelHistory', data.id, oldPatient.responsavelHistory);
              if (oldPatient.arrivalControl) saveLocalData('arrivalControl', data.id, oldPatient.arrivalControl);
              if (oldPatient.financeiro) saveLocalData('financeiro', data.id, oldPatient.financeiro);
              
              migrated++;
            } catch (err) {
              console.error(`Erro ao migrar paciente ${oldPatient.name}:`, err);
              errors++;
            }
          }
          
          // Limpar dados antigos apÃ³s migraÃ§Ã£o bem-sucedida
          if (migrated > 0 && errors === 0) {
            localStorage.removeItem("dental_patients");
          }
          
          return { migrated, errors, total: oldPatients.length };
        } catch (err) {
          console.error('Erro na migraÃ§Ã£o:', err);
          return { migrated: 0, errors: 0, total: 0 };
        }
      };

      // â”€â”€ Load Patients from Supabase â”€â”€
      useEffect(() => {
        const loadPatients = async () => {
          if (!currentUser || !currentUser.clinic_id) {
            setLoadingPatients(false);
            return;
          }
          
          try {
            // Verificar se hÃ¡ dados antigos para migrar
            const oldPatients = JSON.parse(localStorage.getItem("dental_patients") || "[]");
            if (oldPatients.length > 0) {
              const shouldMigrate = confirm(
                `Encontramos ${oldPatients.length} paciente(s) no sistema antigo.\n\n` +
                `Deseja migrÃ¡-los para o novo sistema Supabase?\n\n` +
                `(Recomendado: clique em OK para migrar)`
              );
              
              if (shouldMigrate) {
                const result = await migrateOldDataToSupabase();
                if (result.migrated > 0) {
                  alert(
                    `MigraÃ§Ã£o concluÃ­da!\n\n` +
                    `âœ… ${result.migrated} paciente(s) migrado(s) com sucesso\n` +
                    (result.errors > 0 ? `âš ï¸ ${result.errors} erro(s)` : '')
                  );
                }
              }
            }
            
            // Carregar pacientes do Supabase
            const { data, error } = await supabase
              .from('patients')
              .select('*')
              .eq('clinic_id', currentUser.clinic_id)
              .order('created_at', { ascending: false });
            
            if (error) throw error;
            
            // Converter para formato local (hÃ­brido)
            const patientsData = data.map(p => {
              const extra = getLocalData('extraFields', p.id) || {};
              return {
                ...p,
                birthDate: p.birth_date,
                codigo: extra.codigo || "",
                address: extra.address || "",
                responsavel_clinico_id: extra.responsavel_clinico_id || "",
                responsavel_orto_id: extra.responsavel_orto_id || "",
                // Dados ainda no LocalStorage (temporÃ¡rio)
                anamnesis: getLocalData('anamnesis', p.id) || {...defaultAnamnesis},
                records: getLocalData('records', p.id) || [],
                documents: getLocalData('documents', p.id) || [],
                responsavelHistory: getLocalData('responsavelHistory', p.id) || [],
                arrivalControl: getLocalData('arrivalControl', p.id) || null,
                financeiro: getLocalData('financeiro', p.id) || { orcamento_total: 0, pagamentos: [] },
                createdAt: p.created_at
              };
            });
            
            setPatients(patientsData);
          } catch (err) {
            console.error('Erro ao carregar pacientes:', err);
            // Fallback para LocalStorage se houver erro
            try {
              const localPatients = JSON.parse(localStorage.getItem("dental_patients")) || [];
              setPatients(localPatients.map(migratePatient));
            } catch {
              setPatients([]);
            }
          } finally {
            setLoadingPatients(false);
          }
        };
        
        loadPatients();
      }, [currentUser]);
      
      // â”€â”€ Setup Realtime Listeners â”€â”€
      useEffect(() => {
        if (currentUser && currentUser.clinic_id) {
          setupRealtimeListeners();
        }
        
        // Cleanup ao desmontar ou trocar usuÃ¡rio
        return () => {
          realtimeChannels.forEach(channel => {
            supabase.removeChannel(channel);
          });
        };
      }, [currentUser]);

      // â”€â”€ Persist (with error handling to prevent UI freeze) â”€â”€
      const safeSave = (key, data) => { try { localStorage.setItem(key, JSON.stringify(data)); } catch(e) { console.warn("localStorage save failed for", key, e.message); } };
      useEffect(() => { safeSave("dental_users", users.map(u => { const { password, ...safe } = u; return safe; })); }, [users]);
      // Pacientes agora sÃ£o salvos no Supabase, nÃ£o no localStorage
      // useEffect(() => { safeSave("dental_patients", patients); }, [patients]);
      useEffect(() => { safeSave("dental_audit", auditLogs); }, [auditLogs]);
      useEffect(() => { if (currentUser) safeSave("dental_session", currentUser); else localStorage.removeItem("dental_session"); }, [currentUser]);

      // â”€â”€ Helpers â”€â”€
      const getUserName = (id) => { const u = users.find(x => x.id === id); return u ? u.name : "â€”"; };
      
      // Helper para gerenciar dados locais temporÃ¡rios (atÃ© migrar para Supabase)
      const getLocalData = (type, patientId) => {
        try {
          const key = `patient_${type}_${patientId}`;
          const data = localStorage.getItem(key);
          return data ? JSON.parse(data) : null;
        } catch {
          return null;
        }
      };
      
      const saveLocalData = (type, patientId, data) => {
        try {
          const key = `patient_${type}_${patientId}`;
          localStorage.setItem(key, JSON.stringify(data));
        } catch (e) {
          console.warn(`Erro ao salvar ${type} local:`, e);
        }
      };
      
      const removeLocalData = (patientId) => {
        ['anamnesis', 'records', 'documents', 'responsavelHistory', 'arrivalControl', 'financeiro'].forEach(type => {
          try {
            localStorage.removeItem(`patient_${type}_${patientId}`);
          } catch {}
        });
      };
      const isAdmin = currentUser?.role === "admin";
      const activeDentists = users.filter(u => u.active && u.role !== "admin");

      const addAudit = (action, targetType, targetId, targetName, details) => {
        setAuditLogs(prev => [{ id:generateId(), userId:currentUser?.id, userName:currentUser?.name, action, targetType, targetId, targetName, details: details||"", timestamp:new Date().toISOString(), userAgent:navigator.userAgent }, ...prev]);
      };

      // â”€â”€ Auth â”€â”€
      const handleLogin = async () => {
        setLoginError("");
        try {
          // Autenticar com Supabase Auth
          const { data: authData, error: authError } = await supabase.auth.signInWithPassword({
            email: loginForm.login,
            password: loginForm.password
          });
          
          if (authError) {
            setLoginError("Email ou senha invÃ¡lidos.");
            return;
          }

          // Buscar perfil do usuÃ¡rio no Supabase
          const { data: profile, error: profileError } = await supabase
            .from('profiles')
            .select('*')
            .eq('user_id', authData.user.id)
            .single();

          if (profileError || !profile) {
            setLoginError("Perfil de usuÃ¡rio nÃ£o encontrado.");
            await supabase.auth.signOut();
            return;
          }

          // Converter perfil Supabase para formato local
          const localUser = {
            id: profile.user_id,
            name: profile.full_name || authData.user.email,
            login: authData.user.email,
            role: ENUM_TO_ROLE[profile.role] || 'recepcao',
            specialty: '',
            active: true,
            clinic_id: profile.clinic_id,
            createdAt: profile.created_at
          };

          setCurrentUser(localUser);
          setLoginError("");
          setLoginForm({ login:"", password:"" });
          setTimeout(() => addAudit("LOGIN","usuario",localUser.id,localUser.name,"Login realizado"), 0);
        } catch (err) {
          console.error('Erro no login:', err);
          setLoginError("Erro ao fazer login. Tente novamente.");
        }
      };
      
      const handleLogout = async () => {
        await supabase.auth.signOut();
        setCurrentUser(null);
        setView("list");
        setSelectedPatient(null);
      };

      // â”€â”€ Supabase Storage Functions â”€â”€
      
      // Converter base64 para Blob
      const base64ToBlob = (base64, mimeType = 'image/png') => {
        const byteString = atob(base64.split(',')[1]);
        const ab = new ArrayBuffer(byteString.length);
        const ia = new Uint8Array(ab);
        for (let i = 0; i < byteString.length; i++) {
          ia[i] = byteString.charCodeAt(i);
        }
        return new Blob([ab], { type: mimeType });
      };
      
      // â”€â”€ CRUD Financeiro: OrÃ§amentos (localStorage â€” tabelas nÃ£o existem no DB) â”€â”€
      const createOrUpdateBudgetSupabase = async (patientId, totalAmount) => {
        try {
          const financeiro = getLocalData('financeiro', patientId) || { orcamento_total: 0, pagamentos: [] };
          financeiro.orcamento_total = parseFloat(totalAmount) || 0;
          saveLocalData('financeiro', patientId, financeiro);
          return { total_amount: financeiro.orcamento_total };
        } catch (err) {
          console.error('Erro ao salvar orÃ§amento:', err);
          return null;
        }
      };

      const loadBudgetSupabase = async (patientId) => {
        const financeiro = getLocalData('financeiro', patientId) || { orcamento_total: 0, pagamentos: [] };
        return { total_amount: financeiro.orcamento_total };
      };

      // â”€â”€ CRUD Financeiro: Pagamentos (localStorage â€” tabela payments nÃ£o existe no DB) â”€â”€
      const createPaymentSupabase = async (patientId, paymentData) => {
        try {
          const financeiro = getLocalData('financeiro', patientId) || { orcamento_total: 0, pagamentos: [] };
          const newPayment = {
            id: generateId(),
            data: paymentData.data,
            valor: parseFloat(paymentData.valor),
            forma_pagamento: paymentData.forma_pagamento,
            observacao: paymentData.observacao || '',
            registrado_por: currentUser.name,
            registrado_em: new Date().toISOString()
          };
          financeiro.pagamentos = [newPayment, ...(financeiro.pagamentos || [])];
          saveLocalData('financeiro', patientId, financeiro);
          return newPayment;
        } catch (err) {
          console.error('Erro ao criar pagamento:', err);
          return null;
        }
      };

      const loadPaymentsSupabase = async (patientId) => {
        const financeiro = getLocalData('financeiro', patientId) || { orcamento_total: 0, pagamentos: [] };
        return financeiro.pagamentos || [];
      };

      const deletePaymentSupabase = async (paymentId) => {
        try {
          // Find which patient has this payment
          for (const p of patients) {
            const financeiro = getLocalData('financeiro', p.id);
            if (financeiro && financeiro.pagamentos) {
              const idx = financeiro.pagamentos.findIndex(pg => pg.id === paymentId);
              if (idx >= 0) {
                financeiro.pagamentos.splice(idx, 1);
                saveLocalData('financeiro', p.id, financeiro);
                return true;
              }
            }
          }
          return true;
        } catch (err) {
          console.error('Erro ao deletar pagamento:', err);
          return false;
        }
      };
      
      // â”€â”€ Realtime & NotificaÃ§Ãµes â”€â”€
      const showNotification = (message, type = 'info') => {
        const id = Date.now();
        setNotifications(prev => [...prev, { id, message, type }]);
        
        // Auto-remover apÃ³s 5 segundos
        setTimeout(() => {
          setNotifications(prev => prev.filter(n => n.id !== id));
        }, 5000);
      };
      
      const setupRealtimeListeners = () => {
        if (!currentUser || !currentUser.clinic_id) return;
        
        // Limpar listeners antigos
        realtimeChannels.forEach(channel => {
          supabase.removeChannel(channel);
        });
        
        const channels = [];
        
        // Listener para patients
        const patientsChannel = supabase
          .channel('patients-changes')
          .on('postgres_changes', 
            { 
              event: '*', 
              schema: 'public', 
              table: 'patients',
              filter: `clinic_id=eq.${currentUser.clinic_id}`
            }, 
            (payload) => {
              const { eventType, new: newRecord, old: oldRecord } = payload;
              
              switch (eventType) {
                case 'INSERT':
                  setPatients(prev => {
                    // Evitar duplicatas
                    if (prev.find(p => p.id === newRecord.id)) return prev;
                    const extra = getLocalData('extraFields', newRecord.id) || {};
                    const enriched = {
                      ...newRecord,
                      birthDate: newRecord.birth_date,
                      codigo: extra.codigo || "",
                      address: extra.address || "",
                      responsavel_clinico_id: extra.responsavel_clinico_id || "",
                      responsavel_orto_id: extra.responsavel_orto_id || "",
                      anamnesis: getLocalData('anamnesis', newRecord.id) || {...defaultAnamnesis},
                      records: getLocalData('records', newRecord.id) || [],
                      documents: getLocalData('documents', newRecord.id) || [],
                      responsavelHistory: getLocalData('responsavelHistory', newRecord.id) || [],
                      arrivalControl: getLocalData('arrivalControl', newRecord.id) || null,
                      financeiro: getLocalData('financeiro', newRecord.id) || { orcamento_total: 0, pagamentos: [] },
                      createdAt: newRecord.created_at
                    };
                    return [...prev, enriched];
                  });
                  showNotification(`Novo paciente: ${newRecord.name}`, 'success');
                  break;
                  
                case 'UPDATE':
                  setPatients(prev => prev.map(p => 
                    p.id === newRecord.id ? { ...p, ...newRecord } : p
                  ));
                  // Atualizar selectedPatient se estiver aberto
                  if (selectedPatient?.id === newRecord.id) {
                    setSelectedPatient(prev => ({ ...prev, ...newRecord }));
                  }
                  showNotification(`Paciente atualizado: ${newRecord.name}`, 'info');
                  break;
                  
                case 'DELETE':
                  setPatients(prev => prev.filter(p => p.id !== oldRecord.id));
                  // Fechar prontuÃ¡rio se estiver aberto
                  if (selectedPatient?.id === oldRecord.id) {
                    setSelectedPatient(null);
                    setView('list');
                  }
                  showNotification(`Paciente removido: ${oldRecord.name}`, 'warning');
                  break;
              }
            }
          )
          .subscribe();
        
        channels.push(patientsChannel);

        // Note: realtime listeners for appointments, patient_budgets, and payments
        // are disabled because those tables do not exist in the current DB schema.
        // Data for those features is stored in localStorage.

        setRealtimeChannels(channels);
      };
      
      // Upload de assinatura para Storage
      const uploadSignatureToStorage = async (appointmentId, patientId, signatureBase64) => {
        try {
          if (!signatureBase64 || !signatureBase64.startsWith('data:image')) {
            return null;
          }
          
          const blob = base64ToBlob(signatureBase64, 'image/png');
          const fileName = `${appointmentId}.png`;
          const filePath = `${currentUser.clinic_id}/${patientId}/${fileName}`;
          
          const { data, error } = await supabase.storage
            .from('appointment-signatures')
            .upload(filePath, blob, {
              contentType: 'image/png',
              upsert: true
            });
          
          if (error) throw error;
          
          // Obter URL pÃºblica
          const { data: { publicUrl } } = supabase.storage
            .from('appointment-signatures')
            .getPublicUrl(filePath);
          
          return publicUrl;
        } catch (err) {
          console.error('Erro ao fazer upload de assinatura:', err);
          return null;
        }
      };
      
      // Upload de foto para Storage
      const uploadPhotoToStorage = async (appointmentId, patientId, file, photoId) => {
        try {
          const ext = file.name.split('.').pop();
          const fileName = `${photoId}.${ext}`;
          const filePath = `${currentUser.clinic_id}/${patientId}/${appointmentId}/${fileName}`;
          
          const { data, error } = await supabase.storage
            .from('appointment-photos')
            .upload(filePath, file, {
              contentType: file.type,
              upsert: true
            });
          
          if (error) throw error;
          
          // Obter URL pÃºblica
          const { data: { publicUrl } } = supabase.storage
            .from('appointment-photos')
            .getPublicUrl(filePath);
          
          return {
            id: photoId,
            name: file.name,
            type: file.type,
            size: file.size,
            url: publicUrl,
            storage_path: filePath
          };
        } catch (err) {
          console.error('Erro ao fazer upload de foto:', err);
          return null;
        }
      };
      
      // Upload de documento para Storage
      const uploadDocumentToStorage = async (patientId, file) => {
        try {
          const docId = `doc-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
          const ext = file.name.split('.').pop();
          const fileName = `${docId}.${ext}`;
          const filePath = `${currentUser.clinic_id}/${patientId}/${fileName}`;
          
          const { data, error } = await supabase.storage
            .from('patient-documents')
            .upload(filePath, file, {
              contentType: file.type,
              upsert: false
            });
          
          if (error) throw error;
          
          // Obter URL pÃºblica
          const { data: { publicUrl } } = supabase.storage
            .from('patient-documents')
            .getPublicUrl(filePath);
          
          // Retornar metadata do documento (tabela patient_documents nÃ£o existe no DB)
          return {
            id: docId,
            name: file.name,
            type: file.type,
            size: file.size,
            url: publicUrl,
            storage_path: filePath,
            uploadedBy: currentUser.id,
            uploadedByName: currentUser.name,
            uploadedAt: new Date().toISOString()
          };
        } catch (err) {
          console.error('Erro ao fazer upload de documento:', err);
          throw err;
        }
      };
      
      // Deletar arquivo do Storage
      const deleteFromStorage = async (bucket, path) => {
        try {
          const { error } = await supabase.storage
            .from(bucket)
            .remove([path]);
          
          if (error) throw error;
          return true;
        } catch (err) {
          console.error('Erro ao deletar arquivo do Storage:', err);
          return false;
        }
      };

      // â”€â”€ Appointments CRUD (localStorage â€” tabela appointments nÃ£o existe no DB) â”€â”€
      const createAppointmentSupabase = async (patientId, appointmentData) => {
        const record = {
          id: generateId(),
          patient_id: patientId,
          date: appointmentData.date,
          tipo_atendimento: appointmentData.tipo_atendimento,
          specialty: appointmentData.specialty,
          procedures: appointmentData.procedures,
          teeth: appointmentData.teeth || [],
          notes: appointmentData.notes || null,
          nextAppointment: appointmentData.nextAppointment || null,
          wireInfo: appointmentData.wireInfo || null,
          dentista_atendente_id: appointmentData.dentista_atendente_id,
          dentista_responsavel_no_momento_id: appointmentData.dentista_responsavel_no_momento_id || null,
          atendimento_fora_da_responsabilidade: appointmentData.atendimento_fora_da_responsabilidade || false,
          motivo_fora: appointmentData.motivo_fora || null,
          signature: appointmentData.signature || "",
          photos: appointmentData.photos || [],
          createdAt: new Date().toISOString()
        };

        const records = getLocalData('records', patientId) || [];
        records.unshift(record);
        saveLocalData('records', patientId, records);
        return record;
      };

      const loadAppointmentsSupabase = async (patientId) => {
        return getLocalData('records', patientId) || [];
      };

      const deleteAppointmentSupabase = async (id) => {
        // Find patient that has this appointment
        for (const p of patients) {
          const records = getLocalData('records', p.id) || [];
          const idx = records.findIndex(r => r.id === id);
          if (idx >= 0) {
            records.splice(idx, 1);
            saveLocalData('records', p.id, records);
            return;
          }
        }
      };

      // â”€â”€ MigraÃ§Ã£o de Records Antigos (nÃ£o mais necessÃ¡ria, jÃ¡ Ã© localStorage) â”€â”€
      const migrateRecordsToSupabase = async (patientId) => {
        return { migrated: 0, errors: 0, total: 0 };
      };

      // â”€â”€ Patient CRUD â”€â”€
      const createPatient = async () => {
        if (!npForm.name.trim()) return;
        
        try {
          const { data, error } = await supabase
            .from('patients')
            .insert({
              clinic_id: currentUser.clinic_id,
              name: npForm.name,
              birth_date: npForm.birthDate || null,
              phone: npForm.phone || '',
              email: npForm.email || '',
              cpf: npForm.cpf || '',
              notes: ''
            })
            .select()
            .single();

          if (error) throw error;

          // Converter para formato local (hÃ­brido)
          const newPatient = {
            ...data,
            codigo: npForm.codigo || "",
            address: npForm.address || "",
            responsavel_clinico_id: npForm.responsavel_clinico_id || "",
            responsavel_orto_id: npForm.responsavel_orto_id || "",
            birthDate: data.birth_date,
            anamnesis: {...defaultAnamnesis},
            records: [],
            documents: [],
            responsavelHistory: [],
            arrivalControl: null,
            financeiro: { orcamento_total: 0, pagamentos: [] },
            createdAt: data.created_at
          };

          // Salvar dados locais temporÃ¡rios (campos extras que nÃ£o estÃ£o no DB)
          saveLocalData('anamnesis', newPatient.id, newPatient.anamnesis);
          saveLocalData('records', newPatient.id, newPatient.records);
          saveLocalData('documents', newPatient.id, newPatient.documents);
          saveLocalData('responsavelHistory', newPatient.id, newPatient.responsavelHistory);
          saveLocalData('financeiro', newPatient.id, newPatient.financeiro);
          saveLocalData('extraFields', newPatient.id, { codigo: npForm.codigo || "", address: npForm.address || "", responsavel_clinico_id: npForm.responsavel_clinico_id || "", responsavel_orto_id: npForm.responsavel_orto_id || "" });

          setPatients(prev => [newPatient, ...prev]);
          setNpForm({ codigo:"", name:"", birthDate:"", phone:"", email:"", cpf:"", address:"", responsavel_clinico_id:"", responsavel_orto_id:"" });
          setShowNewPatient(false);
          setSelectedPatient(newPatient);
          setView("patient");
          addAudit("CRIAR_PACIENTE","paciente",newPatient.id,newPatient.name, `Resp. ClÃ­nico: ${getUserName(npForm.responsavel_clinico_id)}, Resp. Orto: ${getUserName(npForm.responsavel_orto_id)}`);
        } catch (err) {
          console.error('Erro ao criar paciente:', err);
          alert('Erro ao criar paciente. Verifique os dados e tente novamente.');
        }
      };

      const deletePatient = async (id) => {
        const p = patients.find(x => x.id === id);
        if (!p) return;
        
        if (!confirm(`Deseja realmente excluir o paciente ${p.name}? Esta aÃ§Ã£o nÃ£o pode ser desfeita.`)) return;
        
        try {
          const { error } = await supabase
            .from('patients')
            .delete()
            .eq('id', id);
          
          if (error) throw error;
          
          // Remover dados locais
          removeLocalData(id);
          
          setPatients(prev => prev.filter(x => x.id !== id));
          setSelectedPatient(null);
          setView("list");
          addAudit("EXCLUIR_PACIENTE","paciente",id,p.name,"");
        } catch (err) {
          console.error('Erro ao excluir paciente:', err);
          alert('Erro ao excluir paciente. Tente novamente.');
        }
      };

      const openPatient = async (p) => {
        try {
          const fresh = patients.find(x => x.id === p.id) || p;
          
          // Verificar se hÃ¡ records antigos para migrar
          const oldRecords = getLocalData('records', fresh.id) || [];
          if (oldRecords.length > 0) {
            const shouldMigrate = confirm(
              `Encontramos ${oldRecords.length} atendimento(s) antigo(s) deste paciente.\n\n` +
              `Deseja migrÃ¡-los para o novo sistema Supabase?\n\n` +
              `(Recomendado: clique em OK para migrar)`
            );
            
            if (shouldMigrate) {
              const result = await migrateRecordsToSupabase(fresh.id);
              if (result.migrated > 0) {
                alert(
                  `MigraÃ§Ã£o de atendimentos concluÃ­da!\n\n` +
                  `âœ… ${result.migrated} atendimento(s) migrado(s) com sucesso\n` +
                  (result.errors > 0 ? `âš ï¸ ${result.errors} erro(s)` : '')
                );
              }
            }
          }
          
          // Carregar atendimentos do Supabase
          const appointments = await loadAppointmentsSupabase(fresh.id);
          
          // Carregar dados financeiros do Supabase
          const budget = await loadBudgetSupabase(fresh.id);
          const payments = await loadPaymentsSupabase(fresh.id);
          
          // Verificar se hÃ¡ dados financeiros antigos para migrar
          const oldFinanceiro = getLocalData('financeiro', fresh.id);
          if (oldFinanceiro && (oldFinanceiro.orcamento_total > 0 || oldFinanceiro.pagamentos?.length > 0)) {
            const shouldMigrate = confirm(
              `Encontramos dados financeiros antigos deste paciente.\n\n` +
              `OrÃ§amento: R$ ${oldFinanceiro.orcamento_total.toFixed(2)}\n` +
              `Pagamentos: ${oldFinanceiro.pagamentos?.length || 0}\n\n` +
              `Deseja migrÃ¡-los para o novo sistema Supabase?\n\n` +
              `(Recomendado: clique em OK para migrar)`
            );
            
            if (shouldMigrate) {
              let migrated = 0;
              let errors = 0;
              
              // Migrar orÃ§amento
              if (oldFinanceiro.orcamento_total > 0) {
                const budgetResult = await createOrUpdateBudgetSupabase(fresh.id, oldFinanceiro.orcamento_total);
                if (budgetResult) migrated++;
                else errors++;
              }
              
              // Migrar pagamentos
              for (const pagamento of (oldFinanceiro.pagamentos || [])) {
                const paymentResult = await createPaymentSupabase(fresh.id, {
                  data: pagamento.data,
                  valor: pagamento.valor,
                  forma_pagamento: pagamento.forma_pagamento,
                  observacao: pagamento.observacao
                });
                if (paymentResult) migrated++;
                else errors++;
              }
              
              if (migrated > 0) {
                alert(
                  `MigraÃ§Ã£o financeira concluÃ­da!\n\n` +
                  `âœ… ${migrated} item(ns) migrado(s) com sucesso\n` +
                  (errors > 0 ? `âš ï¸ ${errors} erro(s)` : '')
                );
                
                // Recarregar dados apÃ³s migraÃ§Ã£o
                const newBudget = await loadBudgetSupabase(fresh.id);
                const newPayments = await loadPaymentsSupabase(fresh.id);
                budget.total_amount = newBudget?.total_amount || 0;
                payments.splice(0, payments.length, ...newPayments);
                
                // Limpar dados antigos
                localStorage.removeItem(`patient_financeiro_${fresh.id}`);
              }
            }
          }
          
          const patientWithRecords = {
            ...fresh,
            records: appointments,
            financeiro: {
              orcamento_total: budget?.total_amount || 0,
              pagamentos: payments
            }
          };
          
          setSelectedPatient(patientWithRecords);
          setView("patient");
          setPatientTab("orto");
          addAudit("VISUALIZAR_PRONTUARIO","paciente",fresh.id,fresh.name,"");
        } catch (err) {
          console.error('Erro ao carregar atendimentos:', err);
          // Fallback para dados locais
          const fresh = patients.find(x => x.id === p.id) || p;
          const localRecords = getLocalData('records', fresh.id) || [];
          setSelectedPatient({...fresh, records: localRecords});
          setView("patient");
          setPatientTab("orto");
        }
      };

      // â”€â”€ Anamnesis â”€â”€
      const saveAnamnesis = () => {
        // Salvar anamnesis no LocalStorage (temporÃ¡rio - serÃ¡ migrado na Fase 3)
        saveLocalData('anamnesis', selectedPatient.id, anamnesisForm);
        
        setPatients(prev => prev.map(p => p.id===selectedPatient.id ? {...p, anamnesis:{...anamnesisForm}} : p));
        setSelectedPatient(prev => ({...prev, anamnesis:{...anamnesisForm}}));
        setEditingAnamnesis(false);
        addAudit("EDITAR_ANAMNESE","paciente",selectedPatient.id,selectedPatient.name,"");
      };

      // â”€â”€ Change Responsible â”€â”€
      const saveResponsible = async () => {
        const changes = [];
        if (respForm.responsavel_clinico_id !== selectedPatient.responsavel_clinico_id) {
          changes.push({ date:new Date().toISOString(), changedBy:currentUser.id, changedByName:currentUser.name, field:"responsavel_clinico_id", from:selectedPatient.responsavel_clinico_id, fromName:getUserName(selectedPatient.responsavel_clinico_id), to:respForm.responsavel_clinico_id, toName:getUserName(respForm.responsavel_clinico_id) });
        }
        if (respForm.responsavel_orto_id !== selectedPatient.responsavel_orto_id) {
          changes.push({ date:new Date().toISOString(), changedBy:currentUser.id, changedByName:currentUser.name, field:"responsavel_orto_id", from:selectedPatient.responsavel_orto_id, fromName:getUserName(selectedPatient.responsavel_orto_id), to:respForm.responsavel_orto_id, toName:getUserName(respForm.responsavel_orto_id) });
        }
        if (changes.length === 0) { setShowChangeResp(false); return; }
        
        try {
          // ResponsÃ¡veis sÃ£o armazenados localmente (colunas nÃ£o existem no DB)
          const newHistory = [...selectedPatient.responsavelHistory, ...changes];
          const updated = { ...selectedPatient, responsavel_clinico_id:respForm.responsavel_clinico_id, responsavel_orto_id:respForm.responsavel_orto_id, responsavelHistory:newHistory };

          // Salvar no LocalStorage
          saveLocalData('responsavelHistory', selectedPatient.id, newHistory);
          saveLocalData('extraFields', selectedPatient.id, { codigo: selectedPatient.codigo || "", address: selectedPatient.address || "", responsavel_clinico_id: respForm.responsavel_clinico_id || "", responsavel_orto_id: respForm.responsavel_orto_id || "" });
          
          setPatients(prev => prev.map(p => p.id===selectedPatient.id ? updated : p));
          setSelectedPatient(updated);
          setShowChangeResp(false);
          addAudit("ALTERAR_RESPONSAVEL","paciente",selectedPatient.id,selectedPatient.name, changes.map(c => `${c.field==="responsavel_clinico_id"?"ClÃ­nico":"Orto"}: ${c.fromName} â†’ ${c.toName}`).join("; "));
        } catch (err) {
          console.error('Erro ao alterar responsÃ¡vel:', err);
          alert('Erro ao alterar responsÃ¡vel. Tente novamente.');
        }
      };

      // â”€â”€ Arrival Control â”€â”€
      const handleArrival = (patientId) => {
        setArrivalPatientId(patientId);
        setArrivalForm({ dentista_id: "" });
        setShowArrivalControl(true);
      };

      const confirmArrival = () => {
        if (!arrivalForm.dentista_id) { alert("Selecione o dentista que irÃ¡ atender."); return; }
        const patient = patients.find(p => p.id === arrivalPatientId);
        if (!patient) return;
        
        const arrivalData = {
          arrivedAt: new Date().toISOString(),
          dentista_id: arrivalForm.dentista_id,
          dentista_name: getUserName(arrivalForm.dentista_id),
          receptionist_id: currentUser.id,
          receptionist_name: currentUser.name,
          status: "aguardando"
        };
        
        setPatients(prev => prev.map(p => p.id === arrivalPatientId ? {...p, arrivalControl: arrivalData} : p));
        setShowArrivalControl(false);
        setArrivalPatientId(null);
        setArrivalForm({ dentista_id: "" });
        addAudit("MARCAR_CHEGADA","paciente",patient.id,patient.name,`Dentista: ${arrivalData.dentista_name}`);
      };

      const startAttendance = (patientId) => {
        const patient = patients.find(p => p.id === patientId);
        if (!patient || !patient.arrivalControl) return;
        
        setPatients(prev => prev.map(p => p.id === patientId ? {...p, arrivalControl: {...p.arrivalControl, status: "em_atendimento", startedAt: new Date().toISOString()}} : p));
        openPatient(patient);
        addAudit("INICIAR_ATENDIMENTO","paciente",patient.id,patient.name,"");
      };

      const finishAttendance = (patientId) => {
        setPatients(prev => prev.map(p => p.id === patientId ? {...p, arrivalControl: null} : p));
        addAudit("FINALIZAR_ATENDIMENTO","paciente",patientId,patients.find(p=>p.id===patientId)?.name||"","");
      };

      // â”€â”€ Financeiro â”€â”€
      const saveOrcamento = async (patientId, valor) => {
        try {
          // Salvar no Supabase
          await createOrUpdateBudgetSupabase(patientId, valor);
          
          // Atualizar estado local
          setPatients(prev => prev.map(p => p.id === patientId ? {...p, financeiro: {...p.financeiro, orcamento_total: parseFloat(valor) || 0}} : p));
          addAudit("ATUALIZAR_ORCAMENTO","paciente",patientId,patients.find(p=>p.id===patientId)?.name||"",`OrÃ§amento: R$ ${parseFloat(valor).toFixed(2)}`);
          setEditingOrcamento(false);
          setTempOrcamento("");
        } catch (err) {
          console.error('Erro ao salvar orÃ§amento:', err);
          alert('Erro ao salvar orÃ§amento. Tente novamente.');
        }
      };

      const addPagamento = async (patientId) => {
        if (!financeiroForm.valor || parseFloat(financeiroForm.valor) <= 0) return;
        
        try {
          // Criar no Supabase
          const data = await createPaymentSupabase(patientId, financeiroForm);
          
          if (!data) {
            alert('Erro ao adicionar pagamento. Tente novamente.');
            return;
          }
          
          // Transformar para formato local
          const novoPagamento = {
            id: data.id,
            data: data.payment_date,
            valor: parseFloat(data.amount),
            forma_pagamento: data.payment_method,
            observacao: data.notes || '',
            registrado_por: currentUser.name,
            registrado_em: data.registered_at
          };
          
          // Atualizar estado local
          setPatients(prev => prev.map(p => p.id === patientId ? {...p, financeiro: {...p.financeiro, pagamentos: [...p.financeiro.pagamentos, novoPagamento]}} : p));
          addAudit("ADICIONAR_PAGAMENTO","paciente",patientId,patients.find(p=>p.id===patientId)?.name||"",`Valor: R$ ${novoPagamento.valor.toFixed(2)} - ${novoPagamento.forma_pagamento === "avista" ? "Ã€ vista" : "Parcelado"}`);
          setFinanceiroForm({ data: formatDateISO(new Date()), valor: "", forma_pagamento: "avista", observacao: "" });
        } catch (err) {
          console.error('Erro ao adicionar pagamento:', err);
          alert('Erro ao adicionar pagamento. Tente novamente.');
        }
      };

      const removePagamento = async (patientId, pagamentoId) => {
        if (!confirm("Deseja realmente remover este pagamento?")) return;
        
        try {
          // Deletar do Supabase
          const success = await deletePaymentSupabase(pagamentoId);
          
          if (!success) {
            alert('Erro ao remover pagamento. Tente novamente.');
            return;
          }
          
          // Atualizar estado local
          setPatients(prev => prev.map(p => p.id === patientId ? {...p, financeiro: {...p.financeiro, pagamentos: p.financeiro.pagamentos.filter(pg => pg.id !== pagamentoId)}} : p));
          addAudit("REMOVER_PAGAMENTO","paciente",patientId,patients.find(p=>p.id===patientId)?.name||"","");
        } catch (err) {
          console.error('Erro ao remover pagamento:', err);
          alert('Erro ao remover pagamento. Tente novamente.');
        }
      };

      // â”€â”€ Records â”€â”€
      const tryAddRecord = () => {
        if (!nrForm.tipo_atendimento || !nrForm.specialty || nrForm.procedures.length === 0) return;
        const respField = nrForm.tipo_atendimento === "ORTODONTIA" ? "responsavel_orto_id" : "responsavel_clinico_id";
        const respId = selectedPatient[respField];
        const isResp = currentUser.id === respId || !respId;
        const rec = {
          id:generateId(), ...nrForm,
          dentista_atendente_id: currentUser.id,
          dentista_responsavel_no_momento_id: respId,
          atendimento_fora_da_responsabilidade: !isResp,
          motivo_fora: "",
          createdAt: new Date().toISOString(),
        };
        if (!isResp) {
          setPendingRecord(rec);
          setRespCheckMotivo("");
          setShowRespCheck(true);
        } else {
          saveRecord(rec);
        }
      };

      const confirmOutOfResp = () => {
        if (!pendingRecord) return;
        const rec = { ...pendingRecord, motivo_fora: respCheckMotivo };
        saveRecord(rec);
        setShowRespCheck(false);
        setPendingRecord(null);
        setRespCheckMotivo("");
      };

      const saveRecord = async (rec) => {
        try {
          // Criar atendimento no Supabase
          const newAppointment = await createAppointmentSupabase(selectedPatient.id, rec);
          
          // Atualizar estado local
          const updated = { 
            ...selectedPatient, 
            records: [newAppointment, ...selectedPatient.records],
            arrivalControl: null // Remove da fila ao finalizar atendimento
          };
          
          setPatients(prev => prev.map(p => p.id === selectedPatient.id ? updated : p));
          setSelectedPatient(updated);
          setNrForm({...emptyNrForm});
          setShowNewRecord(false);
          
          addAudit("CRIAR_ATENDIMENTO","atendimento",newAppointment.id,selectedPatient.name,
            `Tipo: ${rec.tipo_atendimento}, Especialidade: ${SPECIALTIES[rec.specialty]?.label}, Fora da resp: ${rec.atendimento_fora_da_responsabilidade?"SIM":"NÃƒO"}${rec.motivo_fora?", Motivo: "+rec.motivo_fora:""}`);
          addAudit("FINALIZAR_ATENDIMENTO","paciente",selectedPatient.id,selectedPatient.name,"Atendimento finalizado e paciente removido da fila");
        } catch (err) {
          console.error('Erro ao salvar atendimento:', err);
          alert('Erro ao salvar atendimento. Verifique os dados e tente novamente.');
        }
      };

      const deleteRecord = async (recId) => {
        if (!confirm("Deseja realmente excluir este atendimento? Esta aÃ§Ã£o nÃ£o pode ser desfeita.")) return;
        
        try {
          await deleteAppointmentSupabase(recId);
          
          const updated = { 
            ...selectedPatient, 
            records: selectedPatient.records.filter(r => r.id !== recId) 
          };
          
          setPatients(prev => prev.map(p => p.id === selectedPatient.id ? updated : p));
          setSelectedPatient(updated);
          addAudit("EXCLUIR_ATENDIMENTO","atendimento",recId,selectedPatient.name,"");
        } catch (err) {
          console.error('Erro ao excluir atendimento:', err);
          alert('Erro ao excluir atendimento. Tente novamente.');
        }
      };

      // â”€â”€ RelatÃ³rio â”€â”€
      const getRelatorioData = () => {
        const allRecords = [];
        patients.forEach(patient => {
          patient.records.forEach(record => {
            const dentista = users.find(u => u.id === record.dentista_atendente_id);
            const recordDate = record.date || record.createdAt.split('T')[0];
            
            // Filtros
            if (relatorioFilters.data_inicio && recordDate < relatorioFilters.data_inicio) return;
            if (relatorioFilters.data_fim && recordDate > relatorioFilters.data_fim) return;
            if (relatorioFilters.profissional_id && record.dentista_atendente_id !== relatorioFilters.profissional_id) return;
            if (relatorioFilters.busca && !patient.name.toLowerCase().includes(relatorioFilters.busca.toLowerCase())) return;

            // CÃ¡lculos financeiros
            const valorTotal = patient.financeiro?.orcamento_total || 0;
            const totalPago = patient.financeiro?.pagamentos.reduce((sum, p) => sum + p.valor, 0) || 0;
            const valorAberto = valorTotal - totalPago;
            const statusFinanceiro = valorTotal === 0 ? "sem_orcamento" : (valorAberto === 0 ? "pago" : (totalPago > 0 ? "parcial" : "aberto"));

            allRecords.push({
              id: record.id,
              paciente_nome: patient.name,
              data: recordDate,
              profissional: dentista?.name || "N/A",
              tipo_atendimento: record.tipo_atendimento,
              especialidade: SPECIALTIES[record.specialty]?.label || record.specialty,
              procedimentos: record.procedures.join(", "),
              valor_total: valorTotal,
              valor_pago: totalPago,
              valor_aberto: valorAberto,
              status_financeiro: statusFinanceiro
            });
          });
        });

        // OrdenaÃ§Ã£o
        allRecords.sort((a, b) => {
          const aVal = a[relatorioSort.field];
          const bVal = b[relatorioSort.field];
          const direction = relatorioSort.direction === "asc" ? 1 : -1;
          if (typeof aVal === "string") return aVal.localeCompare(bVal) * direction;
          return (aVal - bVal) * direction;
        });

        return allRecords;
      };

      const exportToExcel = () => {
        const data = getRelatorioData();
        if (data.length === 0) {
          alert("Nenhum dado para exportar");
          return;
        }

        // CabeÃ§alho
        let csv = "Paciente,Data,Profissional,Tipo,Especialidade,Procedimentos,Valor Total,Valor Pago,Valor em Aberto,Status\n";
        
        // Dados
        data.forEach(row => {
          csv += `"${row.paciente_nome}",`;
          csv += `"${formatDate(row.data)}",`;
          csv += `"${row.profissional}",`;
          csv += `"${row.tipo_atendimento}",`;
          csv += `"${row.especialidade}",`;
          csv += `"${row.procedimentos}",`;
          csv += `"R$ ${row.valor_total.toFixed(2).replace(".", ",")}",`;
          csv += `"R$ ${row.valor_pago.toFixed(2).replace(".", ",")}",`;
          csv += `"R$ ${row.valor_aberto.toFixed(2).replace(".", ",")}",`;
          csv += `"${row.status_financeiro === "pago" ? "Pago" : row.status_financeiro === "parcial" ? "Parcial" : row.status_financeiro === "aberto" ? "Em Aberto" : "Sem Or\u00e7amento"}"\n`;
        });

        // Totalizadores
        const totalGeral = data.reduce((sum, r) => sum + r.valor_total, 0);
        const totalPago = data.reduce((sum, r) => sum + r.valor_pago, 0);
        const totalAberto = data.reduce((sum, r) => sum + r.valor_aberto, 0);
        
        csv += `\n"TOTAIS","","","","","","R$ ${totalGeral.toFixed(2).replace(".", ",")}","R$ ${totalPago.toFixed(2).replace(".", ",")}","R$ ${totalAberto.toFixed(2).replace(".", ",")}",""\n`;

        // Download
        const blob = new Blob(["\uFEFF" + csv], { type: "text/csv;charset=utf-8;" });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", `relatorio_atendimentos_${formatDateISO(new Date())}.csv`);
        link.style.visibility = "hidden";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      };

      // â”€â”€ File blob cache (loaded from IndexedDB on demand) â”€â”€
      const [fileCache, setFileCache] = useState({});
      const loadFile = useCallback(async (fileId) => {
        if (!fileId) return;
        setFileCache(prev => { if (prev[fileId]) return prev; return prev; });
        try {
          const data = await FileDB.get(fileId);
          if (data) setFileCache(prev => ({...prev, [fileId]: data}));
        } catch(e) { console.warn("FileDB load error", e); }
      }, []);

      // â”€â”€ Photos â”€â”€
      const handlePhotoUpload = (e) => {
        Array.from(e.target.files).forEach(file => {
          if (file.size > MAX_FILE_SIZE) { alert(`Arquivo ${file.name} excede 50MB.`); return; }
          const fid = generateId();
          const reader = new FileReader();
          reader.onload = async (ev) => {
            const dataUrl = ev.target.result;
            try { await FileDB.put(fid, dataUrl); } catch(err) { alert("Erro ao salvar arquivo: " + err.message); return; }
            setFileCache(prev => ({...prev, [fid]: dataUrl}));
            setNrForm(prev => ({...prev, photos:[...prev.photos, {id:fid, name:file.name, type:file.type, size:file.size}]}));
          };
          reader.readAsDataURL(file);
        });
        if (photoInputRef.current) photoInputRef.current.value = "";
      };

      // â”€â”€ Patient Documents â”€â”€
      const handleDocUpload = async (e) => {
        for (const file of Array.from(e.target.files)) {
          if (file.size > MAX_FILE_SIZE) { alert(`Arquivo ${file.name} excede 50MB.`); continue; }
          if (!ALLOWED_FILE_TYPES.some(t => file.type === t || file.type.startsWith("image/"))) { alert(`Tipo nÃ£o permitido: ${file.type}`); continue; }
          
          try {
            // Upload para Supabase Storage
            const doc = await uploadDocumentToStorage(selectedPatient.id, file);
            
            // Atualizar estado local
            const updated = { ...selectedPatient, documents:[doc, ...selectedPatient.documents] };
            setPatients(prev => prev.map(p => p.id===selectedPatient.id ? updated : p));
            setSelectedPatient(updated);
            
            // Salvar metadata no LocalStorage (para compatibilidade)
            saveLocalData('documents', selectedPatient.id, updated.documents);
            
            addAudit("UPLOAD_DOCUMENTO","paciente",selectedPatient.id,selectedPatient.name, `Arquivo: ${file.name} (${formatSize(file.size)})`);
          } catch (err) {
            console.error('Erro ao fazer upload de documento:', err);
            alert(`Erro ao fazer upload de ${file.name}. Tente novamente.`);
          }
        }
        if (docInputRef.current) docInputRef.current.value = "";
      };

      const deleteDoc = async (docId) => {
        try { await FileDB.del(docId); } catch(e) {}
        setFileCache(prev => { const n={...prev}; delete n[docId]; return n; });
        const updated = { ...selectedPatient, documents: selectedPatient.documents.filter(d => d.id !== docId) };
        setPatients(prev => prev.map(p => p.id===selectedPatient.id ? updated : p));
        setSelectedPatient(updated);
      };

      // â”€â”€ Users â”€â”€
      const saveUser = () => {
        if (!userForm.name.trim() || !userForm.login.trim()) return;
        if (editingUserId) {
          setUsers(prev => prev.map(u => u.id===editingUserId ? {...u, name:userForm.name, login:userForm.login, role:userForm.role, active:userForm.active} : u));
          addAudit("EDITAR_USUARIO","usuario",editingUserId,userForm.name,"");
        } else {
          if (!userForm.password) return;
          if (users.some(u => u.login === userForm.login)) { alert("Login jÃ¡ existe."); return; }
          const nu = { id:generateId(), name:userForm.name, login:userForm.login, password:userForm.password, role:userForm.role, active:true, createdAt:new Date().toISOString() };
          setUsers(prev => [...prev, nu]);
          addAudit("CRIAR_USUARIO","usuario",nu.id,nu.name,`Perfil: ${ROLE_LABELS[nu.role]}`);
        }
        setShowUserForm(false); setEditingUserId(null);
        setUserForm({ id:"", name:"", login:"", password:"", role:"dentista", active:true });
      };

      // â”€â”€ Procedure/Tooth toggles â”€â”€
      const toggleProcedure = (proc) => setNrForm(prev => ({...prev, procedures: prev.procedures.includes(proc) ? prev.procedures.filter(p=>p!==proc) : [...prev.procedures, proc]}));
      const toggleTooth = (t) => setNrForm(prev => ({...prev, teeth: prev.teeth.includes(t) ? prev.teeth.filter(x=>x!==t) : [...prev.teeth, t]}));

      const filteredPatients = patients.filter(p => { const s = searchTerm.toLowerCase(); return p.name.toLowerCase().includes(s) || (p.cpf && p.cpf.includes(searchTerm)) || (p.phone && p.phone.includes(searchTerm)) || (p.codigo && p.codigo.toLowerCase().includes(s)); });

      const needsWireInfo = nrForm.tipo_atendimento === "ORTODONTIA" && nrForm.procedures.length > 0;
      const geralSpecOpts = [{ value:"", label:"Selecione..." }, ...Object.entries(SPECIALTIES).filter(([k])=>k!=="ortodontia").map(([k,v])=>({ value:k, label:`${v.icon} ${v.label}` }))];
      const dentistOpts = [{ value:"", label:"Selecione..." }, ...activeDentists.map(u => ({ value:u.id, label:`${u.name} (${ROLE_LABELS[u.role]})` }))];
      const allUserOpts = [{ value:"", label:"Selecione..." }, ...users.filter(u=>u.active && u.id !== "admin1").map(u => ({ value:u.id, label:`${u.name} (${ROLE_LABELS[u.role]})` }))];

      // â”€â”€ Styles â”€â”€
      const btnPrimary = { background:"linear-gradient(135deg,#0EA5E9,#0284C7)", color:"#fff", border:"none", borderRadius:10, padding:"10px 20px", fontSize:14, fontWeight:700, cursor:"pointer", display:"inline-flex", alignItems:"center", gap:6 };
      const btnSecondary = { background:"#F1F5F9", color:"#475569", border:"1.5px solid #E2E8F0", borderRadius:10, padding:"10px 20px", fontSize:14, fontWeight:600, cursor:"pointer" };
      const btnDanger = { ...btnSecondary, color:"#EF4444", borderColor:"#FECACA" };
      const cardStyle = { background:"#fff", borderRadius:14, border:"1px solid #E2E8F0", padding:20, marginBottom:12, transition:"all 0.2s", boxShadow:"0 1px 3px rgba(0,0,0,0.04)" };

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // LOGIN SCREEN
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      if (!currentUser) {
        return (
          <div style={{ minHeight:"100vh", display:"flex", alignItems:"center", justifyContent:"center", background:"linear-gradient(135deg,#0F172A 0%,#1E3A5F 100%)" }}>
            <div style={{ background:"#fff", borderRadius:20, padding:40, width:"min(420px,92%)", boxShadow:"0 25px 60px rgba(0,0,0,0.3)" }}>
              <div style={{ textAlign:"center", marginBottom:30 }}>
                <div style={{ fontSize:36, marginBottom:8 }}>ðŸ¦·</div>
                <h1 style={{ fontSize:24, fontWeight:800, color:"#0F172A", margin:0 }}>O+ Fichas</h1>
                <p style={{ fontSize:13, color:"#64748B", marginTop:4 }}>ProntuÃ¡rio EletrÃ´nico OdontolÃ³gico</p>
              </div>
              {loginError && <div style={{ background:"#FEF2F2", border:"1px solid #FECACA", borderRadius:10, padding:"10px 14px", fontSize:13, color:"#DC2626", marginBottom:14, fontWeight:600 }}>{loginError}</div>}
              <Input label="Email" value={loginForm.login} onChange={e => setLoginForm({...loginForm, login:e.target.value})} placeholder="seu@email.com" onKeyDown={e => e.key==="Enter" && handleLogin()} />
              <Input label="Senha" type="password" value={loginForm.password} onChange={e => setLoginForm({...loginForm, password:e.target.value})} placeholder="Sua senha" onKeyDown={e => e.key==="Enter" && handleLogin()} />
              <button onClick={handleLogin} style={{ ...btnPrimary, width:"100%", justifyContent:"center", padding:"12px 20px", fontSize:15, marginTop:8 }}>Entrar</button>
              <div style={{ textAlign:"center", marginTop:16, fontSize:11, color:"#94A3B8" }}>Use suas credenciais do Supabase</div>
            </div>
          </div>
        );
      }

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // AUTHENTICATED APP
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      return (
        <div>
          {/* â”€â”€ HEADER â”€â”€ */}
          <div style={{ background:"linear-gradient(135deg,#0F172A 0%,#1E3A5F 100%)", color:"#fff", padding:"12px 24px", display:"flex", alignItems:"center", justifyContent:"space-between", position:"sticky", top:0, zIndex:100, flexWrap:"wrap", gap:8 }}>
            <div style={{ display:"flex", alignItems:"center", gap:10 }}>
              {(view === "patient" || view === "users" || view === "audit" || view === "queue") && (
                <button onClick={() => { setView("list"); setSelectedPatient(null); }} style={{ background:"rgba(255,255,255,0.12)", border:"none", borderRadius:8, width:36, height:36, color:"#fff", cursor:"pointer", fontSize:18, display:"flex", alignItems:"center", justifyContent:"center" }}>â†</button>
              )}
              <div>
                <div style={{ fontSize:18, fontWeight:800, letterSpacing:-0.5, cursor:"pointer" }} onClick={() => { setView("list"); setSelectedPatient(null); }}>ðŸ¦· O+ Fichas</div>
                <div style={{ fontSize:10, opacity:0.5, fontWeight:500 }}>ProntuÃ¡rio EletrÃ´nico</div>
              </div>
              {/* Indicador de SincronizaÃ§Ã£o */}
              {syncing && (
                <div style={{ display:"flex", alignItems:"center", gap:6, background:"rgba(255,255,255,0.12)", padding:"6px 12px", borderRadius:8, fontSize:12 }}>
                  <div style={{ width:12, height:12, border:"2px solid #fff", borderTopColor:"transparent", borderRadius:"50%", animation:"spin 0.8s linear infinite" }}></div>
                  Sincronizando...
                </div>
              )}
              {!syncing && realtimeChannels.length > 0 && (
                <div style={{ display:"flex", alignItems:"center", gap:6, background:"rgba(34,197,94,0.15)", padding:"6px 12px", borderRadius:8, fontSize:12, color:"#22C55E" }}>
                  âœ“ Sincronizado
                </div>
              )}
            </div>
            <div style={{ display:"flex", alignItems:"center", gap:8, flexWrap:"wrap" }}>
              {(currentUser.role === "dentista" || currentUser.role === "orto" || currentUser.role === "admin") && (
                <button onClick={() => setView("queue")} style={{ background: view==="queue"?"rgba(255,255,255,0.2)":"rgba(255,255,255,0.08)", border:"none", borderRadius:8, padding:"6px 14px", color:"#fff", cursor:"pointer", fontSize:12, fontWeight:600, display:"flex", alignItems:"center", gap:6 }}>
                  â³ Fila de Atendimento
                  {currentUser.role === "admin" ? (
                    patients.filter(p => p.arrivalControl?.status === "aguardando").length > 0 && (
                      <span style={{ background:"#10B981", borderRadius:"50%", width:18, height:18, display:"flex", alignItems:"center", justifyContent:"center", fontSize:10, fontWeight:700 }}>
                        {patients.filter(p => p.arrivalControl?.status === "aguardando").length}
                      </span>
                    )
                  ) : (
                    patients.filter(p => p.arrivalControl?.dentista_id === currentUser.id && p.arrivalControl?.status === "aguardando").length > 0 && (
                      <span style={{ background:"#10B981", borderRadius:"50%", width:18, height:18, display:"flex", alignItems:"center", justifyContent:"center", fontSize:10, fontWeight:700 }}>
                        {patients.filter(p => p.arrivalControl?.dentista_id === currentUser.id && p.arrivalControl?.status === "aguardando").length}
                      </span>
                    )
                  )}
                </button>
              )}
              {(currentUser.role === "admin" || currentUser.role === "recepcao") && (
                <button onClick={() => setShowRelatorio(true)} style={{ background:"rgba(255,255,255,0.08)", border:"none", borderRadius:8, padding:"6px 14px", color:"#fff", cursor:"pointer", fontSize:12, fontWeight:600 }}>ðŸ“Š RelatÃ³rios</button>
              )}
              {isAdmin && (
                <>
                  <button onClick={() => setView("users")} style={{ background: view==="users"?"rgba(255,255,255,0.2)":"rgba(255,255,255,0.08)", border:"none", borderRadius:8, padding:"6px 14px", color:"#fff", cursor:"pointer", fontSize:12, fontWeight:600 }}>UsuÃ¡rios</button>
                  <button onClick={() => setView("audit")} style={{ background: view==="audit"?"rgba(255,255,255,0.2)":"rgba(255,255,255,0.08)", border:"none", borderRadius:8, padding:"6px 14px", color:"#fff", cursor:"pointer", fontSize:12, fontWeight:600 }}>Auditoria</button>
                </>
              )}
              <div style={{ display:"flex", alignItems:"center", gap:8, marginLeft:8 }}>
                <div style={{ textAlign:"right" }}>
                  <div style={{ fontSize:12, fontWeight:700 }}>{currentUser.name}</div>
                  <div style={{ fontSize:10, opacity:0.6 }}>{ROLE_LABELS[currentUser.role]}</div>
                </div>
                <button onClick={handleLogout} style={{ background:"rgba(255,255,255,0.12)", border:"none", borderRadius:8, padding:"6px 10px", color:"#fff", cursor:"pointer", fontSize:11, fontWeight:600 }}>Sair</button>
              </div>
            </div>
          </div>

          {/* â•â•â• PATIENT LIST â•â•â• */}
          {view === "list" && (
            <div style={{ padding:"20px 24px", maxWidth:800, margin:"0 auto" }}>
              <div style={{ display:"flex", gap:10, marginBottom:16, flexWrap:"wrap" }}>
                <input placeholder="Buscar por cÃ³digo, nome, CPF ou telefone..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)}
                  style={{ flex:1, minWidth:200, padding:"12px 16px", borderRadius:12, border:"1.5px solid #CBD5E1", fontSize:14, outline:"none", background:"#fff", boxSizing:"border-box" }} />
                <button onClick={() => setShowNewPatient(true)} style={btnPrimary}>+ Novo Paciente</button>
              </div>
              {loadingPatients ? (
                <div style={{ textAlign:"center", padding:60, color:"#94A3B8" }}>
                  <div style={{ fontSize:48, marginBottom:12 }}>â³</div>
                  <div style={{ fontSize:16, fontWeight:600 }}>Carregando pacientes...</div>
                </div>
              ) : filteredPatients.length === 0 && (
                <div style={{ textAlign:"center", padding:60, color:"#94A3B8" }}>
                  <div style={{ fontSize:48, marginBottom:12 }}>ðŸ¦·</div>
                  <div style={{ fontSize:16, fontWeight:600 }}>Nenhum paciente cadastrado</div>
                  <div style={{ fontSize:13, marginTop:4 }}>Clique em "+ Novo Paciente" para comeÃ§ar</div>
                </div>
              )}
              {filteredPatients.map(p => (
                <div key={p.id} style={{...cardStyle, position:"relative"}}>
                  <div onClick={() => openPatient(p)} style={{ cursor:"pointer" }}
                    onMouseEnter={e => e.currentTarget.parentElement.style.borderColor="#0EA5E9"} 
                    onMouseLeave={e => e.currentTarget.parentElement.style.borderColor="#E2E8F0"}>
                    <div style={{ display:"flex", justifyContent:"space-between", alignItems:"start" }}>
                      <div>
                        <div style={{ display:"flex", alignItems:"center", gap:8 }}>
                          {p.codigo && <span style={{ fontSize:11, fontWeight:700, color:"#0EA5E9", background:"#EFF6FF", border:"1px solid #BFDBFE", borderRadius:6, padding:"2px 8px" }}>{p.codigo}</span>}
                          <span style={{ fontSize:16, fontWeight:700 }}>{p.name}</span>
                          {p.arrivalControl && (
                            <span style={{ fontSize:10, fontWeight:700, color:"#10B981", background:"#D1FAE5", border:"1px solid #6EE7B7", borderRadius:6, padding:"2px 8px" }}>
                              {p.arrivalControl.status === "aguardando" ? "â³ Aguardando" : "ðŸ‘¨â€âš•ï¸ Em atendimento"}
                            </span>
                          )}
                        </div>
                        <div style={{ fontSize:12, color:"#64748B", marginTop:4 }}>
                          {p.phone && `${p.phone}`}{p.cpf && ` Â· CPF: ${p.cpf}`}
                        </div>
                        <div style={{ fontSize:11, color:"#94A3B8", marginTop:4 }}>
                          ClÃ­nico: <strong>{getUserName(p.responsavel_clinico_id)}</strong> Â· Orto: <strong>{getUserName(p.responsavel_orto_id)}</strong>
                        </div>
                        {p.arrivalControl && (
                          <div style={{ fontSize:11, color:"#10B981", marginTop:4, fontWeight:600 }}>
                            Dentista: {p.arrivalControl.dentista_name} Â· Chegada: {new Date(p.arrivalControl.arrivedAt).toLocaleTimeString("pt-BR", {hour:"2-digit", minute:"2-digit"})}
                          </div>
                        )}
                      </div>
                      <div style={{ textAlign:"right" }}>
                        <div style={{ fontSize:11, color:"#94A3B8" }}>{formatDate(p.createdAt)}</div>
                        <div style={{ fontSize:12, fontWeight:700, color:"#0EA5E9", marginTop:4, background:"#0EA5E910", padding:"2px 8px", borderRadius:6 }}>{(p.records || []).length} atend.</div>
                        {(currentUser.role === "admin" || currentUser.role === "recepcao") && p.financeiro && p.financeiro.orcamento_total > 0 && (
                          <div style={{ fontSize:11, fontWeight:700, color: p.financeiro.orcamento_total - p.financeiro.pagamentos.reduce((sum, pg) => sum + pg.valor, 0) > 0 ? "#EF4444" : "#10B981", marginTop:4, background: p.financeiro.orcamento_total - p.financeiro.pagamentos.reduce((sum, pg) => sum + pg.valor, 0) > 0 ? "#FEE2E2" : "#D1FAE5", padding:"2px 8px", borderRadius:6 }}>
                            {p.financeiro.orcamento_total - p.financeiro.pagamentos.reduce((sum, pg) => sum + pg.valor, 0) > 0 ? "âš ï¸ Devendo" : "âœ“ Quitado"}
                          </div>
                        )}
                      </div>
                    </div>
                  </div>
                  {(currentUser.role === "recepcao" || currentUser.role === "admin") && !p.arrivalControl && (
                    <button onClick={(e) => { e.stopPropagation(); handleArrival(p.id); }} 
                      style={{ ...btnPrimary, marginTop:12, fontSize:13, padding:"8px 16px", width:"100%" }}>
                      ðŸ‘‹ Marcar Chegada
                    </button>
                  )}
                </div>
              ))}
            </div>
          )}

          {/* â•â•â• PATIENT DETAIL â•â•â• */}
          {view === "patient" && selectedPatient && (
            <div style={{ padding:"20px 24px", maxWidth:800, margin:"0 auto" }}>
              {/* Info card */}
              <div style={{ ...cardStyle, background:"linear-gradient(135deg,#F0F9FF,#F8FAFC)" }}>
                <div style={{ display:"flex", justifyContent:"space-between", alignItems:"start", flexWrap:"wrap", gap:12 }}>
                  <div style={{ flex:1 }}>
                    <div style={{ display:"flex", alignItems:"center", gap:10 }}>
                      {selectedPatient.codigo && <span style={{ fontSize:13, fontWeight:700, color:"#0EA5E9", background:"#EFF6FF", border:"1px solid #BFDBFE", borderRadius:8, padding:"4px 12px" }}>{selectedPatient.codigo}</span>}
                      <span style={{ fontSize:22, fontWeight:800 }}>{selectedPatient.name}</span>
                    </div>
                    <div style={{ fontSize:13, color:"#64748B", marginTop:4, lineHeight:1.8 }}>
                      {selectedPatient.birthDate && <span>Nasc: {formatDate(selectedPatient.birthDate+"T12:00:00")} </span>}
                      {selectedPatient.phone && <span>Tel: {selectedPatient.phone} </span>}
                      {selectedPatient.cpf && <span>CPF: {selectedPatient.cpf} </span>}
                      {selectedPatient.email && <span>Email: {selectedPatient.email} </span>}
                      {selectedPatient.address && <div>EndereÃ§o: {selectedPatient.address}</div>}
                    </div>
                    <div style={{ display:"flex", gap:12, marginTop:10, flexWrap:"wrap" }}>
                      <div style={{ background:"#EFF6FF", border:"1px solid #BFDBFE", borderRadius:10, padding:"8px 14px" }}>
                        <div style={{ fontSize:10, fontWeight:700, color:"#3B82F6", textTransform:"uppercase" }}>Resp. ClÃ­nico</div>
                        <div style={{ fontSize:14, fontWeight:700, color:"#1E40AF" }}>{getUserName(selectedPatient.responsavel_clinico_id)}</div>
                      </div>
                      <div style={{ background:"#F0FDFA", border:"1px solid #99F6E4", borderRadius:10, padding:"8px 14px" }}>
                        <div style={{ fontSize:10, fontWeight:700, color:"#14B8A6", textTransform:"uppercase" }}>Resp. Ortodontia</div>
                        <div style={{ fontSize:14, fontWeight:700, color:"#0F766E" }}>{getUserName(selectedPatient.responsavel_orto_id)}</div>
                      </div>
                    </div>
                  </div>
                  <div style={{ display:"flex", flexDirection:"column", gap:6 }}>
                    {isAdmin && <button onClick={() => { setRespForm({ responsavel_clinico_id:selectedPatient.responsavel_clinico_id, responsavel_orto_id:selectedPatient.responsavel_orto_id }); setShowChangeResp(true); }} style={{ ...btnSecondary, fontSize:11, padding:"6px 12px" }}>Alterar ResponsÃ¡veis</button>}
                    {isAdmin && <button onClick={() => { if (confirm("Excluir este paciente e todos os registros?")) deletePatient(selectedPatient.id); }} style={{ ...btnDanger, fontSize:11, padding:"6px 12px" }}>Excluir Paciente</button>}
                  </div>
                </div>
              </div>

              {/* Action buttons */}
              <div style={{ display:"flex", gap:10, marginBottom:16, flexWrap:"wrap" }}>
                <button onClick={() => { setAnamnesisForm({...defaultAnamnesis, ...selectedPatient.anamnesis}); setShowAnamnesis(true); setEditingAnamnesis(false); }} style={btnSecondary}>Anamnese</button>
                <button onClick={() => { docInputRef.current?.click(); }} style={btnSecondary}>Anexar Documento</button>
                {(currentUser.role === "admin" || currentUser.role === "recepcao") && (
                  <button onClick={() => setShowFinanceiro(true)} style={{...btnSecondary, background:"linear-gradient(135deg,#10B981,#059669)", color:"#fff"}}>ðŸ’° Financeiro</button>
                )}
                <button onClick={() => setShowNewRecord(true)} style={btnPrimary}>+ Novo Atendimento</button>
                <input ref={docInputRef} type="file" accept="image/*,.pdf,.docx" multiple onChange={handleDocUpload} style={{ display:"none" }} />
              </div>

              {/* Patient Documents */}
              {selectedPatient.documents?.length > 0 && (
                <div style={{ ...cardStyle, marginBottom:16 }}>
                  <div style={{ display:"flex", justifyContent:"space-between", alignItems:"center", marginBottom:10, flexWrap:"wrap", gap:8 }}>
                    <div style={{ fontSize:14, fontWeight:700, color:"#334155" }}>Documentos do Paciente ({selectedPatient.documents.length})</div>
                    <div style={{ display:"flex", alignItems:"center", gap:6 }}>
                      <label style={{ fontSize:11, color:"#64748B", fontWeight:600 }}>Data:</label>
                      <input type="date" value={docDateFilter} onChange={e => setDocDateFilter(e.target.value)}
                        style={{ padding:"4px 8px", borderRadius:8, border:"1px solid #CBD5E1", fontSize:12, outline:"none", background:"#F8FAFC" }} />
                      {docDateFilter && <button onClick={() => setDocDateFilter("")} style={{ background:"none", border:"none", color:"#94A3B8", cursor:"pointer", fontSize:14, padding:0 }}>Ã—</button>}
                    </div>
                  </div>
                  <div style={{ display:"flex", flexWrap:"wrap", gap:10 }}>
                    {selectedPatient.documents
                      .filter(doc => !docDateFilter || (doc.uploadedAt && doc.uploadedAt.startsWith(docDateFilter)))
                      .map(doc => (
                      <div key={doc.id} style={{ border:"1px solid #E2E8F0", borderRadius:10, padding:10, width:140, position:"relative" }}>
                        <div style={{ width:"100%", height:80, borderRadius:6, overflow:"hidden" }}>
                          <FileThumb fileId={doc.id} cache={fileCache} loadFn={loadFile} type={doc.type} name={doc.name}
                            onClick={async () => { const d = fileCache[doc.id] || await FileDB.get(doc.id); if (d) { if (doc.type?.startsWith("image/")) setViewingPhoto(d); else { const a=document.createElement("a"); a.href=d; a.download=doc.name; a.click(); } } }}
                            style={{ borderRadius:6 }} />
                        </div>
                        <div style={{ fontSize:10, color:"#64748B", marginTop:6, overflow:"hidden", textOverflow:"ellipsis", whiteSpace:"nowrap" }} title={doc.name}>{doc.name}</div>
                        <div style={{ fontSize:9, color:"#94A3B8" }}>{formatSize(doc.size)} Â· {doc.uploadedByName}</div>
                        {doc.uploadedAt && <div style={{ fontSize:9, color:"#94A3B8" }}>{formatDate(doc.uploadedAt)}</div>}
                        {isAdmin && <button onClick={() => deleteDoc(doc.id)} style={{ position:"absolute", top:4, right:4, background:"rgba(239,68,68,0.9)", border:"none", borderRadius:"50%", width:18, height:18, color:"#fff", fontSize:11, cursor:"pointer", display:"flex", alignItems:"center", justifyContent:"center", padding:0 }}>Ã—</button>}
                      </div>
                    ))}
                    {selectedPatient.documents.length > 0 && docDateFilter && selectedPatient.documents.filter(doc => doc.uploadedAt && doc.uploadedAt.startsWith(docDateFilter)).length === 0 && (
                      <div style={{ fontSize:12, color:"#94A3B8", padding:16 }}>Nenhum documento nesta data.</div>
                    )}
                  </div>
                </div>
              )}

              {/* Tabs */}
              <div style={{ borderBottom:"2px solid #E2E8F0", marginBottom:16, display:"flex" }}>
                <button className={`tab-btn ${patientTab==="orto"?"active":""}`} onClick={() => setPatientTab("orto")} style={patientTab==="orto"?{color:"#0EA5E9", borderBottomColor:"#0EA5E9"}:{}}>
                  ðŸ¦· Ortodontia ({selectedPatient.records.filter(r=>r.tipo_atendimento==="ORTODONTIA").length})
                </button>
                <button className={`tab-btn ${patientTab==="geral"?"active":""}`} onClick={() => setPatientTab("geral")} style={patientTab==="geral"?{color:"#10B981", borderBottomColor:"#10B981"}:{}}>
                  ClÃ­nico/Outros ({selectedPatient.records.filter(r=>r.tipo_atendimento!=="ORTODONTIA").length})
                </button>
              </div>

              {/* Records */}
              {(() => {
                const recs = selectedPatient.records.filter(r => patientTab==="orto" ? r.tipo_atendimento==="ORTODONTIA" : r.tipo_atendimento!=="ORTODONTIA");
                if (recs.length === 0) return (
                  <div style={{ textAlign:"center", padding:40, color:"#94A3B8", background:"#fff", borderRadius:14, border:"1px solid #E2E8F0" }}>
                    <div style={{ fontSize:13 }}>Nenhum atendimento de {patientTab==="orto"?"ortodontia":"clÃ­nico geral"} registrado</div>
                  </div>
                );
                return recs.map(rec => {
                  const spec = SPECIALTIES[rec.specialty];
                  return (
                    <div key={rec.id} style={cardStyle}>
                      <div style={{ display:"flex", justifyContent:"space-between", alignItems:"start", marginBottom:10 }}>
                        <div style={{ display:"flex", alignItems:"center", gap:8, flexWrap:"wrap" }}>
                          <span style={{ background:spec?.color+"18", color:spec?.color, padding:"4px 10px", borderRadius:8, fontSize:12, fontWeight:700 }}>{spec?.icon} {spec?.label}</span>
                          <span style={{ fontSize:13, color:"#64748B", fontWeight:600 }}>{formatDate(rec.date+"T12:00:00")}</span>
                          {rec.atendimento_fora_da_responsabilidade && <span style={{ background:"#FEF3C7", color:"#D97706", padding:"3px 8px", borderRadius:6, fontSize:10, fontWeight:700 }}>FORA DA RESP.</span>}
                        </div>
                        <button onClick={() => { if (confirm("Excluir este atendimento?")) deleteRecord(rec.id); }}
                          style={{ background:"none", border:"none", color:"#CBD5E1", cursor:"pointer", fontSize:14 }}>ðŸ—‘ï¸</button>
                      </div>
                      <div style={{ fontSize:11, color:"#94A3B8", marginBottom:6 }}>
                        Atendente: <strong style={{ color:"#475569" }}>{getUserName(rec.dentista_atendente_id)}</strong>
                        {rec.atendimento_fora_da_responsabilidade && <span> Â· Resp. vigente: <strong style={{ color:"#475569" }}>{getUserName(rec.dentista_responsavel_no_momento_id)}</strong></span>}
                        {rec.motivo_fora && <span> Â· Motivo: {rec.motivo_fora}</span>}
                      </div>
                      <div style={{ marginBottom:6 }}>
                        {rec.procedures.map(pr => <Badge key={pr} text={pr} color={spec?.color || "#64748B"} />)}
                      </div>
                      {rec.teeth?.length > 0 && <div style={{ fontSize:12, color:"#64748B", marginBottom:4 }}><strong>Dentes:</strong> {rec.teeth.sort((a,b)=>a-b).join(", ")}</div>}
                      {rec.wireInfo && (rec.wireInfo.upper || rec.wireInfo.lower) && (
                        <div style={{ marginTop:6 }}>
                          {rec.wireInfo.upper && (rec.wireInfo.upper.material || rec.wireInfo.upper.format || rec.wireInfo.upper.gauge) && (
                            <div style={{ display:"flex", gap:6, flexWrap:"wrap", alignItems:"center", marginBottom:4 }}>
                              <span style={{ fontSize:12, color:"#0369A1", fontWeight:600 }}>Fio Superior:</span>
                              {rec.wireInfo.upper.material && <Badge text={rec.wireInfo.upper.material} color="#0EA5E9" />}
                              {rec.wireInfo.upper.format && <Badge text={rec.wireInfo.upper.format} color="#0EA5E9" />}
                              {rec.wireInfo.upper.gauge && <Badge text={rec.wireInfo.upper.gauge} color="#0EA5E9" />}
                            </div>
                          )}
                          {rec.wireInfo.lower && (rec.wireInfo.lower.material || rec.wireInfo.lower.format || rec.wireInfo.lower.gauge) && (
                            <div style={{ display:"flex", gap:6, flexWrap:"wrap", alignItems:"center" }}>
                              <span style={{ fontSize:12, color:"#0369A1", fontWeight:600 }}>Fio Inferior:</span>
                              {rec.wireInfo.lower.material && <Badge text={rec.wireInfo.lower.material} color="#0EA5E9" />}
                              {rec.wireInfo.lower.format && <Badge text={rec.wireInfo.lower.format} color="#0EA5E9" />}
                              {rec.wireInfo.lower.gauge && <Badge text={rec.wireInfo.lower.gauge} color="#0EA5E9" />}
                            </div>
                          )}
                        </div>
                      )}

                      {rec.notes && <div style={{ fontSize:13, color:"#475569", marginTop:8, padding:"10px 12px", background:"#F8FAFC", borderRadius:8, borderLeft:`3px solid ${spec?.color||"#CBD5E1"}` }}>{rec.notes}</div>}
                      {rec.photos?.length > 0 && (
                        <div style={{ marginTop:10 }}>
                          <div style={{ fontSize:12, color:"#64748B", fontWeight:600, marginBottom:6 }}>Fotos ({rec.photos.length})</div>
                          <div style={{ display:"flex", flexWrap:"wrap", gap:6 }}>
                            {rec.photos.map(ph => (
                              <div key={ph.id} style={{ width:56, height:56, borderRadius:8, overflow:"hidden", border:"1px solid #E2E8F0", cursor:"pointer" }}>
                                {ph.url ? (
                                  <img src={ph.url} alt={ph.name} onClick={() => setViewingPhoto(ph.url)} style={{ width:"100%", height:"100%", objectFit:"cover", borderRadius:8 }} />
                                ) : (
                                  <FileThumb fileId={ph.id} cache={fileCache} loadFn={loadFile} type={ph.type || "image/jpeg"} name={ph.name}
                                    onClick={async () => { const d = fileCache[ph.id] || await FileDB.get(ph.id); if (d) setViewingPhoto(d); }}
                                    style={{ borderRadius:8 }} />
                                )}
                              </div>
                            ))}
                          </div>
                        </div>
                      )}
                      {rec.nextAppointment && <div style={{ fontSize:12, color:"#0EA5E9", marginTop:8, fontWeight:600 }}>PrÃ³xima consulta: {formatDate(rec.nextAppointment+"T12:00:00")}</div>}
                      {(rec.signatureUrl || rec.signature) ? (
                        <div style={{ marginTop:10, paddingTop:10, borderTop:"1px dashed #E2E8F0", display:"flex", alignItems:"center", justifyContent:"space-between" }}>
                          <span style={{ fontSize:12, color:"#10B981", fontWeight:600 }}>Assinado</span>
                          <button onClick={() => setViewingSignature(rec.signatureUrl || rec.signature)} style={{ background:"#F0FDF4", border:"1px solid #BBF7D0", borderRadius:6, padding:"4px 10px", fontSize:11, color:"#16A34A", cursor:"pointer", fontWeight:600 }}>Ver assinatura</button>
                        </div>
                      ) : (
                        <div style={{ marginTop:8, fontSize:11, color:"#F59E0B", fontWeight:600 }}>Sem assinatura</div>
                      )}
                    </div>
                  );
                });
              })()}
            </div>
          )}

          {/* â•â•â• USER MANAGEMENT â•â•â• */}
          {view === "users" && isAdmin && (
            <div style={{ padding:"20px 24px", maxWidth:800, margin:"0 auto" }}>
              <div style={{ display:"flex", justifyContent:"space-between", alignItems:"center", marginBottom:16 }}>
                <h2 style={{ fontSize:20, fontWeight:800, color:"#0F172A" }}>GestÃ£o de UsuÃ¡rios</h2>
                <button onClick={() => { setUserForm({ id:"", name:"", login:"", password:"", role:"dentista", active:true }); setEditingUserId(null); setShowUserForm(true); }} style={btnPrimary}>+ Novo UsuÃ¡rio</button>
              </div>
              {users.map(u => (
                <div key={u.id} style={{ ...cardStyle, display:"flex", justifyContent:"space-between", alignItems:"center" }}>
                  <div>
                    <div style={{ fontSize:15, fontWeight:700 }}>{u.name} {!u.active && <span style={{ fontSize:11, color:"#EF4444", fontWeight:600 }}>(Inativo)</span>}</div>
                    <div style={{ fontSize:12, color:"#64748B" }}>Login: {u.login} Â· Perfil: {ROLE_LABELS[u.role]}</div>
                  </div>
                  {u.id !== "admin1" && (
                    <button onClick={() => { setUserForm({ id:u.id, name:u.name, login:u.login, password:"", role:u.role, active:u.active }); setEditingUserId(u.id); setShowUserForm(true); }} style={{ ...btnSecondary, fontSize:12, padding:"6px 12px" }}>Editar</button>
                  )}
                </div>
              ))}
            </div>
          )}

          {/* â•â•â• AUDIT LOG â•â•â• */}
          {view === "audit" && isAdmin && (
            <div style={{ padding:"20px 24px", maxWidth:900, margin:"0 auto" }}>
              <h2 style={{ fontSize:20, fontWeight:800, color:"#0F172A", marginBottom:16 }}>Log de Auditoria</h2>
              <input placeholder="Filtrar por usuÃ¡rio, aÃ§Ã£o, paciente..." value={auditFilter} onChange={e => setAuditFilter(e.target.value)}
                style={{ width:"100%", padding:"10px 14px", borderRadius:10, border:"1.5px solid #CBD5E1", fontSize:14, outline:"none", background:"#fff", boxSizing:"border-box", marginBottom:16 }} />
              <div style={{ maxHeight:"70vh", overflowY:"auto" }}>
                {auditLogs.filter(l => {
                  if (!auditFilter) return true;
                  const f = auditFilter.toLowerCase();
                  return l.userName?.toLowerCase().includes(f) || l.action?.toLowerCase().includes(f) || l.targetName?.toLowerCase().includes(f) || l.details?.toLowerCase().includes(f);
                }).slice(0, 200).map(l => (
                  <div key={l.id} style={{ padding:"10px 14px", borderBottom:"1px solid #F1F5F9", fontSize:13 }}>
                    <div style={{ display:"flex", justifyContent:"space-between", alignItems:"start" }}>
                      <div>
                        <span style={{ fontWeight:700, color:"#0F172A" }}>{l.userName}</span>
                        <span style={{ color:"#64748B" }}> Â· {l.action}</span>
                        {l.targetName && <span style={{ color:"#64748B" }}> Â· {l.targetName}</span>}
                      </div>
                      <span style={{ fontSize:11, color:"#94A3B8", whiteSpace:"nowrap", marginLeft:10 }}>{formatDateTime(l.timestamp)}</span>
                    </div>
                    {l.details && <div style={{ fontSize:12, color:"#94A3B8", marginTop:2 }}>{l.details}</div>}
                  </div>
                ))}
                {auditLogs.length === 0 && <div style={{ textAlign:"center", padding:40, color:"#94A3B8" }}>Nenhum registro de auditoria</div>}
              </div>
            </div>
          )}

          {/* â•â•â• QUEUE VIEW â•â•â• */}
          {view === "queue" && (currentUser.role === "dentista" || currentUser.role === "orto" || currentUser.role === "admin") && (
            <div style={{ padding:"20px 24px", maxWidth:800, margin:"0 auto" }}>
              <h2 style={{ fontSize:20, fontWeight:800, color:"#0F172A", marginBottom:16 }}>Fila de Atendimento</h2>
              
              {/* Aguardando Atendimento */}
              <div style={{ marginBottom:24 }}>
                <div style={{ fontSize:16, fontWeight:700, color:"#0F172A", marginBottom:12, display:"flex", alignItems:"center", gap:8 }}>
                  â³ Aguardando ({patients.filter(p => currentUser.role === "admin" ? p.arrivalControl?.status === "aguardando" : (p.arrivalControl?.dentista_id === currentUser.id && p.arrivalControl?.status === "aguardando")).length})
                </div>
                {patients
                  .filter(p => currentUser.role === "admin" ? p.arrivalControl?.status === "aguardando" : (p.arrivalControl?.dentista_id === currentUser.id && p.arrivalControl?.status === "aguardando"))
                  .sort((a, b) => new Date(a.arrivalControl.arrivedAt) - new Date(b.arrivalControl.arrivedAt))
                  .map(p => (
                    <div key={p.id} style={{ ...cardStyle, marginBottom:12 }}>
                      <div style={{ display:"flex", justifyContent:"space-between", alignItems:"start" }}>
                        <div style={{ flex:1 }}>
                          <div style={{ display:"flex", alignItems:"center", gap:8, marginBottom:6 }}>
                            {p.codigo && <span style={{ fontSize:11, fontWeight:700, color:"#0EA5E9", background:"#EFF6FF", border:"1px solid #BFDBFE", borderRadius:6, padding:"2px 8px" }}>{p.codigo}</span>}
                            <span style={{ fontSize:16, fontWeight:700 }}>{p.name}</span>
                          </div>
                          <div style={{ fontSize:12, color:"#64748B", marginBottom:4 }}>
                            {p.phone && `${p.phone}`}{p.cpf && ` Â· CPF: ${p.cpf}`}
                          </div>
                          <div style={{ fontSize:12, color:"#10B981", fontWeight:600 }}>
                            {currentUser.role === "admin" && (
                              <>
                                Dentista: {p.arrivalControl.dentista_name}
                                {" Â· "}
                              </>
                            )}
                            Chegada: {new Date(p.arrivalControl.arrivedAt).toLocaleTimeString("pt-BR", {hour:"2-digit", minute:"2-digit"})}
                            {" Â· "}
                            Registrado por: {p.arrivalControl.receptionist_name}
                          </div>
                        </div>
                        <button onClick={() => startAttendance(p.id)} style={{ ...btnPrimary, fontSize:13, padding:"8px 16px", whiteSpace:"nowrap" }}>
                          ðŸ‘¨â€âš•ï¸ Iniciar Atendimento
                        </button>
                      </div>
                    </div>
                  ))}
                {patients.filter(p => currentUser.role === "admin" ? p.arrivalControl?.status === "aguardando" : (p.arrivalControl?.dentista_id === currentUser.id && p.arrivalControl?.status === "aguardando")).length === 0 && (
                  <div style={{ textAlign:"center", padding:40, color:"#94A3B8", background:"#F8FAFC", borderRadius:12, border:"1px solid #E2E8F0" }}>
                    <div style={{ fontSize:48, marginBottom:8 }}>â˜•</div>
                    <div style={{ fontSize:14, fontWeight:600 }}>Nenhum paciente aguardando</div>
                  </div>
                )}
              </div>

              {/* Em Atendimento */}
              <div>
                <div style={{ fontSize:16, fontWeight:700, color:"#0F172A", marginBottom:12, display:"flex", alignItems:"center", gap:8 }}>
                  ðŸ‘¨â€âš•ï¸ Em Atendimento ({patients.filter(p => currentUser.role === "admin" ? p.arrivalControl?.status === "em_atendimento" : (p.arrivalControl?.dentista_id === currentUser.id && p.arrivalControl?.status === "em_atendimento")).length})
                </div>
                {patients
                  .filter(p => currentUser.role === "admin" ? p.arrivalControl?.status === "em_atendimento" : (p.arrivalControl?.dentista_id === currentUser.id && p.arrivalControl?.status === "em_atendimento"))
                  .map(p => (
                    <div key={p.id} style={{ ...cardStyle, marginBottom:12, borderColor:"#10B981" }}>
                      <div style={{ display:"flex", justifyContent:"space-between", alignItems:"start" }}>
                        <div style={{ flex:1 }}>
                          <div style={{ display:"flex", alignItems:"center", gap:8, marginBottom:6 }}>
                            {p.codigo && <span style={{ fontSize:11, fontWeight:700, color:"#0EA5E9", background:"#EFF6FF", border:"1px solid #BFDBFE", borderRadius:6, padding:"2px 8px" }}>{p.codigo}</span>}
                            <span style={{ fontSize:16, fontWeight:700 }}>{p.name}</span>
                            <span style={{ fontSize:10, fontWeight:700, color:"#10B981", background:"#D1FAE5", border:"1px solid #6EE7B7", borderRadius:6, padding:"2px 8px" }}>
                              ðŸ‘¨â€âš•ï¸ Em atendimento
                            </span>
                          </div>
                          <div style={{ fontSize:12, color:"#64748B", marginBottom:4 }}>
                            {p.phone && `${p.phone}`}{p.cpf && ` Â· CPF: ${p.cpf}`}
                          </div>
                          <div style={{ fontSize:12, color:"#10B981", fontWeight:600 }}>
                            {currentUser.role === "admin" && (
                              <>
                                Dentista: {p.arrivalControl.dentista_name}
                                {" Â· "}
                              </>
                            )}
                            InÃ­cio: {new Date(p.arrivalControl.startedAt).toLocaleTimeString("pt-BR", {hour:"2-digit", minute:"2-digit"})}
                          </div>
                        </div>
                        <div style={{ display:"flex", gap:8 }}>
                          <button onClick={() => openPatient(p)} style={{ ...btnSecondary, fontSize:13, padding:"8px 16px" }}>
                            Ver ProntuÃ¡rio
                          </button>
                          <button onClick={() => finishAttendance(p.id)} style={{ ...btnPrimary, fontSize:13, padding:"8px 16px", background:"linear-gradient(135deg,#10B981,#059669)" }}>
                            âœ“ Finalizar
                          </button>
                        </div>
                      </div>
                    </div>
                  ))}
                {patients.filter(p => currentUser.role === "admin" ? p.arrivalControl?.status === "em_atendimento" : (p.arrivalControl?.dentista_id === currentUser.id && p.arrivalControl?.status === "em_atendimento")).length === 0 && (
                  <div style={{ textAlign:"center", padding:40, color:"#94A3B8", background:"#F8FAFC", borderRadius:12, border:"1px solid #E2E8F0" }}>
                    <div style={{ fontSize:14, fontWeight:600 }}>Nenhum atendimento em andamento</div>
                  </div>
                )}
              </div>
            </div>
          )}

          {/* â•â•â• NEW PATIENT MODAL â•â•â• */}
          <Modal isOpen={showNewPatient} onClose={() => setShowNewPatient(false)} title="Novo Paciente" wide>
            <div style={{ display:"grid", gridTemplateColumns:"1fr 2fr", gap:12 }}>
              <Input label="CÃ³digo do Paciente" value={npForm.codigo} onChange={e => setNpForm({...npForm, codigo:e.target.value})} placeholder="Ex: P001" />
              <Input label="Nome Completo *" value={npForm.name} onChange={e => setNpForm({...npForm, name:e.target.value})} placeholder="Nome do paciente" />
            </div>
            <div style={{ display:"grid", gridTemplateColumns:"1fr 1fr", gap:12 }}>
              <Input label="Data de Nascimento" type="date" value={npForm.birthDate} onChange={e => setNpForm({...npForm, birthDate:e.target.value})} />
              <Input label="Telefone" value={npForm.phone} onChange={e => setNpForm({...npForm, phone:e.target.value})} placeholder="(00) 00000-0000" />
            </div>
            <div style={{ display:"grid", gridTemplateColumns:"1fr 1fr", gap:12 }}>
              <Input label="CPF" value={npForm.cpf} onChange={e => setNpForm({...npForm, cpf:e.target.value})} placeholder="000.000.000-00" />
              <Input label="Email" type="email" value={npForm.email} onChange={e => setNpForm({...npForm, email:e.target.value})} placeholder="email@exemplo.com" />
            </div>
            <Input label="EndereÃ§o" value={npForm.address} onChange={e => setNpForm({...npForm, address:e.target.value})} placeholder="EndereÃ§o completo" />
            <div style={{ marginTop:8, paddingTop:16, borderTop:"2px dashed #E2E8F0" }}>
              <div style={{ fontSize:14, fontWeight:700, color:"#334155", marginBottom:4 }}>ResponsÃ¡veis</div>
              <div style={{ fontSize:12, color:"#64748B", marginBottom:12 }}>Selecione pelo menos um responsÃ¡vel (clÃ­nico ou ortodontista).</div>
              <div style={{ display:"grid", gridTemplateColumns:"1fr 1fr", gap:12 }}>
                <Select label="ResponsÃ¡vel ClÃ­nico" value={npForm.responsavel_clinico_id}
                  onChange={e => setNpForm({...npForm, responsavel_clinico_id:e.target.value})} options={allUserOpts} />
                <Select label="ResponsÃ¡vel Ortodontia" value={npForm.responsavel_orto_id}
                  onChange={e => setNpForm({...npForm, responsavel_orto_id:e.target.value})} options={allUserOpts} />
              </div>
            </div>
            <div style={{ display:"flex", gap:10, justifyContent:"flex-end", marginTop:16 }}>
              <button onClick={() => setShowNewPatient(false)} style={btnSecondary}>Cancelar</button>
              <button onClick={createPatient} style={{ ...btnPrimary, opacity:(!npForm.name.trim())?0.5:1 }}>Cadastrar Paciente</button>
            </div>
          </Modal>

          {/* â•â•â• NEW RECORD MODAL â•â•â• */}
          <Modal isOpen={showNewRecord} onClose={() => { setShowNewRecord(false); setNrForm({...emptyNrForm}); }} title="Novo Atendimento" wide>
            {/* Step 1: Tipo */}
            <div style={{ marginBottom:16 }}>
              <label style={{ display:"block", fontSize:13, fontWeight:600, color:"#475569", marginBottom:8 }}>Tipo de Atendimento *</label>
              <div style={{ display:"flex", gap:12 }}>
                <div className={`tipo-card ${nrForm.tipo_atendimento==="ORTODONTIA"?"selected":""}`}
                  onClick={() => setNrForm({...emptyNrForm, date:nrForm.date, tipo_atendimento:"ORTODONTIA", specialty:"ortodontia"})}
                  style={{ color:"#0EA5E9", borderColor:nrForm.tipo_atendimento==="ORTODONTIA"?"#0EA5E9":"#E2E8F0", background:nrForm.tipo_atendimento==="ORTODONTIA"?"#F0F9FF":"#fff" }}>
                  <div style={{ fontSize:28 }}>ðŸ¦·</div>
                  <div style={{ fontWeight:700, marginTop:4 }}>Ortodontia</div>
                </div>
                <div className={`tipo-card ${nrForm.tipo_atendimento==="GERAL"?"selected":""}`}
                  onClick={() => setNrForm({...emptyNrForm, date:nrForm.date, tipo_atendimento:"GERAL", specialty:""})}
                  style={{ color:"#10B981", borderColor:nrForm.tipo_atendimento==="GERAL"?"#10B981":"#E2E8F0", background:nrForm.tipo_atendimento==="GERAL"?"#F0FDF4":"#fff" }}>
                  <div style={{ fontSize:28 }}>ðŸ©º</div>
                  <div style={{ fontWeight:700, marginTop:4 }}>ClÃ­nico / Outros</div>
                </div>
              </div>
            </div>

            {nrForm.tipo_atendimento && (
              <>
                <div style={{ display:"grid", gridTemplateColumns:"1fr 1fr", gap:12 }}>
                  <Input label="Data do Atendimento" type="date" value={nrForm.date} onChange={e => setNrForm({...nrForm, date:e.target.value})} />
                  {nrForm.tipo_atendimento === "GERAL" && (
                    <Select label="Especialidade *" value={nrForm.specialty}
                      onChange={e => setNrForm({...nrForm, specialty:e.target.value, procedures:[]})}
                      options={geralSpecOpts} />
                  )}
                  {nrForm.tipo_atendimento === "ORTODONTIA" && (
                    <div style={{ marginBottom:14 }}>
                      <label style={{ display:"block", fontSize:13, fontWeight:600, color:"#475569", marginBottom:5 }}>Especialidade</label>
                      <div style={{ padding:"10px 14px", borderRadius:10, border:"1.5px solid #BAE6FD", background:"#F0F9FF", fontSize:14, color:"#0369A1", fontWeight:600 }}>ðŸ¦· Ortodontia</div>
                    </div>
                  )}
                </div>

                {/* Procedures */}
                {nrForm.specialty && (
                  <div style={{ marginBottom:14 }}>
                    <label style={{ display:"block", fontSize:13, fontWeight:600, color:"#475569", marginBottom:8 }}>Procedimentos Realizados *</label>
                    <div style={{ display:"flex", flexWrap:"wrap", gap:6, background:"#F8FAFC", borderRadius:12, padding:12, border:"1px solid #E2E8F0", maxHeight:200, overflowY:"auto" }}>
                      {SPECIALTIES[nrForm.specialty]?.procedures.map(proc => {
                        const isSel = nrForm.procedures.includes(proc);
                        const col = SPECIALTIES[nrForm.specialty]?.color;
                        return (<button key={proc} onClick={() => toggleProcedure(proc)} style={{ padding:"6px 12px", borderRadius:8, fontSize:12, fontWeight:600, border:isSel?`2px solid ${col}`:"1.5px solid #CBD5E1", background:isSel?col+"15":"#fff", color:isSel?col:"#475569", cursor:"pointer", transition:"all 0.15s" }}>
                          {isSel?"âœ“ ":""}{proc}
                        </button>);
                      })}
                    </div>
                    {nrForm.procedures.length > 0 && <div style={{ marginTop:8, fontSize:12, color:"#64748B" }}>{nrForm.procedures.length} procedimento(s)</div>}
                  </div>
                )}

                {/* Wire Info */}
                {needsWireInfo && (
                  <div style={{ marginBottom:14, padding:14, background:"#F0F9FF", borderRadius:12, border:"1.5px solid #BAE6FD" }}>
                    <div style={{ display:"flex", alignItems:"center", gap:8, marginBottom:12 }}>
                      <span style={{ fontSize:16 }}>ðŸ”©</span>
                      <span style={{ fontSize:14, fontWeight:700, color:"#0369A1" }}>InformaÃ§Ãµes do Fio OrtodÃ´ntico</span>
                    </div>
                    
                    {/* Arcada Superior */}
                    <div style={{ marginBottom:12 }}>
                      <div style={{ fontSize:13, fontWeight:600, color:"#0369A1", marginBottom:8 }}>Arcada Superior</div>
                      <div style={{ display:"grid", gridTemplateColumns:"1fr 1fr 1fr", gap:10 }}>
                        <Select label="Material" value={nrForm.wireInfo.upper.material}
                          onChange={e => setNrForm({...nrForm, wireInfo:{...nrForm.wireInfo, upper:{...nrForm.wireInfo.upper, material:e.target.value}}})}
                          options={[{value:"",label:"Selecione..."}, ...WIRE_MATERIALS.map(m=>({value:m,label:m}))]} />
                        <Select label="Formato" value={nrForm.wireInfo.upper.format}
                          onChange={e => setNrForm({...nrForm, wireInfo:{...nrForm.wireInfo, upper:{...nrForm.wireInfo.upper, format:e.target.value}}})}
                          options={[{value:"",label:"Selecione..."}, ...WIRE_FORMATS.map(f=>({value:f,label:f}))]} />
                        <Select label="Calibre" value={nrForm.wireInfo.upper.gauge}
                          onChange={e => setNrForm({...nrForm, wireInfo:{...nrForm.wireInfo, upper:{...nrForm.wireInfo.upper, gauge:e.target.value}}})}
                          options={[{value:"",label:"Selecione..."}, ...WIRE_GAUGES.map(g=>({value:g,label:g}))]} />
                      </div>
                    </div>
                    
                    {/* Arcada Inferior */}
                    <div>
                      <div style={{ fontSize:13, fontWeight:600, color:"#0369A1", marginBottom:8 }}>Arcada Inferior</div>
                      <div style={{ display:"grid", gridTemplateColumns:"1fr 1fr 1fr", gap:10 }}>
                        <Select label="Material" value={nrForm.wireInfo.lower.material}
                          onChange={e => setNrForm({...nrForm, wireInfo:{...nrForm.wireInfo, lower:{...nrForm.wireInfo.lower, material:e.target.value}}})}
                          options={[{value:"",label:"Selecione..."}, ...WIRE_MATERIALS.map(m=>({value:m,label:m}))]} />
                        <Select label="Formato" value={nrForm.wireInfo.lower.format}
                          onChange={e => setNrForm({...nrForm, wireInfo:{...nrForm.wireInfo, lower:{...nrForm.wireInfo.lower, format:e.target.value}}})}
                          options={[{value:"",label:"Selecione..."}, ...WIRE_FORMATS.map(f=>({value:f,label:f}))]} />
                        <Select label="Calibre" value={nrForm.wireInfo.lower.gauge}
                          onChange={e => setNrForm({...nrForm, wireInfo:{...nrForm.wireInfo, lower:{...nrForm.wireInfo.lower, gauge:e.target.value}}})}
                          options={[{value:"",label:"Selecione..."}, ...WIRE_GAUGES.map(g=>({value:g,label:g}))]} />
                      </div>
                    </div>
                  </div>
                )}

                <ToothChart selected={nrForm.teeth} onToggle={toggleTooth} />
                <Textarea label="ObservaÃ§Ãµes" value={nrForm.notes} onChange={e => setNrForm({...nrForm, notes:e.target.value})} placeholder="Detalhes do procedimento..." style={{ minHeight:80 }} />
                <Input label="PrÃ³xima Consulta" type="date" value={nrForm.nextAppointment} onChange={e => setNrForm({...nrForm, nextAppointment:e.target.value})} />

                {/* Photos */}
                <div style={{ marginTop:8, paddingTop:16, borderTop:"2px dashed #E2E8F0" }}>
                  <div style={{ fontSize:14, fontWeight:700, color:"#334155", marginBottom:8 }}>Fotos ClÃ­nicas</div>
                  <input ref={photoInputRef} type="file" accept="image/*" multiple onChange={handlePhotoUpload} style={{ display:"none" }} />
                  <button onClick={() => photoInputRef.current?.click()} style={{ ...btnSecondary, fontSize:13, padding:"8px 16px", marginBottom:8 }}>Anexar Foto</button>
                  {nrForm.photos.length > 0 && (
                    <div style={{ display:"flex", flexWrap:"wrap", gap:8, marginTop:8 }}>
                      {nrForm.photos.map(ph => (
                        <div key={ph.id} style={{ position:"relative", width:80, height:80, borderRadius:10, overflow:"hidden", border:"1.5px solid #CBD5E1" }}>
                          <FileThumb fileId={ph.id} cache={fileCache} loadFn={loadFile} type={ph.type || "image/jpeg"} name={ph.name} style={{ borderRadius:10 }} />
                          <button onClick={async () => { try { await FileDB.del(ph.id); } catch(e) {} setFileCache(prev => { const n={...prev}; delete n[ph.id]; return n; }); setNrForm(prev => ({...prev, photos:prev.photos.filter(p=>p.id!==ph.id)})); }} style={{ position:"absolute", top:2, right:2, background:"rgba(239,68,68,0.9)", border:"none", borderRadius:"50%", width:18, height:18, color:"#fff", fontSize:11, cursor:"pointer", display:"flex", alignItems:"center", justifyContent:"center", padding:0 }}>Ã—</button>
                        </div>
                      ))}
                    </div>
                  )}
                </div>

                {/* Signature */}
                <div style={{ marginTop:8, paddingTop:16, borderTop:"2px dashed #E2E8F0" }}>
                  <div style={{ fontSize:14, fontWeight:700, color:"#334155", marginBottom:4 }}>Assinatura do Paciente</div>
                  <p style={{ fontSize:12, color:"#64748B", marginBottom:10 }}>O paciente declara ciÃªncia e autoriza o tratamento.</p>
                  <SignaturePad value={nrForm.signature} onChange={(sig) => setNrForm({...nrForm, signature:sig})} label="Desenhe a assinatura" />
                </div>

                <div style={{ display:"flex", gap:10, justifyContent:"flex-end", marginTop:16 }}>
                  <button onClick={() => { setShowNewRecord(false); setNrForm({...emptyNrForm}); }} style={btnSecondary}>Cancelar</button>
                  <button onClick={tryAddRecord} style={{ ...btnPrimary, opacity:(!nrForm.specialty||nrForm.procedures.length===0)?0.5:1 }}>Registrar Atendimento</button>
                </div>
              </>
            )}
          </Modal>

          {/* â•â•â• RESPONSIBILITY CHECK POPUP â•â•â• */}
          <Modal isOpen={showRespCheck} onClose={() => { setShowRespCheck(false); setPendingRecord(null); }} title="AtenÃ§Ã£o: Paciente com ResponsÃ¡vel">
            {pendingRecord && (() => {
              const respField = pendingRecord.tipo_atendimento === "ORTODONTIA" ? "responsavel_orto_id" : "responsavel_clinico_id";
              const respName = getUserName(selectedPatient?.[respField]);
              const tipoLabel = pendingRecord.tipo_atendimento === "ORTODONTIA" ? "Ortodontia" : "ClÃ­nico";
              return (
                <div>
                  <div style={{ background:"#FEF3C7", border:"1px solid #FDE68A", borderRadius:12, padding:16, marginBottom:16 }}>
                    <div style={{ fontSize:14, fontWeight:700, color:"#92400E", marginBottom:4 }}>Este paciente possui responsÃ¡vel de {tipoLabel}:</div>
                    <div style={{ fontSize:18, fontWeight:800, color:"#78350F" }}>{respName}</div>
                  </div>
                  <p style={{ fontSize:13, color:"#475569", marginBottom:12 }}>VocÃª ({currentUser.name}) nÃ£o Ã© o responsÃ¡vel vigente. Deseja prosseguir com o atendimento mesmo assim?</p>
                  <Select label="Motivo (obrigatÃ³rio)" value={respCheckMotivo}
                    onChange={e => setRespCheckMotivo(e.target.value)}
                    options={[{value:"",label:"Selecione o motivo..."},{value:"Cobertura",label:"Cobertura"},{value:"UrgÃªncia",label:"UrgÃªncia"},{value:"Encaixe",label:"Encaixe"},{value:"SubstituiÃ§Ã£o",label:"SubstituiÃ§Ã£o"},{value:"Outro",label:"Outro"}]} />
                  <div style={{ display:"flex", gap:10, justifyContent:"flex-end", marginTop:16 }}>
                    <button onClick={() => { setShowRespCheck(false); setPendingRecord(null); }} style={btnSecondary}>Cancelar</button>
                    <button onClick={confirmOutOfResp} style={{ ...btnPrimary, background:"linear-gradient(135deg,#F59E0B,#D97706)", opacity:!respCheckMotivo?0.5:1 }} disabled={!respCheckMotivo}>Confirmar Atendimento</button>
                  </div>
                </div>
              );
            })()}
          </Modal>

          {/* â•â•â• CHANGE RESPONSIBLE MODAL â•â•â• */}
          <Modal isOpen={showChangeResp} onClose={() => setShowChangeResp(false)} title="Alterar ResponsÃ¡veis" wide>
            {selectedPatient && (
              <div>
                <div style={{ display:"grid", gridTemplateColumns:"1fr 1fr", gap:12 }}>
                  <Select label="ResponsÃ¡vel ClÃ­nico" value={respForm.responsavel_clinico_id}
                    onChange={e => setRespForm({...respForm, responsavel_clinico_id:e.target.value})} options={allUserOpts} />
                  <Select label="ResponsÃ¡vel Ortodontia" value={respForm.responsavel_orto_id}
                    onChange={e => setRespForm({...respForm, responsavel_orto_id:e.target.value})} options={allUserOpts} />
                </div>
                {selectedPatient.responsavelHistory?.length > 0 && (
                  <div style={{ marginTop:16, paddingTop:16, borderTop:"1px solid #E2E8F0" }}>
                    <div style={{ fontSize:13, fontWeight:700, color:"#334155", marginBottom:8 }}>HistÃ³rico de AlteraÃ§Ãµes</div>
                    {selectedPatient.responsavelHistory.map((h, i) => (
                      <div key={i} style={{ fontSize:12, color:"#64748B", padding:"6px 0", borderBottom:"1px solid #F1F5F9" }}>
                        <strong>{formatDateTime(h.date)}</strong> â€” {h.changedByName} alterou {h.field==="responsavel_clinico_id"?"Resp. ClÃ­nico":"Resp. Orto"}: {h.fromName || "â€”"} â†’ {h.toName}
                      </div>
                    ))}
                  </div>
                )}
                <div style={{ display:"flex", gap:10, justifyContent:"flex-end", marginTop:16 }}>
                  <button onClick={() => setShowChangeResp(false)} style={btnSecondary}>Cancelar</button>
                  <button onClick={saveResponsible} style={btnPrimary}>Salvar</button>
                </div>
              </div>
            )}
          </Modal>

          {/* â•â•â• USER FORM MODAL â•â•â• */}
          <Modal isOpen={showUserForm} onClose={() => { setShowUserForm(false); setEditingUserId(null); }} title={editingUserId ? "Editar UsuÃ¡rio" : "Novo UsuÃ¡rio"}>
            <Input label="Nome Completo *" value={userForm.name} onChange={e => setUserForm({...userForm, name:e.target.value})} placeholder="Nome do profissional" />
            <Input label="Login *" value={userForm.login} onChange={e => setUserForm({...userForm, login:e.target.value})} placeholder="Login de acesso" />
            <Input label={editingUserId ? "Nova Senha (deixe vazio para manter)" : "Senha *"} type="password" value={userForm.password} onChange={e => setUserForm({...userForm, password:e.target.value})} placeholder="Senha" />
            <Select label="Perfil *" value={userForm.role} onChange={e => setUserForm({...userForm, role:e.target.value})}
              options={[{value:"dentista",label:"Dentista"},{value:"orto",label:"Ortodontista"},{value:"recepcao",label:"Recepcionista"},{value:"admin",label:"Administrador"}]} />
            {editingUserId && (
              <Select label="Status" value={userForm.active?"true":"false"} onChange={e => setUserForm({...userForm, active:e.target.value==="true"})}
                options={[{value:"true",label:"Ativo"},{value:"false",label:"Inativo"}]} />
            )}
            <div style={{ display:"flex", gap:10, justifyContent:"flex-end", marginTop:16 }}>
              <button onClick={() => { setShowUserForm(false); setEditingUserId(null); }} style={btnSecondary}>Cancelar</button>
              <button onClick={saveUser} style={btnPrimary}>{editingUserId ? "Salvar" : "Criar UsuÃ¡rio"}</button>
            </div>
          </Modal>

          {/* â•â•â• ANAMNESIS MODAL â•â•â• */}
          <Modal isOpen={showAnamnesis} onClose={() => setShowAnamnesis(false)} title="Anamnese ClÃ­nica" wide>
            {!editingAnamnesis ? (
              <div>
                <div style={{ display:"flex", justifyContent:"flex-end", marginBottom:16 }}>
                  <button onClick={() => setEditingAnamnesis(true)} style={btnPrimary}>Editar</button>
                </div>
                {[["Alergias",anamnesisForm.allergies],["Medicamentos",anamnesisForm.medications],["DoenÃ§as",anamnesisForm.diseases],["Cirurgias",anamnesisForm.surgeries],["HistÃ³rico familiar",anamnesisForm.familyHistory],["PressÃ£o arterial",anamnesisForm.bloodPressure]].map(([l,v]) => (
                  <div key={l} style={{ marginBottom:12 }}>
                    <div style={{ fontSize:12, fontWeight:700, color:"#64748B", textTransform:"uppercase", letterSpacing:0.5 }}>{l}</div>
                    <div style={{ fontSize:14, color:v?"#0F172A":"#CBD5E1", marginTop:2 }}>{v||"NÃ£o informado"}</div>
                  </div>
                ))}
                <div style={{ display:"grid", gridTemplateColumns:"repeat(auto-fill,minmax(160px,1fr))", gap:8, marginTop:12 }}>
                  {[["Tabagismo",anamnesisForm.smoker],["Etilismo",anamnesisForm.drinker],["Gestante",anamnesisForm.pregnant],["Diabetes",anamnesisForm.diabetes],["Cardiopatia",anamnesisForm.heartDisease],["Hepatite",anamnesisForm.hepatitis],["HIV",anamnesisForm.hiv],["Sangramento",anamnesisForm.bleeding],["CicatrizaÃ§Ã£o",anamnesisForm.healing],["ReaÃ§Ã£o anestesia",anamnesisForm.anesthesiaReaction]].map(([l,v]) => (
                    <div key={l} style={{ padding:"8px 12px", borderRadius:10, background:v==="Sim"||v==="Alterada"?"#FEF2F2":"#F0FDF4", border:`1px solid ${v==="Sim"||v==="Alterada"?"#FECACA":"#BBF7D0"}` }}>
                      <div style={{ fontSize:11, color:"#64748B", fontWeight:600 }}>{l}</div>
                      <div style={{ fontSize:14, fontWeight:700, color:v==="Sim"||v==="Alterada"?"#DC2626":"#16A34A" }}>{v}</div>
                    </div>
                  ))}
                </div>
                {anamnesisForm.observations && (
                  <div style={{ marginTop:16, padding:14, background:"#FFFBEB", borderRadius:10, border:"1px solid #FDE68A" }}>
                    <div style={{ fontSize:12, fontWeight:700, color:"#92400E", marginBottom:4 }}>ObservaÃ§Ãµes</div>
                    <div style={{ fontSize:14, color:"#78350F", whiteSpace:"pre-wrap" }}>{anamnesisForm.observations}</div>
                  </div>
                )}
              </div>
            ) : (
              <div>
                <Textarea label="Alergias" value={anamnesisForm.allergies} onChange={e => setAnamnesisForm({...anamnesisForm, allergies:e.target.value})} placeholder="Alergias conhecidas..." />
                <Textarea label="Medicamentos" value={anamnesisForm.medications} onChange={e => setAnamnesisForm({...anamnesisForm, medications:e.target.value})} placeholder="Medicamentos em uso..." />
                <Textarea label="DoenÃ§as" value={anamnesisForm.diseases} onChange={e => setAnamnesisForm({...anamnesisForm, diseases:e.target.value})} placeholder="CondiÃ§Ãµes de saÃºde..." />
                <div style={{ display:"grid", gridTemplateColumns:"1fr 1fr", gap:12 }}>
                  <Textarea label="Cirurgias" value={anamnesisForm.surgeries} onChange={e => setAnamnesisForm({...anamnesisForm, surgeries:e.target.value})} placeholder="Cirurgias realizadas..." />
                  <Textarea label="HistÃ³rico familiar" value={anamnesisForm.familyHistory} onChange={e => setAnamnesisForm({...anamnesisForm, familyHistory:e.target.value})} placeholder="DoenÃ§as na famÃ­lia..." />
                </div>
                <Input label="PressÃ£o Arterial" value={anamnesisForm.bloodPressure} onChange={e => setAnamnesisForm({...anamnesisForm, bloodPressure:e.target.value})} placeholder="Ex: 120x80 mmHg" />
                <div style={{ display:"grid", gridTemplateColumns:"repeat(auto-fill,minmax(200px,1fr))", gap:10, marginTop:8 }}>
                  {[["smoker","Tabagismo"],["drinker","Etilismo"],["pregnant","Gestante"],["diabetes","Diabetes"],["heartDisease","Cardiopatia"],["hepatitis","Hepatite"],["hiv","HIV"],["bleeding","Sangramento"],["anesthesiaReaction","ReaÃ§Ã£o anestesia"]].map(([k,l]) => (
                    <Select key={k} label={l} value={anamnesisForm[k]} onChange={e => setAnamnesisForm({...anamnesisForm, [k]:e.target.value})} options={[{value:"NÃ£o",label:"NÃ£o"},{value:"Sim",label:"Sim"}]} />
                  ))}
                  <Select label="CicatrizaÃ§Ã£o" value={anamnesisForm.healing} onChange={e => setAnamnesisForm({...anamnesisForm, healing:e.target.value})} options={[{value:"Normal",label:"Normal"},{value:"Alterada",label:"Alterada"}]} />
                </div>
                <Textarea label="ObservaÃ§Ãµes" value={anamnesisForm.observations} onChange={e => setAnamnesisForm({...anamnesisForm, observations:e.target.value})} placeholder="AnotaÃ§Ãµes adicionais..." style={{ minHeight:100 }} />
                <div style={{ display:"flex", gap:10, justifyContent:"flex-end", marginTop:16 }}>
                  <button onClick={() => setEditingAnamnesis(false)} style={btnSecondary}>Cancelar</button>
                  <button onClick={saveAnamnesis} style={btnPrimary}>Salvar Anamnese</button>
                </div>
              </div>
            )}
          </Modal>

          {/* â•â•â• VIEW SIGNATURE MODAL â•â•â• */}
          <Modal isOpen={!!viewingSignature} onClose={() => setViewingSignature(null)} title="Assinatura do Paciente">
            {viewingSignature && (<div style={{ textAlign:"center" }}><div style={{ background:"#FAFBFC", borderRadius:12, border:"1px solid #E2E8F0", padding:16, display:"inline-block" }}><img src={viewingSignature} alt="Assinatura" style={{ maxWidth:"100%", height:"auto" }} /></div></div>)}
          </Modal>

          {/* â•â•â• VIEW PHOTO MODAL â•â•â• */}
          <Modal isOpen={!!viewingPhoto} onClose={() => setViewingPhoto(null)} title="Visualizar Imagem">
            {viewingPhoto && (<div style={{ textAlign:"center" }}><img src={viewingPhoto} alt="Foto" style={{ maxWidth:"100%", maxHeight:"70vh", borderRadius:12, border:"1px solid #E2E8F0" }} /></div>)}
          </Modal>

          {/* â•â•â• FINANCEIRO MODAL â•â•â• */}
          <Modal isOpen={showFinanceiro} onClose={() => { setShowFinanceiro(false); setEditingOrcamento(false); setTempOrcamento(""); setFinanceiroForm({ data: formatDateISO(new Date()), valor: "", forma_pagamento: "avista", observacao: "" }); }} title="Financeiro - Controle de Pagamentos" wide>
            {selectedPatient && (
              <div>
                {/* OrÃ§amento Total */}
                <div style={{ ...cardStyle, marginBottom:16, background:"linear-gradient(135deg,#EFF6FF,#DBEAFE)", borderColor:"#3B82F6" }}>
                  <div style={{ display:"flex", justifyContent:"space-between", alignItems:"center", marginBottom:10 }}>
                    <div style={{ fontSize:16, fontWeight:700, color:"#1E40AF" }}>ðŸ’µ OrÃ§amento Total</div>
                    {!editingOrcamento && (
                      <button onClick={() => { setTempOrcamento(selectedPatient.financeiro.orcamento_total.toString()); setEditingOrcamento(true); }} style={{...btnSecondary, fontSize:12, padding:"4px 12px"}}>âœï¸ Editar</button>
                    )}
                  </div>
                  {editingOrcamento ? (
                    <div style={{ display:"flex", gap:10, alignItems:"center" }}>
                      <Input label="" value={tempOrcamento} onChange={e => setTempOrcamento(e.target.value)} placeholder="0.00" type="number" step="0.01" />
                      <button onClick={() => saveOrcamento(selectedPatient.id, tempOrcamento)} style={{...btnPrimary, fontSize:13, padding:"8px 16px", whiteSpace:"nowrap"}}>âœ“ Salvar</button>
                      <button onClick={() => { setEditingOrcamento(false); setTempOrcamento(""); }} style={{...btnSecondary, fontSize:13, padding:"8px 16px"}}>Ã—</button>
                    </div>
                  ) : (
                    <div style={{ fontSize:28, fontWeight:800, color:"#1E40AF" }}>
                      R$ {(selectedPatient.financeiro.orcamento_total || 0).toFixed(2).replace(".", ",")}
                    </div>
                  )}
                </div>

                {/* Resumo Financeiro */}
                <div style={{ display:"grid", gridTemplateColumns:"repeat(auto-fit, minmax(200px, 1fr))", gap:12, marginBottom:16 }}>
                  <div style={{ ...cardStyle, background:"#F0FDF4", borderColor:"#10B981" }}>
                    <div style={{ fontSize:12, fontWeight:600, color:"#059669", marginBottom:4 }}>âœ“ Total Pago</div>
                    <div style={{ fontSize:22, fontWeight:800, color:"#10B981" }}>
                      R$ {selectedPatient.financeiro.pagamentos.reduce((sum, p) => sum + p.valor, 0).toFixed(2).replace(".", ",")}
                    </div>
                  </div>
                  <div style={{ ...cardStyle, background: selectedPatient.financeiro.orcamento_total - selectedPatient.financeiro.pagamentos.reduce((sum, p) => sum + p.valor, 0) > 0 ? "#FEF2F2" : "#F0FDF4", borderColor: selectedPatient.financeiro.orcamento_total - selectedPatient.financeiro.pagamentos.reduce((sum, p) => sum + p.valor, 0) > 0 ? "#EF4444" : "#10B981" }}>
                    <div style={{ fontSize:12, fontWeight:600, color: selectedPatient.financeiro.orcamento_total - selectedPatient.financeiro.pagamentos.reduce((sum, p) => sum + p.valor, 0) > 0 ? "#DC2626" : "#059669", marginBottom:4 }}>
                      {selectedPatient.financeiro.orcamento_total - selectedPatient.financeiro.pagamentos.reduce((sum, p) => sum + p.valor, 0) > 0 ? "âš ï¸ Saldo Devedor" : "âœ“ Quitado"}
                    </div>
                    <div style={{ fontSize:22, fontWeight:800, color: selectedPatient.financeiro.orcamento_total - selectedPatient.financeiro.pagamentos.reduce((sum, p) => sum + p.valor, 0) > 0 ? "#EF4444" : "#10B981" }}>
                      R$ {Math.abs(selectedPatient.financeiro.orcamento_total - selectedPatient.financeiro.pagamentos.reduce((sum, p) => sum + p.valor, 0)).toFixed(2).replace(".", ",")}
                    </div>
                  </div>
                </div>

                {/* Novo Pagamento */}
                <div style={{ ...cardStyle, marginBottom:16 }}>
                  <div style={{ fontSize:16, fontWeight:700, color:"#0F172A", marginBottom:12 }}>ðŸ’³ Registrar Novo Pagamento</div>
                  <div style={{ display:"grid", gridTemplateColumns:"repeat(auto-fit, minmax(200px, 1fr))", gap:12, marginBottom:12 }}>
                    <Input label="Data *" type="date" value={financeiroForm.data} onChange={e => setFinanceiroForm({...financeiroForm, data: e.target.value})} />
                    <Input label="Valor (R$) *" type="number" step="0.01" value={financeiroForm.valor} onChange={e => setFinanceiroForm({...financeiroForm, valor: e.target.value})} placeholder="0.00" />
                    <Select label="Forma de Pagamento *" value={financeiroForm.forma_pagamento} onChange={e => setFinanceiroForm({...financeiroForm, forma_pagamento: e.target.value})}
                      options={[{value:"avista",label:"Ã€ Vista"},{value:"parcelado",label:"Parcelado"}]} />
                  </div>
                  <Input label="ObservaÃ§Ã£o" value={financeiroForm.observacao} onChange={e => setFinanceiroForm({...financeiroForm, observacao: e.target.value})} placeholder="Ex: Parcela 1/12, CartÃ£o, etc." />
                  <div style={{ display:"flex", justifyContent:"flex-end", marginTop:12 }}>
                    <button onClick={() => addPagamento(selectedPatient.id)} style={btnPrimary}>âœ“ Adicionar Pagamento</button>
                  </div>
                </div>

                {/* HistÃ³rico de Pagamentos */}
                <div style={{ ...cardStyle }}>
                  <div style={{ fontSize:16, fontWeight:700, color:"#0F172A", marginBottom:12 }}>ðŸ“Š HistÃ³rico de Pagamentos ({selectedPatient.financeiro.pagamentos.length})</div>
                  {selectedPatient.financeiro.pagamentos.length === 0 ? (
                    <div style={{ textAlign:"center", padding:40, color:"#94A3B8" }}>Nenhum pagamento registrado</div>
                  ) : (
                    <div style={{ maxHeight:400, overflowY:"auto" }}>
                      {selectedPatient.financeiro.pagamentos.sort((a, b) => new Date(b.data) - new Date(a.data)).map(pg => (
                        <div key={pg.id} style={{ padding:12, background:"#F8FAFC", borderRadius:8, marginBottom:8, border:"1px solid #E2E8F0" }}>
                          <div style={{ display:"flex", justifyContent:"space-between", alignItems:"start", marginBottom:6 }}>
                            <div style={{ flex:1 }}>
                              <div style={{ display:"flex", alignItems:"center", gap:8, marginBottom:4 }}>
                                <span style={{ fontSize:18, fontWeight:800, color:"#10B981" }}>R$ {pg.valor.toFixed(2).replace(".", ",")}</span>
                                <span style={{ fontSize:11, fontWeight:700, color:pg.forma_pagamento === "avista" ? "#0EA5E9" : "#F59E0B", background:pg.forma_pagamento === "avista" ? "#EFF6FF" : "#FEF3C7", border:`1px solid ${pg.forma_pagamento === "avista" ? "#BFDBFE" : "#FDE68A"}`, borderRadius:6, padding:"2px 8px" }}>
                                  {pg.forma_pagamento === "avista" ? "Ã€ Vista" : "Parcelado"}
                                </span>
                              </div>
                              <div style={{ fontSize:12, color:"#64748B" }}>
                                ðŸ“… {formatDate(pg.data)}
                                {pg.observacao && ` Â· ${pg.observacao}`}
                              </div>
                              <div style={{ fontSize:11, color:"#94A3B8", marginTop:4 }}>
                                Registrado por: {pg.registrado_por} em {new Date(pg.registrado_em).toLocaleString("pt-BR")}
                              </div>
                            </div>
                            <button onClick={() => removePagamento(selectedPatient.id, pg.id)} style={{...btnSecondary, fontSize:11, padding:"4px 8px", background:"#FEE2E2", color:"#DC2626", border:"1px solid #FCA5A5"}}>ðŸ—‘ï¸</button>
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              </div>
            )}
          </Modal>

          {/* â•â•â• ARRIVAL CONTROL MODAL â•â•â• */}
          <Modal isOpen={showArrivalControl} onClose={() => { setShowArrivalControl(false); setArrivalPatientId(null); }} title="Marcar Chegada do Paciente">
            <div style={{ marginBottom:16, padding:14, background:"#F0F9FF", borderRadius:12, border:"1.5px solid #BAE6FD" }}>
              <div style={{ fontSize:14, fontWeight:700, color:"#0369A1", marginBottom:4 }}>
                Paciente: {patients.find(p => p.id === arrivalPatientId)?.name}
              </div>
              <div style={{ fontSize:12, color:"#64748B" }}>
                Selecione o dentista ou ortodontista que irÃ¡ atender este paciente.
              </div>
            </div>
            <Select 
              label="Dentista/Ortodontista *" 
              value={arrivalForm.dentista_id}
              onChange={e => setArrivalForm({...arrivalForm, dentista_id: e.target.value})}
              options={dentistOpts}
            />
            <div style={{ display:"flex", gap:10, justifyContent:"flex-end", marginTop:16 }}>
              <button onClick={() => { setShowArrivalControl(false); setArrivalPatientId(null); }} style={btnSecondary}>Cancelar</button>
              <button onClick={confirmArrival} style={btnPrimary}>ðŸ‘‹ Confirmar Chegada</button>
            </div>
          </Modal>

          {/* â•â•â• RELATÃ“RIO DE ATENDIMENTOS â•â•â• */}
          <Modal isOpen={showRelatorio} onClose={() => setShowRelatorio(false)} title="ðŸ“Š RelatÃ³rio de Atendimentos por PerÃ­odo" wide>
            <div>
              {/* Filtros */}
              <div style={{ ...cardStyle, marginBottom:16 }}>
                <div style={{ fontSize:16, fontWeight:700, color:"#0F172A", marginBottom:12 }}>ðŸ” Filtros</div>
                <div style={{ display:"grid", gridTemplateColumns:"repeat(auto-fit, minmax(200px, 1fr))", gap:12, marginBottom:12 }}>
                  <Select 
                    label="Profissional" 
                    value={relatorioFilters.profissional_id}
                    onChange={e => setRelatorioFilters({...relatorioFilters, profissional_id: e.target.value})}
                    options={[{value:"",label:"Todos"}, ...dentistOpts]}
                  />
                  <Input 
                    label="Data InÃ­cio" 
                    type="date" 
                    value={relatorioFilters.data_inicio}
                    onChange={e => setRelatorioFilters({...relatorioFilters, data_inicio: e.target.value})}
                  />
                  <Input 
                    label="Data Fim" 
                    type="date" 
                    value={relatorioFilters.data_fim}
                    onChange={e => setRelatorioFilters({...relatorioFilters, data_fim: e.target.value})}
                  />
                </div>
                <Input 
                  label="Buscar Paciente" 
                  value={relatorioFilters.busca}
                  onChange={e => setRelatorioFilters({...relatorioFilters, busca: e.target.value})}
                  placeholder="Digite o nome do paciente..."
                />
              </div>

              {/* Tabela de Resultados */}
              <div style={{ ...cardStyle, marginBottom:16 }}>
                <div style={{ display:"flex", justifyContent:"space-between", alignItems:"center", marginBottom:12 }}>
                  <div style={{ fontSize:16, fontWeight:700, color:"#0F172A" }}>ðŸ“Š Resultados ({getRelatorioData().length} atendimentos)</div>
                  <button onClick={exportToExcel} style={{...btnPrimary, fontSize:13, padding:"8px 16px"}}>ðŸ“„ Exportar Excel</button>
                </div>
                
                <div style={{ overflowX:"auto" }}>
                  <table style={{ width:"100%", borderCollapse:"collapse", fontSize:12 }}>
                    <thead>
                      <tr style={{ background:"#F8FAFC", borderBottom:"2px solid #E2E8F0" }}>
                        <th onClick={() => setRelatorioSort({field:"paciente_nome", direction: relatorioSort.field==="paciente_nome" && relatorioSort.direction==="asc"?"desc":"asc"})} style={{ padding:"10px 8px", textAlign:"left", fontWeight:700, color:"#475569", cursor:"pointer", whiteSpace:"nowrap" }}>ðŸ‘¤ Paciente {relatorioSort.field==="paciente_nome" && (relatorioSort.direction==="asc"?"â†‘":"â†“")}</th>
                        <th onClick={() => setRelatorioSort({field:"data", direction: relatorioSort.field==="data" && relatorioSort.direction==="asc"?"desc":"asc"})} style={{ padding:"10px 8px", textAlign:"left", fontWeight:700, color:"#475569", cursor:"pointer", whiteSpace:"nowrap" }}>ðŸ“… Data {relatorioSort.field==="data" && (relatorioSort.direction==="asc"?"â†‘":"â†“")}</th>
                        <th onClick={() => setRelatorioSort({field:"profissional", direction: relatorioSort.field==="profissional" && relatorioSort.direction==="asc"?"desc":"asc"})} style={{ padding:"10px 8px", textAlign:"left", fontWeight:700, color:"#475569", cursor:"pointer", whiteSpace:"nowrap" }}>ðŸ‘¨â€âš•ï¸ Profissional {relatorioSort.field==="profissional" && (relatorioSort.direction==="asc"?"â†‘":"â†“")}</th>
                        <th onClick={() => setRelatorioSort({field:"tipo_atendimento", direction: relatorioSort.field==="tipo_atendimento" && relatorioSort.direction==="asc"?"desc":"asc"})} style={{ padding:"10px 8px", textAlign:"left", fontWeight:700, color:"#475569", cursor:"pointer", whiteSpace:"nowrap" }}>ðŸŽ¯ Tipo {relatorioSort.field==="tipo_atendimento" && (relatorioSort.direction==="asc"?"â†‘":"â†“")}</th>
                        <th style={{ padding:"10px 8px", textAlign:"left", fontWeight:700, color:"#475569", whiteSpace:"nowrap" }}>ðŸ”§ Procedimentos</th>
                        <th onClick={() => setRelatorioSort({field:"valor_total", direction: relatorioSort.field==="valor_total" && relatorioSort.direction==="asc"?"desc":"asc"})} style={{ padding:"10px 8px", textAlign:"right", fontWeight:700, color:"#475569", cursor:"pointer", whiteSpace:"nowrap" }}>ðŸ’µ Valor Total {relatorioSort.field==="valor_total" && (relatorioSort.direction==="asc"?"â†‘":"â†“")}</th>
                        <th onClick={() => setRelatorioSort({field:"valor_pago", direction: relatorioSort.field==="valor_pago" && relatorioSort.direction==="asc"?"desc":"asc"})} style={{ padding:"10px 8px", textAlign:"right", fontWeight:700, color:"#475569", cursor:"pointer", whiteSpace:"nowrap" }}>âœ“ Pago {relatorioSort.field==="valor_pago" && (relatorioSort.direction==="asc"?"â†‘":"â†“")}</th>
                        <th onClick={() => setRelatorioSort({field:"valor_aberto", direction: relatorioSort.field==="valor_aberto" && relatorioSort.direction==="asc"?"desc":"asc"})} style={{ padding:"10px 8px", textAlign:"right", fontWeight:700, color:"#475569", cursor:"pointer", whiteSpace:"nowrap" }}>âš ï¸ Em Aberto {relatorioSort.field==="valor_aberto" && (relatorioSort.direction==="asc"?"â†‘":"â†“")}</th>
                        <th onClick={() => setRelatorioSort({field:"status_financeiro", direction: relatorioSort.field==="status_financeiro" && relatorioSort.direction==="asc"?"desc":"asc"})} style={{ padding:"10px 8px", textAlign:"center", fontWeight:700, color:"#475569", cursor:"pointer", whiteSpace:"nowrap" }}>ðŸŸ¢ Status {relatorioSort.field==="status_financeiro" && (relatorioSort.direction==="asc"?"â†‘":"â†“")}</th>
                      </tr>
                    </thead>
                    <tbody>
                      {getRelatorioData().length === 0 ? (
                        <tr>
                          <td colSpan="9" style={{ padding:40, textAlign:"center", color:"#94A3B8" }}>Nenhum atendimento encontrado no perÃ­odo</td>
                        </tr>
                      ) : (
                        getRelatorioData().map(row => (
                          <tr key={row.id} style={{ borderBottom:"1px solid #F1F5F9" }}>
                            <td style={{ padding:"10px 8px", color:"#334155", fontWeight:600 }}>{row.paciente_nome}</td>
                            <td style={{ padding:"10px 8px", color:"#64748B" }}>{formatDate(row.data)}</td>
                            <td style={{ padding:"10px 8px", color:"#64748B" }}>{row.profissional}</td>
                            <td style={{ padding:"10px 8px" }}>
                              <span style={{ fontSize:10, fontWeight:700, color:row.tipo_atendimento==="ORTODONTIA"?"#0EA5E9":"#10B981", background:row.tipo_atendimento==="ORTODONTIA"?"#EFF6FF":"#F0FDF4", border:`1px solid ${row.tipo_atendimento==="ORTODONTIA"?"#BFDBFE":"#BBF7D0"}`, borderRadius:6, padding:"2px 8px" }}>
                                {row.tipo_atendimento}
                              </span>
                            </td>
                            <td style={{ padding:"10px 8px", color:"#64748B", fontSize:11, maxWidth:200, overflow:"hidden", textOverflow:"ellipsis", whiteSpace:"nowrap" }} title={row.procedimentos}>{row.procedimentos}</td>
                            <td style={{ padding:"10px 8px", textAlign:"right", fontWeight:700, color:"#334155" }}>R$ {row.valor_total.toFixed(2).replace(".", ",")}</td>
                            <td style={{ padding:"10px 8px", textAlign:"right", fontWeight:600, color:"#10B981" }}>R$ {row.valor_pago.toFixed(2).replace(".", ",")}</td>
                            <td style={{ padding:"10px 8px", textAlign:"right", fontWeight:600, color:row.valor_aberto>0?"#EF4444":"#10B981" }}>R$ {row.valor_aberto.toFixed(2).replace(".", ",")}</td>
                            <td style={{ padding:"10px 8px", textAlign:"center" }}>
                              {row.status_financeiro === "pago" && <span style={{ fontSize:10, fontWeight:700, color:"#10B981", background:"#D1FAE5", border:"1px solid #BBF7D0", borderRadius:6, padding:"3px 10px" }}>âœ… Pago</span>}
                              {row.status_financeiro === "parcial" && <span style={{ fontSize:10, fontWeight:700, color:"#F59E0B", background:"#FEF3C7", border:"1px solid #FDE68A", borderRadius:6, padding:"3px 10px" }}>ðŸŸ¡ Parcial</span>}
                              {row.status_financeiro === "aberto" && <span style={{ fontSize:10, fontWeight:700, color:"#EF4444", background:"#FEE2E2", border:"1px solid #FCA5A5", borderRadius:6, padding:"3px 10px" }}>ðŸ”´ Aberto</span>}
                              {row.status_financeiro === "sem_orcamento" && <span style={{ fontSize:10, fontWeight:700, color:"#94A3B8", background:"#F1F5F9", border:"1px solid #E2E8F0", borderRadius:6, padding:"3px 10px" }}>âšª Sem OrÃ§.</span>}
                            </td>
                          </tr>
                        ))
                      )}
                    </tbody>
                  </table>
                </div>
              </div>

              {/* Totalizadores */}
              {getRelatorioData().length > 0 && (
                <div style={{ display:"grid", gridTemplateColumns:"repeat(auto-fit, minmax(200px, 1fr))", gap:12 }}>
                  <div style={{ ...cardStyle, background:"#EFF6FF", borderColor:"#3B82F6" }}>
                    <div style={{ fontSize:12, fontWeight:600, color:"#1E40AF", marginBottom:4 }}>ðŸ’µ Total Geral</div>
                    <div style={{ fontSize:22, fontWeight:800, color:"#3B82F6" }}>
                      R$ {getRelatorioData().reduce((sum, r) => sum + r.valor_total, 0).toFixed(2).replace(".", ",")}
                    </div>
                  </div>
                  <div style={{ ...cardStyle, background:"#F0FDF4", borderColor:"#10B981" }}>
                    <div style={{ fontSize:12, fontWeight:600, color:"#059669", marginBottom:4 }}>âœ“ Total Recebido</div>
                    <div style={{ fontSize:22, fontWeight:800, color:"#10B981" }}>
                      R$ {getRelatorioData().reduce((sum, r) => sum + r.valor_pago, 0).toFixed(2).replace(".", ",")}
                    </div>
                  </div>
                  <div style={{ ...cardStyle, background:"#FEF2F2", borderColor:"#EF4444" }}>
                    <div style={{ fontSize:12, fontWeight:600, color:"#DC2626", marginBottom:4 }}>âš ï¸ Total em Aberto</div>
                    <div style={{ fontSize:22, fontWeight:800, color:"#EF4444" }}>
                      R$ {getRelatorioData().reduce((sum, r) => sum + r.valor_aberto, 0).toFixed(2).replace(".", ",")}
                    </div>
                  </div>
                </div>
              )}
            </div>
          </Modal>
          
          {/* Sistema de NotificaÃ§Ãµes */}
          <div style={{ position:"fixed", top:80, right:20, zIndex:9999, display:"flex", flexDirection:"column", gap:10, maxWidth:350 }}>
            {notifications.map(notif => (
              <div key={notif.id} style={{
                background: notif.type === 'success' ? '#ECFDF5' : notif.type === 'warning' ? '#FEF3C7' : '#EFF6FF',
                border: `1px solid ${notif.type === 'success' ? '#A7F3D0' : notif.type === 'warning' ? '#FDE68A' : '#BFDBFE'}`,
                borderRadius:10,
                padding:"12px 16px",
                fontSize:13,
                color: notif.type === 'success' ? '#065F46' : notif.type === 'warning' ? '#92400E' : '#1E40AF',
                fontWeight:600,
                boxShadow:"0 4px 12px rgba(0,0,0,0.1)",
                animation:"slideInRight 0.3s ease-out",
                display:"flex",
                alignItems:"center",
                gap:8
              }}>
                <span>{notif.type === 'success' ? 'âœ“' : notif.type === 'warning' ? 'âš ï¸' : 'ðŸ””'}</span>
                {notif.message}
              </div>
            ))}
          </div>
        </div>
      );
    }
    ReactDOM.createRoot(document.getElementById("root")).render(<App />);;
  </script>
</body>
</html>