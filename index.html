<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>O+ Fichas ‚Äî Prontu√°rio Eletr√¥nico</title>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <!-- Supabase Client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
  <style>
    :root {
      --radius: 12px;
      --radius-sm: 8px;
      --radius-lg: 16px;
      --space-1: 8px;
      --space-2: 12px;
      --space-3: 16px;
      --space-4: 20px;
      --space-5: 24px;
      --color-primary: #0EA5E9;
      --color-primary-dark: #0284C7;
      --color-danger: #EF4444;
      --color-success: #10B981;
      --color-warning: #F59E0B;
      --color-text: #0F172A;
      --color-text-secondary: #64748B;
      --color-text-muted: #94A3B8;
      --color-border: #E2E8F0;
      --color-bg: #F1F5F9;
      --color-bg-card: #fff;
      --color-surface: #F8FAFC;
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.04);
      --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
      --shadow-lg: 0 8px 30px rgba(0,0,0,0.12);
      --font: 'DM Sans', 'Segoe UI', system-ui, sans-serif;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: var(--font); background: var(--color-bg); color: var(--color-text); }
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-thumb { background: #CBD5E1; border-radius: 3px; }
    input, select, textarea { font-family: inherit; }
    button { font-family: inherit; }
    .tab-btn { padding: 10px 20px; border: none; border-bottom: 3px solid transparent; background: none; font-size: 14px; font-weight: 700; color: #94A3B8; cursor: pointer; transition: all 0.2s; }
    .tab-btn.active { color: #0EA5E9; border-bottom-color: #0EA5E9; }
    .tab-btn:hover { color: #0EA5E9; }
    .tipo-card { padding: 16px 24px; border-radius: 12px; border: 2px solid #E2E8F0; cursor: pointer; text-align: center; transition: all 0.2s; flex: 1; }
    .tipo-card:hover { border-color: #94A3B8; }
    .tipo-card.selected { border-color: currentColor; }

    /* Patient Detail Tabs */
    .pd-tabs { display:flex; gap:0; background:#fff; border-bottom:1px solid var(--color-border); overflow-x:auto; -webkit-overflow-scrolling:touch; scrollbar-width:none; }
    .pd-tabs::-webkit-scrollbar { display:none; }
    .pd-tab { flex:0 0 auto; padding:12px 16px; border:none; border-bottom:2px solid transparent; background:none; font-size:13px; font-weight:600; color:var(--color-text-muted); cursor:pointer; transition:all 0.15s; white-space:nowrap; min-height:44px; }
    .pd-tab:hover { color:var(--color-text-secondary); }
    .pd-tab[data-active="true"] { color:var(--color-primary); border-bottom-color:var(--color-primary); font-weight:700; }

    /* Summary cards grid */
    .summary-grid { display:grid; grid-template-columns:1fr 1fr; gap:var(--space-2); padding:0; }
    @media (min-width: 640px) { .summary-grid { grid-template-columns:repeat(4, 1fr); } }
    .summary-card { background:var(--color-bg-card); border:1px solid var(--color-border); border-radius:var(--radius); padding:var(--space-2) var(--space-3); }
    .summary-card-label { font-size:10px; font-weight:700; text-transform:uppercase; letter-spacing:0.5px; color:var(--color-text-muted); margin-bottom:4px; }
    .summary-card-value { font-size:14px; font-weight:700; color:var(--color-text); }

    /* Encounter timeline */
    .encounter-timeline { position:relative; }
    .encounter-card { position:relative; padding-left:20px; margin-bottom:var(--space-3); }
    .encounter-card::before { content:''; position:absolute; left:5px; top:24px; bottom:-16px; width:1px; background:var(--color-border); }
    .encounter-card:last-child::before { display:none; }
    .encounter-card::after { content:''; position:absolute; left:0; top:16px; width:11px; height:11px; border-radius:50%; border:2px solid var(--color-primary); background:var(--color-bg-card); z-index:1; }

    /* Action menu overlay */
    .action-menu-overlay { position:fixed; inset:0; z-index:299; background:rgba(0,0,0,0.2); }
    .action-menu { position:absolute; right:0; top:100%; background:#fff; border-radius:var(--radius); box-shadow:var(--shadow-lg); min-width:200px; z-index:300; overflow:hidden; border:1px solid var(--color-border); }
    .action-menu-item { width:100%; text-align:left; background:none; border:none; padding:11px 16px; font-size:13px; color:var(--color-text); cursor:pointer; display:flex; align-items:center; gap:8px; transition:background 0.1s; }
    .action-menu-item:hover { background:var(--color-surface); }
    .action-menu-item[data-danger="true"] { color:var(--color-danger); }
    .action-menu-item[data-danger="true"]:hover { background:#FEF2F2; }
    .action-menu-divider { height:1px; background:var(--color-border); margin:4px 0; }

    /* Anima√ß√µes Realtime */
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    @keyframes slideInRight {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useRef, useCallback } = React;

    // ‚îÄ‚îÄ‚îÄ CONSTANTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const ROLES = { OWNER: "OWNER", ADMIN: "ADMIN", MANAGER: "MANAGER", PROFESSIONAL: "PROFESSIONAL", RECEPTION: "RECEPTION" };
    const ROLE_LABELS = { OWNER: "Propriet√°rio", ADMIN: "Administrador", MANAGER: "Gerente", PROFESSIONAL: "Profissional", RECEPTION: "Recepcionista" };
    const isAdminRole = (r) => r === "ADMIN" || r === "OWNER";
    const RECORD_TYPES = { ORTODONTIA: "ORTODONTIA", GERAL: "GERAL" };
    const MAX_FILE_SIZE = 50 * 1024 * 1024;
    const ALLOWED_FILE_TYPES = ["image/jpeg","image/png","image/webp","image/gif","application/pdf",
      "application/vnd.openxmlformats-officedocument.wordprocessingml.document"];

    const SPECIALTIES = {
      ortodontia: {
        label: "Ortodontia", icon: "ü¶∑", color: "#0EA5E9",
        procedures: [
          "Instala√ß√£o de aparelho fixo","Manuten√ß√£o de aparelho fixo","Troca de fio ortod√¥ntico",
          "Colagem de braquete","Bandagem","Instala√ß√£o de aparelho m√≥vel","Ajuste de aparelho m√≥vel",
          "Conten√ß√£o fixa","Conten√ß√£o remov√≠vel","Mini-implante ortod√¥ntico","El√°stico intermaxilar",
          "Moldagem ortod√¥ntica","Documenta√ß√£o ortod√¥ntica","Remo√ß√£o de aparelho","Expansor palatino",
          "Alinhador transparente",
        ],
      },
      endodontia: {
        label: "Endodontia", icon: "üî¨", color: "#8B5CF6",
        procedures: [
          "Tratamento de canal - unirradicular","Tratamento de canal - birradicular",
          "Tratamento de canal - multirradicular","Retratamento endod√¥ntico",
          "Capeamento pulpar direto","Capeamento pulpar indireto","Pulpotomia",
          "Pulpectomia","Drenagem de abscesso","Curativo de demora",
        ],
      },
      periodontia: {
        label: "Periodontia", icon: "ü©∫", color: "#10B981",
        procedures: [
          "Raspagem supragengival","Raspagem subgengival","Profilaxia dental",
          "Aplica√ß√£o de fl√∫or","Gengivectomia","Gengivoplastia","Cirurgia periodontal",
          "Enxerto gengival","Frenectomia","Sondagem periodontal",
        ],
      },
      protese: {
        label: "Pr√≥tese", icon: "üèóÔ∏è", color: "#F59E0B",
        procedures: [
          "Pr√≥tese total superior","Pr√≥tese total inferior","Pr√≥tese parcial remov√≠vel",
          "Coroa provis√≥ria","Coroa definitiva - metalocer√¢mica","Coroa definitiva - porcelana pura",
          "Faceta de porcelana","Faceta de resina","Pr√≥tese sobre implante",
          "Moldagem para pr√≥tese","Prova de estrutura met√°lica","Ajuste oclusal",
          "Reembasamento","Conserto de pr√≥tese",
        ],
      },
      implantodontia: {
        label: "Implantodontia", icon: "‚öôÔ∏è", color: "#EC4899",
        procedures: [
          "Instala√ß√£o de implante","Reabertura de implante","Instala√ß√£o de cicatrizador",
          "Moldagem sobre implante","Instala√ß√£o de pilar prot√©tico","Carga imediata",
          "Enxerto √≥sseo","Levantamento de seio maxilar","Regenera√ß√£o √≥ssea guiada",
        ],
      },
      dentistica: {
        label: "Dent√≠stica", icon: "‚ú®", color: "#06B6D4",
        procedures: [
          "Restaura√ß√£o resina composta - simples","Restaura√ß√£o resina composta - composta",
          "Restaura√ß√£o resina composta - complexa","Restaura√ß√£o am√°lgama",
          "Clareamento caseiro","Clareamento de consult√≥rio","Clareamento interno",
          "Faceta direta em resina","Ajuste oclusal","Polimento de restaura√ß√£o",
        ],
      },
      cirurgia: {
        label: "Cirurgia", icon: "üî™", color: "#EF4444",
        procedures: [
          "Exodontia simples","Exodontia de terceiro molar","Exodontia de raiz residual",
          "Cirurgia de dente incluso","Apicectomia","Bi√≥psia","Remo√ß√£o de cisto",
          "Frenectomia lingual","Frenectomia labial","Sutura","Remo√ß√£o de sutura",
          "Drenagem de abscesso",
        ],
      },
      odontopediatria: {
        label: "Odontopediatria", icon: "üë∂", color: "#A78BFA",
        procedures: [
          "Aplica√ß√£o de selante","Aplica√ß√£o de fl√∫or","Restaura√ß√£o em dente dec√≠duo",
          "Pulpotomia em dec√≠duo","Pulpectomia em dec√≠duo","Exodontia de dec√≠duo",
          "Mantenedor de espa√ßo","Coroa de a√ßo","Adequa√ß√£o do meio bucal",
        ],
      },
    };

    const TOOTH_NUMBERS = [
      [18,17,16,15,14,13,12,11,21,22,23,24,25,26,27,28],
      [48,47,46,45,44,43,42,41,31,32,33,34,35,36,37,38],
    ];

    const WIRE_MATERIALS = ["Nitinol", "A√ßo"];
    const WIRE_FORMATS = ["Redondo", "Quadrado"];
    const WIRE_GAUGES = ["012","014","016","018","020","16x16","16x22","17x25","19x25","21x25"];

    // ‚îÄ‚îÄ‚îÄ STATUS ORTODONTIA ‚îÄ‚îÄ‚îÄ
    const ORTHO_STATUSES = [
      "Tratamento",
      "Controle de conten√ß√£o",
      "Abandono",
      "Cancelado",
      "√Ä protestar",
      "Protesto",
      "Afastamento tempor√°rio",
      "Transfer√™ncia",
      "Controle de erup√ß√£o",
    ];
    const ORTHO_STATUS_COLORS = {
      "Tratamento": { color: "#10B981", bg: "#F0FDF4" },
      "Controle de conten√ß√£o": { color: "#0EA5E9", bg: "#EFF6FF" },
      "Abandono": { color: "#EF4444", bg: "#FEF2F2" },
      "Cancelado": { color: "#6B7280", bg: "#F3F4F6" },
      "√Ä protestar": { color: "#F59E0B", bg: "#FFFBEB" },
      "Protesto": { color: "#DC2626", bg: "#FEF2F2" },
      "Afastamento tempor√°rio": { color: "#8B5CF6", bg: "#F5F3FF" },
      "Transfer√™ncia": { color: "#06B6D4", bg: "#ECFEFF" },
      "Controle de erup√ß√£o": { color: "#14B8A6", bg: "#F0FDFA" },
    };

    // ‚îÄ‚îÄ‚îÄ TABELA MESTRE DE PROCEDIMENTOS (importada de procedimentos 2.xlsx) ‚îÄ‚îÄ‚îÄ
    const BUDGET_STATUSES = {
      rascunho: { label: "Rascunho", color: "#94A3B8", bg: "#F1F5F9" },
      entregue: { label: "Entregue", color: "#0EA5E9", bg: "#EFF6FF" },
      aprovado: { label: "Aprovado", color: "#10B981", bg: "#F0FDF4" },
      cancelado: { label: "Cancelado", color: "#EF4444", bg: "#FEF2F2" },
    };

    const PROCEDURES_TABLE = [
      { code: "1", specialty: "Cirurgia", name: "Apicetomia Birradicular", base_value: 0, unit_value: 619 },
      { code: "2", specialty: "Ortodontia", name: "1¬™ Consulta", base_value: 0, unit_value: 0 },
      { code: "3", specialty: "Cl√≠nica geral", name: "Abertura Coron√°ria Para Al√≠vio Da Dor", base_value: 0, unit_value: 149 },
      { code: "4", specialty: "Cl√≠nica geral", name: "Adequa√ß√£o Do Meio Bucal (Ionomero De Vidro)", base_value: 0, unit_value: 149 },
      { code: "5", specialty: "Cl√≠nica geral", name: "Adequa√ß√£o Do Meio Bucal Oxido De Zinco E Eugenol)", base_value: 0, unit_value: 149 },
      { code: "6", specialty: "Cl√≠nica geral", name: "Ajuste Oclusal", base_value: 0, unit_value: 149 },
      { code: "7", specialty: "Ortodontia", name: "Alta", base_value: 0, unit_value: 0 },
      { code: "8", specialty: "SAC", name: "Alta", base_value: 0, unit_value: 0 },
      { code: "9", specialty: "SAC", name: "Altera√ß√£o Do Vencimento", base_value: 0, unit_value: 0 },
      { code: "10", specialty: "Cl√≠nica geral", name: "Alveoloplastia", base_value: 0, unit_value: 149 },
      { code: "11", specialty: "Ortodontia", name: "Aparelho Extra", base_value: 0, unit_value: 250 },
      { code: "12", specialty: "Produtos", name: "Aparelho Ortod√¥ntico Fixo", base_value: 0, unit_value: 200 },
      { code: "13", specialty: "Produtos", name: "Aparelho Ortod√¥ntico Fixo Autoligado", base_value: 0, unit_value: 1500 },
      { code: "14", specialty: "Produtos", name: "Aparelho Ortodontico Fixo Est√©tico", base_value: 0, unit_value: 1500 },
      { code: "15", specialty: "Produtos", name: "Aparelho Ortodontico Fixo Porcelana", base_value: 0, unit_value: 1200 },
      { code: "16", specialty: "Cirurgia", name: "Apicetomia Birradicular Com Obtura√ß√£o Retr√≥grada", base_value: 0, unit_value: 749 },
      { code: "17", specialty: "Cirurgia", name: "Apicetomia Trirradicular", base_value: 0, unit_value: 849 },
      { code: "18", specialty: "Cirurgia", name: "Apicetomia Trirradicular Com Obtura√ß√£o Retr√≥grada", base_value: 0, unit_value: 949 },
      { code: "19", specialty: "Cirurgia", name: "Apicetomia Unirradicular", base_value: 0, unit_value: 449 },
      { code: "20", specialty: "Cirurgia", name: "Apicetomia Unirradicular Com Obtura√ß√£o Retr√≥grada", base_value: 0, unit_value: 549 },
      { code: "21", specialty: "Cl√≠nica geral", name: "Aplica√ß√£o De Cariost√°tico", base_value: 0, unit_value: 139 },
      { code: "22", specialty: "Cl√≠nica geral", name: "Aplica√ß√£o De Cariost√°tico Superior", base_value: 0, unit_value: 139 },
      { code: "23", specialty: "Cl√≠nica geral", name: "Aplica√ß√£o T√≥pica De Fl√∫or", base_value: 0, unit_value: 139 },
      { code: "24", specialty: "Cl√≠nica geral", name: "Atendimento Emerg√™ncial", base_value: 0, unit_value: 149 },
      { code: "25", specialty: "Cl√≠nica geral", name: "Aumento De Coroa Cl√≠nica", base_value: 0, unit_value: 379 },
      { code: "26", specialty: "Cl√≠nica geral", name: "Avalia√ß√£o com Endodontia", base_value: 0, unit_value: 0 },
      { code: "27", specialty: "Implantodontia", name: "Avalia√ß√£o Implante", base_value: 0, unit_value: 0 },
      { code: "28", specialty: "Odontopediatria", name: "Avalia√ß√£o Odontopediatria", base_value: 0, unit_value: 50 },
      { code: "29", specialty: "Periodontia", name: "Avalia√ß√£o Periodontal", base_value: 0, unit_value: 0 },
      { code: "30", specialty: "Ortodontia", name: "Banda Inferior", base_value: 0, unit_value: 0 },
      { code: "31", specialty: "Ortodontia", name: "Banda superior", base_value: 0, unit_value: 0 },
      { code: "32", specialty: "Cirurgia", name: "Biopsia", base_value: 0, unit_value: 600 },
      { code: "33", specialty: "Produtos", name: "Braquete Est√©tico", base_value: 0, unit_value: 50 },
      { code: "34", specialty: "Produtos", name: "Braquete Met√°lico", base_value: 10, unit_value: 10 },
      { code: "35", specialty: "Produtos", name: "Braquete Met√°lico Autoligado", base_value: 20, unit_value: 50 },
      { code: "36", specialty: "Produtos", name: "Braquete Porcelana", base_value: 0, unit_value: 50 },
      { code: "37", specialty: "Produtos", name: "Braquete Resina", base_value: 0, unit_value: 0 },
      { code: "38", specialty: "Produtos", name: "Caixinha de Aparelho", base_value: 0, unit_value: 7 },
      { code: "39", specialty: "SAC", name: "Cancelamento", base_value: 0, unit_value: 350 },
      { code: "40", specialty: "Produtos", name: "Cart√£o De Retorno", base_value: 0, unit_value: 1 },
      { code: "41", specialty: "Produtos", name: "Carteirinha Ortodontia", base_value: 0, unit_value: 1 },
      { code: "42", specialty: "Produtos", name: "Cera Ortod√¥ntica", base_value: 0, unit_value: 7 },
      { code: "43", specialty: "SAC", name: "Cess√£o De Contrato", base_value: 0, unit_value: 0 },
      { code: "44", specialty: "Cl√≠nica geral", name: "Cimenta√ß√£o De Pr√≥tese Provis√≥ria Ou Definitiva(Por Elemento)", base_value: 0, unit_value: 149 },
      { code: "45", specialty: "Cirurgia", name: "Cirurgia De T√≥rus Mandibular Bilateral", base_value: 0, unit_value: 619 },
      { code: "46", specialty: "Cirurgia", name: "Cirurgia De T√≥rus Mandibular Unilateral", base_value: 0, unit_value: 519 },
      { code: "47", specialty: "Cirurgia", name: "Cirurgia De T√≥rus Palatino", base_value: 0, unit_value: 680 },
      { code: "48", specialty: "Periodontia", name: "Cirurgia para Tracionamento", base_value: 0, unit_value: 369 },
      { code: "49", specialty: "Periodontia", name: "Cirurgia Retalho", base_value: 0, unit_value: 2875 },
      { code: "50", specialty: "Cl√≠nica geral", name: "Clareamento Intra Pulpar Por Elemento", base_value: 0, unit_value: 405 },
      { code: "51", specialty: "Cl√≠nica geral", name: "Clareamento Moldeira", base_value: 0, unit_value: 490 },
      { code: "52", specialty: "SAC", name: "Cobran√ßa", base_value: 0, unit_value: 0 },
      { code: "53", specialty: "Cl√≠nica geral", name: "Colagem De Fragmentos Dentais", base_value: 0, unit_value: 179 },
      { code: "54", specialty: "Cl√≠nica geral", name: "Colagem De Provisorios Por Pilares", base_value: 0, unit_value: 89 },
      { code: "55", specialty: "Ortodontia", name: "Colagem Inferior", base_value: 0, unit_value: 0 },
      { code: "56", specialty: "Ortodontia", name: "Colagem superior", base_value: 0, unit_value: 0 },
      { code: "57", specialty: "Pr√≥tese", name: "Colagem/Cimenta√ß√£o De Pr√≥tese Definitiva Por Pilares", base_value: 0, unit_value: 138 },
      { code: "58", specialty: "Cl√≠nica geral", name: "Condicionamento Infantil (Por Sess√£o)", base_value: 0, unit_value: 89 },
      { code: "59", specialty: "Produtos", name: "Conserto de Aparelho M√≥vel", base_value: 0, unit_value: 50 },
      { code: "60", specialty: "Implantodontia", name: "Conserto de Overdenture", base_value: 0, unit_value: 230 },
      { code: "61", specialty: "Pr√≥tese", name: "Conserto De Pr√≥tese Remov√≠vel Inferior", base_value: 0, unit_value: 139 },
      { code: "62", specialty: "Pr√≥tese", name: "Conserto De Pr√≥tese Remov√≠vel Superior", base_value: 0, unit_value: 159 },
      { code: "64", specialty: "Implantodontia", name: "Conserto de Protocolo", base_value: 0, unit_value: 575 },
      { code: "65", specialty: "Ortodontia", name: "Controle de Conten√ß√£o", base_value: 0, unit_value: 100 },
      { code: "66", specialty: "Ortodontia", name: "Controle de Erup√ß√£o", base_value: 0, unit_value: 100 },
      { code: "67", specialty: "Implantodontia", name: "Controle de Implante", base_value: 0, unit_value: 80 },
      { code: "68", specialty: "Cl√≠nica geral", name: "Controle De Placa Bacteriana", base_value: 0, unit_value: 159 },
      { code: "70", specialty: "Periodontia", name: "Controle Periodontal", base_value: 0, unit_value: 80 },
      { code: "71", specialty: "Pr√≥tese", name: "Coroa De A√ßo (Por Elemento)", base_value: 0, unit_value: 632 },
      { code: "72", specialty: "Pr√≥tese", name: "Coroa De Porcelana Pura (Por Elemento)", base_value: 0, unit_value: 1449 },
      { code: "73", specialty: "Cirurgia", name: "Cunha Distal", base_value: 0, unit_value: 216 },
      { code: "74", specialty: "Cl√≠nica geral", name: "Curativo (Puplectomia + Restaura√ß√£o Provisoria)", base_value: 0, unit_value: 214.8 },
      { code: "75", specialty: "Cl√≠nica geral", name: "Curativo Em Caso De Hemorragia Bucal", base_value: 0, unit_value: 216 },
      { code: "76", specialty: "Periodontia", name: "Curetagem De Bolsa", base_value: 0, unit_value: 149 },
      { code: "77", specialty: "SAC", name: "Desist√™ncia", base_value: 0, unit_value: 0 },
      { code: "78", specialty: "Radiologia", name: "Documenta√ß√£o de Alta", base_value: 0, unit_value: 80 },
      { code: "79", specialty: "Radiologia", name: "Documenta√ß√£o de Cancelamento", base_value: 0, unit_value: 150 },
      { code: "80", specialty: "Radiologia", name: "Documenta√ß√£o Ortod√¥ntica (Completa)", base_value: 0, unit_value: 150 },
      { code: "81", specialty: "SAC", name: "Elogios", base_value: 0, unit_value: 0 },
      { code: "82", specialty: "Ortodontia", name: "Emerg√™ncia", base_value: 0, unit_value: 149 },
      { code: "83", specialty: "Cl√≠nica geral", name: "Endodontia Birradicular", base_value: 0, unit_value: 698 },
      { code: "84", specialty: "Cl√≠nica geral", name: "Endodontia De Dec√≠duos Birradiculares", base_value: 0, unit_value: 598 },
      { code: "85", specialty: "Cl√≠nica geral", name: "Endodontia De Dec√≠duos Trirradiculares", base_value: 0, unit_value: 698 },
      { code: "86", specialty: "Cl√≠nica geral", name: "Endodontia De Dec√≠duos Unirradiculares", base_value: 0, unit_value: 498 },
      { code: "87", specialty: "Cl√≠nica geral", name: "Endodontia Trirradicular Ou Mais", base_value: 0, unit_value: 898 },
      { code: "88", specialty: "Cl√≠nica geral", name: "Endodontia Unirradicular", base_value: 0, unit_value: 598 },
      { code: "89", specialty: "Produtos", name: "Enxaguante Bucal", base_value: 0, unit_value: 23 },
      { code: "90", specialty: "Periodontia", name: "Enxerto Conjuntivo", base_value: 0, unit_value: 920 },
      { code: "91", specialty: "Implantodontia", name: "Enxerto De Bloco Localizado", base_value: 0, unit_value: 1014 },
      { code: "92", specialty: "Implantodontia", name: "Enxerto De Bloco Regi√£o De Incisivos A Caninos Direito (Superior)", base_value: 0, unit_value: 1014 },
      { code: "93", specialty: "Implantodontia", name: "Enxerto De Bloco Regi√£o De Incisivos A Caninos Esquerdo (Superior)", base_value: 0, unit_value: 1014 },
      { code: "94", specialty: "Implantodontia", name: "Enxerto De Bloco Regi√£o De Pr√© - Molares", base_value: 0, unit_value: 1014 },
      { code: "95", specialty: "Cirurgia", name: "Enxerto De Bloco Regi√£o De Pr√© - Molares A Molares Esquerdo (Superior)", base_value: 0, unit_value: 1014 },
      { code: "96", specialty: "Periodontia", name: "Enxerto Gengival Livre", base_value: 0, unit_value: 920 },
      { code: "97", specialty: "Implantodontia", name: "Enxerto Livre Por Elemento", base_value: 0, unit_value: 556 },
      { code: "98", specialty: "Implantodontia", name: "Enxerto Pediculado Por Elemento", base_value: 0, unit_value: 556 },
      { code: "99", specialty: "Produtos", name: "Escova Lingual", base_value: 0, unit_value: 16 },
      { code: "100", specialty: "Produtos", name: "Escova Ortod√¥ntica", base_value: 0, unit_value: 14 },
      { code: "101", specialty: "Periodontia", name: "Esplintagem (Por Dente)", base_value: 0, unit_value: 179 },
      { code: "102", specialty: "Cl√≠nica geral", name: "Evidencia√ß√£o De Placa Bacteriana (Por Sess√£o)", base_value: 0, unit_value: 139 },
      { code: "103", specialty: "Cl√≠nica geral", name: "Excis√£o De Mucocele", base_value: 0, unit_value: 449 },
      { code: "104", specialty: "Cirurgia", name: "Excis√£o De R√¢nula", base_value: 0, unit_value: 449 },
      { code: "106", specialty: "Cl√≠nica geral", name: "Exodontia De Terceiro Molar", base_value: 0, unit_value: 748 },
      { code: "107", specialty: "Cl√≠nica geral", name: "Exodontia Dentes Dec√≠duos", base_value: 0, unit_value: 129 },
      { code: "108", specialty: "Cl√≠nica geral", name: "Exodontia Extranumer√°rio", base_value: 0, unit_value: 369 },
      { code: "109", specialty: "Cl√≠nica geral", name: "Exodontia Raiz Residual", base_value: 0, unit_value: 172 },
      { code: "110", specialty: "Cl√≠nica geral", name: "Exodontia Simples", base_value: 0, unit_value: 129 },
      { code: "111", specialty: "Cl√≠nica geral", name: "Faceta Direta ( Elemento)", base_value: 0, unit_value: 319 },
      { code: "112", specialty: "Cl√≠nica geral", name: "Faceta Laminada De Resina", base_value: 0, unit_value: 598 },
      { code: "113", specialty: "Cl√≠nica geral", name: "Fechamento de Diastema", base_value: 0, unit_value: 239 },
      { code: "114", specialty: "Produtos", name: "Fio Dental", base_value: 0, unit_value: 6 },
      { code: "115", specialty: "Radiologia", name: "Fotografias Acompanhamento do Tratamento", base_value: 0, unit_value: 50 },
      { code: "116", specialty: "Cl√≠nica geral", name: "Frenectomia", base_value: 0, unit_value: 329 },
      { code: "117", specialty: "Produtos", name: "Garrafa Squezee", base_value: 0, unit_value: 6 },
      { code: "118", specialty: "Cl√≠nica geral", name: "Gengivectomia Por Elemento", base_value: 0, unit_value: 129 },
      { code: "119", specialty: "Cl√≠nica geral", name: "Gengivectomia Por Segmento", base_value: 0, unit_value: 330 },
      { code: "120", specialty: "Implantodontia", name: "Implante M√∫ltiplo", base_value: 0, unit_value: 1495 },
      { code: "121", specialty: "Implantodontia", name: "Implante Unit√°rio", base_value: 0, unit_value: 1210 },
      { code: "122", specialty: "Cl√≠nica geral", name: "Incis√£o E Drenagem De Abcesso Extra-Oral", base_value: 0, unit_value: 149 },
      { code: "123", specialty: "Cl√≠nica geral", name: "Incis√£o E Drenagem De Abcesso Intra-Oral", base_value: 0, unit_value: 149 },
      { code: "124", specialty: "SAC", name: "Informa√ß√£o", base_value: 0, unit_value: 0 },
      { code: "125", specialty: "Pr√≥tese", name: "Inlay Cer√¢mica", base_value: 0, unit_value: 1102 },
      { code: "126", specialty: "Pr√≥tese", name: "Inlay Resina", base_value: 0, unit_value: 862 },
      { code: "127", specialty: "Ortodontia", name: "Instala√ß√£o Aparelho M√≥vel Inferior", base_value: 0, unit_value: 250 },
      { code: "128", specialty: "Ortodontia", name: "Instala√ß√£o Aparelho M√≥vel Superior", base_value: 0, unit_value: 250 },
      { code: "129", specialty: "Implantodontia", name: "Instala√ß√£o de Pr√≥tese", base_value: 0, unit_value: 0 },
      { code: "130", specialty: "Produtos", name: "Kit Cerinha Com Passa Fio", base_value: 0, unit_value: 14 },
      { code: "131", specialty: "Produtos", name: "Kit Ortod√¥ntico", base_value: 0, unit_value: 36 },
      { code: "132", specialty: "Implantodontia", name: "Levantamento De Seio Maxilar Direito", base_value: 0, unit_value: 1109 },
      { code: "133", specialty: "Implantodontia", name: "Levantamento De Seio Maxilar Esquerdo", base_value: 0, unit_value: 1109 },
      { code: "134", specialty: "Ortodontia", name: "Levante de Mordida", base_value: 0, unit_value: 0 },
      { code: "135", specialty: "Cl√≠nica geral", name: "Mantenedor De Espa√ßo", base_value: 0, unit_value: 304 },
      { code: "136", specialty: "Ortodontia", name: "Manuten√ß√£o", base_value: 0, unit_value: 100 },
      { code: "137", specialty: "Pr√≥tese", name: "Metalocer√¢mica Unit√°ria", base_value: 0, unit_value: 1210 },
      { code: "138", specialty: "Ortodontia", name: "Mini Implante", base_value: 0, unit_value: 218 },
      { code: "139", specialty: "Radiologia", name: "Modelo Aparellho Extra", base_value: 0, unit_value: 0 },
      { code: "140", specialty: "Radiologia", name: "Modelo de Clareamento", base_value: 0, unit_value: 90 },
      { code: "141", specialty: "Radiologia", name: "Modelo de Estudo", base_value: 0, unit_value: 0 },
      { code: "142", specialty: "Cl√≠nica geral", name: "Moldagem", base_value: 0, unit_value: 0 },
      { code: "143", specialty: "Implantodontia", name: "Moldagem de Implante", base_value: 0, unit_value: 0 },
      { code: "144", specialty: "Ortodontia", name: "Moldagem Inferior", base_value: 0, unit_value: 0 },
      { code: "145", specialty: "Pr√≥tese", name: "Moldagem para Pr√≥tese", base_value: 0, unit_value: 0 },
      { code: "146", specialty: "Ortodontia", name: "Moldagem Superior", base_value: 0, unit_value: 150 },
      { code: "147", specialty: "Ortodontia", name: "Multa Contratual", base_value: 0, unit_value: 350 },
      { code: "148", specialty: "Produtos", name: "Necessiere", base_value: 0, unit_value: 15 },
      { code: "149", specialty: "Pr√≥tese", name: "N√∫cleo De Fibra De Carbono", base_value: 0, unit_value: 218 },
      { code: "150", specialty: "Pr√≥tese", name: "N√∫cleo Met√°lico Fundido", base_value: 0, unit_value: 218 },
      { code: "151", specialty: "Pr√≥tese", name: "Onlay Cer√¢mica", base_value: 0, unit_value: 1102 },
      { code: "152", specialty: "Pr√≥tese", name: "Onlay Resina", base_value: 0, unit_value: 870 },
      { code: "153", specialty: "Radiologia", name: "Radiografia Panor√¢mica (Com Laudo)", base_value: 0, unit_value: 75 },
      { code: "154", specialty: "Radiologia", name: "Radiografia Panor√¢mica (Sem Laudo)", base_value: 0, unit_value: 66 },
      { code: "155", specialty: "Radiologia", name: "Radiografia Panor√¢mica + Modelo De Estudo", base_value: 0, unit_value: 0 },
      { code: "156", specialty: "Produtos", name: "Passa Fio Caixa", base_value: 0, unit_value: 9 },
      { code: "157", specialty: "SAC", name: "Pedido De Documenta√ß√£o", base_value: 0, unit_value: 0 },
      { code: "158", specialty: "SAC", name: "Pedido De Raio X", base_value: 0, unit_value: 0 },
      { code: "159", specialty: "Cl√≠nica geral", name: "Placa De Mordida", base_value: 0, unit_value: 338 },
      { code: "160", specialty: "Cl√≠nica geral", name: "Placa Miorelaxante", base_value: 0, unit_value: 517 },
      { code: "161", specialty: "Pr√≥tese", name: "P√¥ntico Metalo Cer√¢mica", base_value: 0, unit_value: 966 },
      { code: "162", specialty: "Pr√≥tese", name: "P√¥ntico Resina", base_value: 0, unit_value: 345 },
      { code: "163", specialty: "Cirurgia", name: "Pr√© Cir√∫rgico", base_value: 0, unit_value: 80 },
      { code: "164", specialty: "Cl√≠nica geral", name: "Profilaxia (Escova De Robinson ou Ta√ßa)", base_value: 0, unit_value: 149 },
      { code: "165", specialty: "Cl√≠nica geral", name: "Profilaxia (Ultrasom+Jato De Bicarbonato)", base_value: 0, unit_value: 169 },
      { code: "166", specialty: "Pr√≥tese", name: "Pr√≥tese Fixa Adesiva (3 Elementos)", base_value: 0, unit_value: 1207 },
      { code: "167", specialty: "Pr√≥tese", name: "Pr√≥tese Fixa Adesiva Sem Metal (3 Elementos)", base_value: 0, unit_value: 1035 },
      { code: "168", specialty: "Pr√≥tese", name: "Protese Parcial Inferior Com Arma√ß√£o Met√°lica (Apr)", base_value: 0, unit_value: 1343 },
      { code: "169", specialty: "Pr√≥tese", name: "Pr√≥tese Parcial Provis√≥ria Inferior (Ppr)", base_value: 0, unit_value: 483 },
      { code: "170", specialty: "Pr√≥tese", name: "Pr√≥tese Parcial Provis√≥ria Superior (Ppr)", base_value: 0, unit_value: 483 },
      { code: "171", specialty: "Pr√≥tese", name: "Pr√≥tese Parcial Provis√≥ria Superior Com Arco Vestibular (Ppr)", base_value: 0, unit_value: 483 },
      { code: "172", specialty: "Pr√≥tese", name: "Pr√≥tese Parcial Superior Com Arma√ß√£o Met√°lica (Apr)", base_value: 0, unit_value: 1343 },
      { code: "173", specialty: "Pr√≥tese", name: "Pr√≥tese Resina Unit√°rio", base_value: 0, unit_value: 368 },
      { code: "174", specialty: "Pr√≥tese", name: "Pr√≥tese Total Inferior Definitiva Caracterizada + Dentes Importados", base_value: 0, unit_value: 1610 },
      { code: "175", specialty: "Pr√≥tese", name: "Pr√≥tese Total Inferior Definitiva Simples", base_value: 0, unit_value: 920 },
      { code: "176", specialty: "Pr√≥tese", name: "Pr√≥tese Total Inferior Provis√≥ria", base_value: 0, unit_value: 678 },
      { code: "177", specialty: "Pr√≥tese", name: "Pr√≥tese Total Superior Definitiva Caracterizada + Dentes Importados", base_value: 0, unit_value: 1610 },
      { code: "178", specialty: "Pr√≥tese", name: "Pr√≥tese Total Superior Definitiva Simples", base_value: 0, unit_value: 920 },
      { code: "179", specialty: "Pr√≥tese", name: "Pr√≥tese Total Superior Provis√≥ria", base_value: 0, unit_value: 678 },
      { code: "180", specialty: "SAC", name: "Protesto", base_value: 0, unit_value: 0 },
      { code: "181", specialty: "Cl√≠nica geral", name: "Prova de cor", base_value: 0, unit_value: 0 },
      { code: "182", specialty: "Cl√≠nica geral", name: "Pulpotomia + Restaura√ß√£o Provis√≥ria", base_value: 0, unit_value: 149 },
      { code: "183", specialty: "Radiologia", name: "Radiografia Bite-Wing", base_value: 0, unit_value: 30 },
      { code: "184", specialty: "Radiologia", name: "Radiografia Periapical", base_value: 0, unit_value: 25 },
      { code: "185", specialty: "Cl√≠nica geral", name: "Raspagem Inferior Leve", base_value: 0, unit_value: 76 },
      { code: "186", specialty: "Cl√≠nica geral", name: "Raspagem Inferior Moderada", base_value: 0, unit_value: 98 },
      { code: "187", specialty: "Cl√≠nica geral", name: "Raspagem Inferior Severa", base_value: 0, unit_value: 146 },
      { code: "188", specialty: "Cl√≠nica geral", name: "Raspagem Superior Leve", base_value: 0, unit_value: 76 },
      { code: "189", specialty: "Cl√≠nica geral", name: "Raspagem Superior Moderada", base_value: 0, unit_value: 98 },
      { code: "190", specialty: "Cl√≠nica geral", name: "Raspagem Superior Severa", base_value: 0, unit_value: 146 },
      { code: "191", specialty: "Implantodontia", name: "Reabertura de Implante", base_value: 0, unit_value: 145 },
      { code: "192", specialty: "Cl√≠nica geral", name: "Reanatomiza√ß√£o", base_value: 0, unit_value: 350 },
      { code: "193", specialty: "SAC", name: "Reclama√ß√µes", base_value: 0, unit_value: 0 },
      { code: "194", specialty: "Ortodontia", name: "Reposicao Braquete Individual Inferior", base_value: 0, unit_value: 10 },
      { code: "195", specialty: "Ortodontia", name: "Reposicao Braquete Individual Superior", base_value: 0, unit_value: 10 },
      { code: "196", specialty: "Cl√≠nica geral", name: "Reconstru√ß√£o De Dente Anterior", base_value: 0, unit_value: 350 },
      { code: "197", specialty: "Cl√≠nica geral", name: "Reconstru√ß√£o De Dente Anterior sem pino", base_value: 0, unit_value: 350 },
      { code: "198", specialty: "Pr√≥tese", name: "Reembasamento De Pr√≥tese Inferior", base_value: 0, unit_value: 253 },
      { code: "199", specialty: "Pr√≥tese", name: "Reembasamento De Pr√≥tese Superior", base_value: 0, unit_value: 253 },
      { code: "200", specialty: "Cl√≠nica geral", name: "Reimplante De Dente Avulcionado", base_value: 0, unit_value: 172 },
      { code: "201", specialty: "Ortodontia", name: "Remo√ß√£o de Aparelho", base_value: 0, unit_value: 100 },
      { code: "202", specialty: "Periodontia", name: "Remo√ß√£o de Cisto", base_value: 0, unit_value: 345 },
      { code: "203", specialty: "Implantodontia", name: "Remo√ß√£o de Implante", base_value: 0, unit_value: 359 },
      { code: "204", specialty: "Pr√≥tese", name: "Remo√ß√£o De N√∫cleo Ou Pino Intrarradicular", base_value: 0, unit_value: 403 },
      { code: "205", specialty: "Cl√≠nica geral", name: "Remo√ß√£o De Sutura", base_value: 0, unit_value: 0 },
      { code: "206", specialty: "SAC", name: "Renegocia√ß√µes", base_value: 0, unit_value: 0 },
      { code: "207", specialty: "Cl√≠nica geral", name: "Restaura√ß√£o Classe I", base_value: 0, unit_value: 157 },
      { code: "208", specialty: "Cl√≠nica geral", name: "Restaura√ß√£o Classe Il Com Envolvimento De C√∫spide 2 Faces", base_value: 0, unit_value: 187 },
      { code: "209", specialty: "Cl√≠nica geral", name: "Restaura√ß√£o Classe Il Com Envolvimento De C√∫spide 3 Faces", base_value: 0, unit_value: 197 },
      { code: "210", specialty: "Cl√≠nica geral", name: "Restaura√ß√£o Classe Il Mod Com Extens√£o P Ou V", base_value: 0, unit_value: 197 },
      { code: "211", specialty: "Cl√≠nica geral", name: "Restaura√ß√£o Classe Il OD", base_value: 0, unit_value: 169 },
      { code: "212", specialty: "Cl√≠nica geral", name: "Restaura√ß√£o Classe Il OM", base_value: 0, unit_value: 169 },
      { code: "213", specialty: "Cl√≠nica geral", name: "Restaura√ß√£o Classe Ill Distal", base_value: 0, unit_value: 167 },
      { code: "214", specialty: "Cl√≠nica geral", name: "Restaura√ß√£o Classe Ill Mesial", base_value: 0, unit_value: 167 },
      { code: "215", specialty: "Cl√≠nica geral", name: "Restaura√ß√£o Classe IV Distal", base_value: 0, unit_value: 179 },
      { code: "216", specialty: "Cl√≠nica geral", name: "Restaura√ß√£o Classe IV Mesial", base_value: 0, unit_value: 179 },
      { code: "217", specialty: "Cl√≠nica geral", name: "Restaura√ß√£o Classe l com Extens√£o Lingual", base_value: 0, unit_value: 167 },
      { code: "218", specialty: "Cl√≠nica geral", name: "Restaura√ß√£o Classe l com Extens√£o Palatina", base_value: 0, unit_value: 167 },
      { code: "219", specialty: "Cl√≠nica geral", name: "Restaura√ß√£o Classe l com Extens√£o Vestibular", base_value: 0, unit_value: 167 },
      { code: "220", specialty: "Cl√≠nica geral", name: "Restaura√ß√£o Classe l com Extens√£o Vest√≠bulo Lingual", base_value: 0, unit_value: 167 },
      { code: "221", specialty: "Cl√≠nica geral", name: "Restaura√ß√£o Classe l com Extens√£o Vest√≠bulo Palatal", base_value: 0, unit_value: 177 },
      { code: "222", specialty: "Cl√≠nica geral", name: "Restaura√ß√£o Classe ll MOD", base_value: 0, unit_value: 197 },
      { code: "223", specialty: "Cl√≠nica geral", name: "Restaura√ß√£o Classe V Radicular Lingual", base_value: 0, unit_value: 167 },
      { code: "224", specialty: "Cl√≠nica geral", name: "Restaura√ß√£o Classe V Radicular Palatina", base_value: 0, unit_value: 167 },
      { code: "225", specialty: "Cl√≠nica geral", name: "Restaura√ß√£o Classe V Radicular Vestibular", base_value: 0, unit_value: 167 },
      { code: "226", specialty: "Cl√≠nica geral", name: "Restaura√ß√£o Classe V Vestibular", base_value: 0, unit_value: 167 },
      { code: "227", specialty: "Cl√≠nica geral", name: "Restaura√ß√£o Classe Vi (Ponta De Cuspide Ou Incisal)", base_value: 0, unit_value: 167 },
      { code: "228", specialty: "Cl√≠nica geral", name: "Restaura√ß√£o De Ion√¥mero", base_value: 0, unit_value: 142 },
      { code: "229", specialty: "Cl√≠nica geral", name: "Restaura√ß√£o Ion√¥mero de Vidro (Provis√≥ria)", base_value: 0, unit_value: 142 },
      { code: "230", specialty: "Cl√≠nica geral", name: "Restaura√ß√£o Preventiva Lingual", base_value: 0, unit_value: 142 },
      { code: "231", specialty: "Cl√≠nica geral", name: "Restaura√ß√£o Preventiva Palatina", base_value: 0, unit_value: 142 },
      { code: "232", specialty: "Cl√≠nica geral", name: "Restaura√ß√£o Preventiva Vestibular", base_value: 0, unit_value: 142 },
      { code: "233", specialty: "Cl√≠nica geral", name: "Restaura√ß√£o Reconstru√ß√£o Dente Posterior Com Pino", base_value: 0, unit_value: 789 },
      { code: "234", specialty: "Cl√≠nica geral", name: "Restaura√ß√£o Reconstru√ß√£o Dente Posterior Sem Pino", base_value: 0, unit_value: 712 },
      { code: "235", specialty: "Cl√≠nica geral", name: "Restaura√ß√£o Tempor√°ria (Ion√¥mero)", base_value: 0, unit_value: 142 },
      { code: "236", specialty: "Cl√≠nica geral", name: "Restaura√ß√£o Tempor√°ria (Irm)", base_value: 0, unit_value: 99 },
      { code: "237", specialty: "Periodontia", name: "Retalho Pediculado", base_value: 0, unit_value: 345 },
      { code: "238", specialty: "SAC", name: "Retirada De Documenta√ß√£o", base_value: 0, unit_value: 0 },
      { code: "239", specialty: "Cl√≠nica geral", name: "Retirada de Pontos", base_value: 0, unit_value: 0 },
      { code: "240", specialty: "Cl√≠nica geral", name: "Retratamento Birradicular Automatizado", base_value: 0, unit_value: 898 },
      { code: "241", specialty: "Cl√≠nica geral", name: "Retratamento Trirradicular Automatizado", base_value: 0, unit_value: 1198 },
      { code: "242", specialty: "Cl√≠nica geral", name: "Retratamento Unirradicular Automatizado", base_value: 0, unit_value: 698 },
      { code: "243", specialty: "Cl√≠nica geral", name: "Selante", base_value: 0, unit_value: 100 },
      { code: "244", specialty: "Ortodontia", name: "Separador", base_value: 0, unit_value: 0 },
      { code: "245", specialty: "Produtos", name: "Skate", base_value: 0, unit_value: 0 },
      { code: "246", specialty: "SAC", name: "Transfer√™ncias", base_value: 0, unit_value: 0 },
      { code: "247", specialty: "Cl√≠nica geral", name: "Tratamento De Alveolite", base_value: 0, unit_value: 139 },
      { code: "248", specialty: "Cl√≠nica geral", name: "Tratamento Expectante + OZE (sess√£o)", base_value: 0, unit_value: 115 },
      { code: "249", specialty: "Produtos", name: "Troca de Borrachas do Aparelho", base_value: 0, unit_value: 10 },
      { code: "250", specialty: "SAC", name: "Troca De Dentistas", base_value: 0, unit_value: 0 },
      { code: "251", specialty: "Odontopediatria", name: "Ulectomia", base_value: 0, unit_value: 179 },
      { code: "252", specialty: "Radiologia", name: "Aparelho Extra", base_value: 0, unit_value: 250 },
      { code: "253", specialty: "Cl√≠nica geral", name: "Clareamento a Laser", base_value: 0, unit_value: 890 },
      { code: "254", specialty: "Cl√≠nica geral", name: "Exodontia de Dente Semi Incluso", base_value: 0, unit_value: 402 },
      { code: "255", specialty: "Cl√≠nica geral", name: "Exodontia de Dente Incluso e Impactado", base_value: 0, unit_value: 750 },
      { code: "256", specialty: "Cl√≠nica geral", name: "Moldagem Clareamento", base_value: 0, unit_value: 0 },
      { code: "257", specialty: "Pr√≥tese", name: "Protese Unitaria Provisoria (Dente de Estoque)", base_value: 0, unit_value: 100 },
      { code: "258", specialty: "Pr√≥tese", name: "Protese Unitaria Provisoria (Laboratorio)", base_value: 0, unit_value: 228 },
      { code: "259", specialty: "Cl√≠nica geral", name: "Restauracao 01 Face", base_value: 0, unit_value: 167 },
      { code: "260", specialty: "Cl√≠nica geral", name: "Restauracao 02 Face", base_value: 0, unit_value: 177 },
      { code: "261", specialty: "Cl√≠nica geral", name: "Restauracao 03 Face", base_value: 0, unit_value: 197 },
      { code: "262", specialty: "Cl√≠nica geral", name: "Restauracao 04 Face", base_value: 0, unit_value: 209 },
      { code: "263", specialty: "Cl√≠nica geral", name: "Restauracao 05 Face", base_value: 0, unit_value: 252 },
      { code: "264", specialty: "Pr√≥tese", name: "Protese Fixa Adesiva (4 Elementos)", base_value: 0, unit_value: 1380 },
      { code: "265", specialty: "Pr√≥tese", name: "Protese Fixa Adesiva Sem Metal (4 Elementos)", base_value: 0, unit_value: 1380 },
      { code: "266", specialty: "Ortodontia", name: "Remocao mini implante", base_value: 0, unit_value: 0 },
      { code: "267", specialty: "Ortodontia", name: "Instala√ß√£o de Aparelho Est√©tico", base_value: 0, unit_value: 0 },
      { code: "268", specialty: "Ortodontia", name: "Instala√ß√£o de Aparelho AutoLigado", base_value: 0, unit_value: 0 },
      { code: "269", specialty: "Radiologia", name: "Contencao Superior", base_value: 0, unit_value: 200 },
      { code: "270", specialty: "Radiologia", name: "Contencao Inferior", base_value: 0, unit_value: 100 },
      { code: "271", specialty: "Radiologia", name: "Aparelho Movel - Arco de Hawley", base_value: 0, unit_value: 250 },
      { code: "272", specialty: "Radiologia", name: "Aparelho Movel - Arco Lingual", base_value: 0, unit_value: 250 },
      { code: "273", specialty: "Radiologia", name: "Aparelho Movel - Batente Anterior", base_value: 0, unit_value: 250 },
      { code: "274", specialty: "Radiologia", name: "Aparelho Movel - Batente Inferior", base_value: 0, unit_value: 250 },
      { code: "275", specialty: "Radiologia", name: "Aparelho Movel - Bionator", base_value: 0, unit_value: 250 },
      { code: "276", specialty: "Radiologia", name: "Aparelho Movel - BN (Botao de Nance)", base_value: 0, unit_value: 250 },
      { code: "277", specialty: "Radiologia", name: "Aparelho Movel - BTP", base_value: 0, unit_value: 250 },
      { code: "278", specialty: "Radiologia", name: "Aparelho Movel - Expansor", base_value: 0, unit_value: 250 },
      { code: "279", specialty: "Radiologia", name: "Aparelho Movel - FP (Front Plato)", base_value: 0, unit_value: 250 },
      { code: "280", specialty: "Radiologia", name: "Aparelho Movel - Grade Palatina", base_value: 0, unit_value: 250 },
      { code: "281", specialty: "Radiologia", name: "Aparelho Movel - Hyrax", base_value: 0, unit_value: 250 },
      { code: "282", specialty: "Radiologia", name: "Aparelho Movel - Levante de Mordida", base_value: 0, unit_value: 250 },
      { code: "283", specialty: "Radiologia", name: "Aparelho Movel - Placa de Acetato", base_value: 0, unit_value: 250 },
      { code: "284", specialty: "Radiologia", name: "Aparelho Movel - Hass", base_value: 0, unit_value: 250 },
      { code: "285", specialty: "Ortodontia", name: "Colagem de Tubo", base_value: 0, unit_value: 0 },
      { code: "286", specialty: "SAC", name: "Retorno de Contrato", base_value: 0, unit_value: 0 },
      { code: "287", specialty: "Cl√≠nica geral", name: "Controle de Clareamento", base_value: 0, unit_value: 100 },
      { code: "288", specialty: "Cl√≠nica geral", name: "Acompanhamento Clinico", base_value: 0, unit_value: 80 },
      { code: "289", specialty: "Cl√≠nica geral", name: "Avalia√ß√£o Clinica", base_value: 0, unit_value: 140 },
      { code: "290", specialty: "Ortodontia", name: "Instala√ß√£o de Conten√ß√£o Superior e Inferior", base_value: 0, unit_value: 300 },
      { code: "291", specialty: "Implantodontia", name: "Protocolo sobre Implante - Superior (Fase Cirurgia)", base_value: 0, unit_value: 6900 },
      { code: "292", specialty: "Implantodontia", name: "Protocolo sobre Implante - Inferior (Fase Cirurgia)", base_value: 0, unit_value: 6900 },
      { code: "293", specialty: "Cl√≠nica geral", name: "Remo√ß√£o de Aparelho", base_value: 0, unit_value: 100 },
      { code: "294", specialty: "Ortodontia", name: "Instala√ß√£o de Conten√ß√£o Superior", base_value: 0, unit_value: 200 },
      { code: "295", specialty: "Ortodontia", name: "Instala√ß√£o de Conten√ß√£o Inferior", base_value: 0, unit_value: 100 },
      { code: "296", specialty: "Implantodontia", name: "Higieniza√ß√£o de Protocolo", base_value: 0, unit_value: 899 },
      { code: "297", specialty: "Ortodontia", name: "Fotografias Acompanhamento Ortodontia", base_value: 0, unit_value: 0 },
      { code: "298", specialty: "Cl√≠nica geral", name: "Retorno de Tratamento", base_value: 0, unit_value: 0 },
      { code: "299", specialty: "Cl√≠nica geral", name: "Piercing Dental", base_value: 0, unit_value: 172 },
      { code: "300", specialty: "Ortodontia", name: "Instala√ß√£o Aparelho Propulsor Mandibular", base_value: 0, unit_value: 250 },
      { code: "301", specialty: "Ortodontia", name: "Separador Superior", base_value: 0, unit_value: 0 },
      { code: "302", specialty: "Ortodontia", name: "Separador Inferior", base_value: 0, unit_value: 0 },
      { code: "304", specialty: "Pr√≥tese", name: "Retorno Pr√≥tese", base_value: 0, unit_value: 0 },
      { code: "305", specialty: "Produtos", name: "Aparelho Ortodontico Fixo Autoligado Est√©tico", base_value: 0, unit_value: 1500 },
      { code: "306", specialty: "Produtos", name: "2¬∞ Via Carn√™", base_value: 0, unit_value: 20 },
      { code: "307", specialty: "Produtos", name: "Caixa de El√°stico Ortod√¥ntico", base_value: 0, unit_value: 5 },
      { code: "308", specialty: "Pr√≥tese", name: "Coroa Provis√≥ria", base_value: 0, unit_value: 228 },
      { code: "309", specialty: "Pr√≥tese", name: "Coroa De Zirc√¥nia", base_value: 0, unit_value: 1495 },
      { code: "310", specialty: "Cl√≠nica geral", name: "Faceta por elemento", base_value: 0, unit_value: 1200 },
      { code: "311", specialty: "Cl√≠nica geral", name: "Tratamento de Gengivite (por arcada)", base_value: 0, unit_value: 129 },
      { code: "312", specialty: "Periodontia", name: "Hiperplasia Gengival", base_value: 0, unit_value: 1150 },
      { code: "313", specialty: "Radiologia", name: "Tomografia", base_value: 0, unit_value: 110 },
      { code: "314", specialty: "Produtos", name: "Escova Interdental", base_value: 0, unit_value: 17 },
      { code: "315", specialty: "Produtos", name: "Refil Escova Interdental", base_value: 0, unit_value: 25 },
      { code: "316", specialty: "Produtos", name: "Escova Unitufo", base_value: 0, unit_value: 12 },
      { code: "317", specialty: "Cl√≠nica geral", name: "Dessensibiliza√ß√£o Dent√°ria", base_value: 0, unit_value: 119 },
      { code: "318", specialty: "Ortodontia", name: "Controle Ortodontico", base_value: 0, unit_value: 100 },
      { code: "319", specialty: "Pr√≥tese", name: "Pr√≥tese Fixa (Por Elemento)", base_value: 0, unit_value: 1135 },
      { code: "320", specialty: "Pr√≥tese", name: "Cunha Proximal", base_value: 0, unit_value: 110 },
      { code: "321", specialty: "Cl√≠nica geral", name: "Polimento", base_value: 0, unit_value: 399 },
      { code: "322", specialty: "Pr√≥tese", name: "Protese - Troca de Elemento", base_value: 0, unit_value: 148 },
      { code: "323", specialty: "Cl√≠nica geral", name: "Remineraliza√ß√£o - Fluor", base_value: 0, unit_value: 88 },
      { code: "324", specialty: "Pr√≥tese", name: "Pr√≥tese Superior Overdenture", base_value: 0, unit_value: 1925 },
      { code: "325", specialty: "Pr√≥tese", name: "Pr√≥tese Inferior Overdenture", base_value: 0, unit_value: 1925 },
      { code: "326", specialty: "Cl√≠nica geral", name: "Exodontia Molar", base_value: 0, unit_value: 180 },
      { code: "327", specialty: "Cl√≠nica geral", name: "Exodontia Pr√© Molar", base_value: 0, unit_value: 129 },
      { code: "328", specialty: "Cl√≠nica geral", name: "Restaura√ß√£o OD com extens√£o Vest√≠bulo Lingual", base_value: 0, unit_value: 199 },
      { code: "329", specialty: "Cl√≠nica geral", name: "N√∫cleo de preenchimento", base_value: 0, unit_value: 218 },
      { code: "330", specialty: "Cl√≠nica geral", name: "Restaura√ß√£o Classe III Mesial Distal", base_value: 0, unit_value: 189 },
      { code: "334", specialty: "Pr√≥tese", name: "Pr√≥tese Total Nacional", base_value: 0, unit_value: 1399 },
      { code: "335", specialty: "Pr√≥tese", name: "Pr√≥tese Total Importada", base_value: 0, unit_value: 1799 },
      { code: "336", specialty: "Cl√≠nica geral", name: "Remo√ß√£o de Resina", base_value: 0, unit_value: 80 },
      { code: "337", specialty: "Periodontia", name: "Raspagem Supra Gengival", base_value: 0, unit_value: 79 },
      { code: "338", specialty: "Periodontia", name: "Raspagem Sub Gengival", base_value: 0, unit_value: 119 },
      { code: "339", specialty: "Pr√≥tese", name: "Avalia√ß√£o Protese", base_value: 0, unit_value: 0 },
      { code: "340", specialty: "Cirurgia", name: "Avalia√ß√£o Bucomaxilo", base_value: 0, unit_value: 0 },
      { code: "341", specialty: "Radiologia", name: "Documenta√ß√£o Pr√© Conten√ß√£o", base_value: 0, unit_value: 150 },
      { code: "342", specialty: "Cl√≠nica geral", name: "Profilaxia (Campanha)", base_value: 0, unit_value: 99.9 },
      { code: "343", specialty: "Radiologia", name: "Radiografia Panor√¢mica (Campanha)", base_value: 0, unit_value: 59 },
      { code: "347", specialty: "Ortodontia", name: "GlassLine - 6 Meses", base_value: 0, unit_value: 5500 },
      { code: "348", specialty: "Ortodontia", name: "GlassLine - 12 Meses", base_value: 0, unit_value: 5500 },
      { code: "349", specialty: "Ortodontia", name: "GlassLine - 18 Meses", base_value: 0, unit_value: 5500 },
      { code: "350", specialty: "Ortodontia", name: "GlassLine - 24 Meses", base_value: 0, unit_value: 0 },
      { code: "351", specialty: "Alinhadores", name: "Conten√ß√£o Alinhador", base_value: 0, unit_value: 350 },
      { code: "352", specialty: "Radiologia", name: "Escaneamento Alinhador", base_value: 0, unit_value: 249 },
      { code: "353", specialty: "Cl√≠nica geral", name: "Lente de Contato", base_value: 0, unit_value: 750 },
      { code: "354", specialty: "Odontopediatria", name: "Consulta Odontopediatria", base_value: 0, unit_value: 50 },
      { code: "355", specialty: "Radiologia", name: "Tomografia Maxila Total", base_value: 0, unit_value: 0 },
      { code: "356", specialty: "Radiologia", name: "Tomografia Mand√≠bula Total", base_value: 0, unit_value: 0 },
      { code: "357", specialty: "Radiologia", name: "Tomografia Maxima + Mand√≠bula", base_value: 0, unit_value: 0 },
      { code: "358", specialty: "Cl√≠nica geral", name: "Endodontia Unirradicular Manual", base_value: 0, unit_value: 0 },
      { code: "359", specialty: "Cl√≠nica geral", name: "Endodontia Birradicular Manual", base_value: 0, unit_value: 0 },
      { code: "360", specialty: "Cl√≠nica geral", name: "Endodontia Trirradicular Ou Mais Manual", base_value: 0, unit_value: 0 },
      { code: "361", specialty: "Cl√≠nica geral", name: "Endodontia Unirradicular Automatizada", base_value: 0, unit_value: 598 },
      { code: "362", specialty: "Cl√≠nica geral", name: "Endodontia Birradicular Automatizada", base_value: 0, unit_value: 698 },
      { code: "363", specialty: "Cl√≠nica geral", name: "Endodontia Trirradicular Ou Mais Automatizada", base_value: 0, unit_value: 898 },
      { code: "364", specialty: "Cl√≠nica geral", name: "Retratamento Unirradicular Manual", base_value: 0, unit_value: 0 },
      { code: "365", specialty: "Cl√≠nica geral", name: "Retratamento Birradicular Manual", base_value: 0, unit_value: 0 },
      { code: "366", specialty: "Cl√≠nica geral", name: "Retratamento Trirradicular Manual", base_value: 0, unit_value: 0 },
      { code: "367", specialty: "Cl√≠nica geral", name: "Restaura√ß√£o Classe II OD ou OM Com Extens√£o P ou V ou L", base_value: 0, unit_value: 197 },
      { code: "368", specialty: "Harmoniza√ß√£o Facial", name: "Botox - Ter√ßo Superior", base_value: 0, unit_value: 0 },
      { code: "369", specialty: "Harmoniza√ß√£o Facial", name: "Botox - Canto do Olho", base_value: 0, unit_value: 0 },
      { code: "370", specialty: "Harmoniza√ß√£o Facial", name: "Botox - Glabela", base_value: 0, unit_value: 0 },
      { code: "371", specialty: "Harmoniza√ß√£o Facial", name: "Botox - Rugas da Fronte (Testa)", base_value: 0, unit_value: 0 },
      { code: "372", specialty: "Harmoniza√ß√£o Facial", name: "Botox - Sorriso Gengival", base_value: 0, unit_value: 0 },
      { code: "373", specialty: "Harmoniza√ß√£o Facial", name: "Botox - Bruxismo", base_value: 0, unit_value: 0 },
      { code: "374", specialty: "Harmoniza√ß√£o Facial", name: "Preenchimento Labial", base_value: 0, unit_value: 0 },
      { code: "375", specialty: "Harmoniza√ß√£o Facial", name: "Bichectomia", base_value: 0, unit_value: 0 },
      { code: "376", specialty: "Periodontia", name: "Raspagem Severa de Campo Aberto", base_value: 0, unit_value: 450 },
      { code: "377", specialty: "Cl√≠nica geral", name: "Aumento de Coroa Est√©tica", base_value: 0, unit_value: 290 },
      { code: "378", specialty: "Periodontia", name: "Cirurgia para Tracionamento + Exo Supra", base_value: 0, unit_value: 488 },
      { code: "379", specialty: "Periodontia", name: "Cirurgia para Tracionamento + Odontonia", base_value: 0, unit_value: 679 },
      { code: "380", specialty: "Cl√≠nica geral", name: "Exodontia De Terceiro Molar - Classe I", base_value: 0, unit_value: 253 },
      { code: "381", specialty: "Cl√≠nica geral", name: "Exodontia De Terceiro Molar - Classe II", base_value: 0, unit_value: 508 },
      { code: "382", specialty: "Cl√≠nica geral", name: "Exodontia De Terceiro Molar - Classe III", base_value: 0, unit_value: 748 },
      { code: "383", specialty: "Cl√≠nica geral", name: "Exodontia Supranumer√°rio I", base_value: 0, unit_value: 200 },
      { code: "384", specialty: "Cl√≠nica geral", name: "Exodontia Extranumer√°rio II", base_value: 0, unit_value: 350 },
      { code: "385", specialty: "Pr√≥tese", name: "Prova de chapa", base_value: 0, unit_value: 0 },
      { code: "386", specialty: "Pr√≥tese", name: "Prova do metal", base_value: 0, unit_value: 0 },
      { code: "387", specialty: "Pr√≥tese", name: "Prova dos Dentes", base_value: 0, unit_value: 0 },
      { code: "388", specialty: "Implantodontia", name: "Protocolo sobre Implante - Superior (Fase Protese)", base_value: 0, unit_value: 6900 },
      { code: "389", specialty: "Implantodontia", name: "Protocolo sobre Implante - Inferior (Fase Protese)", base_value: 0, unit_value: 6900 },
      { code: "390", specialty: "Implantodontia", name: "Cirurgia Mini Implante", base_value: 0, unit_value: 150 },
      { code: "391", specialty: "Cl√≠nica geral", name: "Exodontia Terceiro Molar Inferior - Erupcionado", base_value: 0, unit_value: 253 },
      { code: "392", specialty: "Cl√≠nica geral", name: "Exodontia Terceiro Molar Inferior - N√£o Erupcionado", base_value: 0, unit_value: 508 },
      { code: "393", specialty: "Cl√≠nica geral", name: "Exodontia Terceiro Molar Inferior - Com contato mandibular", base_value: 0, unit_value: 748 },
      { code: "394", specialty: "Cl√≠nica geral", name: "Exodontia Terceiro Molar Superior - Erupcionado", base_value: 0, unit_value: 253 },
      { code: "395", specialty: "Cl√≠nica geral", name: "Exodontia Terceiro Molar Superior - N√£o Erupcionado", base_value: 0, unit_value: 408 },
      { code: "396", specialty: "Cl√≠nica geral", name: "Exodontia Terceiro Molar Superior - Com maior grau de dificuldade", base_value: 0, unit_value: 848 },
      { code: "397", specialty: "Cl√≠nica geral", name: "Restaura√ß√£o classe V com extens√£o Mesial e Distal", base_value: 0, unit_value: 175 },
      { code: "398", specialty: "Harmoniza√ß√£o Facial", name: "Botox - Retoque", base_value: 0, unit_value: 0 },
      { code: "399", specialty: "Produtos", name: "Kit Infantil", base_value: 0, unit_value: 20 },
      { code: "400", specialty: "Cl√≠nica geral", name: "Reanatomiza√ß√£o est√©tica", base_value: 0, unit_value: 0 },
      { code: "401", specialty: "Cirurgia", name: "Osteoplastia", base_value: 0, unit_value: 0 },
      { code: "402", specialty: "Produtos", name: "Braquete Est√©tico Autoligado", base_value: 0, unit_value: 50 },
      { code: "404", specialty: "Pr√≥tese", name: "Protese Parcial Inferior Com Arma√ß√£o Met√°lica (Apr) Dente Importado", base_value: 0, unit_value: 0 },
      { code: "405", specialty: "Pr√≥tese", name: "Protese Parcial Superior Com Arma√ß√£o Met√°lica (Apr) Dente Importado", base_value: 0, unit_value: 0 },
      { code: "406", specialty: "Radiologia", name: "Teleradiografia", base_value: 0, unit_value: 0 },
      { code: "407", specialty: "Cl√≠nica geral", name: "Capeamento Pulpar", base_value: 0, unit_value: 100 },
      { code: "408", specialty: "Cl√≠nica geral", name: "Forramento de Dente", base_value: 0, unit_value: 0 },
      { code: "409", specialty: "Pr√≥tese", name: "Metalocer√¢mica Sobre Implante", base_value: 0, unit_value: 0 },
      { code: "410", specialty: "Cl√≠nica geral", name: "Raspagem Completa", base_value: 0, unit_value: 0 },
      { code: "411", specialty: "Cl√≠nica geral", name: "Clareamento H√≠brido", base_value: 0, unit_value: 0 },
      { code: "412", specialty: "Pr√≥tese", name: "Coroa Provisoria CAD/CAM", base_value: 0, unit_value: 0 },
      { code: "413", specialty: "Cl√≠nica geral", name: "Extra√ß√£o de Siso", base_value: 0, unit_value: 0 },
      { code: "414", specialty: "Cl√≠nica geral", name: "Avalia√ß√£o Exodontia de Siso", base_value: 0, unit_value: 0 },
      { code: "415", specialty: "Ortodontia", name: "Remo√ß√£o Resina Arcada Superior", base_value: 0, unit_value: 0 },
      { code: "416", specialty: "Ortodontia", name: "Remo√ß√£o de Resina Arcada Inferior", base_value: 0, unit_value: 0 },
      { code: "417", specialty: "Cl√≠nica geral", name: "Restaura√ß√£o Pino + Resina", base_value: 0, unit_value: 397 },
      { code: "418", specialty: "Pr√≥tese", name: "Protese sobre Implante", base_value: 0, unit_value: 0 },
      { code: "419", specialty: "Pr√≥tese", name: "Protese sobre Implante M√∫ltiplo", base_value: 0, unit_value: 0 },
      { code: "420", specialty: "Cl√≠nica geral", name: "Exodontia M√∫ltipla", base_value: 0, unit_value: 0 },
      { code: "421", specialty: "Pr√≥tese", name: "Overdenture Superior Cir√∫rgica", base_value: 0, unit_value: 0 },
      { code: "422", specialty: "Pr√≥tese", name: "Overdenture Superior Prot√©tica", base_value: 0, unit_value: 0 },
      { code: "423", specialty: "Pr√≥tese", name: "Overdenture Inferior Cir√∫rgica", base_value: 0, unit_value: 0 },
      { code: "424", specialty: "Pr√≥tese", name: "Overdenture Inferior Prot√©tica", base_value: 0, unit_value: 0 },
      { code: "425", specialty: "Pr√≥tese", name: "Pr√≥tese Parcial Provis√≥ria Inferior (PPR FLEX)", base_value: 0, unit_value: 0 },
      { code: "426", specialty: "Pr√≥tese", name: "Protese Parcial Provisoria Superior (PPR FLEX)", base_value: 0, unit_value: 0 },
      { code: "427", specialty: "Harmoniza√ß√£o Facial", name: "Avalia√ß√£o Harmoniza√ß√£o Facial", base_value: 0, unit_value: 0 },
      { code: "433", specialty: "Pr√≥tese", name: "Coroa metalo-cer√¢mica", base_value: 0, unit_value: 0 },
      { code: "434", specialty: "Pr√≥tese", name: "N√∫cleo de fibra de vidro", base_value: 0, unit_value: 0 },
      { code: "435", specialty: "Pr√≥tese", name: "Protese Parcial Provisoria Inferior (PPR FLEX) Importado", base_value: 0, unit_value: 0 },
      { code: "436", specialty: "Pr√≥tese", name: "Protese Parcial Provisoria Superior (PPR FLEX) Importado", base_value: 0, unit_value: 0 },
      { code: "437", specialty: "Implantodontia", name: "Protocolo sobre Implante - Superior (Fase Cirurgia) Importado", base_value: 0, unit_value: 0 },
      { code: "438", specialty: "Implantodontia", name: "Protocolo sobre Implante - Inferior (Fase Cirurgia) Importado", base_value: 0, unit_value: 0 },
      { code: "439", specialty: "Implantodontia", name: "Implante Unit√°rio Importado", base_value: 0, unit_value: 0 },
      { code: "440", specialty: "Ortodontia", name: "Recolagem Conten√ß√£o", base_value: 0, unit_value: 0 },
      { code: "441", specialty: "Pr√≥tese", name: "N√∫cleo", base_value: 0, unit_value: 0 },
      { code: "442", specialty: "Pr√≥tese", name: "Coroa de Resina Acr√≠lica", base_value: 0, unit_value: 0 },
      { code: "443", specialty: "Pr√≥tese", name: "Coroa de Cer√¢mica", base_value: 0, unit_value: 0 },
      { code: "444", specialty: "Radiologia", name: "Escaneamento Pr√≥tese", base_value: 0, unit_value: 249 },
      { code: "445", specialty: "Cl√≠nica geral", name: "Orienta√ß√£o de Higiene", base_value: 0, unit_value: 0 },
      { code: "446", specialty: "Harmoniza√ß√£o Facial", name: "Avalia√ß√£o Botox", base_value: 0, unit_value: 0 },
      { code: "447", specialty: "Pr√≥tese", name: "Coroa Cer√¥mero", base_value: 0, unit_value: 699 },
      { code: "448", specialty: "Produtos", name: "Aparelho PLG - Apn√©ia", base_value: 0, unit_value: 0 },
      { code: "449", specialty: "Pr√≥tese", name: "Coral Total Cer√¥mero", base_value: 0, unit_value: 0 },
      { code: "450", specialty: "Pr√≥tese", name: "Coral Parcial Cer√¥mero", base_value: 0, unit_value: 0 },
      { code: "451", specialty: "Cl√≠nica geral", name: "Restaura√ß√£o classe IV Mesial e Distal", base_value: 0, unit_value: 274 },
      { code: "452", specialty: "Pr√≥tese", name: "Protese Provis√≥ria sobre Implante", base_value: 0, unit_value: 0 },
      { code: "453", specialty: "Cl√≠nica geral", name: "Remo√ß√£o Aparelho + Profilaxia", base_value: 0, unit_value: 0 },
      { code: "455", specialty: "Pr√≥tese", name: "Pr√≥tese Total Superior Definitiva Simples com Dentes Importados", base_value: 0, unit_value: 0 },
      { code: "456", specialty: "Pr√≥tese", name: "Pr√≥tese Total Inferior Definitiva Simples com Dentes Importados", base_value: 0, unit_value: 0 },
      { code: "457", specialty: "Pr√≥tese", name: "Pr√≥tese Parcial Inferior (PPR FLEX)", base_value: 0, unit_value: 0 },
      { code: "458", specialty: "Pr√≥tese", name: "Pr√≥tese Parcial Superior (PPR FLEX)", base_value: 0, unit_value: 0 },
      { code: "459", specialty: "Cl√≠nica geral", name: "Restaura√ß√£o Extensa", base_value: 0, unit_value: 274 },
      { code: "460", specialty: "Cl√≠nica geral", name: "Restaura√ß√£o de Am√°lgama", base_value: 0, unit_value: 0 },
      { code: "461", specialty: "Implantodontia", name: "Avalia√ß√£o Mini Implante", base_value: 0, unit_value: 0 },
      { code: "462", specialty: "Alinhadores", name: "Manuten√ß√£o Alinhador", base_value: 0, unit_value: 0 },
      { code: "463", specialty: "Ortodontia", name: "Colagem de Bot√£o", base_value: 0, unit_value: 0 },
      { code: "464", specialty: "Pr√≥tese", name: "Moldagem PPR", base_value: 0, unit_value: 0 },
      { code: "465", specialty: "Cl√≠nica geral", name: "Profilaxia + Fluorterapia", base_value: 0, unit_value: 0 },
      { code: "466", specialty: "Cl√≠nica geral", name: "Profilaxia Simples", base_value: 0, unit_value: 0 },
      { code: "467", specialty: "Periodontia", name: "Gengivoplastia", base_value: 0, unit_value: 0 },
      { code: "468", specialty: "Cl√≠nica geral", name: "Avalia√ß√£o com Panor√¢mica", base_value: 0, unit_value: 66 },
      { code: "469", specialty: "Cl√≠nica geral", name: "Microabras√£o", base_value: 0, unit_value: 200 },
      { code: "470", specialty: "Cl√≠nica geral", name: "Restaura√ß√£o em Resina Composta", base_value: 0, unit_value: 0 },
      { code: "471", specialty: "Cl√≠nica geral", name: "Faceta em Resina", base_value: 0, unit_value: 319 },
      { code: "472", specialty: "Cl√≠nica geral", name: "Exodontia de siso incluso", base_value: 0, unit_value: 0 },
      { code: "473", specialty: "Cl√≠nica geral", name: "Exodontia de siso semi incluso", base_value: 0, unit_value: 0 },
      { code: "474", specialty: "Cl√≠nica geral", name: "Esplintagem inferior", base_value: 0, unit_value: 0 },
      { code: "475", specialty: "Cl√≠nica geral", name: "Esplintagem superior", base_value: 0, unit_value: 0 },
      { code: "476", specialty: "Cl√≠nica geral", name: "Exodontia Terceiro Molar Incluso", base_value: 0, unit_value: 0 },
      { code: "477", specialty: "Cl√≠nica geral", name: "Exodontia Terceiro Molar Semi Incluso", base_value: 0, unit_value: 0 },
      { code: "486", specialty: "Produtos", name: "Braquete Safira", base_value: 40, unit_value: 50 },
      { code: "487", specialty: "Produtos", name: "Braquete Ceramico", base_value: 30, unit_value: 50 },
      { code: "490", specialty: "Ortodontia", name: "Instalacao de elasticos intermaxilares", base_value: 0, unit_value: 0 },
      { code: "492", specialty: "Ortodontia", name: "Instalacao de aparelho movel", base_value: 0, unit_value: 0 },
      { code: "493", specialty: "Ortodontia", name: "Moldagem de aparelho movel", base_value: 0, unit_value: 0 },
      { code: "147352", specialty: "Ortodontia", name: "Procedimento APP-Dentista", base_value: 0, unit_value: 0 },
      { code: "147353", specialty: "Pr√≥tese", name: "Conserto de Pr√≥tese", base_value: 0, unit_value: 0 },
      { code: "147354", specialty: "Radiologia", name: "Raio-x Controle Ortod√¥ntico - (solicitar a cada 6 meses)", base_value: 0, unit_value: 0 },
      { code: "147355", specialty: "Radiologia", name: "Raio-x Cl√≠nica (sem plano de ortodontia)", base_value: 0, unit_value: 0 },
      { code: "147356", specialty: "Radiologia", name: "Raio-x Primeira consulta", base_value: 0, unit_value: 0 },
      { code: "147357", specialty: "Produtos", name: "Aparelho Ortop√©dico", base_value: 0, unit_value: 0 },
      { code: "147358", specialty: "Cl√≠nica geral", name: "Laserterapia", base_value: 0, unit_value: 0 },
      { code: "147369", specialty: "Ortodontia", name: "Colagem do Aparelho", base_value: 0, unit_value: 0 },
      { code: "147379", specialty: "Implantodontia", name: "Enxerto de Preenchimento", base_value: 0, unit_value: 0 },
      { code: "147380", specialty: "Cl√≠nica geral", name: "Placa de Bruxismo - Acetato", base_value: 0, unit_value: 0 },
      { code: "147381", specialty: "Cl√≠nica geral", name: "Frenectomia Lingual", base_value: 0, unit_value: 0 },
      { code: "147382", specialty: "Implantodontia", name: "Implante e Coroa", base_value: 0, unit_value: 0 },
      { code: "147383", specialty: "Implantodontia", name: "Coroa Sobre Implante", base_value: 0, unit_value: 0 },
      { code: "147384", specialty: "Implantodontia", name: "Implante", base_value: 0, unit_value: 0 },
      { code: "147387", specialty: "Cl√≠nica geral", name: "Selante Dentes Permanentes", base_value: 0, unit_value: 0 },
      { code: "147388", specialty: "Cl√≠nica geral", name: "Selante Dentes Deciduos", base_value: 0, unit_value: 0 },
      { code: "147389", specialty: "Cl√≠nica geral", name: "Aplica√ß√£o de Verniz Unitario", base_value: 0, unit_value: 0 },
      { code: "147390", specialty: "Cl√≠nica geral", name: "Aplica√ß√£o de Verniz Fluoreto por Arcada", base_value: 0, unit_value: 0 },
      { code: "147391", specialty: "Cl√≠nica geral", name: "Revis√£o Placa Miorelaxante", base_value: 0, unit_value: 0 },
      { code: "147392", specialty: "Pr√≥tese", name: "Avalia√ß√£o Pr√≥tese Sob Implante", base_value: 0, unit_value: 0 },
      { code: "147393", specialty: "Pr√≥tese", name: "Moldagem Pr√≥tese Sob Implante", base_value: 0, unit_value: 0 },
      { code: "147394", specialty: "Pr√≥tese", name: "Protese Sob Implante", base_value: 0, unit_value: 0 },
      { code: "147395", specialty: "SAC", name: "Retorno de Or√ßamento Cl√≠nico", base_value: 0, unit_value: 0 },
      { code: "147396", specialty: "Produtos", name: "Kit Ortod√¥ntico (Escova + Fio dental + Necessaire)", base_value: 0, unit_value: 0 },
      { code: "147397", specialty: "Radiologia", name: "Documenta√ß√£o de Retorno ao Tratamento", base_value: 0, unit_value: 0 },
      { code: "147398", specialty: "Implantodontia", name: "Implante Ajuste de PSI", base_value: 0, unit_value: 0 },
      { code: "147400", specialty: "Implantodontia", name: "Implante - Superior (Fase Cirurgia)", base_value: 0, unit_value: 0 },
      { code: "147401", specialty: "Implantodontia", name: "Implante - Inferior (Fase Cirurgia)", base_value: 0, unit_value: 0 },
      { code: "147402", specialty: "Implantodontia", name: "Implante - Superior (Fase protetica)", base_value: 0, unit_value: 0 },
      { code: "147403", specialty: "Implantodontia", name: "Implante - Inferior (Fase protetica)", base_value: 0, unit_value: 0 },
      { code: "147404", specialty: "Implantodontia", name: "Implante - Unitario (fase cirurgica)", base_value: 0, unit_value: 0 },
      { code: "147405", specialty: "Implantodontia", name: "Implante - Unitario (fase protetica)", base_value: 0, unit_value: 0 },
      { code: "147406", specialty: "Pr√≥tese", name: "Procedimentos para Proteses - PPR Superior Definitiva", base_value: 0, unit_value: 0 },
      { code: "147407", specialty: "Periodontia", name: "Gengivoplastia por Elemento", base_value: 0, unit_value: 0 },
      { code: "147408", specialty: "Periodontia", name: "Gengivoplastia por Segmento", base_value: 0, unit_value: 0 },
      { code: "147409", specialty: "Cl√≠nica geral", name: "Instala√ß√£o Arco Cirurgico", base_value: 0, unit_value: 0 },
      { code: "147410", specialty: "Cl√≠nica geral", name: "Remo√ß√£o Odontoma", base_value: 0, unit_value: 0 },
      { code: "147411", specialty: "Ortodontia", name: "ESCANEAMENTO ITERO", base_value: 0, unit_value: 0 },
      { code: "147412", specialty: "Pr√≥tese", name: "Protese Unit√°ria Definitiva (Dente de Estoque)", base_value: 0, unit_value: 0 },
      { code: "147413", specialty: "Pr√≥tese", name: "Protese Unit√°ria Definitiva (Laboratorio)", base_value: 0, unit_value: 0 },
      { code: "147414", specialty: "Cl√≠nica geral", name: "Restaura√ß√£o de Dente Dec√≠duo", base_value: 0, unit_value: 0 },
      { code: "147415", specialty: "Cl√≠nica geral", name: "Avalia√ß√£o com Periapical", base_value: 0, unit_value: 0 },
      { code: "147416", specialty: "Produtos", name: "Porta Copos", base_value: 0, unit_value: 0 },
      { code: "147417", specialty: "Produtos", name: "Garrafa T√©rmica", base_value: 0, unit_value: 0 },
      { code: "147418", specialty: "Produtos", name: "Caneta Esferogr√°fica", base_value: 0, unit_value: 0 },
      { code: "147419", specialty: "Produtos", name: "Sacola TNT", base_value: 0, unit_value: 0 },
      { code: "147420", specialty: "Produtos", name: "Mochila Saco", base_value: 0, unit_value: 0 },
      { code: "147421", specialty: "Produtos", name: "Garrafa em Inox", base_value: 0, unit_value: 0 },
      { code: "147422", specialty: "Produtos", name: "Copo T√©rmico com Abridor", base_value: 0, unit_value: 0 },
      { code: "147424", specialty: "Ortodontia", name: "1¬™ Consulta Invisalign", base_value: 0, unit_value: 0 },
      { code: "147425", specialty: "Ortodontia", name: "Manuten√ß√£o Invisalign", base_value: 0, unit_value: 0 },
      { code: "147426", specialty: "Implantodontia", name: "Protocolo sobre Implante Superior (Resina)", base_value: 0, unit_value: 0 },
      { code: "147427", specialty: "Implantodontia", name: "Protocolo sobre Implante Inferior (Resina)", base_value: 0, unit_value: 0 },
      { code: "147428", specialty: "Implantodontia", name: "Protocolo sobre Implante - Superior (Cer√¢mica)", base_value: 0, unit_value: 0 },
      { code: "147429", specialty: "Implantodontia", name: "Protocolo sobre Implante - Inferior (Cer√¢mica)", base_value: 0, unit_value: 0 },
      { code: "147430", specialty: "Endodontia", name: "Restauracao Estetica", base_value: 0, unit_value: 0 },
      { code: "147434", specialty: "Endodontia", name: "Endodontia em 2 sess√µes", base_value: 0, unit_value: 0 },
      { code: "147435", specialty: "Endodontia", name: "Endodontia em 3 sess√µes", base_value: 0, unit_value: 0 },
      { code: "147436", specialty: "Endodontia", name: "Endodontia em 3 sessoes dentes 1 a 5", base_value: 0, unit_value: 0 },
      { code: "147437", specialty: "Endodontia", name: "Endodontia em 2 sessoes dentes 1 a 5", base_value: 0, unit_value: 0 },
      { code: "147438", specialty: "Endodontia", name: "Endodontia em 3 sessoes dentes 6 a 8", base_value: 0, unit_value: 0 },
      { code: "147439", specialty: "Endodontia", name: "Endodontia em 2 sessoes dentes 6 a 8", base_value: 0, unit_value: 0 },
      { code: "147440", specialty: "Odontopediatria", name: "Exodontia Dentes Dec√≠duos", base_value: 0, unit_value: 0 },
      { code: "147441", specialty: "Cirurgia", name: "Curetagem de Les√£o Periapical", base_value: 0, unit_value: 0 },
      { code: "147442", specialty: "Ortodontia", name: "CAMPANHA ESCANEAMENTO ITERO", base_value: 0, unit_value: 0 },
      { code: "147443", specialty: "Endodontia", name: "Endodontia de Molar", base_value: 0, unit_value: 0 },
      { code: "147444", specialty: "Endodontia", name: "Endodontia de pre molar canino e incisivo", base_value: 0, unit_value: 0 },
      { code: "147445", specialty: "Pr√≥tese", name: "PTR Definitiva", base_value: 0, unit_value: 0 },
      { code: "147446", specialty: "Pr√≥tese", name: "PTR Provis√≥ria", base_value: 0, unit_value: 0 },
      { code: "147447", specialty: "Pr√≥tese", name: "PPR (Roach com Estrutura Met√°lica)", base_value: 0, unit_value: 0 },
      { code: "147448", specialty: "Pr√≥tese", name: "PPR Provis√≥ria", base_value: 0, unit_value: 0 },
      { code: "147449", specialty: "Pr√≥tese", name: "Coroa Provisoria por Dente (feita em laborat√≥rio)", base_value: 0, unit_value: 0 },
      { code: "147450", specialty: "Pr√≥tese", name: "Coroa Emax", base_value: 0, unit_value: 0 },
      { code: "147451", specialty: "Pr√≥tese", name: "Restaurado Emax", base_value: 0, unit_value: 0 },
      { code: "147452", specialty: "Pr√≥tese", name: "Protese Protocolo (fase cirurgica)", base_value: 0, unit_value: 0 },
      { code: "147453", specialty: "Pr√≥tese", name: "Protese Protocolo (fase protetica)", base_value: 0, unit_value: 0 },
      { code: "147454", specialty: "Pr√≥tese", name: "N√∫cleo de Preenchimento com Pino de Fibra de Vidro", base_value: 0, unit_value: 0 },
      { code: "147455", specialty: "Ortodontia", name: "Retorno de Tratamento", base_value: 0, unit_value: 0 },
      { code: "147456", specialty: "Ortodontia", name: "FIO ORTODONTICO", base_value: 0, unit_value: 0 },
      { code: "147457", specialty: "Pr√≥tese", name: "Protese Provis√≥ria Fixa por Elemento (Fio de ORTO)", base_value: 0, unit_value: 0 },
      { code: "147462", specialty: "Alinhadores", name: "Avalia√ß√£o Alinhador", base_value: 0, unit_value: 0 },
      { code: "147463", specialty: "Cl√≠nica geral", name: "Regulariza√ß√£o Anat√¥mica", base_value: 0, unit_value: 0 },
      { code: "148051", specialty: "Cl√≠nica geral", name: "Exodontia de Terceiro Molar (1 elemento - campanha)", base_value: 0, unit_value: 0 },
      { code: "148052", specialty: "Cl√≠nica geral", name: "Exodontia de Terceiro Molar (2 elementos - campanha)", base_value: 0, unit_value: 0 },
      { code: "148053", specialty: "Cl√≠nica geral", name: "Exodontia de Terceiro Molar (4 elementos - campanha)", base_value: 0, unit_value: 0 },
      { code: "148054", specialty: "Pr√≥tese", name: "Protese Flexite Unit√°ria Remov√≠vel", base_value: 0, unit_value: 0 },
      { code: "148055", specialty: "Implantodontia", name: "Restaura√ß√£o Coroa Sobre Implante", base_value: 0, unit_value: 0 },
      { code: "148056", specialty: "Implantodontia", name: "Torque", base_value: 0, unit_value: 0 },
      { code: "148057", specialty: "Alinhadores", name: "Moldagem Conten√ß√£o Alinhador", base_value: 0, unit_value: 0 },
      { code: "148058", specialty: "Radiologia", name: "LEVANTAMENTO PERIAPICAL", base_value: 0, unit_value: 0 },
      { code: "148059", specialty: "Cirurgia", name: "Biopsia de Tecido Bucal", base_value: 0, unit_value: 800 },
      { code: "148060", specialty: "Ortodontia", name: "Instala√ß√£o Aparelho Movel", base_value: 0, unit_value: 0 },
      { code: "148061", specialty: "Cl√≠nica geral", name: "Ajuste Interproximal", base_value: 0, unit_value: 0 },
      { code: "148062", specialty: "Pr√≥tese", name: "Protese Fixa Adesiva (2 Elementos)", base_value: 0, unit_value: 0 },
      { code: "148063", specialty: "Cl√≠nica geral", name: "Limpeza (Contrato)", base_value: 0, unit_value: 0 },
      { code: "148064", specialty: "Ortodontia", name: "Entrega de Clareamento", base_value: 0, unit_value: 0 },
      { code: "148065", specialty: "Implantodontia", name: "Pino", base_value: 0, unit_value: 0 },
      { code: "148066", specialty: "Implantodontia", name: "GUIA CIRURGICO", base_value: 0, unit_value: 0 },
      { code: "148067", specialty: "Cl√≠nica geral", name: "Remocao de Amalgama", base_value: 0, unit_value: 0 },
      { code: "148068", specialty: "Cl√≠nica geral", name: "RASPAGEM COMERCIAL", base_value: 0, unit_value: 0 },
      { code: "148069", specialty: "Pr√≥tese", name: "PPR Definitiva Superior", base_value: 0, unit_value: 0 },
      { code: "148070", specialty: "Pr√≥tese", name: "PPR Definitiva Inferior", base_value: 0, unit_value: 0 },
      { code: "148071", specialty: "Pr√≥tese", name: "PPR Definitiva Superior Importada", base_value: 0, unit_value: 0 },
      { code: "148072", specialty: "Pr√≥tese", name: "PPR Definitiva Inferior Importada", base_value: 0, unit_value: 0 },
      { code: "148073", specialty: "Produtos", name: "Pasta Dental", base_value: 0, unit_value: 18 },
      { code: "148074", specialty: "Produtos", name: "Escova Dental Extreme Ice", base_value: 0, unit_value: 0 },
      { code: "148075", specialty: "Produtos", name: "Escova Personalizada Ideal Pro", base_value: 0, unit_value: 0 },
      { code: "148076", specialty: "Produtos", name: "Kit ortodontico - (Cera, Passa Fio e Escova Interdental)", base_value: 0, unit_value: 36 },
      { code: "148077", specialty: "Produtos", name: "Kit ortodontico - (Cera, Passa Fio e Escova Interdental)", base_value: 0, unit_value: 36 },
      { code: "148078", specialty: "Cl√≠nica geral", name: "Profilaxia + Clareamento", base_value: 0, unit_value: 299 },
      { code: "148079", specialty: "Cl√≠nica geral", name: "Remo√ß√£o de Coroa", base_value: 0, unit_value: 0 },
      { code: "148080", specialty: "Ortodontia", name: "Escaneamento para Conten√ß√£o", base_value: 0, unit_value: 100 },
      { code: "148081", specialty: "Radiologia", name: "Documenta√ß√£o Cl√≠nica (Raio-X/Fotos)", base_value: 0, unit_value: 0 },
      { code: "148082", specialty: "Radiologia", name: "Documenta√ß√£o Cl√≠nica (Fotos)", base_value: 0, unit_value: 0 },
      { code: "148083", specialty: "Produtos", name: "Clinexidin", base_value: 0, unit_value: 0 },
      { code: "148084", specialty: "Produtos", name: "Antiss√©ptico", base_value: 0, unit_value: 0 },
      { code: "148085", specialty: "Ortodontia", name: "Moldagem Clareamento", base_value: 0, unit_value: 0 },
      { code: "148086", specialty: "Alinhadores", name: "Conten√ß√£o Alinhador Inferior", base_value: 0, unit_value: 200 },
      { code: "148087", specialty: "Alinhadores", name: "Conten√ß√£o Alinhador Superior", base_value: 0, unit_value: 200 },
      { code: "148088", specialty: "Ortodontia", name: "Escaneamento Inicial", base_value: 0, unit_value: 0 },
      { code: "148089", specialty: "Ortodontia", name: "Moldagem Conten√ß√£o", base_value: 0, unit_value: 0 },
      { code: "148090", specialty: "Produtos", name: "Aparelho Safira Autoligado", base_value: 0, unit_value: 0 },
      { code: "148091", specialty: "Cl√≠nica geral", name: "Clareamento sem Moldeira", base_value: 0, unit_value: 0 },
      { code: "148092", specialty: "Produtos", name: "BISNAGA DE CLAREAMENTO", base_value: 0, unit_value: 70 },
      { code: "148093", specialty: "Cl√≠nica geral", name: "Profilaxia (Contrato)", base_value: 0, unit_value: 0 },
      { code: "148094", specialty: "Ortodontia", name: "Fio Termo", base_value: 0, unit_value: 0 },
      { code: "148095", specialty: "Ortodontia", name: "Fio Quadrado", base_value: 0, unit_value: 0 },
      { code: "148096", specialty: "Cl√≠nica geral", name: "Mini Implante", base_value: 0, unit_value: 0 },
      { code: "148097", specialty: "Cl√≠nica geral", name: "Clareamento a Laser - Campanha", base_value: 0, unit_value: 0 },
      { code: "148098", specialty: "Cirurgia", name: "COLAGEM DE BOTAO", base_value: 0, unit_value: 0 },
      { code: "148099", specialty: "Produtos", name: "ANESTESICO LIDOCAINA COM EPINEFRINA", base_value: 0, unit_value: 0 },
      { code: "148100", specialty: "Produtos", name: "Jaleco Descart√°vel", base_value: 0, unit_value: 0 },
      { code: "148101", specialty: "Produtos", name: "RESINA SPECTRA SMART - A1", base_value: 0, unit_value: 0 },
      { code: "148102", specialty: "Produtos", name: "RESINA SPECTRA SMART - A2", base_value: 0, unit_value: 0 },
      { code: "148103", specialty: "Produtos", name: "RESINA SPECTRA SMART - A3", base_value: 0, unit_value: 0 },
      { code: "148104", specialty: "Produtos", name: "Lima 10 de 25 mm", base_value: 0, unit_value: 0 },
      { code: "148105", specialty: "Cl√≠nica geral", name: "Raspagem Leve (CAMPANHA)", base_value: 0, unit_value: 0 },
      { code: "148106", specialty: "Cl√≠nica geral", name: "Raspagem Moderada (CAMPANHA)", base_value: 0, unit_value: 0 },
      { code: "148107", specialty: "Produtos", name: "Mini Antiss√©ptico", base_value: 0, unit_value: 0 },
      { code: "148108", specialty: "Cl√≠nica geral", name: "Controle de Erup√ß√£o", base_value: 0, unit_value: 0 },
      { code: "148109", specialty: "Harmoniza√ß√£o Facial", name: "Sess√£o de Skinbooster", base_value: 0, unit_value: 0 },
      { code: "148110", specialty: "Harmoniza√ß√£o Facial", name: "Preenchimento Facial", base_value: 0, unit_value: 0 },
      { code: "148111", specialty: "Harmoniza√ß√£o Facial", name: "Sess√£o de Bioestimulador", base_value: 0, unit_value: 0 },
      { code: "148112", specialty: "Cl√≠nica geral", name: "EXODONTIA DE DENTE TRATADO ENDODONTICAMENTE", base_value: 0, unit_value: 0 },
      { code: "148113", specialty: "Cl√≠nica geral", name: "Profilaxia + RX Panor√¢mico", base_value: 0, unit_value: 120 },
      { code: "148114", specialty: "Ortodontia", name: "CONTENCAO VIVERA", base_value: 0, unit_value: 1000 },
      { code: "148115", specialty: "Cl√≠nica geral", name: "Remocao de Coroa Definitiva", base_value: 0, unit_value: 0 },
      { code: "148116", specialty: "Cl√≠nica geral", name: "RECOLAGEM DE CONTENCAO", base_value: 0, unit_value: 0 },
      { code: "148117", specialty: "Pr√≥tese", name: "Entrega de Protese", base_value: 0, unit_value: 0 },
      { code: "148118", specialty: "Pr√≥tese", name: "Prova de Cera", base_value: 0, unit_value: 0 },
      { code: "148119", specialty: "Cl√≠nica geral", name: "Placa de Clareamento", base_value: 0, unit_value: 0 },
      { code: "148120", specialty: "Produtos", name: "Escova Pos Cirurgica", base_value: 0, unit_value: 0 },
      { code: "148121", specialty: "Produtos", name: "Spray Extreme Ice", base_value: 0, unit_value: 0 },
      { code: "148122", specialty: "Produtos", name: "Clinexidin 250mL", base_value: 0, unit_value: 0 },
      { code: "148123", specialty: "Pr√≥tese", name: "Protese", base_value: 0, unit_value: 0 },
      { code: "148124", specialty: "Pr√≥tese", name: "PPR IMEDIATA PROVISORIA SUPERIOR", base_value: 0, unit_value: 0 },
      { code: "148125", specialty: "Pr√≥tese", name: "PPR IMEDIATA PROVISORIA INFERIOR", base_value: 0, unit_value: 0 },
      { code: "148126", specialty: "Pr√≥tese", name: "PROTESE TOTAL IMEDIATA PROVISORIA SUPERIOR", base_value: 0, unit_value: 0 },
      { code: "148127", specialty: "Pr√≥tese", name: "PROTESE TOTAL IMEDIATA PROVISORIA INFERIOR", base_value: 0, unit_value: 0 },
      { code: "148128", specialty: "Alinhadores", name: "Contencao Hibrida", base_value: 0, unit_value: 0 },
      { code: "148129", specialty: "Cl√≠nica geral", name: "Emergencia", base_value: 0, unit_value: 0 },
      { code: "148130", specialty: "Ortodontia", name: "Corte de Fio", base_value: 0, unit_value: 0 },
      { code: "148131", specialty: "Produtos", name: "Escova Dental Expert Gengiva Sensi - Oral-B", base_value: 0, unit_value: 0 },
      { code: "148132", specialty: "Cl√≠nica geral", name: "Avaliacao Estetica", base_value: 0, unit_value: 0 },
      { code: "148133", specialty: "Endodontia", name: "Endodontia", base_value: 0, unit_value: 0 },
      { code: "148134", specialty: "Ortodontia", name: "Scanner Superior", base_value: 0, unit_value: 0 },
      { code: "148135", specialty: "Ortodontia", name: "Scanner Inferior", base_value: 0, unit_value: 0 },
      { code: "148136", specialty: "Cl√≠nica geral", name: "Protese Provisoria Fixa por Elemento (Fio de ORTO)", base_value: 0, unit_value: 0 },
      { code: "148137", specialty: "Cl√≠nica geral", name: "Sedacao com Oxido Nitroso", base_value: 0, unit_value: 0 },
      { code: "148138", specialty: "Cl√≠nica geral", name: "Aumento De Coroa", base_value: 0, unit_value: 0 },
      { code: "148139", specialty: "Pr√≥tese", name: "Onlay Resina - Escola", base_value: 0, unit_value: 0 },
      { code: "148140", specialty: "Cl√≠nica geral", name: "Endodontia Unirradicular - Escola", base_value: 0, unit_value: 0 },
      { code: "148141", specialty: "Cl√≠nica geral", name: "Endodontia Trirradicular Ou Mais - Escola", base_value: 0, unit_value: 0 },
      { code: "148142", specialty: "Cl√≠nica geral", name: "Cimenta√ß√£o De Protese Provisoria Ou Definitiva (Escola)", base_value: 0, unit_value: 89 },
      { code: "148143", specialty: "Cl√≠nica geral", name: "Clareamento H√≠brido (Escola)", base_value: 0, unit_value: 0 },
      { code: "148144", specialty: "Cl√≠nica geral", name: "Clareamento Moldeira - Escola", base_value: 0, unit_value: 0 },
      { code: "148145", specialty: "Cl√≠nica geral", name: "Clareamento de Consultorio", base_value: 0, unit_value: 0 },
      { code: "148146", specialty: "Cl√≠nica geral", name: "Clareamento de Consultorio (Escola)", base_value: 0, unit_value: 0 },
      { code: "148147", specialty: "Ortodontia", name: "Conserto de Aparelho Movel (Escola)", base_value: 0, unit_value: 0 },
      { code: "148148", specialty: "Pr√≥tese", name: "Conserto de Protese (Escola)", base_value: 0, unit_value: 0 },
      { code: "148149", specialty: "Cl√≠nica geral", name: "Coroa Emax (Escola)", base_value: 0, unit_value: 0 },
      { code: "148150", specialty: "Cl√≠nica geral", name: "Coroa metalo-cer√¢mica (Escola)", base_value: 0, unit_value: 0 },
      { code: "148151", specialty: "Pr√≥tese", name: "Coroa De Porcelana Pura (Escola)", base_value: 0, unit_value: 0 },
      { code: "148152", specialty: "Cl√≠nica geral", name: "Emergencia (Escola)", base_value: 0, unit_value: 0 },
      { code: "148154", specialty: "Ortodontia", name: "Aparelho Movel - Expansor", base_value: 0, unit_value: 0 },
      { code: "148155", specialty: "Radiologia", name: "Bite Wing Centrais e Caninos", base_value: 0, unit_value: 0 },
      { code: "148156", specialty: "Radiologia", name: "Bite Wing Molares e Pre Molares", base_value: 0, unit_value: 0 },
      { code: "148157", specialty: "Radiologia", name: "Radiografia Panoramica (Contrato)", base_value: 0, unit_value: 0 },
      { code: "148158", specialty: "Pr√≥tese", name: "SNs I II e III", base_value: 0, unit_value: 0 },
      { code: "148159", specialty: "Pr√≥tese", name: "SNs VII e X", base_value: 0, unit_value: 0 },
      { code: "148160", specialty: "Pr√≥tese", name: "PICS", base_value: 0, unit_value: 0 },
      { code: "148161", specialty: "Pr√≥tese", name: "PIPS", base_value: 0, unit_value: 0 },
      { code: "148163", specialty: "Produtos", name: "Alinhador", base_value: 0, unit_value: 0 },
      { code: "148164", specialty: "Cl√≠nica geral", name: "Ulectomia/Ulotomia", base_value: 0, unit_value: 0 },
      { code: "148165", specialty: "Produtos", name: "Alinhador Superior", base_value: 0, unit_value: 0 },
      { code: "148166", specialty: "Produtos", name: "Alinhador Inferior", base_value: 0, unit_value: 0 },
      { code: "148167", specialty: "Ortodontia", name: "Braquete Est√©tico Autoligado", base_value: 0, unit_value: 0 },
      { code: "148168", specialty: "Cl√≠nica geral", name: "CAMPANHA PROFILAXIA 2 POR 1", base_value: 0, unit_value: 0 },
      { code: "148169", specialty: "Cl√≠nica geral", name: "Entrega de Clareamento", base_value: 0, unit_value: 0 },
      { code: "148170", specialty: "Cl√≠nica geral", name: "Profilaxia de Aniversario", base_value: 0, unit_value: 0 },
      { code: "148171", specialty: "Implantodontia", name: "HIGIENIZACAO 2 PROTOCOLOS - INFERIOR", base_value: 0, unit_value: 0 },
      { code: "148172", specialty: "Implantodontia", name: "HIGIENIZACAO 2 PROTOCOLOS - SUPERIOR", base_value: 0, unit_value: 0 },
      { code: "148173", specialty: "Implantodontia", name: "Parafuso Sextavado", base_value: 0, unit_value: 0 },
      { code: "148174", specialty: "Implantodontia", name: "Troca de componente protetico", base_value: 0, unit_value: 0 },
      { code: "148175", specialty: "Ortodontia", name: "Check-Up + Raio X", base_value: 0, unit_value: 0 },
      { code: "148176", specialty: "Ortodontia", name: "Avalia√ß√£o com Raio X (Paciente Abandono)", base_value: 0, unit_value: 0 },
      { code: "148177", specialty: "Produtos", name: "KIT ESCOLAR STITCH", base_value: 0, unit_value: 0 },
      { code: "148178", specialty: "Produtos", name: "Escova Stitch Adulto - 2 und", base_value: 0, unit_value: 0 },
      { code: "148179", specialty: "Produtos", name: "Escova - Viagem", base_value: 0, unit_value: 0 },
      { code: "148180", specialty: "Produtos", name: "Gel Dental Clinexidin", base_value: 0, unit_value: 0 },
      { code: "148181", specialty: "Produtos", name: "Kit Premium Stitch", base_value: 0, unit_value: 0 },
      { code: "148182", specialty: "Ortodontia", name: "O ring", base_value: 0, unit_value: 0 },
      { code: "148183", specialty: "Ortodontia", name: "Troca de Sistema Overdenture", base_value: 0, unit_value: 0 },
      { code: "148184", specialty: "Implantodontia", name: "Contrato Clinico Geral", base_value: 0, unit_value: 0 },
      { code: "148185", specialty: "Cl√≠nica geral", name: "Exodontia Extranumer√°rio em Boca", base_value: 0, unit_value: 0 },
      { code: "148186", specialty: "Cl√≠nica geral", name: "Exodontia Extranumer√°rio Incluso", base_value: 0, unit_value: 0 },
      { code: "148187", specialty: "Cl√≠nica geral", name: "Exodontia Extranumer√°rio Incluso/Impactado acima de 2 horas", base_value: 0, unit_value: 0 },
      { code: "148188", specialty: "Cl√≠nica geral", name: "FRENECTOMIA LABIAL SUPERIOR", base_value: 0, unit_value: 0 },
      { code: "148189", specialty: "Cl√≠nica geral", name: "FRENECTOMIA LABIAL SUPERIOR COM OSTEOTOMIA NA LINHA MEDIA", base_value: 0, unit_value: 0 },
      { code: "148190", specialty: "Cl√≠nica geral", name: "FRENECTOMIA LINGUAL (PACIENTE COM L√çNGUA PRESA OU ANQUILOGLOSSIA)", base_value: 0, unit_value: 0 },
      { code: "148191", specialty: "Cl√≠nica geral", name: "BIOPSIA (COLETA DA PE?A E ARMAZENAMENTO EM FORMOL 10%)", base_value: 0, unit_value: 0 },
      { code: "148192", specialty: "Cl√≠nica geral", name: "TRANSPLANTE DENTARIO", base_value: 0, unit_value: 0 },
      { code: "148193", specialty: "Cl√≠nica geral", name: "TRATAMENTO DE ALVEOLITE PROVENIENTE DE EXO REALIZADA FORA DA ORHODONTIC", base_value: 0, unit_value: 0 },
      { code: "148194", specialty: "Cl√≠nica geral", name: "TRATAMENTO DE TRAUMATISMO DENTO-ALVEOLAR", base_value: 0, unit_value: 0 },
      { code: "148195", specialty: "Cl√≠nica geral", name: "TRATAMENTO DE HEMORRAGIA PROVENIENTE DE EXO REALIZADA FORA DA ORTHODONTIC", base_value: 0, unit_value: 0 },
      { code: "148196", specialty: "Cl√≠nica geral", name: "DRENAGEM DE ABSCESSO", base_value: 0, unit_value: 0 },
      { code: "148197", specialty: "Ortodontia", name: "Profilaxia (Campanha)", base_value: 0, unit_value: 0 },
      { code: "148198", specialty: "Produtos", name: "Protetor Bucal", base_value: 0, unit_value: 0 },
      { code: "148199", specialty: "Cl√≠nica geral", name: "Alinhadores Invisalign - Plano 6 meses (teste piloto)", base_value: 3294, unit_value: 0 },
      { code: "148200", specialty: "Cl√≠nica geral", name: "Alinhadores Invisalign - Plano 6 meses - COM Beneficios (teste piloto)", base_value: 3554, unit_value: 0 },
      { code: "148201", specialty: "Cl√≠nica geral", name: "Alinhadores Invisalign - Escaneamento Digital (teste piloto)", base_value: 0, unit_value: 0 },
      { code: "148202", specialty: "Cl√≠nica geral", name: "Contencao transparente Vivera - (teste piloto)", base_value: 0, unit_value: 0 },
      { code: "148203", specialty: "Cl√≠nica geral", name: "Alinhadores Invisalign - TOUCH UP - 1 par (teste piloto)", base_value: 0, unit_value: 0 },
      { code: "148206", specialty: "Cl√≠nica geral", name: "Remo√ß√£o de Lentes", base_value: 0, unit_value: 0 },
      { code: "148207", specialty: "Radiologia", name: "Raio x Panoramica (Campanha - Parc 2x Cart√£o)", base_value: 0, unit_value: 59 },
      { code: "148208", specialty: "Produtos", name: "Kit ortodontico - (Cera, Superfloss e Escova Interdental)", base_value: 0, unit_value: 0 },
      { code: "148209", specialty: "Produtos", name: "Superfloss", base_value: 0, unit_value: 0 },
      { code: "148210", specialty: "Produtos", name: "Escova id orthokit", base_value: 0, unit_value: 0 },
      { code: "148211", specialty: "Cl√≠nica geral", name: "Manutencao Avulsa", base_value: 0, unit_value: 0 },
      { code: "148212", specialty: "Cl√≠nica geral", name: "Aumento de DVO em Resina Composta", base_value: 0, unit_value: 0 },
      { code: "148213", specialty: "Ortodontia", name: "PERSONALIZACAO DE APARELHO ORTOPEDICO", base_value: 0, unit_value: 0 },
      { code: "148214", specialty: "Cl√≠nica geral", name: "Avaliacao Clinica com Indicacao profilaxia", base_value: 0, unit_value: 0 },
      { code: "148215", specialty: "Cl√≠nica geral", name: "Remocao de Espicula Ossea", base_value: 0, unit_value: 0 },
      { code: "148216", specialty: "Cl√≠nica geral", name: "AVALIACAO COM SCANNER DIGITAL", base_value: 0, unit_value: 0 },
      { code: "148217", specialty: "Cl√≠nica geral", name: "Regularizacao de Bordo", base_value: 0, unit_value: 0 },
      { code: "148218", specialty: "Cl√≠nica geral", name: "MULTIPLAS EXTRACOES", base_value: 0, unit_value: 0 },
      { code: "148219", specialty: "Cl√≠nica geral", name: "SCANER SUPERIOR E INFERIOR", base_value: 0, unit_value: 0 },
      { code: "148220", specialty: "Cl√≠nica geral", name: "ENCERRAMENTO DE DIAGNOSTICO", base_value: 0, unit_value: 0 },
    ];

    // ‚îÄ‚îÄ‚îÄ SUPABASE CONFIGURATION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const SUPABASE_URL = 'https://bzixxdtbktsztdtpadwh.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ6aXh4ZHRia3RzenRkdHBhZHdoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE0NDcwNjEsImV4cCI6MjA4NzAyMzA2MX0.DqgAyHB_QPzkz21RFXYf-fN1IzxyxoX4mMzqr3KMIww';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Role values now match the DB enum directly (OWNER, ADMIN, MANAGER, RECEPTION, PROFESSIONAL)
    // No mapping needed ‚Äî app uses DB enum values as-is

    // ‚îÄ‚îÄ‚îÄ UTILITIES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const generateId = () => Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
    const formatDate = (d) => new Date(d).toLocaleDateString("pt-BR");
    const formatDateTime = (d) => new Date(d).toLocaleString("pt-BR");
    const formatDateISO = (d) => new Date(d).toISOString().split("T")[0];
    const fileIcon = (type) => {
      if (type?.startsWith("image/")) return "üñºÔ∏è";
      if (type?.includes("pdf")) return "üìÑ";
      return "üìé";
    };
    const formatSize = (bytes) => {
      if (bytes < 1024) return bytes + " B";
      if (bytes < 1048576) return (bytes / 1024).toFixed(1) + " KB";
      return (bytes / 1048576).toFixed(1) + " MB";
    };

    const defaultAnamnesis = {
      allergies: "", medications: "", diseases: "", surgeries: "", familyHistory: "",
      smoker: "N√£o", drinker: "N√£o", pregnant: "N√£o", bloodPressure: "",
      diabetes: "N√£o", heartDisease: "N√£o", hepatitis: "N√£o", hiv: "N√£o",
      bleeding: "N√£o", healing: "Normal", anesthesiaReaction: "N√£o", observations: "",
    };

    // Migrate old inline base64 data to IndexedDB
    const migrateFileToIDB = (item) => {
      if (item && item.data && typeof item.data === "string" && item.data.startsWith("data:")) {
        FileDB.put(item.id, item.data).catch(() => {});
        const { data, ...meta } = item;
        return meta;
      }
      return item;
    };

    const migratePatient = (p) => ({
      ...p,
      codigo: p.codigo || "",
      responsavel_clinico_id: p.responsavel_clinico_id || "",
      responsavel_orto_id: p.responsavel_orto_id || "",
      responsavelHistory: p.responsavelHistory || [],
      documents: (p.documents || []).map(migrateFileToIDB),
      arrivalControl: p.arrivalControl || null,
      financeiro: p.financeiro || { orcamento_total: 0, pagamentos: [] },
      records: (p.records || []).map(r => ({
        ...r,
        tipo_atendimento: r.tipo_atendimento || (r.specialty === "ortodontia" ? "ORTODONTIA" : "GERAL"),
        dentista_atendente_id: r.dentista_atendente_id || "",
        dentista_responsavel_no_momento_id: r.dentista_responsavel_no_momento_id || "",
        atendimento_fora_da_responsabilidade: r.atendimento_fora_da_responsabilidade || false,
        motivo_fora: r.motivo_fora || "",
        photos: (r.photos || []).map(migrateFileToIDB),
        wireInfo: r.wireInfo?.upper ? r.wireInfo : { upper: { material: r.wireInfo?.material || "", format: r.wireInfo?.format || "", gauge: r.wireInfo?.gauge || "" }, lower: { material: "", format: "", gauge: "" } },
      })),
    });

    // Default admin stub (no credentials ‚Äî auth is handled by Supabase)
    const DEFAULT_ADMIN = {
      id: "admin1", name: "Administrador", login: "",
      role: "ADMIN", specialty: "", active: true, createdAt: new Date().toISOString(),
    };

    // ‚îÄ‚îÄ‚îÄ INDEXEDDB FILE STORAGE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // Files are stored in IndexedDB to avoid localStorage size limits.
    // Only metadata (id, name, type, size) is kept in state/localStorage.
    const FileDB = (() => {
      const DB_NAME = "dental_files_db";
      const STORE = "files";
      const open = () => new Promise((resolve, reject) => {
        const req = indexedDB.open(DB_NAME, 1);
        req.onupgradeneeded = () => req.result.createObjectStore(STORE);
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => reject(req.error);
      });
      return {
        put: async (id, data) => { const db = await open(); return new Promise((res, rej) => { const tx = db.transaction(STORE, "readwrite"); tx.objectStore(STORE).put(data, id); tx.oncomplete = () => res(); tx.onerror = () => rej(tx.error); }); },
        get: async (id) => { const db = await open(); return new Promise((res, rej) => { const tx = db.transaction(STORE, "readonly"); const req = tx.objectStore(STORE).get(id); req.onsuccess = () => res(req.result); req.onerror = () => rej(req.error); }); },
        del: async (id) => { const db = await open(); return new Promise((res, rej) => { const tx = db.transaction(STORE, "readwrite"); tx.objectStore(STORE).delete(id); tx.oncomplete = () => res(); tx.onerror = () => rej(tx.error); }); },
      };
    })();

    // ‚îÄ‚îÄ‚îÄ SIGNATURE PAD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function SignaturePad({ value, onChange, label }) {
      const canvasRef = useRef(null);
      const [isDrawing, setIsDrawing] = useState(false);
      const [hasDrawn, setHasDrawn] = useState(false);
      useEffect(() => {
        const canvas = canvasRef.current;
        if (!canvas) return;
        const ctx = canvas.getContext("2d");
        const rect = canvas.parentElement.getBoundingClientRect();
        canvas.width = rect.width; canvas.height = 160;
        ctx.fillStyle = "#FAFBFC"; ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.strokeStyle = "#E2E8F0"; ctx.lineWidth = 1; ctx.setLineDash([4,4]);
        ctx.beginPath(); ctx.moveTo(20, 120); ctx.lineTo(canvas.width - 20, 120); ctx.stroke(); ctx.setLineDash([]);
        if (value) {
          const img = new Image();
          img.onload = () => { ctx.fillStyle="#FAFBFC"; ctx.fillRect(0,0,canvas.width,canvas.height); ctx.drawImage(img,0,0,canvas.width,canvas.height); setHasDrawn(true); };
          img.src = value;
        }
      }, []);
      const getPos = (e) => { const c=canvasRef.current, r=c.getBoundingClientRect(), t=e.touches?e.touches[0]:e; return { x:(t.clientX-r.left)*(c.width/r.width), y:(t.clientY-r.top)*(c.height/r.height) }; };
      const startDraw = (e) => { e.preventDefault(); const ctx=canvasRef.current.getContext("2d"), pos=getPos(e); ctx.beginPath(); ctx.moveTo(pos.x,pos.y); ctx.strokeStyle="#1E293B"; ctx.lineWidth=2.5; ctx.lineCap="round"; ctx.lineJoin="round"; setIsDrawing(true); setHasDrawn(true); };
      const draw = (e) => { e.preventDefault(); if(!isDrawing) return; const ctx=canvasRef.current.getContext("2d"), pos=getPos(e); ctx.lineTo(pos.x,pos.y); ctx.stroke(); };
      const endDraw = (e) => { if(e) e.preventDefault(); setIsDrawing(false); if(canvasRef.current && hasDrawn) onChange(canvasRef.current.toDataURL("image/png")); };
      const clearSig = () => { const c=canvasRef.current, ctx=c.getContext("2d"); ctx.fillStyle="#FAFBFC"; ctx.fillRect(0,0,c.width,c.height); ctx.strokeStyle="#E2E8F0"; ctx.lineWidth=1; ctx.setLineDash([4,4]); ctx.beginPath(); ctx.moveTo(20,120); ctx.lineTo(c.width-20,120); ctx.stroke(); ctx.setLineDash([]); setHasDrawn(false); onChange(""); };
      return (
        <div style={{ marginBottom: 14 }}>
          <label style={{ display:"block", fontSize:13, fontWeight:600, color:"#475569", marginBottom:6 }}>{label || "Assinatura do Paciente"}</label>
          <div style={{ position:"relative", borderRadius:12, border:"1.5px solid #CBD5E1", overflow:"hidden", background:"#FAFBFC" }}>
            <canvas ref={canvasRef} style={{ display:"block", width:"100%", height:160, cursor:"crosshair", touchAction:"none" }}
              onMouseDown={startDraw} onMouseMove={draw} onMouseUp={endDraw} onMouseLeave={endDraw}
              onTouchStart={startDraw} onTouchMove={draw} onTouchEnd={endDraw} />
            <div style={{ position:"absolute", bottom:8, left:12, fontSize:10, color:"#94A3B8", pointerEvents:"none" }}>Assine acima da linha</div>
            <button onClick={clearSig} style={{ position:"absolute", top:8, right:8, background:"rgba(255,255,255,0.9)", border:"1px solid #E2E8F0", borderRadius:6, padding:"4px 10px", fontSize:11, color:"#64748B", cursor:"pointer", fontWeight:600 }}>Limpar</button>
          </div>
        </div>
      );
    }

    // ‚îÄ‚îÄ‚îÄ REUSABLE UI COMPONENTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function Modal({ isOpen, onClose, title, children, wide }) {
      if (!isOpen) return null;
      return (
        <div style={{ position:"fixed", inset:0, zIndex:1000, display:"flex", alignItems:"center", justifyContent:"center", background:"rgba(15,23,42,0.6)", backdropFilter:"blur(4px)" }} onClick={onClose}>
          <div onClick={e=>e.stopPropagation()} style={{ background:"#fff", borderRadius:16, width:wide?"90%":"min(560px,92%)", maxWidth:wide?900:560, maxHeight:"88vh", overflow:"hidden", display:"flex", flexDirection:"column", boxShadow:"0 25px 60px rgba(0,0,0,0.2)" }}>
            <div style={{ padding:"20px 24px", borderBottom:"1px solid #E2E8F0", display:"flex", justifyContent:"space-between", alignItems:"center", flexShrink:0 }}>
              <h2 style={{ margin:0, fontSize:18, fontWeight:700, color:"#0F172A" }}>{title}</h2>
              <button onClick={onClose} style={{ background:"#F1F5F9", border:"none", borderRadius:8, width:32, height:32, cursor:"pointer", fontSize:18, display:"flex", alignItems:"center", justifyContent:"center", color:"#64748B" }}>√ó</button>
            </div>
            <div style={{ padding:24, overflowY:"auto", flex:1 }}>{children}</div>
          </div>
        </div>
      );
    }
    function Input({ label, ...props }) {
      return (<div style={{ marginBottom:14 }}>
        {label && <label style={{ display:"block", fontSize:13, fontWeight:600, color:"#475569", marginBottom:5 }}>{label}</label>}
        <input {...props} style={{ width:"100%", padding:"10px 14px", borderRadius:10, border:"1.5px solid #CBD5E1", fontSize:14, outline:"none", transition:"border 0.2s", boxSizing:"border-box", background:"#F8FAFC", ...props.style }} />
      </div>);
    }
    function Textarea({ label, ...props }) {
      return (<div style={{ marginBottom:14 }}>
        {label && <label style={{ display:"block", fontSize:13, fontWeight:600, color:"#475569", marginBottom:5 }}>{label}</label>}
        <textarea {...props} style={{ width:"100%", padding:"10px 14px", borderRadius:10, border:"1.5px solid #CBD5E1", fontSize:14, outline:"none", minHeight:70, resize:"vertical", boxSizing:"border-box", background:"#F8FAFC", fontFamily:"inherit", ...props.style }} />
      </div>);
    }
    function Select({ label, options, ...props }) {
      return (<div style={{ marginBottom:14 }}>
        {label && <label style={{ display:"block", fontSize:13, fontWeight:600, color:"#475569", marginBottom:5 }}>{label}</label>}
        <select {...props} style={{ width:"100%", padding:"10px 14px", borderRadius:10, border:"1.5px solid #CBD5E1", fontSize:14, outline:"none", background:"#F8FAFC", boxSizing:"border-box", ...props.style }}>
          {options.map(o => <option key={o.value} value={o.value}>{o.label}</option>)}
        </select>
      </div>);
    }
    function Badge({ text, color }) {
      return (<span style={{ display:"inline-flex", alignItems:"center", gap:4, background:color+"18", color, border:`1px solid ${color}40`, borderRadius:8, padding:"4px 10px", fontSize:12, fontWeight:600, margin:"2px 4px 2px 0" }}>{text}</span>);
    }
    // ‚îÄ‚îÄ StatusChip Component ‚îÄ‚îÄ
    function StatusChip({ label, color, bg, small }) {
      return (
        <span style={{ display:"inline-flex", alignItems:"center", fontSize: small ? 10 : 11, fontWeight:600, color, background: bg || (color + "14"), border:`1px solid ${color}25`, borderRadius:6, padding: small ? "2px 6px" : "3px 10px", letterSpacing:0.1, whiteSpace:"nowrap" }}>
          {label}
        </span>
      );
    }
    // ‚îÄ‚îÄ FAB Component ‚îÄ‚îÄ
    function FAB({ onClick, label }) {
      return (
        <button onClick={onClick} style={{ position:"fixed", bottom:24, right:24, zIndex:90, width:56, height:56, borderRadius:16, background:"#0EA5E9", color:"#fff", border:"none", fontSize:28, fontWeight:300, cursor:"pointer", boxShadow:"0 4px 20px rgba(14,165,233,0.35)", display:"flex", alignItems:"center", justifyContent:"center", transition:"transform 0.2s, box-shadow 0.2s" }}
          onMouseEnter={e => { e.currentTarget.style.transform="scale(1.08)"; e.currentTarget.style.boxShadow="0 6px 28px rgba(14,165,233,0.5)"; }}
          onMouseLeave={e => { e.currentTarget.style.transform="scale(1)"; e.currentTarget.style.boxShadow="0 4px 20px rgba(14,165,233,0.4)"; }}
          title={label || "Novo"}>
          +
        </button>
      );
    }
    // ‚îÄ‚îÄ ConfirmModal Component ‚îÄ‚îÄ
    function ConfirmModal({ config, onClose }) {
      if (!config) return null;
      return (
        <div style={{ position:"fixed", inset:0, zIndex:1100, display:"flex", alignItems:"center", justifyContent:"center", background:"rgba(15,23,42,0.6)", backdropFilter:"blur(4px)" }} onClick={onClose}>
          <div onClick={e => e.stopPropagation()} style={{ background:"#fff", borderRadius:"var(--radius-lg)", width:"min(400px,90%)", boxShadow:"var(--shadow-lg)", overflow:"hidden" }}>
            <div style={{ padding:"var(--space-4) var(--space-5)" }}>
              <div style={{ fontSize:17, fontWeight:700, color: config.danger ? "var(--color-danger)" : "var(--color-text)", marginBottom:"var(--space-1)" }}>{config.title}</div>
              <div style={{ fontSize:13, color:"var(--color-text-secondary)", lineHeight:1.5 }}>{config.message}</div>
            </div>
            <div style={{ padding:"var(--space-2) var(--space-5) var(--space-4)", display:"flex", gap:"var(--space-2)", justifyContent:"flex-end" }}>
              <button onClick={onClose} style={{ background:"var(--color-surface)", border:"1px solid var(--color-border)", borderRadius:"var(--radius-sm)", padding:"10px 20px", fontSize:13, fontWeight:600, color:"var(--color-text-secondary)", cursor:"pointer", minHeight:44 }} aria-label="Cancelar">Cancelar</button>
              <button onClick={() => { config.onConfirm(); onClose(); }} style={{ background: config.danger ? "var(--color-danger)" : "var(--color-primary)", color:"#fff", border:"none", borderRadius:"var(--radius-sm)", padding:"10px 20px", fontSize:13, fontWeight:700, cursor:"pointer", minHeight:44 }} aria-label={config.confirmLabel || "Confirmar"}>{config.confirmLabel || "Confirmar"}</button>
            </div>
          </div>
        </div>
      );
    }
    // ‚îÄ‚îÄ ActionMenu Component ‚îÄ‚îÄ
    function ActionMenu({ open, onClose, items, anchorRight }) {
      if (!open) return null;
      const handleKeyDown = (e) => { if (e.key === "Escape") onClose(); };
      return (
        <React.Fragment>
          <div className="action-menu-overlay" onClick={onClose} onKeyDown={handleKeyDown} tabIndex={-1} />
          <div className="action-menu" style={anchorRight ? { right:0 } : { left:0 }}>
            {items.map((item, i) => {
              if (item.divider) return <div key={i} className="action-menu-divider" />;
              return (
                <button key={i} className="action-menu-item" data-danger={item.danger || undefined} onClick={() => { item.onClick(); onClose(); }} aria-label={item.label}>
                  {item.icon && <span style={{ fontSize:15, width:20, textAlign:"center" }}>{item.icon}</span>}
                  {item.label}
                </button>
              );
            })}
          </div>
        </React.Fragment>
      );
    }

    // SVG tooth shapes for visual odontogram
    const ToothSVG = ({ type, number, isSelected, onClick }) => {
      const baseColor = isSelected ? "#0EA5E9" : "#B8C5D6";
      const fillColor = isSelected ? "#0EA5E920" : "transparent";
      
      // Determine tooth type based on number
      const getToothType = (num) => {
        const lastDigit = num % 10;
        if (lastDigit === 8 || lastDigit === 7 || lastDigit === 6) return "molar";
        if (lastDigit === 5 || lastDigit === 4) return "premolar";
        if (lastDigit === 3) return "canine";
        return "incisor"; // 1, 2
      };
      
      const toothType = getToothType(number);
      const isUpper = number >= 11 && number <= 28;
      
      // SVG paths for different tooth types
      const paths = {
        molar: isUpper 
          ? "M5,15 L5,8 Q5,5 8,5 L22,5 Q25,5 25,8 L25,15 Q25,18 22,18 L20,18 L20,35 Q20,38 17,38 L13,38 Q10,38 10,35 L10,18 L8,18 Q5,18 5,15 Z M11,18 L11,32 L13,32 L13,18 Z M17,18 L17,32 L19,32 L19,18 Z"
          : "M5,5 Q5,2 8,2 L22,2 Q25,2 25,5 L25,12 Q25,15 22,15 L20,15 L20,25 Q20,30 18,32 Q16,34 15,34 Q14,34 12,32 Q10,30 10,25 L10,15 L8,15 Q5,15 5,12 Z M11,15 L11,24 Q11,27 13,29 L13,15 Z M17,15 L17,29 Q19,27 19,24 L19,15 Z",
        premolar: isUpper
          ? "M7,15 L7,8 Q7,5 10,5 L20,5 Q23,5 23,8 L23,15 Q23,18 20,18 L18,18 L18,35 Q18,38 15,38 Q12,38 12,35 L12,18 L10,18 Q7,18 7,15 Z M13,18 L13,33 L17,33 L17,18 Z"
          : "M7,5 Q7,2 10,2 L20,2 Q23,2 23,5 L23,12 Q23,15 20,15 L18,15 L18,28 Q18,32 15,34 Q12,32 12,28 L12,15 L10,15 Q7,15 7,12 Z M13,15 L13,27 Q13,29 15,30 Q17,29 17,27 L17,15 Z",
        canine: isUpper
          ? "M10,12 L10,6 Q10,3 13,3 L17,3 Q20,3 20,6 L20,12 Q20,15 18,17 L16,17 L16,36 Q16,39 15,39 Q14,39 14,36 L14,17 L12,17 Q10,15 10,12 Z"
          : "M10,4 Q10,2 13,2 L17,2 Q20,2 20,4 L20,10 Q20,13 18,15 L16,15 L16,30 Q16,33 15,34 Q14,33 14,30 L14,15 L12,15 Q10,13 10,10 Z",
        incisor: isUpper
          ? "M9,12 L9,6 Q9,3 12,3 L18,3 Q21,3 21,6 L21,12 Q21,15 18,15 L17,15 L17,35 Q17,38 15,38 Q13,38 13,35 L13,15 L12,15 Q9,15 9,12 Z"
          : "M10,5 Q10,2 13,2 L17,2 Q20,2 20,5 L20,11 Q20,14 17,14 L16,14 L16,30 Q16,33 15,34 Q14,33 14,30 L14,14 L13,14 Q10,14 10,11 Z",
      };
      
      return (
        <g onClick={onClick} style={{ cursor: "pointer" }}>
          <path d={paths[toothType]} fill={fillColor} stroke={baseColor} strokeWidth="1.5" />
        </g>
      );
    };

    function ToothChart({ selected, onToggle }) {
      const upperTeeth = [18,17,16,15,14,13,12,11,21,22,23,24,25,26,27,28];
      const lowerTeeth = [48,47,46,45,44,43,42,41,31,32,33,34,35,36,37,38];
      
      return (<div style={{ marginBottom:14 }}>
        <label style={{ display:"block", fontSize:13, fontWeight:600, color:"#475569", marginBottom:8 }}>Dentes Envolvidos</label>
        <div style={{ background:"#F8FAFC", borderRadius:12, padding:"20px 12px", border:"1px solid #E2E8F0" }}>
          {/* Upper Arch */}
          <svg viewBox="0 0 480 50" style={{ width:"100%", height:"auto", marginBottom:8 }}>
            {upperTeeth.map((tooth, idx) => (
              <g key={tooth} transform={`translate(${idx * 30}, 0)`}>
                <ToothSVG 
                  number={tooth} 
                  isSelected={selected.includes(tooth)} 
                  onClick={() => onToggle(tooth)}
                />
                <text 
                  x="15" 
                  y="48" 
                  textAnchor="middle" 
                  fontSize="9" 
                  fontWeight="600"
                  fill="#64748B"
                >
                  {tooth}
                </text>
              </g>
            ))}
          </svg>
          
          {/* Divider */}
          <div style={{ borderTop:"1.5px dashed #CBD5E1", margin:"12px 0" }} />
          
          {/* Lower Arch */}
          <svg viewBox="0 0 480 50" style={{ width:"100%", height:"auto", marginTop:8 }}>
            {lowerTeeth.map((tooth, idx) => (
              <g key={tooth} transform={`translate(${idx * 30}, 10)`}>
                <text 
                  x="15" 
                  y="-2" 
                  textAnchor="middle" 
                  fontSize="9" 
                  fontWeight="600"
                  fill="#64748B"
                >
                  {tooth}
                </text>
                <ToothSVG 
                  number={tooth} 
                  isSelected={selected.includes(tooth)} 
                  onClick={() => onToggle(tooth)}
                />
              </g>
            ))}
          </svg>
        </div>
      </div>);
    }

    // ‚îÄ‚îÄ‚îÄ FILE THUMBNAIL (lazy loads from IndexedDB) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function FileThumb({ fileId, cache, loadFn, type, name, onClick, style }) {
      const [loaded, setLoaded] = useState(false);
      useEffect(() => { if (fileId && !cache[fileId]) { loadFn(fileId); } }, [fileId]);
      const src = cache[fileId];
      if (type?.startsWith("image/")) {
        return src ? <img src={src} alt={name} onClick={onClick} style={{ width:"100%", height:"100%", objectFit:"cover", display:"block", cursor:onClick?"pointer":"default", ...style }} />
          : <div style={{ width:"100%", height:"100%", display:"flex", alignItems:"center", justifyContent:"center", background:"#F1F5F9", fontSize:10, color:"#94A3B8", ...style }}>Carregando...</div>;
      }
      return <div onClick={onClick} style={{ width:"100%", height:"100%", background:"#F8FAFC", display:"flex", alignItems:"center", justifyContent:"center", fontSize:28, cursor:"pointer", ...style }}>{fileIcon(type)}</div>;
    }

    // ‚îÄ‚îÄ‚îÄ MAIN APP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function App() {
      // ‚îÄ‚îÄ Auth State ‚îÄ‚îÄ
      const [users, setUsers] = useState(() => {
        try { const u = JSON.parse(localStorage.getItem("dental_users")); return u && u.length ? u : [DEFAULT_ADMIN]; } catch { return [DEFAULT_ADMIN]; }
      });
      const [currentUser, setCurrentUser] = useState(() => {
        try { return JSON.parse(localStorage.getItem("dental_session")); } catch { return null; }
      });
      const [loginForm, setLoginForm] = useState({ login: "", password: "" });
      const [loginError, setLoginError] = useState("");

      // ‚îÄ‚îÄ Data State ‚îÄ‚îÄ
      const [patients, setPatients] = useState([]);
      const [loadingPatients, setLoadingPatients] = useState(true);
      const [auditLogs, setAuditLogs] = useState(() => {
        try { return JSON.parse(localStorage.getItem("dental_audit")) || []; } catch { return []; }
      });
      
      // ‚îÄ‚îÄ Realtime State ‚îÄ‚îÄ
      const [syncing, setSyncing] = useState(false);
      const [notifications, setNotifications] = useState([]);
      const [realtimeChannels, setRealtimeChannels] = useState([]);

      // ‚îÄ‚îÄ Navigation ‚îÄ‚îÄ
      const [view, setView] = useState("list");
      const [selectedPatient, setSelectedPatient] = useState(null);
      const [searchTerm, setSearchTerm] = useState("");
      const [patientTab, setPatientTab] = useState("atendimentos");
      const [patientRecordFilter, setPatientRecordFilter] = useState("orto");
      const [auditFilter, setAuditFilter] = useState("");
      const [docDateFilter, setDocDateFilter] = useState("");
      const [showPatientMenu, setShowPatientMenu] = useState(false);
      const [showEncounterMenu, setShowEncounterMenu] = useState(null);
      const [confirmModal, setConfirmModal] = useState(null);
      const [expandedNotes, setExpandedNotes] = useState({});

      // ‚îÄ‚îÄ Modals ‚îÄ‚îÄ
      const [showAppMenu, setShowAppMenu] = useState(false);
      const [activeTab, setActiveTab] = useState("fila");
      const [swipingCardId, setSwipingCardId] = useState(null);
      const [swipeX, setSwipeX] = useState(0);
      const [touchStartX, setTouchStartX] = useState(0);
      const [showNewPatient, setShowNewPatient] = useState(false);
      const [showNewRecord, setShowNewRecord] = useState(false);
      const [showAnamnesis, setShowAnamnesis] = useState(false);
      const [editingAnamnesis, setEditingAnamnesis] = useState(false);
      const [viewingSignature, setViewingSignature] = useState(null);
      const [viewingPhoto, setViewingPhoto] = useState(null);
      const [showChangeResp, setShowChangeResp] = useState(false);
      const [showRespCheck, setShowRespCheck] = useState(false);
      const [showUserForm, setShowUserForm] = useState(false);
      const [showUploadDoc, setShowUploadDoc] = useState(false);
      const [showArrivalControl, setShowArrivalControl] = useState(false);
      const [arrivalPatientId, setArrivalPatientId] = useState(null);

      // ‚îÄ‚îÄ Forms ‚îÄ‚îÄ
      const [npForm, setNpForm] = useState({ codigo:"", name:"", birthDate:"", phone:"", email:"", address:"", responsavel_clinico_id:"", responsavel_orto_id:"" });
      const emptyNrForm = { date:formatDateISO(new Date()), tipo_atendimento:"", specialty:"", procedures:[], teeth:[], notes:"", nextAppointment:"", signature:"", photos:[], wireInfo:{upper:{material:"",format:"",gauge:""},lower:{material:"",format:"",gauge:""}} };
      const [nrForm, setNrForm] = useState({...emptyNrForm});
      const [anamnesisForm, setAnamnesisForm] = useState({...defaultAnamnesis});
      const [userForm, setUserForm] = useState({ id:"", name:"", login:"", password:"", role:"PROFESSIONAL", active:true });
      const [editingUserId, setEditingUserId] = useState(null);
      const [respForm, setRespForm] = useState({ responsavel_clinico_id:"", responsavel_orto_id:"" });
      const [respCheckMotivo, setRespCheckMotivo] = useState("");
      const [pendingRecord, setPendingRecord] = useState(null);
      const [arrivalForm, setArrivalForm] = useState({ dentista_id: "" });
      const [showFinanceiro, setShowFinanceiro] = useState(false);
      const [financeiroForm, setFinanceiroForm] = useState({ data: formatDateISO(new Date()), valor: "", forma_pagamento: "avista", observacao: "" });
      // ‚îÄ‚îÄ Or√ßamentos ‚îÄ‚îÄ
      const [showOrcamentos, setShowOrcamentos] = useState(false);
      const [orcamentoView, setOrcamentoView] = useState("list"); // list | form | print
      const [editingBudget, setEditingBudget] = useState(null);
      const [budgetForm, setBudgetForm] = useState({ budget_date: formatDateISO(new Date()), professional_id: "", notes: "", status: "rascunho", discount_total: 0, items: [] });
      const [procSearch, setProcSearch] = useState("");
      const [procSearchResults, setProcSearchResults] = useState([]);
      const [printingBudget, setPrintingBudget] = useState(null);
      const [budgetListKey, setBudgetListKey] = useState(0);

      const [showRelatorio, setShowRelatorio] = useState(false);
      const [relatorioFilters, setRelatorioFilters] = useState({ profissional_id: "", data_inicio: formatDateISO(new Date(new Date().getFullYear(), new Date().getMonth(), 1)), data_fim: formatDateISO(new Date()), busca: "" });
      const [relatorioSort, setRelatorioSort] = useState({ field: "date", direction: "desc" });

      // ‚îÄ‚îÄ Relat√≥rio Ortodontia ‚îÄ‚îÄ
      const [showRelatorioOrtho, setShowRelatorioOrtho] = useState(false);
      const [orthoReportFilters, setOrthoReportFilters] = useState({ status: [], busca: "", profissional_id: "" });

      // ‚îÄ‚îÄ Refs ‚îÄ‚îÄ
      const photoInputRef = useRef(null);
      const docInputRef = useRef(null);

      // ‚îÄ‚îÄ Supabase Session Restore ‚îÄ‚îÄ
      useEffect(() => {
        const restoreSession = async () => {
          const { data: { session } } = await supabase.auth.getSession();
          if (session?.user) {
            // Buscar perfil do usu√°rio
            const { data: profile } = await supabase
              .from('profiles')
              .select('*')
              .eq('user_id', session.user.id)
              .single();
            
            if (profile) {
              const localUser = {
                id: profile.user_id,
                name: profile.full_name || session.user.email,
                login: session.user.email,
                role: profile.role || 'RECEPTION',
                specialty: '',
                active: true,
                clinic_id: profile.clinic_id,
                createdAt: profile.created_at
              };
              setCurrentUser(localUser);
            }
          } else {
            setLoadingPatients(false);
          }
        };
        restoreSession();
      }, []);

      // ‚îÄ‚îÄ Migra√ß√£o de Dados Antigos ‚îÄ‚îÄ
      const migrateOldDataToSupabase = async () => {
        try {
          const oldPatients = JSON.parse(localStorage.getItem("dental_patients")) || [];
          if (oldPatients.length === 0) return { migrated: 0, errors: 0 };
          
          let migrated = 0;
          let errors = 0;
          
          for (const oldPatient of oldPatients) {
            try {
              // Inserir paciente no Supabase
              const { data, error } = await supabase
                .from('patients')
                .insert({
                  clinic_id: currentUser.clinic_id,
                  codigo: oldPatient.codigo || '',
                  name: oldPatient.name,
                  birth_date: oldPatient.birthDate || null,
                  phone: oldPatient.phone || '',
                  email: oldPatient.email || '',
                  address: oldPatient.address || '',
                  responsavel_clinico_id: oldPatient.responsavel_clinico_id || '',
                  responsavel_orto_id: oldPatient.responsavel_orto_id || ''
                })
                .select()
                .single();
              
              if (error) throw error;
              
              // Salvar dados relacionados no LocalStorage com novo ID
              if (oldPatient.anamnesis) saveLocalData('anamnesis', data.id, oldPatient.anamnesis);
              if (oldPatient.records) saveLocalData('records', data.id, oldPatient.records);
              if (oldPatient.documents) saveLocalData('documents', data.id, oldPatient.documents);
              if (oldPatient.responsavelHistory) saveLocalData('responsavelHistory', data.id, oldPatient.responsavelHistory);
              if (oldPatient.arrivalControl) saveLocalData('arrivalControl', data.id, oldPatient.arrivalControl);
              if (oldPatient.financeiro) saveLocalData('financeiro', data.id, oldPatient.financeiro);
              
              migrated++;
            } catch (err) {
              console.error(`Erro ao migrar paciente ${oldPatient.name}:`, err);
              errors++;
            }
          }
          
          // Limpar dados antigos ap√≥s migra√ß√£o bem-sucedida
          if (migrated > 0 && errors === 0) {
            localStorage.removeItem("dental_patients");
          }
          
          return { migrated, errors, total: oldPatients.length };
        } catch (err) {
          console.error('Erro na migra√ß√£o:', err);
          return { migrated: 0, errors: 0, total: 0 };
        }
      };

      // ‚îÄ‚îÄ Load Patients from Supabase ‚îÄ‚îÄ
      useEffect(() => {
        const loadPatients = async () => {
          if (!currentUser || !currentUser.clinic_id) {
            setLoadingPatients(false);
            return;
          }
          
          try {
            // Verificar se h√° dados antigos para migrar
            const oldPatients = JSON.parse(localStorage.getItem("dental_patients") || "[]");
            if (oldPatients.length > 0) {
              const shouldMigrate = confirm(
                `Encontramos ${oldPatients.length} paciente(s) no sistema antigo.\n\n` +
                `Deseja migr√°-los para o novo sistema Supabase?\n\n` +
                `(Recomendado: clique em OK para migrar)`
              );
              
              if (shouldMigrate) {
                const result = await migrateOldDataToSupabase();
                if (result.migrated > 0) {
                  alert(
                    `Migra√ß√£o conclu√≠da!\n\n` +
                    `‚úÖ ${result.migrated} paciente(s) migrado(s) com sucesso\n` +
                    (result.errors > 0 ? `‚ö†Ô∏è ${result.errors} erro(s)` : '')
                  );
                }
              }
            }
            
            // Carregar pacientes do Supabase
            const { data, error } = await supabase
              .from('patients')
              .select('*')
              .eq('clinic_id', currentUser.clinic_id)
              .order('created_at', { ascending: false });
            
            if (error) throw error;
            
            // Converter para formato local (h√≠brido)
            const patientsData = data.map(p => {
              const orthoData = getLocalData('orthoData', p.id) || {};
              return {
                ...p,
                birthDate: p.birth_date,
                // Dados ainda no LocalStorage (tempor√°rio)
                anamnesis: getLocalData('anamnesis', p.id) || {...defaultAnamnesis},
                records: getLocalData('records', p.id) || [],
                documents: getLocalData('documents', p.id) || [],
                responsavelHistory: getLocalData('responsavelHistory', p.id) || [],
                arrivalControl: getLocalData('arrivalControl', p.id) || null,
                financeiro: getLocalData('financeiro', p.id) || { orcamento_total: 0, pagamentos: [] },
                is_orthodontic_patient: orthoData.is_orthodontic_patient || false,
                ortho_status: orthoData.ortho_status || null,
                ortho_status_updated_at: orthoData.ortho_status_updated_at || null,
                ortho_status_updated_by: orthoData.ortho_status_updated_by || null,
                ortho_status_history: orthoData.ortho_status_history || [],
                createdAt: p.created_at
              };
            });
            
            setPatients(patientsData);
          } catch (err) {
            console.error('Erro ao carregar pacientes:', err);
            // Fallback para LocalStorage se houver erro
            try {
              const localPatients = JSON.parse(localStorage.getItem("dental_patients")) || [];
              setPatients(localPatients.map(migratePatient));
            } catch {
              setPatients([]);
            }
          } finally {
            setLoadingPatients(false);
          }
        };
        
        loadPatients();
      }, [currentUser]);
      
      // ‚îÄ‚îÄ Load Clinic Users from Supabase ‚îÄ‚îÄ
      useEffect(() => {
        const loadClinicUsers = async () => {
          console.log('[DEBUG] loadClinicUsers chamado', { currentUser });
          if (!currentUser?.clinic_id) {
            console.log('[DEBUG] Sem clinic_id, retornando');
            return;
          }
          
          try {
            console.log('[DEBUG] Buscando perfis da cl√≠nica:', currentUser.clinic_id);
            const { data: profiles, error } = await supabase
              .from('profiles')
              .select('*')
              .eq('clinic_id', currentUser.clinic_id)
              .eq('active', true);
            
            console.log('[DEBUG] Resultado da busca:', { profiles, error });
            
            if (!error && profiles && profiles.length > 0) {
              const localUsers = profiles.map(p => ({
                id: p.user_id,
                name: p.full_name,
                login: p.user_id,
                role: ENUM_TO_ROLE[p.role] || 'recepcao',
                specialty: p.specialty || '',
                active: p.active,
                clinic_id: p.clinic_id,
                createdAt: p.created_at
              }));
              
              console.log('[DEBUG] Usu√°rios carregados:', localUsers);
              setUsers(localUsers);
            } else {
              console.log('[DEBUG] Nenhum perfil encontrado ou erro:', error);
            }
          } catch (err) {
            console.error('Erro ao carregar usu√°rios da cl√≠nica:', err);
          }
        };
        
        loadClinicUsers();
      }, [currentUser?.clinic_id]);
      
      // ‚îÄ‚îÄ Setup Realtime Listeners ‚îÄ‚îÄ
      useEffect(() => {
        if (currentUser && currentUser.clinic_id) {
          setupRealtimeListeners();
        }
        
        // Cleanup ao desmontar ou trocar usu√°rio
        return () => {
          realtimeChannels.forEach(channel => {
            supabase.removeChannel(channel);
          });
        };
      }, [currentUser]);

      // ‚îÄ‚îÄ Persist (with error handling to prevent UI freeze) ‚îÄ‚îÄ
      const safeSave = (key, data) => { try { localStorage.setItem(key, JSON.stringify(data)); } catch(e) { console.warn("localStorage save failed for", key, e.message); } };
      useEffect(() => { safeSave("dental_users", users.map(u => { const { password, ...safe } = u; return safe; })); }, [users]);
      // Pacientes agora s√£o salvos no Supabase, n√£o no localStorage
      // useEffect(() => { safeSave("dental_patients", patients); }, [patients]);
      useEffect(() => { safeSave("dental_audit", auditLogs); }, [auditLogs]);
      useEffect(() => { if (currentUser) safeSave("dental_session", currentUser); else localStorage.removeItem("dental_session"); }, [currentUser]);

      // ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ
      const getUserName = (id) => { const u = users.find(x => x.id === id); return u ? u.name : "‚Äî"; };
      
      // Helper para gerenciar dados locais tempor√°rios (at√© migrar para Supabase)
      const getLocalData = (type, patientId) => {
        try {
          const key = `patient_${type}_${patientId}`;
          const data = localStorage.getItem(key);
          return data ? JSON.parse(data) : null;
        } catch {
          return null;
        }
      };
      
      const saveLocalData = (type, patientId, data) => {
        try {
          const key = `patient_${type}_${patientId}`;
          localStorage.setItem(key, JSON.stringify(data));
        } catch (e) {
          console.warn(`Erro ao salvar ${type} local:`, e);
        }
      };
      
      const removeLocalData = (patientId) => {
        ['anamnesis', 'records', 'documents', 'responsavelHistory', 'arrivalControl', 'financeiro', 'budgets'].forEach(type => {
          try {
            localStorage.removeItem(`patient_${type}_${patientId}`);
          } catch {}
        });
      };
      const isAdmin = isAdminRole(currentUser?.role);
      const activeDentists = users.filter(u => u.active && u.role === "PROFESSIONAL");

      const addAudit = (action, targetType, targetId, targetName, details) => {
        setAuditLogs(prev => [{ id:generateId(), userId:currentUser?.id, userName:currentUser?.name, action, targetType, targetId, targetName, details: details||"", timestamp:new Date().toISOString(), userAgent:navigator.userAgent }, ...prev]);
      };

      // ‚îÄ‚îÄ Auth ‚îÄ‚îÄ
      const handleLogin = async () => {
        setLoginError("");
        try {
          // Autenticar com Supabase Auth
          const { data: authData, error: authError } = await supabase.auth.signInWithPassword({
            email: loginForm.login,
            password: loginForm.password
          });
          
          if (authError) {
            setLoginError("Email ou senha inv√°lidos.");
            return;
          }

          // Buscar perfil do usu√°rio no Supabase
          const { data: profile, error: profileError } = await supabase
            .from('profiles')
            .select('*')
            .eq('user_id', authData.user.id)
            .single();

          if (profileError || !profile) {
            setLoginError("Perfil de usu√°rio n√£o encontrado.");
            await supabase.auth.signOut();
            return;
          }

          // Converter perfil Supabase para formato local
          const localUser = {
            id: profile.user_id,
            name: profile.full_name || authData.user.email,
            login: authData.user.email,
            role: profile.role || 'RECEPTION',
            specialty: '',
            active: true,
            clinic_id: profile.clinic_id,
            createdAt: profile.created_at
          };

          setCurrentUser(localUser);
          setLoginError("");
          setLoginForm({ login:"", password:"" });
          setTimeout(() => addAudit("LOGIN","usuario",localUser.id,localUser.name,"Login realizado"), 0);
        } catch (err) {
          console.error('Erro no login:', err);
          setLoginError("Erro ao fazer login. Tente novamente.");
        }
      };
      
      const handleLogout = async () => {
        await supabase.auth.signOut();
        setCurrentUser(null);
        setView("list");
        setSelectedPatient(null);
      };

      // ‚îÄ‚îÄ Supabase Storage Functions ‚îÄ‚îÄ
      
      // Converter base64 para Blob
      const base64ToBlob = (base64, mimeType = 'image/png') => {
        const byteString = atob(base64.split(',')[1]);
        const ab = new ArrayBuffer(byteString.length);
        const ia = new Uint8Array(ab);
        for (let i = 0; i < byteString.length; i++) {
          ia[i] = byteString.charCodeAt(i);
        }
        return new Blob([ab], { type: mimeType });
      };
      
      // ‚îÄ‚îÄ CRUD Financeiro: Or√ßamentos (localStorage ‚Äî tabelas n√£o existem no DB) ‚îÄ‚îÄ
      const createOrUpdateBudgetSupabase = async (patientId, totalAmount) => {
        try {
          const financeiro = getLocalData('financeiro', patientId) || { orcamento_total: 0, pagamentos: [] };
          financeiro.orcamento_total = parseFloat(totalAmount) || 0;
          saveLocalData('financeiro', patientId, financeiro);
          return { total_amount: financeiro.orcamento_total };
        } catch (err) {
          console.error('Erro ao salvar or√ßamento:', err);
          return null;
        }
      };

      const loadBudgetSupabase = async (patientId) => {
        const financeiro = getLocalData('financeiro', patientId) || { orcamento_total: 0, pagamentos: [] };
        return { total_amount: parseFloat(financeiro.orcamento_total) || 0 };
      };

      // ‚îÄ‚îÄ CRUD Financeiro: Pagamentos (localStorage ‚Äî tabela payments n√£o existe no DB) ‚îÄ‚îÄ
      const createPaymentSupabase = async (patientId, paymentData) => {
        try {
          const financeiro = getLocalData('financeiro', patientId) || { orcamento_total: 0, pagamentos: [] };
          const newPayment = {
            id: generateId(),
            data: paymentData.data,
            valor: parseFloat(paymentData.valor),
            forma_pagamento: paymentData.forma_pagamento,
            observacao: paymentData.observacao || '',
            registrado_por: currentUser.name,
            registrado_em: new Date().toISOString()
          };
          financeiro.pagamentos = [newPayment, ...(financeiro.pagamentos || [])];
          saveLocalData('financeiro', patientId, financeiro);
          return newPayment;
        } catch (err) {
          console.error('Erro ao criar pagamento:', err);
          return null;
        }
      };

      const loadPaymentsSupabase = async (patientId) => {
        const financeiro = getLocalData('financeiro', patientId) || { orcamento_total: 0, pagamentos: [] };
        return financeiro.pagamentos || [];
      };

      const deletePaymentSupabase = async (paymentId) => {
        try {
          // Find which patient has this payment
          for (const p of patients) {
            const financeiro = getLocalData('financeiro', p.id);
            if (financeiro && financeiro.pagamentos) {
              const idx = financeiro.pagamentos.findIndex(pg => pg.id === paymentId);
              if (idx >= 0) {
                financeiro.pagamentos.splice(idx, 1);
                saveLocalData('financeiro', p.id, financeiro);
                return true;
              }
            }
          }
          return true;
        } catch (err) {
          console.error('Erro ao deletar pagamento:', err);
          return false;
        }
      };
      
      // ‚îÄ‚îÄ CRUD Or√ßamentos (budgets) ‚Äî localStorage ‚îÄ‚îÄ
      const loadBudgets = (patientId) => {
        return getLocalData('budgets', patientId) || [];
      };

      const saveBudget = (patientId, budget) => {
        const budgets = loadBudgets(patientId);
        const existingIdx = budgets.findIndex(b => b.id === budget.id);
        if (existingIdx >= 0) {
          budgets[existingIdx] = { ...budget, updated_at: new Date().toISOString() };
        } else {
          budgets.unshift({ ...budget, created_at: new Date().toISOString(), updated_at: new Date().toISOString() });
        }
        saveLocalData('budgets', patientId, budgets);
        syncApprovedBudgetsTotal(patientId, budgets);
        return budget;
      };

      const syncApprovedBudgetsTotal = async (patientId, budgetsOverride) => {
        const budgets = budgetsOverride || loadBudgets(patientId);
        const approvedTotal = budgets
          .filter(b => b.status === "aprovado")
          .reduce((sum, b) => sum + (parseFloat(b.total) || 0), 0);
        try {
          await createOrUpdateBudgetSupabase(patientId, approvedTotal);
        } catch (e) { console.error('Erro sync or√ßamento:', e); }
        setPatients(prev => prev.map(p => p.id === patientId ? {...p, financeiro: {...p.financeiro, orcamento_total: approvedTotal}} : p));
        setSelectedPatient(prev => prev && prev.id === patientId ? {...prev, financeiro: {...prev.financeiro, orcamento_total: approvedTotal}} : prev);

        // Classifica√ß√£o ortod√¥ntica autom√°tica
        syncOrthoClassification(patientId, budgets);
      };

      // ‚îÄ‚îÄ Classifica√ß√£o Ortod√¥ntica Autom√°tica ‚îÄ‚îÄ
      const syncOrthoClassification = (patientId, budgets) => {
        const hasApprovedOrtho = budgets
          .filter(b => b.status === "aprovado")
          .some(b => (b.items || []).some(item => item.specialty && item.specialty.toLowerCase().includes("ortod")));

        if (hasApprovedOrtho) {
          const orthoData = getLocalData('orthoData', patientId) || {};
          if (!orthoData.is_orthodontic_patient) {
            // Primeira classifica√ß√£o ‚Üí setar "Tratamento" como default
            const now = new Date().toISOString();
            const historyEntry = {
              id: generateId(),
              old_status: null,
              new_status: "Tratamento",
              changed_by: currentUser?.name || "Sistema",
              changed_at: now,
              reason: "Classifica√ß√£o autom√°tica: or√ßamento aprovado com especialidade Ortodontia"
            };
            const newOrthoData = {
              is_orthodontic_patient: true,
              ortho_status: "Tratamento",
              ortho_status_updated_at: now,
              ortho_status_updated_by: currentUser?.name || "Sistema",
              ortho_status_history: [...(orthoData.ortho_status_history || []), historyEntry]
            };
            saveLocalData('orthoData', patientId, newOrthoData);
            const updateFields = { is_orthodontic_patient: true, ortho_status: "Tratamento", ortho_status_updated_at: now, ortho_status_updated_by: currentUser?.name || "Sistema", ortho_status_history: newOrthoData.ortho_status_history };
            setPatients(prev => prev.map(p => p.id === patientId ? {...p, ...updateFields} : p));
            setSelectedPatient(prev => prev && prev.id === patientId ? {...prev, ...updateFields} : prev);
            addAudit("CLASSIFICAR_ORTODONTIA", "paciente", patientId, patients.find(p => p.id === patientId)?.name || "", "Classificado automaticamente como Paciente de Ortodontia ‚Üí Status: Tratamento");
          }
        }
        // Regra segura: N√ÉO reverter automaticamente. S√≥ via a√ß√£o manual.
      };

      const updateOrthoStatus = (patientId, newStatus, reason) => {
        const patient = patients.find(p => p.id === patientId);
        if (!patient) return;
        const oldStatus = patient.ortho_status;
        if (oldStatus === newStatus) return;

        const now = new Date().toISOString();
        const historyEntry = {
          id: generateId(),
          old_status: oldStatus,
          new_status: newStatus,
          changed_by: currentUser?.name || "‚Äî",
          changed_at: now,
          reason: reason || ""
        };
        const orthoData = getLocalData('orthoData', patientId) || {};
        const newOrthoData = {
          ...orthoData,
          ortho_status: newStatus,
          ortho_status_updated_at: now,
          ortho_status_updated_by: currentUser?.name || "‚Äî",
          ortho_status_history: [...(orthoData.ortho_status_history || []), historyEntry]
        };
        saveLocalData('orthoData', patientId, newOrthoData);
        const updateFields = { ortho_status: newStatus, ortho_status_updated_at: now, ortho_status_updated_by: currentUser?.name || "‚Äî", ortho_status_history: newOrthoData.ortho_status_history };
        setPatients(prev => prev.map(p => p.id === patientId ? {...p, ...updateFields} : p));
        setSelectedPatient(prev => prev && prev.id === patientId ? {...prev, ...updateFields} : prev);
        addAudit("ALTERAR_STATUS_ORTODONTIA", "paciente", patientId, patient.name, `Status: ${oldStatus || "‚Äî"} ‚Üí ${newStatus}`);
      };

      const removeOrthoClassification = (patientId) => {
        const patient = patients.find(p => p.id === patientId);
        if (!patient) return;
        const now = new Date().toISOString();
        const orthoData = getLocalData('orthoData', patientId) || {};
        const historyEntry = {
          id: generateId(),
          old_status: patient.ortho_status,
          new_status: null,
          changed_by: currentUser?.name || "‚Äî",
          changed_at: now,
          reason: "Classifica√ß√£o de ortodontia removida manualmente"
        };
        const newOrthoData = {
          is_orthodontic_patient: false,
          ortho_status: null,
          ortho_status_updated_at: now,
          ortho_status_updated_by: currentUser?.name || "‚Äî",
          ortho_status_history: [...(orthoData.ortho_status_history || []), historyEntry]
        };
        saveLocalData('orthoData', patientId, newOrthoData);
        const updateFields = { is_orthodontic_patient: false, ortho_status: null, ortho_status_updated_at: now, ortho_status_updated_by: currentUser?.name || "‚Äî", ortho_status_history: newOrthoData.ortho_status_history };
        setPatients(prev => prev.map(p => p.id === patientId ? {...p, ...updateFields} : p));
        setSelectedPatient(prev => prev && prev.id === patientId ? {...prev, ...updateFields} : prev);
        addAudit("REMOVER_ORTODONTIA", "paciente", patientId, patient.name, `Classifica√ß√£o de ortodontia removida. Status anterior: ${patient.ortho_status || "‚Äî"}`);
      };

      const deleteBudget = (patientId, budgetId) => {
        const budgets = loadBudgets(patientId);
        const filtered = budgets.filter(b => b.id !== budgetId);
        saveLocalData('budgets', patientId, filtered);
        syncApprovedBudgetsTotal(patientId, filtered);
      };

      const duplicateBudget = (patientId, budgetId) => {
        const budgets = loadBudgets(patientId);
        const original = budgets.find(b => b.id === budgetId);
        if (!original) return null;
        const newBudget = {
          ...original,
          id: generateId(),
          status: "rascunho",
          budget_date: formatDateISO(new Date()),
          notes: (original.notes || "") + " (C√≥pia)",
          created_at: new Date().toISOString(),
          updated_at: new Date().toISOString(),
        };
        budgets.unshift(newBudget);
        saveLocalData('budgets', patientId, budgets);
        return newBudget;
      };

      const searchProcedures = (query) => {
        if (!query || query.length < 2) return [];
        const q = query.toLowerCase();
        return PROCEDURES_TABLE.filter(p =>
          p.name.toLowerCase().includes(q) ||
          p.code.toLowerCase().includes(q) ||
          p.specialty.toLowerCase().includes(q)
        ).slice(0, 15);
      };

      const initBudgetForm = (budget) => {
        if (budget) {
          setBudgetForm({
            budget_date: budget.budget_date || formatDateISO(new Date()),
            professional_id: budget.professional_id || "",
            notes: budget.notes || "",
            status: budget.status || "rascunho",
            discount_total: budget.discount_total || 0,
            items: budget.items || [],
          });
          setEditingBudget(budget);
        } else {
          setBudgetForm({
            budget_date: formatDateISO(new Date()),
            professional_id: "",
            notes: "",
            status: "rascunho",
            discount_total: 0,
            items: [],
          });
          setEditingBudget(null);
        }
        setProcSearch("");
        setProcSearchResults([]);
      };

      const addBudgetItem = (proc) => {
        const newItem = {
          id: generateId(),
          procedure_id: proc.code,
          procedure_code: proc.code,
          procedure_name: proc.name,
          specialty: proc.specialty,
          dente_ou_regiao: "",
          qty: 1,
          unit_price: proc.unit_value || 0,
          line_discount: 0,
          line_total: proc.unit_value || 0,
        };
        setBudgetForm(prev => ({ ...prev, items: [...prev.items, newItem] }));
        setProcSearch("");
        setProcSearchResults([]);
      };

      const updateBudgetItem = (itemId, field, value) => {
        setBudgetForm(prev => {
          const items = prev.items.map(item => {
            if (item.id !== itemId) return item;
            const updated = { ...item, [field]: value };
            if (field === "qty" || field === "unit_price" || field === "line_discount") {
              const qty = parseFloat(field === "qty" ? value : updated.qty) || 0;
              const price = parseFloat(field === "unit_price" ? value : updated.unit_price) || 0;
              const disc = parseFloat(field === "line_discount" ? value : updated.line_discount) || 0;
              updated.line_total = Math.max(0, (qty * price) - disc);
            }
            return updated;
          });
          return { ...prev, items };
        });
      };

      const removeBudgetItem = (itemId) => {
        setBudgetForm(prev => ({ ...prev, items: prev.items.filter(i => i.id !== itemId) }));
      };

      const calcBudgetSubtotal = (items) => items.reduce((sum, i) => sum + (parseFloat(i.line_total) || 0), 0);

      const handleSaveBudget = (patientId) => {
        // Valida√ß√£o
        const invalidItems = budgetForm.items.filter(i => !i.dente_ou_regiao || !i.dente_ou_regiao.trim());
        if (invalidItems.length > 0) {
          alert("Preencha o campo 'Dente/Regi√£o' de todos os itens antes de salvar.");
          return false;
        }
        if (budgetForm.items.some(i => (parseFloat(i.qty) || 0) <= 0)) {
          alert("Quantidade deve ser maior que zero em todos os itens.");
          return false;
        }
        if (!budgetForm.professional_id) {
          alert("Selecione o profissional respons√°vel.");
          return false;
        }

        const subtotal = calcBudgetSubtotal(budgetForm.items);
        const discountTotal = parseFloat(budgetForm.discount_total) || 0;
        const total = Math.max(0, subtotal - discountTotal);

        const budget = {
          id: editingBudget?.id || generateId(),
          patient_id: patientId,
          budget_date: budgetForm.budget_date,
          professional_id: budgetForm.professional_id,
          professional_name: users.find(u => u.id === budgetForm.professional_id)?.name || "",
          notes: budgetForm.notes,
          status: budgetForm.status,
          items: budgetForm.items,
          subtotal,
          discount_total: discountTotal,
          total,
        };

        saveBudget(patientId, budget);
        addAudit(editingBudget ? "EDITAR_ORCAMENTO" : "CRIAR_ORCAMENTO", "paciente", patientId, selectedPatient?.name || "", `Or√ßamento R$ ${total.toFixed(2)} - ${budget.items.length} item(ns)`);
        return true;
      };

      // ‚îÄ‚îÄ Realtime & Notifica√ß√µes ‚îÄ‚îÄ
      const showNotification = (message, type = 'info') => {
        const id = Date.now();
        setNotifications(prev => [...prev, { id, message, type }]);
        
        // Auto-remover ap√≥s 5 segundos
        setTimeout(() => {
          setNotifications(prev => prev.filter(n => n.id !== id));
        }, 5000);
      };
      
      const setupRealtimeListeners = () => {
        if (!currentUser || !currentUser.clinic_id) return;
        
        // Limpar listeners antigos
        realtimeChannels.forEach(channel => {
          supabase.removeChannel(channel);
        });
        
        const channels = [];
        
        // Listener para patients
        const patientsChannel = supabase
          .channel('patients-changes')
          .on('postgres_changes', 
            { 
              event: '*', 
              schema: 'public', 
              table: 'patients',
              filter: `clinic_id=eq.${currentUser.clinic_id}`
            }, 
            (payload) => {
              const { eventType, new: newRecord, old: oldRecord } = payload;
              
              switch (eventType) {
                case 'INSERT':
                  setPatients(prev => {
                    // Evitar duplicatas
                    if (prev.find(p => p.id === newRecord.id)) return prev;
                    const enriched = {
                      ...newRecord,
                      birthDate: newRecord.birth_date,
                      anamnesis: getLocalData('anamnesis', newRecord.id) || {...defaultAnamnesis},
                      records: getLocalData('records', newRecord.id) || [],
                      documents: getLocalData('documents', newRecord.id) || [],
                      responsavelHistory: getLocalData('responsavelHistory', newRecord.id) || [],
                      arrivalControl: getLocalData('arrivalControl', newRecord.id) || null,
                      financeiro: getLocalData('financeiro', newRecord.id) || { orcamento_total: 0, pagamentos: [] },
                      createdAt: newRecord.created_at
                    };
                    return [...prev, enriched];
                  });
                  showNotification(`Novo paciente: ${newRecord.name}`, 'success');
                  break;
                  
                case 'UPDATE':
                  setPatients(prev => prev.map(p => 
                    p.id === newRecord.id ? { ...p, ...newRecord } : p
                  ));
                  // Atualizar selectedPatient se estiver aberto
                  if (selectedPatient?.id === newRecord.id) {
                    setSelectedPatient(prev => ({ ...prev, ...newRecord }));
                  }
                  showNotification(`Paciente atualizado: ${newRecord.name}`, 'info');
                  break;
                  
                case 'DELETE':
                  setPatients(prev => prev.filter(p => p.id !== oldRecord.id));
                  // Fechar prontu√°rio se estiver aberto
                  if (selectedPatient?.id === oldRecord.id) {
                    setSelectedPatient(null);
                    setView('list');
                  }
                  showNotification(`Paciente removido: ${oldRecord.name}`, 'warning');
                  break;
              }
            }
          )
          .subscribe();
        
        channels.push(patientsChannel);

        // Note: realtime listeners for appointments, patient_budgets, and payments
        // are disabled because those tables do not exist in the current DB schema.
        // Data for those features is stored in localStorage.

        setRealtimeChannels(channels);
      };
      
      // Upload de assinatura para Storage
      const uploadSignatureToStorage = async (appointmentId, patientId, signatureBase64) => {
        try {
          if (!signatureBase64 || !signatureBase64.startsWith('data:image')) {
            return null;
          }
          
          const blob = base64ToBlob(signatureBase64, 'image/png');
          const fileName = `${appointmentId}.png`;
          const filePath = `${currentUser.clinic_id}/${patientId}/${fileName}`;
          
          const { data, error } = await supabase.storage
            .from('appointment-signatures')
            .upload(filePath, blob, {
              contentType: 'image/png',
              upsert: true
            });
          
          if (error) throw error;
          
          // Obter URL p√∫blica
          const { data: { publicUrl } } = supabase.storage
            .from('appointment-signatures')
            .getPublicUrl(filePath);
          
          return publicUrl;
        } catch (err) {
          console.error('Erro ao fazer upload de assinatura:', err);
          return null;
        }
      };
      
      // Upload de foto para Storage
      const uploadPhotoToStorage = async (appointmentId, patientId, file, photoId) => {
        try {
          const ext = file.name.split('.').pop();
          const fileName = `${photoId}.${ext}`;
          const filePath = `${currentUser.clinic_id}/${patientId}/${appointmentId}/${fileName}`;
          
          const { data, error } = await supabase.storage
            .from('appointment-photos')
            .upload(filePath, file, {
              contentType: file.type,
              upsert: true
            });
          
          if (error) throw error;
          
          // Obter URL p√∫blica
          const { data: { publicUrl } } = supabase.storage
            .from('appointment-photos')
            .getPublicUrl(filePath);
          
          return {
            id: photoId,
            name: file.name,
            type: file.type,
            size: file.size,
            url: publicUrl,
            storage_path: filePath
          };
        } catch (err) {
          console.error('Erro ao fazer upload de foto:', err);
          return null;
        }
      };
      
      // Upload de documento para Storage
      const uploadDocumentToStorage = async (patientId, file) => {
        try {
          const docId = `doc-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
          const ext = file.name.split('.').pop();
          const fileName = `${docId}.${ext}`;
          const filePath = `${currentUser.clinic_id}/${patientId}/${fileName}`;
          
          const { data, error } = await supabase.storage
            .from('patient-documents')
            .upload(filePath, file, {
              contentType: file.type,
              upsert: false
            });
          
          if (error) throw error;
          
          // Obter URL p√∫blica
          const { data: { publicUrl } } = supabase.storage
            .from('patient-documents')
            .getPublicUrl(filePath);
          
          // Retornar metadata do documento (tabela patient_documents n√£o existe no DB)
          return {
            id: docId,
            name: file.name,
            type: file.type,
            size: file.size,
            url: publicUrl,
            storage_path: filePath,
            uploadedBy: currentUser.id,
            uploadedByName: currentUser.name,
            uploadedAt: new Date().toISOString()
          };
        } catch (err) {
          console.error('Erro ao fazer upload de documento:', err);
          throw err;
        }
      };
      
      // Deletar arquivo do Storage
      const deleteFromStorage = async (bucket, path) => {
        try {
          const { error } = await supabase.storage
            .from(bucket)
            .remove([path]);
          
          if (error) throw error;
          return true;
        } catch (err) {
          console.error('Erro ao deletar arquivo do Storage:', err);
          return false;
        }
      };

      // ‚îÄ‚îÄ Appointments CRUD (localStorage ‚Äî tabela appointments n√£o existe no DB) ‚îÄ‚îÄ
      const createAppointmentSupabase = async (patientId, appointmentData) => {
        const record = {
          id: generateId(),
          patient_id: patientId,
          date: appointmentData.date,
          tipo_atendimento: appointmentData.tipo_atendimento,
          specialty: appointmentData.specialty,
          procedures: appointmentData.procedures,
          teeth: appointmentData.teeth || [],
          notes: appointmentData.notes || null,
          nextAppointment: appointmentData.nextAppointment || null,
          wireInfo: appointmentData.wireInfo || null,
          dentista_atendente_id: appointmentData.dentista_atendente_id,
          dentista_responsavel_no_momento_id: appointmentData.dentista_responsavel_no_momento_id || null,
          atendimento_fora_da_responsabilidade: appointmentData.atendimento_fora_da_responsabilidade || false,
          motivo_fora: appointmentData.motivo_fora || null,
          signature: appointmentData.signature || "",
          photos: appointmentData.photos || [],
          createdAt: new Date().toISOString()
        };

        const records = getLocalData('records', patientId) || [];
        records.unshift(record);
        saveLocalData('records', patientId, records);
        return record;
      };

      const loadAppointmentsSupabase = async (patientId) => {
        return getLocalData('records', patientId) || [];
      };

      const deleteAppointmentSupabase = async (id) => {
        // Find patient that has this appointment
        for (const p of patients) {
          const records = getLocalData('records', p.id) || [];
          const idx = records.findIndex(r => r.id === id);
          if (idx >= 0) {
            records.splice(idx, 1);
            saveLocalData('records', p.id, records);
            return;
          }
        }
      };

      // ‚îÄ‚îÄ Migra√ß√£o de Records Antigos (n√£o mais necess√°ria, j√° √© localStorage) ‚îÄ‚îÄ
      const migrateRecordsToSupabase = async (patientId) => {
        return { migrated: 0, errors: 0, total: 0 };
      };

      // ‚îÄ‚îÄ Patient CRUD ‚îÄ‚îÄ
      const createPatient = async () => {
        if (!npForm.name.trim()) return;

        try {
          // Verificar sess√£o ativa antes de inserir
          const { data: { session } } = await supabase.auth.getSession();
          if (!session) {
            alert('Sess√£o expirada. Fa√ßa login novamente.');
            setCurrentUser(null);
            return;
          }

          const insertPayload = {
            clinic_id: currentUser.clinic_id,
            codigo: npForm.codigo || '',
            name: npForm.name.trim(),
            birth_date: npForm.birthDate || null,
            phone: npForm.phone || '',
            email: npForm.email || '',
            address: npForm.address || '',
            responsavel_clinico_id: npForm.responsavel_clinico_id || '',
            responsavel_orto_id: npForm.responsavel_orto_id || ''
          };

          const { data, error } = await supabase
            .from('patients')
            .insert(insertPayload)
            .select()
            .single();

          if (error) throw error;

          // Converter para formato local (h√≠brido)
          const newPatient = {
            ...data,
            birthDate: data.birth_date,
            anamnesis: {...defaultAnamnesis},
            records: [],
            documents: [],
            responsavelHistory: [],
            arrivalControl: null,
            financeiro: { orcamento_total: 0, pagamentos: [] },
            is_orthodontic_patient: false,
            ortho_status: null,
            ortho_status_updated_at: null,
            ortho_status_updated_by: null,
            ortho_status_history: [],
            createdAt: data.created_at
          };

          // Salvar dados locais tempor√°rios (campos que ainda n√£o est√£o no DB)
          saveLocalData('anamnesis', newPatient.id, newPatient.anamnesis);
          saveLocalData('records', newPatient.id, newPatient.records);
          saveLocalData('documents', newPatient.id, newPatient.documents);
          saveLocalData('responsavelHistory', newPatient.id, newPatient.responsavelHistory);
          saveLocalData('financeiro', newPatient.id, newPatient.financeiro);
          saveLocalData('orthoData', newPatient.id, { is_orthodontic_patient: false, ortho_status: null, ortho_status_updated_at: null, ortho_status_updated_by: null, ortho_status_history: [] });

          setPatients(prev => [newPatient, ...prev]);
          setNpForm({ codigo:"", name:"", birthDate:"", phone:"", email:"", address:"", responsavel_clinico_id:"", responsavel_orto_id:"" });
          setShowNewPatient(false);
          setSelectedPatient(newPatient);
          setView("patient");
          addAudit("CRIAR_PACIENTE","paciente",newPatient.id,newPatient.name, `Resp. Cl√≠nico: ${getUserName(npForm.responsavel_clinico_id)}, Resp. Orto: ${getUserName(npForm.responsavel_orto_id)}`);
        } catch (err) {
          console.error('Erro ao criar paciente:', err);
          const msg = err?.message || err?.error_description || JSON.stringify(err);
          if (msg.includes('row-level security') || msg.includes('policy')) {
            alert('Erro de permiss√£o (RLS).\n\nVerifique se as pol√≠ticas de seguran√ßa e a fun√ß√£o current_clinic_id() est√£o configuradas no Supabase.\n\nDetalhes: ' + msg);
          } else if (msg.includes('clinic') || msg.includes('foreign key')) {
            alert('Erro: cl√≠nica n√£o encontrada no banco.\n\nVerifique se a tabela clinics possui o registro correto e se o perfil do usu√°rio est√° vinculado.\n\nDetalhes: ' + msg);
          } else if (msg.includes('null') || msg.includes('not-null')) {
            alert('Erro: campo obrigat√≥rio n√£o preenchido.\n\nDetalhes: ' + msg);
          } else {
            alert('Erro ao criar paciente:\n\n' + msg + '\n\nAbra o console do navegador (F12) para mais detalhes.');
          }
        }
      };

      const deletePatient = async (id) => {
        const p = patients.find(x => x.id === id);
        if (!p) return;
        
        if (!confirm(`Deseja realmente excluir o paciente ${p.name}? Esta a√ß√£o n√£o pode ser desfeita.`)) return;
        
        try {
          const { error } = await supabase
            .from('patients')
            .delete()
            .eq('id', id);
          
          if (error) throw error;
          
          // Remover dados locais
          removeLocalData(id);
          
          setPatients(prev => prev.filter(x => x.id !== id));
          setSelectedPatient(null);
          setView("list");
          addAudit("EXCLUIR_PACIENTE","paciente",id,p.name,"");
        } catch (err) {
          console.error('Erro ao excluir paciente:', err);
          const msgDel = err?.message || err?.error_description || JSON.stringify(err);
          alert('Erro ao excluir paciente:\n\n' + msgDel);
        }
      };

      const openPatient = async (p) => {
        try {
          const fresh = patients.find(x => x.id === p.id) || p;

          // Carregar atendimentos
          const appointments = await loadAppointmentsSupabase(fresh.id);

          // Carregar dados financeiros
          const budget = await loadBudgetSupabase(fresh.id);
          const payments = await loadPaymentsSupabase(fresh.id);
          
          const patientWithRecords = {
            ...fresh,
            records: appointments,
            financeiro: {
              orcamento_total: budget?.total_amount || 0,
              pagamentos: payments
            }
          };
          
          setSelectedPatient(patientWithRecords);
          setView("patient");
          setPatientTab("atendimentos");
          setPatientRecordFilter("orto");
          setShowPatientMenu(false);
          setShowEncounterMenu(null);
          addAudit("VISUALIZAR_PRONTUARIO","paciente",fresh.id,fresh.name,"");
        } catch (err) {
          console.error('Erro ao carregar atendimentos:', err);
          // Fallback para dados locais
          const fresh = patients.find(x => x.id === p.id) || p;
          const localRecords = getLocalData('records', fresh.id) || [];
          setSelectedPatient({...fresh, records: localRecords});
          setView("patient");
          setPatientTab("atendimentos");
          setPatientRecordFilter("orto");
        }
      };

      // ‚îÄ‚îÄ Anamnesis ‚îÄ‚îÄ
      const saveAnamnesis = () => {
        // Salvar anamnesis no LocalStorage (tempor√°rio - ser√° migrado na Fase 3)
        saveLocalData('anamnesis', selectedPatient.id, anamnesisForm);
        
        setPatients(prev => prev.map(p => p.id===selectedPatient.id ? {...p, anamnesis:{...anamnesisForm}} : p));
        setSelectedPatient(prev => ({...prev, anamnesis:{...anamnesisForm}}));
        setEditingAnamnesis(false);
        addAudit("EDITAR_ANAMNESE","paciente",selectedPatient.id,selectedPatient.name,"");
      };

      // ‚îÄ‚îÄ Change Responsible ‚îÄ‚îÄ
      const saveResponsible = async () => {
        const changes = [];
        if (respForm.responsavel_clinico_id !== selectedPatient.responsavel_clinico_id) {
          changes.push({ date:new Date().toISOString(), changedBy:currentUser.id, changedByName:currentUser.name, field:"responsavel_clinico_id", from:selectedPatient.responsavel_clinico_id, fromName:getUserName(selectedPatient.responsavel_clinico_id), to:respForm.responsavel_clinico_id, toName:getUserName(respForm.responsavel_clinico_id) });
        }
        if (respForm.responsavel_orto_id !== selectedPatient.responsavel_orto_id) {
          changes.push({ date:new Date().toISOString(), changedBy:currentUser.id, changedByName:currentUser.name, field:"responsavel_orto_id", from:selectedPatient.responsavel_orto_id, fromName:getUserName(selectedPatient.responsavel_orto_id), to:respForm.responsavel_orto_id, toName:getUserName(respForm.responsavel_orto_id) });
        }
        if (changes.length === 0) { setShowChangeResp(false); return; }
        
        try {
          const newHistory = [...selectedPatient.responsavelHistory, ...changes];
          const updated = { ...selectedPatient, responsavel_clinico_id:respForm.responsavel_clinico_id, responsavel_orto_id:respForm.responsavel_orto_id, responsavelHistory:newHistory };

          // Salvar respons√°veis no Supabase
          const { error: updErr } = await supabase
            .from('patients')
            .update({ responsavel_clinico_id: respForm.responsavel_clinico_id || '', responsavel_orto_id: respForm.responsavel_orto_id || '' })
            .eq('id', selectedPatient.id);
          if (updErr) throw updErr;

          // Hist√≥rico ainda no localStorage
          saveLocalData('responsavelHistory', selectedPatient.id, newHistory);
          
          setPatients(prev => prev.map(p => p.id===selectedPatient.id ? updated : p));
          setSelectedPatient(updated);
          setShowChangeResp(false);
          addAudit("ALTERAR_RESPONSAVEL","paciente",selectedPatient.id,selectedPatient.name, changes.map(c => `${c.field==="responsavel_clinico_id"?"Cl√≠nico":"Orto"}: ${c.fromName} ‚Üí ${c.toName}`).join("; "));
        } catch (err) {
          console.error('Erro ao alterar respons√°vel:', err);
          const msgResp = err?.message || err?.error_description || JSON.stringify(err);
          alert('Erro ao alterar respons√°vel:\n\n' + msgResp);
        }
      };

      // ‚îÄ‚îÄ Arrival Control ‚îÄ‚îÄ
      const handleArrival = (patientId) => {
        setArrivalPatientId(patientId);
        setArrivalForm({ dentista_id: "" });
        setShowArrivalControl(true);
      };

      const confirmArrival = () => {
        if (!arrivalForm.dentista_id) { alert("Selecione o dentista que ir√° atender."); return; }
        const patient = patients.find(p => p.id === arrivalPatientId);
        if (!patient) return;
        
        const arrivalData = {
          arrivedAt: new Date().toISOString(),
          dentista_id: arrivalForm.dentista_id,
          dentista_name: getUserName(arrivalForm.dentista_id),
          receptionist_id: currentUser.id,
          receptionist_name: currentUser.name,
          status: "aguardando"
        };
        
        setPatients(prev => prev.map(p => p.id === arrivalPatientId ? {...p, arrivalControl: arrivalData} : p));
        setShowArrivalControl(false);
        setArrivalPatientId(null);
        setArrivalForm({ dentista_id: "" });
        addAudit("MARCAR_CHEGADA","paciente",patient.id,patient.name,`Dentista: ${arrivalData.dentista_name}`);
      };

      const startAttendance = (patientId) => {
        const patient = patients.find(p => p.id === patientId);
        if (!patient || !patient.arrivalControl) return;
        
        setPatients(prev => prev.map(p => p.id === patientId ? {...p, arrivalControl: {...p.arrivalControl, status: "em_atendimento", startedAt: new Date().toISOString()}} : p));
        openPatient(patient);
        addAudit("INICIAR_ATENDIMENTO","paciente",patient.id,patient.name,"");
      };

      const finishAttendance = (patientId) => {
        setPatients(prev => prev.map(p => p.id === patientId ? {...p, arrivalControl: null} : p));
        addAudit("FINALIZAR_ATENDIMENTO","paciente",patientId,patients.find(p=>p.id===patientId)?.name||"","");
      };

      // ‚îÄ‚îÄ Financeiro ‚îÄ‚îÄ

      const addPagamento = async (patientId) => {
        if (!financeiroForm.valor || parseFloat(financeiroForm.valor) <= 0) return;

        try {
          const novoPagamento = await createPaymentSupabase(patientId, financeiroForm);

          if (!novoPagamento) {
            alert('Erro ao adicionar pagamento. Verifique o console (F12).');
            return;
          }

          // Atualizar estado local usando o objeto retornado diretamente
          setPatients(prev => prev.map(p => p.id === patientId ? {...p, financeiro: {...p.financeiro, pagamentos: [novoPagamento, ...p.financeiro.pagamentos]}} : p));
          setSelectedPatient(prev => prev ? {...prev, financeiro: {...prev.financeiro, pagamentos: [novoPagamento, ...prev.financeiro.pagamentos]}} : prev);
          addAudit("ADICIONAR_PAGAMENTO","paciente",patientId,patients.find(p=>p.id===patientId)?.name||"",`Valor: R$ ${(parseFloat(novoPagamento.valor) || 0).toFixed(2)} - ${novoPagamento.forma_pagamento === "avista" ? "√Ä vista" : "Parcelado"}`);
          setFinanceiroForm({ data: formatDateISO(new Date()), valor: "", forma_pagamento: "avista", observacao: "" });
        } catch (err) {
          console.error('Erro ao adicionar pagamento:', err);
          const msgPag = err?.message || err?.error_description || JSON.stringify(err);
          alert('Erro ao adicionar pagamento:\n\n' + msgPag);
        }
      };

      const removePagamento = async (patientId, pagamentoId) => {
        if (!confirm("Deseja realmente remover este pagamento?")) return;
        
        try {
          // Deletar do Supabase
          const success = await deletePaymentSupabase(pagamentoId);
          
          if (!success) {
            alert('Erro ao remover pagamento: opera√ß√£o falhou. Verifique o console (F12).');
            return;
          }
          
          // Atualizar estado local
          setPatients(prev => prev.map(p => p.id === patientId ? {...p, financeiro: {...p.financeiro, pagamentos: p.financeiro.pagamentos.filter(pg => pg.id !== pagamentoId)}} : p));
          setSelectedPatient(prev => prev ? {...prev, financeiro: {...prev.financeiro, pagamentos: prev.financeiro.pagamentos.filter(pg => pg.id !== pagamentoId)}} : prev);
          addAudit("REMOVER_PAGAMENTO","paciente",patientId,patients.find(p=>p.id===patientId)?.name||"","");
        } catch (err) {
          console.error('Erro ao remover pagamento:', err);
          const msgRemPag = err?.message || err?.error_description || JSON.stringify(err);
          alert('Erro ao remover pagamento:\n\n' + msgRemPag);
        }
      };

      // ‚îÄ‚îÄ Records ‚îÄ‚îÄ
      const tryAddRecord = () => {
        if (!nrForm.tipo_atendimento || !nrForm.specialty || nrForm.procedures.length === 0) return;
        const respField = nrForm.tipo_atendimento === "ORTODONTIA" ? "responsavel_orto_id" : "responsavel_clinico_id";
        const respId = selectedPatient[respField];
        const isResp = currentUser.id === respId || !respId;
        const rec = {
          id:generateId(), ...nrForm,
          dentista_atendente_id: currentUser.id,
          dentista_responsavel_no_momento_id: respId,
          atendimento_fora_da_responsabilidade: !isResp,
          motivo_fora: "",
          createdAt: new Date().toISOString(),
        };
        if (!isResp) {
          setPendingRecord(rec);
          setRespCheckMotivo("");
          setShowRespCheck(true);
        } else {
          saveRecord(rec);
        }
      };

      const confirmOutOfResp = () => {
        if (!pendingRecord) return;
        const rec = { ...pendingRecord, motivo_fora: respCheckMotivo };
        saveRecord(rec);
        setShowRespCheck(false);
        setPendingRecord(null);
        setRespCheckMotivo("");
      };

      const saveRecord = async (rec) => {
        try {
          if (!selectedPatient || !selectedPatient.id) {
            alert('Erro: nenhum paciente selecionado.');
            return;
          }
          if (!Array.isArray(selectedPatient.records)) {
            selectedPatient.records = getLocalData('records', selectedPatient.id) || [];
          }
          // Criar atendimento no localStorage
          const newAppointment = await createAppointmentSupabase(selectedPatient.id, rec);
          
          // Atualizar estado local
          const updated = { 
            ...selectedPatient, 
            records: [newAppointment, ...selectedPatient.records],
            arrivalControl: null // Remove da fila ao finalizar atendimento
          };
          
          setPatients(prev => prev.map(p => p.id === selectedPatient.id ? updated : p));
          setSelectedPatient(updated);
          setNrForm({...emptyNrForm});
          setShowNewRecord(false);
          
          addAudit("CRIAR_ATENDIMENTO","atendimento",newAppointment.id,selectedPatient.name,
            `Tipo: ${rec.tipo_atendimento}, Especialidade: ${SPECIALTIES[rec.specialty]?.label}, Fora da resp: ${rec.atendimento_fora_da_responsabilidade?"SIM":"N√ÉO"}${rec.motivo_fora?", Motivo: "+rec.motivo_fora:""}`);
          addAudit("FINALIZAR_ATENDIMENTO","paciente",selectedPatient.id,selectedPatient.name,"Atendimento finalizado e paciente removido da fila");
        } catch (err) {
          console.error('Erro ao salvar atendimento:', err);
          const msg = err?.message || err?.error_description || JSON.stringify(err);
          alert('Erro ao salvar atendimento:\n\n' + msg + '\n\nAbra o console do navegador (F12) para mais detalhes.');
        }
      };

      const deleteRecord = async (recId) => {
        if (!confirm("Deseja realmente excluir este atendimento? Esta a√ß√£o n√£o pode ser desfeita.")) return;
        
        try {
          await deleteAppointmentSupabase(recId);
          
          const updated = { 
            ...selectedPatient, 
            records: selectedPatient.records.filter(r => r.id !== recId) 
          };
          
          setPatients(prev => prev.map(p => p.id === selectedPatient.id ? updated : p));
          setSelectedPatient(updated);
          addAudit("EXCLUIR_ATENDIMENTO","atendimento",recId,selectedPatient.name,"");
        } catch (err) {
          console.error('Erro ao excluir atendimento:', err);
          const msg = err?.message || err?.error_description || JSON.stringify(err);
          alert('Erro ao excluir atendimento:\n\n' + msg);
        }
      };

      // ‚îÄ‚îÄ Relat√≥rio ‚îÄ‚îÄ
      const getRelatorioData = () => {
        const allRecords = [];
        patients.forEach(patient => {
          patient.records.forEach(record => {
            const dentista = users.find(u => u.id === record.dentista_atendente_id);
            const recordDate = record.date || record.createdAt.split('T')[0];
            
            // Filtros
            if (relatorioFilters.data_inicio && recordDate < relatorioFilters.data_inicio) return;
            if (relatorioFilters.data_fim && recordDate > relatorioFilters.data_fim) return;
            if (relatorioFilters.profissional_id && record.dentista_atendente_id !== relatorioFilters.profissional_id) return;
            if (relatorioFilters.busca && !patient.name.toLowerCase().includes(relatorioFilters.busca.toLowerCase())) return;

            // C√°lculos financeiros
            const valorTotal = patient.financeiro?.orcamento_total || 0;
            const totalPago = patient.financeiro?.pagamentos.reduce((sum, p) => sum + (parseFloat(p.valor) || 0), 0) || 0;
            const valorAberto = valorTotal - totalPago;
            const statusFinanceiro = valorTotal === 0 ? "sem_orcamento" : (valorAberto === 0 ? "pago" : (totalPago > 0 ? "parcial" : "aberto"));

            allRecords.push({
              id: record.id,
              paciente_nome: patient.name,
              data: recordDate,
              profissional: dentista?.name || "N/A",
              tipo_atendimento: record.tipo_atendimento,
              especialidade: SPECIALTIES[record.specialty]?.label || record.specialty,
              procedimentos: record.procedures.join(", "),
              valor_total: valorTotal,
              valor_pago: totalPago,
              valor_aberto: valorAberto,
              status_financeiro: statusFinanceiro
            });
          });
        });

        // Ordena√ß√£o
        allRecords.sort((a, b) => {
          const aVal = a[relatorioSort.field];
          const bVal = b[relatorioSort.field];
          const direction = relatorioSort.direction === "asc" ? 1 : -1;
          if (typeof aVal === "string") return aVal.localeCompare(bVal) * direction;
          return (aVal - bVal) * direction;
        });

        return allRecords;
      };

      const exportToExcel = () => {
        const data = getRelatorioData();
        if (data.length === 0) {
          alert("Nenhum dado para exportar");
          return;
        }

        // Cabe√ßalho
        let csv = "Paciente,Data,Profissional,Tipo,Especialidade,Procedimentos,Valor Total,Valor Pago,Valor em Aberto,Status\n";
        
        // Dados
        data.forEach(row => {
          csv += `"${row.paciente_nome}",`;
          csv += `"${formatDate(row.data)}",`;
          csv += `"${row.profissional}",`;
          csv += `"${row.tipo_atendimento}",`;
          csv += `"${row.especialidade}",`;
          csv += `"${row.procedimentos}",`;
          csv += `"R$ ${row.valor_total.toFixed(2).replace(".", ",")}",`;
          csv += `"R$ ${row.valor_pago.toFixed(2).replace(".", ",")}",`;
          csv += `"R$ ${row.valor_aberto.toFixed(2).replace(".", ",")}",`;
          csv += `"${row.status_financeiro === "pago" ? "Pago" : row.status_financeiro === "parcial" ? "Parcial" : row.status_financeiro === "aberto" ? "Em Aberto" : "Sem Or\u00e7amento"}"\n`;
        });

        // Totalizadores
        const totalGeral = data.reduce((sum, r) => sum + r.valor_total, 0);
        const totalPago = data.reduce((sum, r) => sum + r.valor_pago, 0);
        const totalAberto = data.reduce((sum, r) => sum + r.valor_aberto, 0);
        
        csv += `\n"TOTAIS","","","","","","R$ ${totalGeral.toFixed(2).replace(".", ",")}","R$ ${totalPago.toFixed(2).replace(".", ",")}","R$ ${totalAberto.toFixed(2).replace(".", ",")}",""\n`;

        // Download
        const blob = new Blob(["\uFEFF" + csv], { type: "text/csv;charset=utf-8;" });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", `relatorio_atendimentos_${formatDateISO(new Date())}.csv`);
        link.style.visibility = "hidden";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      };

      // ‚îÄ‚îÄ File blob cache (loaded from IndexedDB on demand) ‚îÄ‚îÄ
      const [fileCache, setFileCache] = useState({});
      const loadFile = useCallback(async (fileId) => {
        if (!fileId) return;
        setFileCache(prev => { if (prev[fileId]) return prev; return prev; });
        try {
          const data = await FileDB.get(fileId);
          if (data) setFileCache(prev => ({...prev, [fileId]: data}));
        } catch(e) { console.warn("FileDB load error", e); }
      }, []);

      // ‚îÄ‚îÄ Photos ‚îÄ‚îÄ
      const handlePhotoUpload = (e) => {
        Array.from(e.target.files).forEach(file => {
          if (file.size > MAX_FILE_SIZE) { alert(`Arquivo ${file.name} excede 50MB.`); return; }
          const fid = generateId();
          const reader = new FileReader();
          reader.onload = async (ev) => {
            const dataUrl = ev.target.result;
            try { await FileDB.put(fid, dataUrl); } catch(err) { alert("Erro ao salvar arquivo: " + err.message); return; }
            setFileCache(prev => ({...prev, [fid]: dataUrl}));
            setNrForm(prev => ({...prev, photos:[...prev.photos, {id:fid, name:file.name, type:file.type, size:file.size}]}));
          };
          reader.readAsDataURL(file);
        });
        if (photoInputRef.current) photoInputRef.current.value = "";
      };

      // ‚îÄ‚îÄ Patient Documents ‚îÄ‚îÄ
      const handleDocUpload = async (e) => {
        for (const file of Array.from(e.target.files)) {
          if (file.size > MAX_FILE_SIZE) { alert(`Arquivo ${file.name} excede 50MB.`); continue; }
          if (!ALLOWED_FILE_TYPES.some(t => file.type === t || file.type.startsWith("image/"))) { alert(`Tipo n√£o permitido: ${file.type}`); continue; }
          
          try {
            // Upload para Supabase Storage
            const doc = await uploadDocumentToStorage(selectedPatient.id, file);
            
            // Atualizar estado local
            const updated = { ...selectedPatient, documents:[doc, ...selectedPatient.documents] };
            setPatients(prev => prev.map(p => p.id===selectedPatient.id ? updated : p));
            setSelectedPatient(updated);
            
            // Salvar metadata no LocalStorage (para compatibilidade)
            saveLocalData('documents', selectedPatient.id, updated.documents);
            
            addAudit("UPLOAD_DOCUMENTO","paciente",selectedPatient.id,selectedPatient.name, `Arquivo: ${file.name} (${formatSize(file.size)})`);
          } catch (err) {
            console.error('Erro ao fazer upload de documento:', err);
            alert(`Erro ao fazer upload de ${file.name}. Tente novamente.`);
          }
        }
        if (docInputRef.current) docInputRef.current.value = "";
      };

      const deleteDoc = async (docId) => {
        try { await FileDB.del(docId); } catch(e) {}
        setFileCache(prev => { const n={...prev}; delete n[docId]; return n; });
        const updated = { ...selectedPatient, documents: selectedPatient.documents.filter(d => d.id !== docId) };
        setPatients(prev => prev.map(p => p.id===selectedPatient.id ? updated : p));
        setSelectedPatient(updated);
      };

      // ‚îÄ‚îÄ Users ‚îÄ‚îÄ
      const saveUser = () => {
        if (!userForm.name.trim() || !userForm.login.trim()) return;
        if (editingUserId) {
          setUsers(prev => prev.map(u => u.id===editingUserId ? {...u, name:userForm.name, login:userForm.login, role:userForm.role, active:userForm.active} : u));
          addAudit("EDITAR_USUARIO","usuario",editingUserId,userForm.name,"");
        } else {
          if (!userForm.password) return;
          if (users.some(u => u.login === userForm.login)) { alert("Login j√° existe."); return; }
          const nu = { id:generateId(), name:userForm.name, login:userForm.login, password:userForm.password, role:userForm.role, active:true, createdAt:new Date().toISOString() };
          setUsers(prev => [...prev, nu]);
          addAudit("CRIAR_USUARIO","usuario",nu.id,nu.name,`Perfil: ${ROLE_LABELS[nu.role]}`);
        }
        setShowUserForm(false); setEditingUserId(null);
        setUserForm({ id:"", name:"", login:"", password:"", role:"PROFESSIONAL", active:true });
      };

      // ‚îÄ‚îÄ Procedure/Tooth toggles ‚îÄ‚îÄ
      const toggleProcedure = (proc) => setNrForm(prev => ({...prev, procedures: prev.procedures.includes(proc) ? prev.procedures.filter(p=>p!==proc) : [...prev.procedures, proc]}));
      const toggleTooth = (t) => setNrForm(prev => ({...prev, teeth: prev.teeth.includes(t) ? prev.teeth.filter(x=>x!==t) : [...prev.teeth, t]}));

      const filteredPatients = patients.filter(p => { const s = searchTerm.toLowerCase(); return p.name.toLowerCase().includes(s) || (p.phone && p.phone.includes(searchTerm)) || (p.email && p.email.toLowerCase().includes(s)) || (p.codigo && p.codigo.toLowerCase().includes(s)); });

      const needsWireInfo = nrForm.tipo_atendimento === "ORTODONTIA" && nrForm.procedures.length > 0;
      const geralSpecOpts = [{ value:"", label:"Selecione..." }, ...Object.entries(SPECIALTIES).filter(([k])=>k!=="ortodontia").map(([k,v])=>({ value:k, label:`${v.icon} ${v.label}` }))];
      const dentistOpts = [{ value:"", label:"Selecione..." }, ...activeDentists.map(u => ({ value:u.id, label:`${u.name} (${ROLE_LABELS[u.role]})` }))];
      const allUserOpts = [{ value:"", label:"Selecione..." }, ...users.filter(u=>u.active && u.id !== "admin1").map(u => ({ value:u.id, label:`${u.name} (${ROLE_LABELS[u.role]})` }))];

      // ‚îÄ‚îÄ Styles ‚îÄ‚îÄ
      const btnPrimary = { background:"#0EA5E9", color:"#fff", border:"none", borderRadius:10, padding:"10px 20px", fontSize:14, fontWeight:700, cursor:"pointer", display:"inline-flex", alignItems:"center", gap:6, transition:"background 0.15s" };
      const btnSecondary = { background:"#F1F5F9", color:"#475569", border:"1.5px solid #E2E8F0", borderRadius:10, padding:"10px 20px", fontSize:14, fontWeight:600, cursor:"pointer", transition:"background 0.15s" };
      const btnDanger = { ...btnSecondary, color:"#EF4444", borderColor:"#FECACA" };
      const cardStyle = { background:"#fff", borderRadius:12, border:"1px solid #E2E8F0", padding:16, marginBottom:10, transition:"all 0.2s", boxShadow:"0 1px 3px rgba(0,0,0,0.04)" };

      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      // LOGIN SCREEN
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      if (!currentUser) {
        return (
          <div style={{ minHeight:"100vh", display:"flex", alignItems:"center", justifyContent:"center", background:"linear-gradient(135deg,#0F172A 0%,#1E3A5F 100%)" }}>
            <div style={{ background:"#fff", borderRadius:20, padding:40, width:"min(420px,92%)", boxShadow:"0 25px 60px rgba(0,0,0,0.3)" }}>
              <div style={{ textAlign:"center", marginBottom:30 }}>
                <div style={{ fontSize:36, marginBottom:8 }}>ü¶∑</div>
                <h1 style={{ fontSize:24, fontWeight:800, color:"#0F172A", margin:0 }}>O+ Fichas</h1>
                <p style={{ fontSize:13, color:"#64748B", marginTop:4 }}>Prontu√°rio Eletr√¥nico Odontol√≥gico</p>
              </div>
              {loginError && <div style={{ background:"#FEF2F2", border:"1px solid #FECACA", borderRadius:10, padding:"10px 14px", fontSize:13, color:"#DC2626", marginBottom:14, fontWeight:600 }}>{loginError}</div>}
              <Input label="Email" value={loginForm.login} onChange={e => setLoginForm({...loginForm, login:e.target.value})} placeholder="seu@email.com" onKeyDown={e => e.key==="Enter" && handleLogin()} />
              <Input label="Senha" type="password" value={loginForm.password} onChange={e => setLoginForm({...loginForm, password:e.target.value})} placeholder="Sua senha" onKeyDown={e => e.key==="Enter" && handleLogin()} />
              <button onClick={handleLogin} style={{ ...btnPrimary, width:"100%", justifyContent:"center", padding:"12px 20px", fontSize:15, marginTop:8 }}>Entrar</button>
              <div style={{ textAlign:"center", marginTop:16, fontSize:11, color:"#94A3B8" }}>Use suas credenciais do Supabase</div>
            </div>
          </div>
        );
      }

      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      // AUTHENTICATED APP
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      return (
        <div>
          {/* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */}
          {/* ‚ïê‚ïê‚ïê APP BAR ‚ïê‚ïê‚ïê */}
          <div style={{ background:"#0F172A", color:"#fff", padding:"0 16px", height:52, display:"flex", alignItems:"center", justifyContent:"space-between", position:"sticky", top:0, zIndex:100 }}>
            <div style={{ display:"flex", alignItems:"center", gap:10 }}>
              {view === "patient" && (
                <button onClick={() => { setView("list"); setSelectedPatient(null); setActiveTab("pacientes"); setShowPatientMenu(false); setShowEncounterMenu(null); setConfirmModal(null); }} style={{ background:"none", border:"none", color:"#fff", cursor:"pointer", fontSize:18, padding:4, display:"flex", alignItems:"center", minWidth:44, minHeight:44 }} aria-label="Voltar">
                  <svg width="20" height="20" viewBox="0 0 20 20" fill="none"><path d="M13 15L8 10L13 5" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/></svg>
                </button>
              )}
              <div style={{ fontSize:16, fontWeight:700, letterSpacing:-0.3, cursor:"pointer" }} onClick={() => { setView("list"); setActiveTab("fila"); }}>{view === "patient" ? "Paciente" : "O+ Fichas"}</div>
              {/* Status chip */}
              {syncing ? (
                <StatusChip label="Sincronizando" color="#F59E0B" bg="rgba(245,158,11,0.15)" small />
              ) : realtimeChannels.length > 0 ? (
                <StatusChip label="Online" color="#22C55E" bg="rgba(34,197,94,0.15)" small />
              ) : (
                <StatusChip label="Offline" color="#EF4444" bg="rgba(239,68,68,0.15)" small />
              )}
            </div>
            <div style={{ position:"relative" }}>
              <button onClick={() => setShowAppMenu(v => !v)} style={{ background:"rgba(255,255,255,0.08)", border:"none", borderRadius:8, width:36, height:36, color:"#fff", cursor:"pointer", fontSize:16, display:"flex", alignItems:"center", justifyContent:"center" }}>
                <svg width="18" height="18" viewBox="0 0 18 18" fill="currentColor"><circle cx="9" cy="3" r="1.5"/><circle cx="9" cy="9" r="1.5"/><circle cx="9" cy="15" r="1.5"/></svg>
              </button>
              {showAppMenu && (
                <>
                  <div onClick={() => setShowAppMenu(false)} style={{ position:"fixed", inset:0, zIndex:199 }} />
                  <div style={{ position:"absolute", right:0, top:42, background:"#fff", borderRadius:12, boxShadow:"0 8px 30px rgba(0,0,0,0.18)", minWidth:200, zIndex:200, overflow:"hidden", border:"1px solid #E2E8F0" }}>
                    <div style={{ padding:"12px 16px", borderBottom:"1px solid #F1F5F9" }}>
                      <div style={{ fontSize:13, fontWeight:700, color:"#0F172A" }}>{currentUser.name}</div>
                      <div style={{ fontSize:11, color:"#94A3B8" }}>{ROLE_LABELS[currentUser.role]}</div>
                    </div>
                    {isAdmin && (
                      <button onClick={() => { setView("users"); setShowAppMenu(false); }} style={{ width:"100%", textAlign:"left", background:"none", border:"none", padding:"10px 16px", fontSize:13, color:"#334155", cursor:"pointer", display:"flex", alignItems:"center", gap:8 }}
                        onMouseEnter={e => e.currentTarget.style.background="#F8FAFC"} onMouseLeave={e => e.currentTarget.style.background="none"}>
                        <span style={{ fontSize:15 }}>üë•</span> Usu√°rios
                      </button>
                    )}
                    {isAdmin && (
                      <button onClick={() => { setView("audit"); setShowAppMenu(false); }} style={{ width:"100%", textAlign:"left", background:"none", border:"none", padding:"10px 16px", fontSize:13, color:"#334155", cursor:"pointer", display:"flex", alignItems:"center", gap:8 }}
                        onMouseEnter={e => e.currentTarget.style.background="#F8FAFC"} onMouseLeave={e => e.currentTarget.style.background="none"}>
                        <span style={{ fontSize:15 }}>üìã</span> Auditoria
                      </button>
                    )}
                    <div style={{ borderTop:"1px solid #F1F5F9" }}>
                      <button onClick={() => { handleLogout(); setShowAppMenu(false); }} style={{ width:"100%", textAlign:"left", background:"none", border:"none", padding:"10px 16px", fontSize:13, color:"#EF4444", cursor:"pointer", display:"flex", alignItems:"center", gap:8 }}
                        onMouseEnter={e => e.currentTarget.style.background="#FEF2F2"} onMouseLeave={e => e.currentTarget.style.background="none"}>
                        <span style={{ fontSize:15 }}>üö™</span> Sair
                      </button>
                    </div>
                  </div>
                </>
              )}
            </div>
          </div>

          {/* ‚ïê‚ïê‚ïê TABS ‚ïê‚ïê‚ïê */}
          {view === "list" && (
            <div style={{ background:"#fff", borderBottom:"1px solid #E2E8F0", position:"sticky", top:52, zIndex:99, padding:"0 8px" }}>
              <div style={{ display:"flex", maxWidth:800, margin:"0 auto", gap:0 }}>
                {[
                  { id:"fila", label:"Fila", badge: (() => { const c = patients.filter(p => isAdminRole(currentUser.role) ? p.arrivalControl?.status === "aguardando" : (p.arrivalControl?.dentista_id === currentUser.id && p.arrivalControl?.status === "aguardando")).length; return c > 0 ? c : null; })(), show: currentUser.role === "PROFESSIONAL" || isAdminRole(currentUser.role) || currentUser.role === "RECEPTION" },
                  { id:"pacientes", label:"Pacientes", show: true },
                  { id:"relatorios", label:"Relat√≥rios", show: isAdminRole(currentUser.role) || currentUser.role === "RECEPTION" },
                  { id:"admin", label:"Admin", show: isAdmin },
                ].filter(t => t.show).map(tab => (
                  <button key={tab.id} onClick={() => setActiveTab(tab.id)}
                    style={{ flex:1, background:"none", border:"none", padding:"12px 8px", fontSize:13, fontWeight: activeTab === tab.id ? 700 : 500, color: activeTab === tab.id ? "#0EA5E9" : "#64748B", cursor:"pointer", position:"relative", display:"flex", alignItems:"center", justifyContent:"center", gap:5, transition:"color 0.2s", borderBottom: activeTab === tab.id ? "2px solid #0EA5E9" : "2px solid transparent" }}>
                    {tab.label}
                    {tab.badge && <span style={{ background:"#EF4444", color:"#fff", borderRadius:10, minWidth:18, height:18, display:"flex", alignItems:"center", justifyContent:"center", fontSize:10, fontWeight:700, padding:"0 4px" }}>{tab.badge}</span>}
                  </button>
                ))}
              </div>
            </div>
          )}

          {/* ‚ïê‚ïê‚ïê TAB: FILA ‚ïê‚ïê‚ïê */}
          {view === "list" && activeTab === "fila" && (
            <div style={{ padding:"12px 16px", maxWidth:800, margin:"0 auto" }}>
              {/* Aguardando */}
              {(() => {
                const aguardando = patients.filter(p => isAdminRole(currentUser.role) || currentUser.role === "RECEPTION" ? p.arrivalControl?.status === "aguardando" : (p.arrivalControl?.dentista_id === currentUser.id && p.arrivalControl?.status === "aguardando")).sort((a,b) => new Date(a.arrivalControl.arrivedAt) - new Date(b.arrivalControl.arrivedAt));
                const emAtendimento = patients.filter(p => isAdminRole(currentUser.role) || currentUser.role === "RECEPTION" ? p.arrivalControl?.status === "em_atendimento" : (p.arrivalControl?.dentista_id === currentUser.id && p.arrivalControl?.status === "em_atendimento"));
                return (
                  <div>
                    <div style={{ fontSize:12, fontWeight:700, color:"#94A3B8", textTransform:"uppercase", letterSpacing:0.5, marginBottom:8 }}>Aguardando ({aguardando.length})</div>
                    {aguardando.length === 0 && (
                      <div style={{ textAlign:"center", padding:32, color:"#CBD5E1", background:"#FAFBFC", borderRadius:12, border:"1px dashed #E2E8F0", marginBottom:20 }}>
                        <div style={{ fontSize:32, marginBottom:4, opacity:0.5 }}>‚òï</div>
                        <div style={{ fontSize:13, fontWeight:500 }}>Nenhum paciente na fila</div>
                      </div>
                    )}
                    {aguardando.map(p => {
                      const waitMins = Math.round((Date.now() - new Date(p.arrivalControl.arrivedAt).getTime()) / 60000);
                      return (
                        <div key={p.id} style={{ ...cardStyle, padding:0, overflow:"hidden", marginBottom:10, position:"relative" }}>
                          {/* Swipe reveal actions */}
                          <div style={{ position:"absolute", top:0, right:0, bottom:0, display:"flex", alignItems:"stretch", zIndex:1 }}>
                            <button onClick={() => openPatient(p)} style={{ width:70, background:"#0EA5E9", color:"#fff", border:"none", fontSize:11, fontWeight:600, cursor:"pointer", display:"flex", flexDirection:"column", alignItems:"center", justifyContent:"center", gap:2 }}>
                              <span style={{ fontSize:16 }}>üìã</span>Prontu√°rio
                            </button>
                          </div>
                          <div style={{ position:"relative", zIndex:2, background:"#fff", padding:"14px 16px", transform:`translateX(${swipingCardId === p.id ? Math.min(0, swipeX) : 0}px)`, transition: swipingCardId === p.id ? "none" : "transform 0.3s ease" }}
                            onTouchStart={e => { setSwipingCardId(p.id); setTouchStartX(e.touches[0].clientX); setSwipeX(0); }}
                            onTouchMove={e => { if (swipingCardId === p.id) { const dx = e.touches[0].clientX - touchStartX; setSwipeX(Math.max(-80, Math.min(0, dx))); } }}
                            onTouchEnd={() => { if (Math.abs(swipeX) < 40) setSwipeX(0); else setSwipeX(-70); setTimeout(() => setSwipingCardId(null), 300); }}>
                            {/* Line 1: Name + ID + Time */}
                            <div style={{ display:"flex", justifyContent:"space-between", alignItems:"center", marginBottom:8 }}>
                              <div style={{ display:"flex", alignItems:"center", gap:8, flex:1, minWidth:0 }}>
                                <span style={{ fontSize:15, fontWeight:700, color:"#0F172A", whiteSpace:"nowrap", overflow:"hidden", textOverflow:"ellipsis" }}>{p.name}</span>
                                {p.codigo && <span style={{ fontSize:10, color:"#94A3B8", fontWeight:500, flexShrink:0 }}>#{p.codigo}</span>}
                              </div>
                              <span style={{ fontSize:11, color:"#94A3B8", flexShrink:0, marginLeft:8 }}>{new Date(p.arrivalControl.arrivedAt).toLocaleTimeString("pt-BR", {hour:"2-digit", minute:"2-digit"})}</span>
                            </div>
                            {/* Line 2: Chips */}
                            <div style={{ display:"flex", gap:4, flexWrap:"wrap", marginBottom:8 }}>
                              {p.is_orthodontic_patient ? (
                                <StatusChip label="Orto" color="#7C3AED" small />
                              ) : (
                                <StatusChip label="Cl√≠nica Geral" color="#0EA5E9" small />
                              )}
                              <StatusChip label={`${waitMins}min espera`} color={waitMins > 30 ? "#EF4444" : waitMins > 15 ? "#F59E0B" : "#10B981"} small />
                              {(isAdminRole(currentUser.role) || currentUser.role === "RECEPTION") && p.financeiro && p.financeiro.orcamento_total > 0 && (() => {
                                const saldo = p.financeiro.orcamento_total - p.financeiro.pagamentos.reduce((s,pg) => s + (parseFloat(pg.valor)||0), 0);
                                return saldo > 0 ? <StatusChip label="Devendo" color="#EF4444" small /> : <StatusChip label="Em dia" color="#10B981" small />;
                              })()}
                            </div>
                            {/* Line 3: Meta + Action */}
                            <div style={{ display:"flex", justifyContent:"space-between", alignItems:"center" }}>
                              <div style={{ fontSize:11, color:"#94A3B8" }}>
                                {isAdminRole(currentUser.role) && <span>Dr(a). {p.arrivalControl.dentista_name}</span>}
                                {!isAdminRole(currentUser.role) && p.phone && <span>{p.phone}</span>}
                              </div>
                              {(currentUser.role === "PROFESSIONAL" || isAdminRole(currentUser.role)) && (
                                <button onClick={() => startAttendance(p.id)} style={{ background:"#0EA5E9", color:"#fff", border:"none", borderRadius:8, padding:"6px 14px", fontSize:12, fontWeight:600, cursor:"pointer" }}>
                                  Atender
                                </button>
                              )}
                            </div>
                          </div>
                        </div>
                      );
                    })}

                    {/* Em Atendimento */}
                    <div style={{ fontSize:12, fontWeight:700, color:"#94A3B8", textTransform:"uppercase", letterSpacing:0.5, marginTop:20, marginBottom:8 }}>Em Atendimento ({emAtendimento.length})</div>
                    {emAtendimento.length === 0 && (
                      <div style={{ textAlign:"center", padding:24, color:"#CBD5E1", background:"#FAFBFC", borderRadius:12, border:"1px dashed #E2E8F0" }}>
                        <div style={{ fontSize:13, fontWeight:500 }}>Nenhum atendimento em andamento</div>
                      </div>
                    )}
                    {emAtendimento.map(p => (
                      <div key={p.id} style={{ ...cardStyle, padding:"14px 16px", marginBottom:10, borderLeft:"3px solid #10B981" }}>
                        <div style={{ display:"flex", justifyContent:"space-between", alignItems:"center", marginBottom:8 }}>
                          <div style={{ display:"flex", alignItems:"center", gap:8, flex:1, minWidth:0 }}>
                            <span style={{ fontSize:15, fontWeight:700, color:"#0F172A" }}>{p.name}</span>
                            {p.codigo && <span style={{ fontSize:10, color:"#94A3B8" }}>#{p.codigo}</span>}
                          </div>
                          <StatusChip label="Em atendimento" color="#10B981" small />
                        </div>
                        <div style={{ display:"flex", justifyContent:"space-between", alignItems:"center" }}>
                          <div style={{ fontSize:11, color:"#64748B" }}>
                            {isAdminRole(currentUser.role) && `Dr(a). ${p.arrivalControl.dentista_name} ¬∑ `}
                            In√≠cio: {new Date(p.arrivalControl.startedAt).toLocaleTimeString("pt-BR", {hour:"2-digit", minute:"2-digit"})}
                          </div>
                          <div style={{ display:"flex", gap:6 }}>
                            <button onClick={() => openPatient(p)} style={{ background:"#F1F5F9", color:"#475569", border:"none", borderRadius:8, padding:"6px 12px", fontSize:11, fontWeight:600, cursor:"pointer" }}>Prontu√°rio</button>
                            <button onClick={() => finishAttendance(p.id)} style={{ background:"#10B981", color:"#fff", border:"none", borderRadius:8, padding:"6px 12px", fontSize:11, fontWeight:600, cursor:"pointer" }}>Finalizar</button>
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                );
              })()}
            </div>
          )}

          {/* ‚ïê‚ïê‚ïê TAB: PACIENTES ‚ïê‚ïê‚ïê */}
          {view === "list" && activeTab === "pacientes" && (
            <div style={{ padding:"12px 16px", maxWidth:800, margin:"0 auto", paddingBottom:80 }}>
              {/* Search full-width */}
              <div style={{ position:"relative", marginBottom:12 }}>
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#94A3B8" strokeWidth="2" strokeLinecap="round" style={{ position:"absolute", left:14, top:"50%", transform:"translateY(-50%)", pointerEvents:"none" }}>
                  <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
                </svg>
                <input placeholder="Buscar paciente por nome, c√≥digo ou telefone" value={searchTerm} onChange={e => setSearchTerm(e.target.value)}
                  style={{ width:"100%", padding:"12px 16px 12px 42px", borderRadius:12, border:"1.5px solid #E2E8F0", fontSize:14, outline:"none", background:"#FAFBFC", boxSizing:"border-box", transition:"border 0.2s" }}
                  onFocus={e => e.target.style.borderColor="#0EA5E9"} onBlur={e => e.target.style.borderColor="#E2E8F0"} />
              </div>

              {loadingPatients ? (
                <div style={{ textAlign:"center", padding:48, color:"#CBD5E1" }}>
                  <div style={{ width:32, height:32, border:"3px solid #E2E8F0", borderTopColor:"#0EA5E9", borderRadius:"50%", animation:"spin 0.8s linear infinite", margin:"0 auto 12px" }}></div>
                  <div style={{ fontSize:13, fontWeight:500 }}>Carregando...</div>
                </div>
              ) : filteredPatients.length === 0 ? (
                <div style={{ textAlign:"center", padding:48, color:"#CBD5E1" }}>
                  <div style={{ fontSize:13, fontWeight:500 }}>Nenhum paciente encontrado</div>
                </div>
              ) : (
                filteredPatients.map(p => {
                  const saldo = (p.financeiro?.orcamento_total || 0) - (p.financeiro?.pagamentos || []).reduce((s,pg) => s+(parseFloat(pg.valor)||0),0);
                  const temFinanceiro = p.financeiro && p.financeiro.orcamento_total > 0;
                  return (
                    <div key={p.id} style={{ ...cardStyle, padding:0, overflow:"hidden", marginBottom:8, position:"relative" }}>
                      {/* Swipe reveal: Chegou */}
                      {(currentUser.role === "RECEPTION" || isAdminRole(currentUser.role)) && !p.arrivalControl && (
                        <div style={{ position:"absolute", top:0, left:0, bottom:0, display:"flex", alignItems:"stretch", zIndex:1 }}>
                          <button onClick={() => handleArrival(p.id)} style={{ width:80, background:"#10B981", color:"#fff", border:"none", fontSize:11, fontWeight:600, cursor:"pointer", display:"flex", flexDirection:"column", alignItems:"center", justifyContent:"center", gap:2 }}>
                            <span style={{ fontSize:18 }}>üëã</span>Chegou
                          </button>
                        </div>
                      )}
                      <div style={{ position:"relative", zIndex:2, background:"#fff", padding:"14px 16px", transform:`translateX(${swipingCardId === p.id ? Math.max(0, swipeX) : 0}px)`, transition: swipingCardId === p.id ? "none" : "transform 0.3s ease", cursor:"pointer" }}
                        onClick={() => openPatient(p)}
                        onTouchStart={e => { if ((currentUser.role === "RECEPTION" || isAdminRole(currentUser.role)) && !p.arrivalControl) { setSwipingCardId(p.id); setTouchStartX(e.touches[0].clientX); setSwipeX(0); }}}
                        onTouchMove={e => { if (swipingCardId === p.id) { const dx = e.touches[0].clientX - touchStartX; setSwipeX(Math.max(0, Math.min(80, dx))); } }}
                        onTouchEnd={() => { if (swipeX > 50) { handleArrival(p.id); setSwipeX(0); } else { setSwipeX(0); } setTimeout(() => setSwipingCardId(null), 300); }}
                        onMouseEnter={e => { e.currentTarget.parentElement.style.borderColor="#0EA5E920"; e.currentTarget.parentElement.style.boxShadow="0 2px 8px rgba(14,165,233,0.08)"; }}
                        onMouseLeave={e => { e.currentTarget.parentElement.style.borderColor="#E2E8F0"; e.currentTarget.parentElement.style.boxShadow="0 1px 3px rgba(0,0,0,0.04)"; }}>
                        {/* Line 1: Name + ID + Date */}
                        <div style={{ display:"flex", justifyContent:"space-between", alignItems:"center", marginBottom:6 }}>
                          <div style={{ display:"flex", alignItems:"center", gap:6, flex:1, minWidth:0 }}>
                            <span style={{ fontSize:15, fontWeight:700, color:"#0F172A", whiteSpace:"nowrap", overflow:"hidden", textOverflow:"ellipsis" }}>{p.name}</span>
                            {p.codigo && <span style={{ fontSize:10, color:"#94A3B8", flexShrink:0 }}>#{p.codigo}</span>}
                          </div>
                          {p.arrivalControl && (
                            <StatusChip label={p.arrivalControl.status === "aguardando" ? "Na fila" : "Atendendo"} color={p.arrivalControl.status === "aguardando" ? "#F59E0B" : "#10B981"} small />
                          )}
                        </div>
                        {/* Line 2: Chips */}
                        <div style={{ display:"flex", gap:4, flexWrap:"wrap", marginBottom:6 }}>
                          {p.is_orthodontic_patient && (() => {
                            const sc = ORTHO_STATUS_COLORS[p.ortho_status] || { color:"#7C3AED", bg:"#F5F3FF" };
                            return <StatusChip label={`Orto ¬∑ ${p.ortho_status || "‚Äî"}`} color={sc.color} bg={sc.bg} small />;
                          })()}
                          {!p.is_orthodontic_patient && <StatusChip label="Cl√≠nica Geral" color="#64748B" small />}
                          {(isAdminRole(currentUser.role) || currentUser.role === "RECEPTION") && temFinanceiro && (
                            saldo > 0 ? <StatusChip label="Devendo" color="#EF4444" small /> : <StatusChip label="Em dia" color="#10B981" small />
                          )}
                        </div>
                        {/* Line 3: Meta */}
                        <div style={{ display:"flex", justifyContent:"space-between", alignItems:"center" }}>
                          <div style={{ fontSize:11, color:"#94A3B8", overflow:"hidden", textOverflow:"ellipsis", whiteSpace:"nowrap" }}>
                            {getUserName(p.responsavel_clinico_id) !== "‚Äî" && <span>Cl√≠nico: {getUserName(p.responsavel_clinico_id)}</span>}
                            {getUserName(p.responsavel_orto_id) !== "‚Äî" && <span> ¬∑ Orto: {getUserName(p.responsavel_orto_id)}</span>}
                          </div>
                          <span style={{ fontSize:10, color:"#CBD5E1", flexShrink:0, marginLeft:8 }}>{(p.records || []).length} atend.</span>
                        </div>
                      </div>
                      {/* Compact arrival button (desktop only, not swipe) */}
                      {(currentUser.role === "RECEPTION" || isAdminRole(currentUser.role)) && !p.arrivalControl && (
                        <div style={{ padding:"0 16px 12px", background:"#fff", position:"relative", zIndex:2 }}>
                          <button onClick={(e) => { e.stopPropagation(); handleArrival(p.id); }}
                            style={{ width:"100%", background:"#F0FDF4", color:"#059669", border:"1px solid #BBF7D0", borderRadius:8, padding:"8px", fontSize:12, fontWeight:600, cursor:"pointer", transition:"all 0.15s" }}
                            onMouseEnter={e => { e.currentTarget.style.background="#DCFCE7"; }}
                            onMouseLeave={e => { e.currentTarget.style.background="#F0FDF4"; }}>
                            Chegou
                          </button>
                        </div>
                      )}
                    </div>
                  );
                })
              )}
              {/* FAB: Novo Paciente */}
              <FAB onClick={() => setShowNewPatient(true)} label="Novo Paciente" />
            </div>
          )}

          {/* ‚ïê‚ïê‚ïê TAB: RELAT√ìRIOS ‚ïê‚ïê‚ïê */}
          {view === "list" && activeTab === "relatorios" && (
            <div style={{ padding:"16px", maxWidth:800, margin:"0 auto" }}>
              <div style={{ display:"grid", gridTemplateColumns:"1fr 1fr", gap:10 }}>
                <button onClick={() => setShowRelatorio(true)} style={{ ...cardStyle, cursor:"pointer", textAlign:"center", padding:24, marginBottom:0 }}
                  onMouseEnter={e => e.currentTarget.style.borderColor="#0EA5E9"} onMouseLeave={e => e.currentTarget.style.borderColor="#E2E8F0"}>
                  <div style={{ fontSize:28, marginBottom:6 }}>üìä</div>
                  <div style={{ fontSize:14, fontWeight:700, color:"#0F172A" }}>Atendimentos</div>
                  <div style={{ fontSize:11, color:"#94A3B8", marginTop:2 }}>Relat√≥rio por per√≠odo</div>
                </button>
                <button onClick={() => setShowRelatorioOrtho(true)} style={{ ...cardStyle, cursor:"pointer", textAlign:"center", padding:24, marginBottom:0 }}
                  onMouseEnter={e => e.currentTarget.style.borderColor="#7C3AED"} onMouseLeave={e => e.currentTarget.style.borderColor="#E2E8F0"}>
                  <div style={{ fontSize:28, marginBottom:6 }}>ü¶∑</div>
                  <div style={{ fontSize:14, fontWeight:700, color:"#0F172A" }}>Ortodontia</div>
                  <div style={{ fontSize:11, color:"#94A3B8", marginTop:2 }}>Pacientes ortod√¥nticos</div>
                </button>
              </div>
            </div>
          )}

          {/* ‚ïê‚ïê‚ïê TAB: ADMIN ‚ïê‚ïê‚ïê */}
          {view === "list" && activeTab === "admin" && isAdmin && (
            <div style={{ padding:"16px", maxWidth:800, margin:"0 auto" }}>
              <div style={{ display:"grid", gridTemplateColumns:"1fr 1fr", gap:10 }}>
                <button onClick={() => setView("users")} style={{ ...cardStyle, cursor:"pointer", textAlign:"center", padding:24, marginBottom:0 }}
                  onMouseEnter={e => e.currentTarget.style.borderColor="#0EA5E9"} onMouseLeave={e => e.currentTarget.style.borderColor="#E2E8F0"}>
                  <div style={{ fontSize:28, marginBottom:6 }}>üë•</div>
                  <div style={{ fontSize:14, fontWeight:700, color:"#0F172A" }}>Usu√°rios</div>
                  <div style={{ fontSize:11, color:"#94A3B8", marginTop:2 }}>Gerenciar equipe</div>
                </button>
                <button onClick={() => setView("audit")} style={{ ...cardStyle, cursor:"pointer", textAlign:"center", padding:24, marginBottom:0 }}
                  onMouseEnter={e => e.currentTarget.style.borderColor="#0EA5E9"} onMouseLeave={e => e.currentTarget.style.borderColor="#E2E8F0"}>
                  <div style={{ fontSize:28, marginBottom:6 }}>üìã</div>
                  <div style={{ fontSize:14, fontWeight:700, color:"#0F172A" }}>Auditoria</div>
                  <div style={{ fontSize:11, color:"#94A3B8", marginTop:2 }}>Hist√≥rico de a√ß√µes</div>
                </button>
              </div>
            </div>
          )}

          {/* ‚ïê‚ïê‚ïê PATIENT DETAIL (Refactored) ‚ïê‚ïê‚ïê */}
          {view === "patient" && selectedPatient && (() => {
            const sp = selectedPatient;
            const orthoRecs = sp.records.filter(r => r.tipo_atendimento === "ORTODONTIA");
            const geralRecs = sp.records.filter(r => r.tipo_atendimento !== "ORTODONTIA");
            const temFinanceiroDetail = sp.financeiro && (sp.financeiro.orcamento_total > 0 || (sp.financeiro.pagamentos && sp.financeiro.pagamentos.length > 0));
            const totalPagoDetail = temFinanceiroDetail ? (sp.financeiro.pagamentos || []).reduce((s, pg) => s + (parseFloat(pg.valor) || 0), 0) : 0;
            const saldoDetail = temFinanceiroDetail ? (sp.financeiro.orcamento_total || 0) - totalPagoDetail : 0;
            const nextAppt = sp.records
              .filter(r => r.nextAppointment)
              .map(r => r.nextAppointment)
              .sort()
              .find(d => d >= formatDateISO(new Date()));
            const pdTabs = [
              { key:"atendimentos", label:"Atendimentos", count: sp.records.length },
              { key:"anamnese", label:"Anamnese" },
              { key:"orcamento", label:"Or√ßamento" },
              { key:"financeiro", label:"Financeiro" },
              { key:"arquivos", label:"Arquivos", count: (sp.documents || []).length }
            ];
            return (
            <div style={{ paddingBottom:80 }}>
              {/* ‚îÄ‚îÄ 2) PatientHeader ‚îÄ‚îÄ */}
              <div style={{ background:"#fff", borderBottom:"1px solid var(--color-border)", padding:"var(--space-3) var(--space-4)" }}>
                <div style={{ maxWidth:800, margin:"0 auto" }}>
                  <div style={{ display:"flex", justifyContent:"space-between", alignItems:"flex-start", gap:12 }}>
                    <div style={{ flex:1, minWidth:0 }}>
                      <div style={{ display:"flex", alignItems:"center", gap:8, flexWrap:"wrap", marginBottom:4 }}>
                        <h1 style={{ fontSize:20, fontWeight:800, margin:0, color:"var(--color-text)", overflow:"hidden", textOverflow:"ellipsis", whiteSpace:"nowrap" }}>{sp.name}</h1>
                        {sp.is_orthodontic_patient && (
                          <span style={{ fontSize:10, fontWeight:700, color:"#7C3AED", background:"#F5F3FF", border:"1px solid #DDD6FE", borderRadius:20, padding:"2px 10px", whiteSpace:"nowrap" }}>Ortodontia</span>
                        )}
                        {!sp.is_orthodontic_patient && (
                          <span style={{ fontSize:10, fontWeight:700, color:"var(--color-primary)", background:"#EFF6FF", border:"1px solid #BFDBFE", borderRadius:20, padding:"2px 10px", whiteSpace:"nowrap" }}>Cl√≠nico</span>
                        )}
                      </div>
                      <div style={{ fontSize:12, color:"var(--color-text-secondary)", display:"flex", gap:8, flexWrap:"wrap", alignItems:"center" }}>
                        {sp.birthDate && <span>Nasc: {formatDate(sp.birthDate+"T12:00:00")}</span>}
                        {sp.phone && <span>{sp.birthDate ? "¬∑" : ""} {sp.phone}</span>}
                        {sp.codigo && <span>¬∑ C√≥d: {sp.codigo}</span>}
                      </div>
                    </div>
                    <div style={{ display:"flex", alignItems:"center", gap:8, flexShrink:0 }}>
                      <button onClick={() => setShowNewRecord(true)} style={{ background:"var(--color-primary)", color:"#fff", border:"none", borderRadius:"var(--radius-sm)", padding:"10px 16px", fontSize:13, fontWeight:700, cursor:"pointer", minHeight:44, display:"flex", alignItems:"center", gap:6, whiteSpace:"nowrap" }} aria-label="Novo Atendimento">
                        <span style={{ fontSize:16, lineHeight:1 }}>+</span> Atender
                      </button>
                      <div style={{ position:"relative" }}>
                        <button onClick={() => setShowPatientMenu(!showPatientMenu)} style={{ background:"var(--color-surface)", border:"1px solid var(--color-border)", borderRadius:"var(--radius-sm)", width:44, height:44, cursor:"pointer", fontSize:18, display:"flex", alignItems:"center", justifyContent:"center", color:"var(--color-text-secondary)" }} aria-label="Mais a√ß√µes do paciente">‚ãØ</button>
                        <ActionMenu open={showPatientMenu} onClose={() => setShowPatientMenu(false)} anchorRight items={[
                          { icon:"üë•", label:"Alterar respons√°veis", onClick:() => { setRespForm({ responsavel_clinico_id:sp.responsavel_clinico_id, responsavel_orto_id:sp.responsavel_orto_id }); setShowChangeResp(true); } },
                          { divider:true },
                          ...(isAdmin ? [{ icon:"üóëÔ∏è", label:"Excluir paciente", danger:true, onClick:() => setConfirmModal({ title:"Excluir paciente", message:`Tem certeza que deseja excluir "${sp.name}" e TODOS os seus registros? Esta a√ß√£o √© irrevers√≠vel.`, danger:true, confirmLabel:"Sim, excluir", onConfirm:() => deletePatient(sp.id) }) }] : [])
                        ]} />
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              {/* ‚îÄ‚îÄ 3) SummaryCards ‚îÄ‚îÄ */}
              <div style={{ padding:"var(--space-3) var(--space-4)", maxWidth:800, margin:"0 auto" }}>
                <div className="summary-grid">
                  <div className="summary-card">
                    <div className="summary-card-label">Etapa Ortodontia</div>
                    <div className="summary-card-value">
                      {sp.is_orthodontic_patient ? (() => {
                        const sc = ORTHO_STATUS_COLORS[sp.ortho_status] || { color:"#64748B", bg:"#F1F5F9" };
                        return <span style={{ color:sc.color, background:sc.bg, borderRadius:6, padding:"2px 8px", fontSize:12 }}>{sp.ortho_status || "‚Äî"}</span>;
                      })() : <span style={{ color:"var(--color-text-muted)", fontSize:12 }}>N/A</span>}
                    </div>
                  </div>
                  <div className="summary-card">
                    <div className="summary-card-label">Financeiro</div>
                    <div className="summary-card-value">
                      {temFinanceiroDetail ? (
                        saldoDetail > 0
                          ? <span style={{ color:"var(--color-danger)", fontSize:13 }}>Devendo R$ {saldoDetail.toFixed(2)}</span>
                          : <span style={{ color:"var(--color-success)", fontSize:13 }}>Em dia</span>
                      ) : <span style={{ color:"var(--color-text-muted)", fontSize:12 }}>Sem dados</span>}
                    </div>
                  </div>
                  <div className="summary-card">
                    <div className="summary-card-label">Pr√≥x. consulta</div>
                    <div className="summary-card-value" style={{ fontSize:13 }}>
                      {nextAppt ? formatDate(nextAppt+"T12:00:00") : <span style={{ color:"var(--color-text-muted)", fontSize:12 }}>Nenhuma</span>}
                    </div>
                  </div>
                  <div className="summary-card">
                    <div className="summary-card-label">Respons√°veis</div>
                    <div style={{ fontSize:11, color:"var(--color-text)", lineHeight:1.5 }}>
                      <div><span style={{ color:"var(--color-text-muted)" }}>Cl√≠n:</span> <strong>{getUserName(sp.responsavel_clinico_id)}</strong></div>
                      <div><span style={{ color:"var(--color-text-muted)" }}>Orto:</span> <strong>{getUserName(sp.responsavel_orto_id)}</strong></div>
                    </div>
                  </div>
                </div>
              </div>

              {/* ‚îÄ‚îÄ 4) Tabs ‚îÄ‚îÄ */}
              <div className="pd-tabs" style={{ position:"sticky", top:52, zIndex:50 }}>
                <div style={{ maxWidth:800, margin:"0 auto", display:"flex", width:"100%" }}>
                  {pdTabs.map(t => (
                    <button key={t.key} className="pd-tab" data-active={patientTab === t.key} onClick={() => setPatientTab(t.key)} aria-label={`Tab ${t.label}`}>
                      {t.label}{t.count != null ? ` (${t.count})` : ""}
                    </button>
                  ))}
                </div>
              </div>

              {/* ‚îÄ‚îÄ 5) Tab Panels ‚îÄ‚îÄ */}
              <div style={{ padding:"var(--space-3) var(--space-4)", maxWidth:800, margin:"0 auto" }}>

                {/* ‚îÄ‚îÄ‚îÄ TAB: ATENDIMENTOS ‚îÄ‚îÄ‚îÄ */}
                {patientTab === "atendimentos" && (
                  <div>
                    {/* StatusOrthoCard */}
                    {sp.is_orthodontic_patient && (
                      <div style={{ ...cardStyle, marginBottom:"var(--space-3)", borderLeft:"3px solid #7C3AED" }}>
                        <div style={{ display:"flex", justifyContent:"space-between", alignItems:"flex-start", gap:8 }}>
                          <div style={{ flex:1 }}>
                            <div style={{ fontSize:13, fontWeight:700, color:"var(--color-text)", marginBottom:4 }}>Status Ortodontia</div>
                            {sp.ortho_status_updated_at && (
                              <div style={{ fontSize:10, color:"var(--color-text-muted)", marginBottom:8 }}>
                                Atualizado em {formatDate(sp.ortho_status_updated_at)} por {sp.ortho_status_updated_by || "‚Äî"}
                              </div>
                            )}
                            <div style={{ display:"flex", alignItems:"center", gap:8, flexWrap:"wrap" }}>
                              <select value={sp.ortho_status || ""} onChange={e => {
                                const nv = e.target.value;
                                if (nv && nv !== sp.ortho_status) {
                                  setConfirmModal({ title:"Alterar status", message:`Alterar status ortod√¥ntico de "${sp.ortho_status || "‚Äî"}" para "${nv}"?`, confirmLabel:"Alterar", onConfirm:() => updateOrthoStatus(sp.id, nv, "Altera√ß√£o manual") });
                                }
                              }} style={{ padding:"8px 12px", borderRadius:"var(--radius-sm)", border:"1px solid #DDD6FE", fontSize:13, fontWeight:600, color:"#5B21B6", background:"#FDFCFF", cursor:"pointer", outline:"none", minHeight:40 }}>
                                {ORTHO_STATUSES.map(s => <option key={s} value={s}>{s}</option>)}
                              </select>
                              {sp.ortho_status_history && sp.ortho_status_history.length > 1 && (
                                <button onClick={() => setConfirmModal({ title:`Hist√≥rico de Status (${sp.ortho_status_history.length})`, message: sp.ortho_status_history.slice().reverse().map(h => `${formatDate(h.changed_at)} ‚Äî ${h.old_status || "Nenhum"} ‚Üí ${h.new_status || "Removido"} ‚Äî por ${h.changed_by}${h.reason ? ` (${h.reason})` : ""}`).join("\n"), confirmLabel:"Fechar", onConfirm:() => {} })} style={{ background:"none", border:"none", color:"#7C3AED", fontSize:12, fontWeight:600, cursor:"pointer", padding:"4px 0", textDecoration:"underline" }}>
                                  Ver hist√≥rico ({sp.ortho_status_history.length})
                                </button>
                              )}
                            </div>
                          </div>
                          {isAdmin && (
                            <div style={{ position:"relative" }}>
                              <button onClick={() => setShowEncounterMenu(showEncounterMenu === "ortho-card" ? null : "ortho-card")} style={{ background:"none", border:"1px solid var(--color-border)", borderRadius:"var(--radius-sm)", width:36, height:36, cursor:"pointer", fontSize:14, display:"flex", alignItems:"center", justifyContent:"center", color:"var(--color-text-muted)" }} aria-label="A√ß√µes do status ortodontia">‚ãØ</button>
                              <ActionMenu open={showEncounterMenu === "ortho-card"} onClose={() => setShowEncounterMenu(null)} anchorRight items={[
                                { icon:"üóëÔ∏è", label:"Remover Ortodontia", danger:true, onClick:() => setConfirmModal({ title:"Remover Ortodontia", message:"Remover classifica√ß√£o de Ortodontia deste paciente? Isso n√£o apaga os or√ßamentos, apenas remove o status ortod√¥ntico.", danger:true, confirmLabel:"Sim, remover", onConfirm:() => removeOrthoClassification(sp.id) }) }
                              ]} />
                            </div>
                          )}
                        </div>
                      </div>
                    )}

                    {/* Record filter segmented control */}
                    <div style={{ display:"flex", gap:0, marginBottom:"var(--space-3)", background:"var(--color-surface)", borderRadius:"var(--radius-sm)", border:"1px solid var(--color-border)", overflow:"hidden" }}>
                      <button onClick={() => setPatientRecordFilter("orto")} style={{ flex:1, padding:"10px 12px", border:"none", background: patientRecordFilter==="orto" ? "var(--color-primary)" : "transparent", color: patientRecordFilter==="orto" ? "#fff" : "var(--color-text-secondary)", fontSize:13, fontWeight:600, cursor:"pointer", minHeight:44, transition:"all 0.15s" }} aria-label="Filtrar por Ortodontia">
                        Ortodontia ({orthoRecs.length})
                      </button>
                      <button onClick={() => setPatientRecordFilter("geral")} style={{ flex:1, padding:"10px 12px", border:"none", borderLeft:"1px solid var(--color-border)", background: patientRecordFilter==="geral" ? "var(--color-success)" : "transparent", color: patientRecordFilter==="geral" ? "#fff" : "var(--color-text-secondary)", fontSize:13, fontWeight:600, cursor:"pointer", minHeight:44, transition:"all 0.15s" }} aria-label="Filtrar por Cl√≠nico">
                        Cl√≠nico/Outros ({geralRecs.length})
                      </button>
                    </div>

                    {/* Encounter Timeline */}
                    {(() => {
                      const recs = patientRecordFilter === "orto" ? orthoRecs : geralRecs;
                      if (recs.length === 0) return (
                        <div style={{ textAlign:"center", padding:"40px 20px", color:"var(--color-text-muted)", background:"#fff", borderRadius:"var(--radius)", border:"1px solid var(--color-border)" }}>
                          <div style={{ fontSize:32, marginBottom:8 }}>{patientRecordFilter === "orto" ? "ü¶∑" : "üìã"}</div>
                          <div style={{ fontSize:13 }}>Nenhum atendimento de {patientRecordFilter === "orto" ? "ortodontia" : "cl√≠nico geral"} registrado</div>
                        </div>
                      );
                      return (
                        <div className="encounter-timeline">
                          {recs.map(rec => {
                            const spec = SPECIALTIES[rec.specialty];
                            const isNotesExpanded = expandedNotes[rec.id];
                            const notesPreview = rec.notes && rec.notes.length > 100 && !isNotesExpanded ? rec.notes.substring(0, 100) + "‚Ä¶" : rec.notes;
                            return (
                              <div key={rec.id} className="encounter-card">
                                <div style={{ background:"#fff", border:"1px solid var(--color-border)", borderRadius:"var(--radius)", padding:"var(--space-3)", boxShadow:"var(--shadow-sm)" }}>
                                  {/* Card Header */}
                                  <div style={{ display:"flex", justifyContent:"space-between", alignItems:"center", marginBottom:10 }}>
                                    <div style={{ display:"flex", alignItems:"center", gap:6, flexWrap:"wrap" }}>
                                      <span style={{ fontSize:13, fontWeight:700, color:"var(--color-text)" }}>{formatDate(rec.date+"T12:00:00")}</span>
                                      <span style={{ fontSize:11, color:"var(--color-text-muted)" }}>por {getUserName(rec.dentista_atendente_id)}</span>
                                      {rec.atendimento_fora_da_responsabilidade && <span style={{ background:"#FEF3C7", color:"#D97706", padding:"2px 8px", borderRadius:20, fontSize:10, fontWeight:700 }}>Fora da resp.</span>}
                                    </div>
                                    <div style={{ position:"relative" }}>
                                      <button onClick={() => setShowEncounterMenu(showEncounterMenu === rec.id ? null : rec.id)} style={{ background:"none", border:"1px solid var(--color-border)", borderRadius:"var(--radius-sm)", width:32, height:32, cursor:"pointer", fontSize:13, display:"flex", alignItems:"center", justifyContent:"center", color:"var(--color-text-muted)" }} aria-label="A√ß√µes do atendimento">‚ãØ</button>
                                      <ActionMenu open={showEncounterMenu === rec.id} onClose={() => setShowEncounterMenu(null)} anchorRight items={[
                                        { icon:"üóëÔ∏è", label:"Excluir atendimento", danger:true, onClick:() => setConfirmModal({ title:"Excluir atendimento", message:`Excluir o atendimento de ${formatDate(rec.date+"T12:00:00")}? Esta a√ß√£o √© irrevers√≠vel.`, danger:true, confirmLabel:"Sim, excluir", onConfirm:() => deleteRecord(rec.id) }) }
                                      ]} />
                                    </div>
                                  </div>
                                  {/* Procedures as chips */}
                                  {rec.procedures && rec.procedures.length > 0 && (
                                    <div style={{ display:"flex", gap:6, flexWrap:"wrap", marginBottom:8 }}>
                                      {rec.procedures.map(pr => <Badge key={pr} text={pr} color={spec?.color || "#64748B"} />)}
                                    </div>
                                  )}
                                  {/* Wire info as small chips */}
                                  {rec.wireInfo && (rec.wireInfo.upper || rec.wireInfo.lower) && (
                                    <div style={{ marginBottom:8 }}>
                                      {rec.wireInfo.upper && (rec.wireInfo.upper.material || rec.wireInfo.upper.format || rec.wireInfo.upper.gauge) && (
                                        <div style={{ display:"flex", gap:4, flexWrap:"wrap", alignItems:"center", marginBottom:4 }}>
                                          <span style={{ fontSize:11, color:"#0369A1", fontWeight:600 }}>Superior:</span>
                                          {rec.wireInfo.upper.material && <span style={{ fontSize:10, background:"#EFF6FF", color:"#0369A1", padding:"2px 8px", borderRadius:20, fontWeight:600 }}>{rec.wireInfo.upper.material}</span>}
                                          {rec.wireInfo.upper.format && <span style={{ fontSize:10, background:"#EFF6FF", color:"#0369A1", padding:"2px 8px", borderRadius:20, fontWeight:600 }}>{rec.wireInfo.upper.format}</span>}
                                          {rec.wireInfo.upper.gauge && <span style={{ fontSize:10, background:"#EFF6FF", color:"#0369A1", padding:"2px 8px", borderRadius:20, fontWeight:600 }}>{rec.wireInfo.upper.gauge}</span>}
                                        </div>
                                      )}
                                      {rec.wireInfo.lower && (rec.wireInfo.lower.material || rec.wireInfo.lower.format || rec.wireInfo.lower.gauge) && (
                                        <div style={{ display:"flex", gap:4, flexWrap:"wrap", alignItems:"center" }}>
                                          <span style={{ fontSize:11, color:"#0369A1", fontWeight:600 }}>Inferior:</span>
                                          {rec.wireInfo.lower.material && <span style={{ fontSize:10, background:"#EFF6FF", color:"#0369A1", padding:"2px 8px", borderRadius:20, fontWeight:600 }}>{rec.wireInfo.lower.material}</span>}
                                          {rec.wireInfo.lower.format && <span style={{ fontSize:10, background:"#EFF6FF", color:"#0369A1", padding:"2px 8px", borderRadius:20, fontWeight:600 }}>{rec.wireInfo.lower.format}</span>}
                                          {rec.wireInfo.lower.gauge && <span style={{ fontSize:10, background:"#EFF6FF", color:"#0369A1", padding:"2px 8px", borderRadius:20, fontWeight:600 }}>{rec.wireInfo.lower.gauge}</span>}
                                        </div>
                                      )}
                                    </div>
                                  )}
                                  {/* Teeth */}
                                  {rec.teeth?.length > 0 && <div style={{ fontSize:11, color:"var(--color-text-secondary)", marginBottom:6 }}>Dentes: {rec.teeth.sort((a,b)=>a-b).join(", ")}</div>}
                                  {/* Notes expandable */}
                                  {rec.notes && (
                                    <div style={{ fontSize:12, color:"#475569", padding:"8px 10px", background:"var(--color-surface)", borderRadius:"var(--radius-sm)", borderLeft:`3px solid ${spec?.color||"#CBD5E1"}`, marginBottom:8, cursor: rec.notes.length > 100 ? "pointer" : "default" }}
                                      onClick={() => rec.notes.length > 100 && setExpandedNotes(prev => ({ ...prev, [rec.id]: !prev[rec.id] }))}>
                                      {notesPreview}
                                      {rec.notes.length > 100 && <span style={{ color:"var(--color-primary)", fontSize:11, fontWeight:600, marginLeft:4 }}>{isNotesExpanded ? "ver menos" : "ver mais"}</span>}
                                    </div>
                                  )}
                                  {/* Photos horizontal scroll */}
                                  {rec.photos?.length > 0 && (
                                    <div style={{ marginBottom:8 }}>
                                      <div style={{ display:"flex", gap:6, overflowX:"auto", paddingBottom:4, WebkitOverflowScrolling:"touch" }}>
                                        {rec.photos.map(ph => (
                                          <div key={ph.id} style={{ width:52, height:52, borderRadius:8, overflow:"hidden", border:"1px solid var(--color-border)", cursor:"pointer", flexShrink:0 }}>
                                            {ph.url ? (
                                              <img src={ph.url} alt={ph.name} onClick={() => setViewingPhoto(ph.url)} style={{ width:"100%", height:"100%", objectFit:"cover" }} />
                                            ) : (
                                              <FileThumb fileId={ph.id} cache={fileCache} loadFn={loadFile} type={ph.type || "image/jpeg"} name={ph.name}
                                                onClick={async () => { const d = fileCache[ph.id] || await FileDB.get(ph.id); if (d) setViewingPhoto(d); }}
                                                style={{ borderRadius:8 }} />
                                            )}
                                          </div>
                                        ))}
                                      </div>
                                    </div>
                                  )}
                                  {/* Footer */}
                                  <div style={{ display:"flex", justifyContent:"space-between", alignItems:"center", flexWrap:"wrap", gap:6, paddingTop:8, borderTop:"1px solid var(--color-border)" }}>
                                    <div>
                                      {rec.nextAppointment && <span style={{ fontSize:11, color:"var(--color-primary)", fontWeight:600 }}>Pr√≥x: {formatDate(rec.nextAppointment+"T12:00:00")}</span>}
                                    </div>
                                    <div>
                                      {(rec.signatureUrl || rec.signature) ? (
                                        <button onClick={() => setViewingSignature(rec.signatureUrl || rec.signature)} style={{ background:"#F0FDF4", border:"1px solid #BBF7D0", borderRadius:20, padding:"4px 10px", fontSize:10, color:"#16A34A", cursor:"pointer", fontWeight:600, minHeight:28 }} aria-label="Ver assinatura">Assinado ‚Äî ver</button>
                                      ) : (
                                        <span style={{ fontSize:10, color:"var(--color-warning)", fontWeight:600 }}>Sem assinatura</span>
                                      )}
                                    </div>
                                  </div>
                                </div>
                              </div>
                            );
                          })}
                        </div>
                      );
                    })()}
                  </div>
                )}

                {/* ‚îÄ‚îÄ‚îÄ TAB: ANAMNESE ‚îÄ‚îÄ‚îÄ */}
                {patientTab === "anamnese" && (
                  <div>
                    <div style={{ ...cardStyle }}>
                      <div style={{ display:"flex", justifyContent:"space-between", alignItems:"center", marginBottom:"var(--space-3)" }}>
                        <div style={{ fontSize:15, fontWeight:700, color:"var(--color-text)" }}>Anamnese Cl√≠nica</div>
                        <button onClick={() => { setAnamnesisForm({...defaultAnamnesis, ...sp.anamnesis}); setShowAnamnesis(true); setEditingAnamnesis(false); }} style={{ background:"var(--color-primary)", color:"#fff", border:"none", borderRadius:"var(--radius-sm)", padding:"8px 16px", fontSize:12, fontWeight:600, cursor:"pointer", minHeight:36 }} aria-label="Abrir Anamnese">
                          {sp.anamnesis && Object.keys(sp.anamnesis).length > 0 ? "Ver / Editar" : "Preencher"}
                        </button>
                      </div>
                      {sp.anamnesis && Object.keys(sp.anamnesis).length > 0 ? (
                        <div style={{ display:"grid", gridTemplateColumns:"1fr 1fr", gap:8 }}>
                          {sp.anamnesis.alergias && <div style={{ fontSize:12, color:"var(--color-text-secondary)" }}><strong>Alergias:</strong> {sp.anamnesis.alergias}</div>}
                          {sp.anamnesis.medicamentos && <div style={{ fontSize:12, color:"var(--color-text-secondary)" }}><strong>Medicamentos:</strong> {sp.anamnesis.medicamentos}</div>}
                          {sp.anamnesis.doencas && <div style={{ fontSize:12, color:"var(--color-text-secondary)" }}><strong>Doen√ßas:</strong> {sp.anamnesis.doencas}</div>}
                          {sp.anamnesis.cirurgias && <div style={{ fontSize:12, color:"var(--color-text-secondary)" }}><strong>Cirurgias:</strong> {sp.anamnesis.cirurgias}</div>}
                        </div>
                      ) : (
                        <div style={{ textAlign:"center", padding:"20px 0", color:"var(--color-text-muted)", fontSize:13 }}>Anamnese ainda n√£o preenchida</div>
                      )}
                    </div>
                  </div>
                )}

                {/* ‚îÄ‚îÄ‚îÄ TAB: OR√áAMENTO ‚îÄ‚îÄ‚îÄ */}
                {patientTab === "orcamento" && (
                  <div>
                    <div style={{ ...cardStyle }}>
                      <div style={{ display:"flex", justifyContent:"space-between", alignItems:"center", marginBottom:"var(--space-3)" }}>
                        <div style={{ fontSize:15, fontWeight:700, color:"var(--color-text)" }}>Or√ßamentos</div>
                        <button onClick={() => { setOrcamentoView("list"); setShowOrcamentos(true); }} style={{ background:"var(--color-primary)", color:"#fff", border:"none", borderRadius:"var(--radius-sm)", padding:"8px 16px", fontSize:12, fontWeight:600, cursor:"pointer", minHeight:36 }} aria-label="Gerenciar Or√ßamentos">
                          Gerenciar
                        </button>
                      </div>
                      {(() => {
                        const budgets = loadBudgets(sp.id);
                        if (budgets.length === 0) return <div style={{ textAlign:"center", padding:"20px 0", color:"var(--color-text-muted)", fontSize:13 }}>Nenhum or√ßamento cadastrado</div>;
                        return (
                          <div>
                            {budgets.slice(0, 3).map(b => (
                              <div key={b.id} style={{ display:"flex", justifyContent:"space-between", alignItems:"center", padding:"8px 0", borderBottom:"1px solid var(--color-border)" }}>
                                <div>
                                  <div style={{ fontSize:13, fontWeight:600, color:"var(--color-text)" }}>R$ {(b.items || []).reduce((s, it) => s + (parseFloat(it.line_total) || 0), 0).toFixed(2)}</div>
                                  <div style={{ fontSize:11, color:"var(--color-text-muted)" }}>{b.items?.length || 0} itens ¬∑ {formatDate(b.budget_date+"T12:00:00")}</div>
                                </div>
                                <span style={{ fontSize:10, fontWeight:700, padding:"3px 10px", borderRadius:20,
                                  background: b.status === "aprovado" ? "#F0FDF4" : b.status === "pendente" ? "#FFFBEB" : "#F8FAFC",
                                  color: b.status === "aprovado" ? "#16A34A" : b.status === "pendente" ? "#D97706" : "#64748B",
                                  border: `1px solid ${b.status === "aprovado" ? "#BBF7D0" : b.status === "pendente" ? "#FDE68A" : "#E2E8F0"}`
                                }}>{b.status === "aprovado" ? "Aprovado" : b.status === "pendente" ? "Pendente" : "Rascunho"}</span>
                              </div>
                            ))}
                            {budgets.length > 3 && <div style={{ fontSize:12, color:"var(--color-primary)", fontWeight:600, marginTop:8, cursor:"pointer" }} onClick={() => { setOrcamentoView("list"); setShowOrcamentos(true); }}>Ver todos ({budgets.length})</div>}
                          </div>
                        );
                      })()}
                    </div>
                  </div>
                )}

                {/* ‚îÄ‚îÄ‚îÄ TAB: FINANCEIRO ‚îÄ‚îÄ‚îÄ */}
                {patientTab === "financeiro" && (
                  <div>
                    <div style={{ ...cardStyle }}>
                      <div style={{ display:"flex", justifyContent:"space-between", alignItems:"center", marginBottom:"var(--space-3)" }}>
                        <div style={{ fontSize:15, fontWeight:700, color:"var(--color-text)" }}>Financeiro</div>
                        {(isAdminRole(currentUser.role) || currentUser.role === "RECEPTION") && (
                          <button onClick={() => setShowFinanceiro(true)} style={{ background:"var(--color-primary)", color:"#fff", border:"none", borderRadius:"var(--radius-sm)", padding:"8px 16px", fontSize:12, fontWeight:600, cursor:"pointer", minHeight:36 }} aria-label="Gerenciar Financeiro">
                            Gerenciar
                          </button>
                        )}
                      </div>
                      <div style={{ display:"grid", gridTemplateColumns:"1fr 1fr", gap:"var(--space-2)", marginBottom:"var(--space-3)" }}>
                        <div style={{ background:"#F0FDF4", borderRadius:"var(--radius-sm)", padding:"var(--space-2) var(--space-3)", border:"1px solid #BBF7D0" }}>
                          <div style={{ fontSize:10, fontWeight:700, color:"#16A34A", textTransform:"uppercase" }}>Total pago</div>
                          <div style={{ fontSize:16, fontWeight:800, color:"#16A34A" }}>R$ {totalPagoDetail.toFixed(2)}</div>
                        </div>
                        <div style={{ background: saldoDetail > 0 ? "#FEF2F2" : "#F0FDF4", borderRadius:"var(--radius-sm)", padding:"var(--space-2) var(--space-3)", border: saldoDetail > 0 ? "1px solid #FECACA" : "1px solid #BBF7D0" }}>
                          <div style={{ fontSize:10, fontWeight:700, color: saldoDetail > 0 ? "#EF4444" : "#16A34A", textTransform:"uppercase" }}>{saldoDetail > 0 ? "Saldo devedor" : "Situa√ß√£o"}</div>
                          <div style={{ fontSize:16, fontWeight:800, color: saldoDetail > 0 ? "#EF4444" : "#16A34A" }}>{saldoDetail > 0 ? `R$ ${saldoDetail.toFixed(2)}` : "Em dia"}</div>
                        </div>
                      </div>
                      {sp.financeiro?.pagamentos?.length > 0 ? (
                        <div>
                          <div style={{ fontSize:12, fontWeight:700, color:"var(--color-text)", marginBottom:8 }}>√öltimos pagamentos</div>
                          {sp.financeiro.pagamentos.slice(0, 5).sort((a,b) => (b.data||"").localeCompare(a.data||"")).map(pg => (
                            <div key={pg.id} style={{ display:"flex", justifyContent:"space-between", alignItems:"center", padding:"6px 0", borderBottom:"1px solid var(--color-border)" }}>
                              <div>
                                <span style={{ fontSize:13, fontWeight:700, color:"var(--color-text)" }}>R$ {parseFloat(pg.valor).toFixed(2)}</span>
                                <span style={{ fontSize:10, color:"var(--color-text-muted)", marginLeft:8 }}>{pg.forma_pagamento === "avista" ? "√Ä vista" : "Parcelado"}</span>
                              </div>
                              <span style={{ fontSize:11, color:"var(--color-text-muted)" }}>{pg.data ? formatDate(pg.data+"T12:00:00") : ""}</span>
                            </div>
                          ))}
                        </div>
                      ) : (
                        <div style={{ textAlign:"center", padding:"12px 0", color:"var(--color-text-muted)", fontSize:13 }}>Nenhum pagamento registrado</div>
                      )}
                    </div>
                  </div>
                )}

                {/* ‚îÄ‚îÄ‚îÄ TAB: ARQUIVOS ‚îÄ‚îÄ‚îÄ */}
                {patientTab === "arquivos" && (
                  <div>
                    <div style={{ ...cardStyle }}>
                      <div style={{ display:"flex", justifyContent:"space-between", alignItems:"center", marginBottom:"var(--space-3)", flexWrap:"wrap", gap:8 }}>
                        <div style={{ fontSize:15, fontWeight:700, color:"var(--color-text)" }}>Documentos ({(sp.documents || []).length})</div>
                        <div style={{ display:"flex", alignItems:"center", gap:8 }}>
                          <div style={{ display:"flex", alignItems:"center", gap:6 }}>
                            <label style={{ fontSize:11, color:"var(--color-text-muted)", fontWeight:600 }}>Data:</label>
                            <input type="date" value={docDateFilter} onChange={e => setDocDateFilter(e.target.value)}
                              style={{ padding:"6px 10px", borderRadius:"var(--radius-sm)", border:"1px solid var(--color-border)", fontSize:12, outline:"none", background:"var(--color-surface)", minHeight:36 }} />
                            {docDateFilter && <button onClick={() => setDocDateFilter("")} style={{ background:"none", border:"none", color:"var(--color-text-muted)", cursor:"pointer", fontSize:14, padding:0 }} aria-label="Limpar filtro">√ó</button>}
                          </div>
                          <button onClick={() => docInputRef.current?.click()} style={{ background:"var(--color-primary)", color:"#fff", border:"none", borderRadius:"var(--radius-sm)", padding:"8px 14px", fontSize:12, fontWeight:600, cursor:"pointer", minHeight:36, whiteSpace:"nowrap" }} aria-label="Anexar documento">+ Anexar</button>
                          <input ref={docInputRef} type="file" accept="image/*,.pdf,.docx" multiple onChange={handleDocUpload} style={{ display:"none" }} />
                        </div>
                      </div>
                      {(!sp.documents || sp.documents.length === 0) ? (
                        <div style={{ textAlign:"center", padding:"30px 20px", border:"2px dashed var(--color-border)", borderRadius:"var(--radius)", color:"var(--color-text-muted)" }}>
                          <div style={{ fontSize:28, marginBottom:8 }}>üìÅ</div>
                          <div style={{ fontSize:13 }}>Nenhum documento anexado</div>
                          <div style={{ fontSize:11, marginTop:4 }}>Clique em "+ Anexar" para adicionar</div>
                        </div>
                      ) : (
                        <div style={{ display:"grid", gridTemplateColumns:"repeat(auto-fill, minmax(120px, 1fr))", gap:10 }}>
                          {sp.documents
                            .filter(doc => !docDateFilter || (doc.uploadedAt && doc.uploadedAt.startsWith(docDateFilter)))
                            .map(doc => (
                            <div key={doc.id} style={{ border:"1px solid var(--color-border)", borderRadius:"var(--radius-sm)", padding:8, position:"relative" }}>
                              <div style={{ width:"100%", height:72, borderRadius:6, overflow:"hidden", marginBottom:6 }}>
                                <FileThumb fileId={doc.id} cache={fileCache} loadFn={loadFile} type={doc.type} name={doc.name}
                                  onClick={async () => { const d = fileCache[doc.id] || await FileDB.get(doc.id); if (d) { if (doc.type?.startsWith("image/")) setViewingPhoto(d); else { const a=document.createElement("a"); a.href=d; a.download=doc.name; a.click(); } } }}
                                  style={{ borderRadius:6 }} />
                              </div>
                              <div style={{ fontSize:10, color:"var(--color-text-secondary)", overflow:"hidden", textOverflow:"ellipsis", whiteSpace:"nowrap" }} title={doc.name}>{doc.name}</div>
                              <div style={{ fontSize:9, color:"var(--color-text-muted)" }}>{formatSize(doc.size)}</div>
                              {doc.uploadedAt && <div style={{ fontSize:9, color:"var(--color-text-muted)" }}>{formatDate(doc.uploadedAt)}</div>}
                              {isAdmin && (
                                <button onClick={() => setConfirmModal({ title:"Excluir documento", message:`Excluir "${doc.name}"?`, danger:true, confirmLabel:"Excluir", onConfirm:() => deleteDoc(doc.id) })} style={{ position:"absolute", top:4, right:4, background:"rgba(239,68,68,0.9)", border:"none", borderRadius:"50%", width:20, height:20, color:"#fff", fontSize:11, cursor:"pointer", display:"flex", alignItems:"center", justifyContent:"center", padding:0 }} aria-label="Excluir documento">√ó</button>
                              )}
                            </div>
                          ))}
                          {sp.documents.length > 0 && docDateFilter && sp.documents.filter(doc => doc.uploadedAt && doc.uploadedAt.startsWith(docDateFilter)).length === 0 && (
                            <div style={{ fontSize:12, color:"var(--color-text-muted)", padding:16, gridColumn:"1 / -1" }}>Nenhum documento nesta data.</div>
                          )}
                        </div>
                      )}
                    </div>
                  </div>
                )}
              </div>

              {/* ‚îÄ‚îÄ FAB contextual ‚îÄ‚îÄ */}
              {patientTab === "atendimentos" && (
                <button onClick={() => setShowNewRecord(true)} style={{ position:"fixed", bottom:24, right:24, zIndex:90, width:56, height:56, borderRadius:16, background:"var(--color-primary)", color:"#fff", border:"none", fontSize:24, fontWeight:300, cursor:"pointer", boxShadow:"0 4px 20px rgba(14,165,233,0.35)", display:"flex", alignItems:"center", justifyContent:"center", transition:"transform 0.2s, box-shadow 0.2s" }}
                  onMouseEnter={e => { e.currentTarget.style.transform="scale(1.08)"; e.currentTarget.style.boxShadow="0 6px 28px rgba(14,165,233,0.5)"; }}
                  onMouseLeave={e => { e.currentTarget.style.transform="scale(1)"; e.currentTarget.style.boxShadow="0 4px 20px rgba(14,165,233,0.35)"; }}
                  aria-label="Novo Atendimento" title="Novo Atendimento">
                  +
                </button>
              )}

              {/* ‚îÄ‚îÄ ConfirmModal ‚îÄ‚îÄ */}
              <ConfirmModal config={confirmModal} onClose={() => setConfirmModal(null)} />
            </div>
            );
          })()}

          {/* ‚ïê‚ïê‚ïê USER MANAGEMENT ‚ïê‚ïê‚ïê */}
          {view === "users" && isAdmin && (
            <div style={{ padding:"20px 24px", maxWidth:800, margin:"0 auto" }}>
              <div style={{ display:"flex", justifyContent:"space-between", alignItems:"center", marginBottom:16 }}>
                <h2 style={{ fontSize:20, fontWeight:800, color:"#0F172A" }}>Gest√£o de Usu√°rios</h2>
                <button onClick={() => { setUserForm({ id:"", name:"", login:"", password:"", role:"PROFESSIONAL", active:true }); setEditingUserId(null); setShowUserForm(true); }} style={btnPrimary}>+ Novo Usu√°rio</button>
              </div>
              {users.map(u => (
                <div key={u.id} style={{ ...cardStyle, display:"flex", justifyContent:"space-between", alignItems:"center" }}>
                  <div>
                    <div style={{ fontSize:15, fontWeight:700 }}>{u.name} {!u.active && <span style={{ fontSize:11, color:"#EF4444", fontWeight:600 }}>(Inativo)</span>}</div>
                    <div style={{ fontSize:12, color:"#64748B" }}>Login: {u.login} ¬∑ Perfil: {ROLE_LABELS[u.role]}</div>
                  </div>
                  {u.id !== "admin1" && (
                    <button onClick={() => { setUserForm({ id:u.id, name:u.name, login:u.login, password:"", role:u.role, active:u.active }); setEditingUserId(u.id); setShowUserForm(true); }} style={{ ...btnSecondary, fontSize:12, padding:"6px 12px" }}>Editar</button>
                  )}
                </div>
              ))}
            </div>
          )}

          {/* ‚ïê‚ïê‚ïê AUDIT LOG ‚ïê‚ïê‚ïê */}
          {view === "audit" && isAdmin && (
            <div style={{ padding:"20px 24px", maxWidth:900, margin:"0 auto" }}>
              <h2 style={{ fontSize:20, fontWeight:800, color:"#0F172A", marginBottom:16 }}>Log de Auditoria</h2>
              <input placeholder="Filtrar por usu√°rio, a√ß√£o, paciente..." value={auditFilter} onChange={e => setAuditFilter(e.target.value)}
                style={{ width:"100%", padding:"10px 14px", borderRadius:10, border:"1.5px solid #CBD5E1", fontSize:14, outline:"none", background:"#fff", boxSizing:"border-box", marginBottom:16 }} />
              <div style={{ maxHeight:"70vh", overflowY:"auto" }}>
                {auditLogs.filter(l => {
                  if (!auditFilter) return true;
                  const f = auditFilter.toLowerCase();
                  return l.userName?.toLowerCase().includes(f) || l.action?.toLowerCase().includes(f) || l.targetName?.toLowerCase().includes(f) || l.details?.toLowerCase().includes(f);
                }).slice(0, 200).map(l => (
                  <div key={l.id} style={{ padding:"10px 14px", borderBottom:"1px solid #F1F5F9", fontSize:13 }}>
                    <div style={{ display:"flex", justifyContent:"space-between", alignItems:"start" }}>
                      <div>
                        <span style={{ fontWeight:700, color:"#0F172A" }}>{l.userName}</span>
                        <span style={{ color:"#64748B" }}> ¬∑ {l.action}</span>
                        {l.targetName && <span style={{ color:"#64748B" }}> ¬∑ {l.targetName}</span>}
                      </div>
                      <span style={{ fontSize:11, color:"#94A3B8", whiteSpace:"nowrap", marginLeft:10 }}>{formatDateTime(l.timestamp)}</span>
                    </div>
                    {l.details && <div style={{ fontSize:12, color:"#94A3B8", marginTop:2 }}>{l.details}</div>}
                  </div>
                ))}
                {auditLogs.length === 0 && <div style={{ textAlign:"center", padding:40, color:"#94A3B8" }}>Nenhum registro de auditoria</div>}
              </div>
            </div>
          )}


          {/* ‚ïê‚ïê‚ïê NEW PATIENT MODAL ‚ïê‚ïê‚ïê */}
          <Modal isOpen={showNewPatient} onClose={() => setShowNewPatient(false)} title="Novo Paciente" wide>
            <div style={{ display:"grid", gridTemplateColumns:"1fr 2fr", gap:12 }}>
              <Input label="C√≥digo do Paciente" value={npForm.codigo} onChange={e => setNpForm({...npForm, codigo:e.target.value})} placeholder="Ex: P001" />
              <Input label="Nome Completo *" value={npForm.name} onChange={e => setNpForm({...npForm, name:e.target.value})} placeholder="Nome do paciente" />
            </div>
            <div style={{ display:"grid", gridTemplateColumns:"1fr 1fr", gap:12 }}>
              <Input label="Data de Nascimento" type="date" value={npForm.birthDate} onChange={e => setNpForm({...npForm, birthDate:e.target.value})} />
              <Input label="Telefone" value={npForm.phone} onChange={e => setNpForm({...npForm, phone:e.target.value})} placeholder="(00) 00000-0000" />
            </div>
            <Input label="Email" type="email" value={npForm.email} onChange={e => setNpForm({...npForm, email:e.target.value})} placeholder="email@exemplo.com" />
            <Input label="Endere√ßo" value={npForm.address} onChange={e => setNpForm({...npForm, address:e.target.value})} placeholder="Endere√ßo completo" />
            <div style={{ marginTop:8, paddingTop:16, borderTop:"2px dashed #E2E8F0" }}>
              <div style={{ fontSize:14, fontWeight:700, color:"#334155", marginBottom:4 }}>Respons√°veis</div>
              <div style={{ fontSize:12, color:"#64748B", marginBottom:12 }}>Selecione pelo menos um respons√°vel (cl√≠nico ou ortodontista).</div>
              <div style={{ display:"grid", gridTemplateColumns:"1fr 1fr", gap:12 }}>
                <Select label="Respons√°vel Cl√≠nico" value={npForm.responsavel_clinico_id}
                  onChange={e => setNpForm({...npForm, responsavel_clinico_id:e.target.value})} options={allUserOpts} />
                <Select label="Respons√°vel Ortodontia" value={npForm.responsavel_orto_id}
                  onChange={e => setNpForm({...npForm, responsavel_orto_id:e.target.value})} options={allUserOpts} />
              </div>
            </div>
            <div style={{ display:"flex", gap:10, justifyContent:"flex-end", marginTop:16 }}>
              <button onClick={() => setShowNewPatient(false)} style={btnSecondary}>Cancelar</button>
              <button onClick={createPatient} style={{ ...btnPrimary, opacity:(!npForm.name.trim())?0.5:1 }}>Cadastrar Paciente</button>
            </div>
          </Modal>

          {/* ‚ïê‚ïê‚ïê NEW RECORD MODAL ‚ïê‚ïê‚ïê */}
          <Modal isOpen={showNewRecord} onClose={() => { setShowNewRecord(false); setNrForm({...emptyNrForm}); }} title="Novo Atendimento" wide>
            {/* Step 1: Tipo */}
            <div style={{ marginBottom:16 }}>
              <label style={{ display:"block", fontSize:13, fontWeight:600, color:"#475569", marginBottom:8 }}>Tipo de Atendimento *</label>
              <div style={{ display:"flex", gap:12 }}>
                <div className={`tipo-card ${nrForm.tipo_atendimento==="ORTODONTIA"?"selected":""}`}
                  onClick={() => setNrForm({...emptyNrForm, date:nrForm.date, tipo_atendimento:"ORTODONTIA", specialty:"ortodontia"})}
                  style={{ color:"#0EA5E9", borderColor:nrForm.tipo_atendimento==="ORTODONTIA"?"#0EA5E9":"#E2E8F0", background:nrForm.tipo_atendimento==="ORTODONTIA"?"#F0F9FF":"#fff" }}>
                  <div style={{ fontSize:28 }}>ü¶∑</div>
                  <div style={{ fontWeight:700, marginTop:4 }}>Ortodontia</div>
                </div>
                <div className={`tipo-card ${nrForm.tipo_atendimento==="GERAL"?"selected":""}`}
                  onClick={() => setNrForm({...emptyNrForm, date:nrForm.date, tipo_atendimento:"GERAL", specialty:""})}
                  style={{ color:"#10B981", borderColor:nrForm.tipo_atendimento==="GERAL"?"#10B981":"#E2E8F0", background:nrForm.tipo_atendimento==="GERAL"?"#F0FDF4":"#fff" }}>
                  <div style={{ fontSize:28 }}>ü©∫</div>
                  <div style={{ fontWeight:700, marginTop:4 }}>Cl√≠nico / Outros</div>
                </div>
              </div>
            </div>

            {nrForm.tipo_atendimento && (
              <>
                <div style={{ display:"grid", gridTemplateColumns:"1fr 1fr", gap:12 }}>
                  <Input label="Data do Atendimento" type="date" value={nrForm.date} onChange={e => setNrForm({...nrForm, date:e.target.value})} />
                  {nrForm.tipo_atendimento === "GERAL" && (
                    <Select label="Especialidade *" value={nrForm.specialty}
                      onChange={e => setNrForm({...nrForm, specialty:e.target.value, procedures:[]})}
                      options={geralSpecOpts} />
                  )}
                  {nrForm.tipo_atendimento === "ORTODONTIA" && (
                    <div style={{ marginBottom:14 }}>
                      <label style={{ display:"block", fontSize:13, fontWeight:600, color:"#475569", marginBottom:5 }}>Especialidade</label>
                      <div style={{ padding:"10px 14px", borderRadius:10, border:"1.5px solid #BAE6FD", background:"#F0F9FF", fontSize:14, color:"#0369A1", fontWeight:600 }}>ü¶∑ Ortodontia</div>
                    </div>
                  )}
                </div>

                {/* Procedures */}
                {nrForm.specialty && (
                  <div style={{ marginBottom:14 }}>
                    <label style={{ display:"block", fontSize:13, fontWeight:600, color:"#475569", marginBottom:8 }}>Procedimentos Realizados *</label>
                    <div style={{ display:"flex", flexWrap:"wrap", gap:6, background:"#F8FAFC", borderRadius:12, padding:12, border:"1px solid #E2E8F0", maxHeight:200, overflowY:"auto" }}>
                      {SPECIALTIES[nrForm.specialty]?.procedures.map(proc => {
                        const isSel = nrForm.procedures.includes(proc);
                        const col = SPECIALTIES[nrForm.specialty]?.color;
                        return (<button key={proc} onClick={() => toggleProcedure(proc)} style={{ padding:"6px 12px", borderRadius:8, fontSize:12, fontWeight:600, border:isSel?`2px solid ${col}`:"1.5px solid #CBD5E1", background:isSel?col+"15":"#fff", color:isSel?col:"#475569", cursor:"pointer", transition:"all 0.15s" }}>
                          {isSel?"‚úì ":""}{proc}
                        </button>);
                      })}
                    </div>
                    {nrForm.procedures.length > 0 && <div style={{ marginTop:8, fontSize:12, color:"#64748B" }}>{nrForm.procedures.length} procedimento(s)</div>}
                  </div>
                )}

                {/* Wire Info */}
                {needsWireInfo && (
                  <div style={{ marginBottom:14, padding:14, background:"#F0F9FF", borderRadius:12, border:"1.5px solid #BAE6FD" }}>
                    <div style={{ display:"flex", alignItems:"center", gap:8, marginBottom:12 }}>
                      <span style={{ fontSize:16 }}>üî©</span>
                      <span style={{ fontSize:14, fontWeight:700, color:"#0369A1" }}>Informa√ß√µes do Fio Ortod√¥ntico</span>
                    </div>
                    
                    {/* Arcada Superior */}
                    <div style={{ marginBottom:12 }}>
                      <div style={{ fontSize:13, fontWeight:600, color:"#0369A1", marginBottom:8 }}>Arcada Superior</div>
                      <div style={{ display:"grid", gridTemplateColumns:"1fr 1fr 1fr", gap:10 }}>
                        <Select label="Material" value={nrForm.wireInfo.upper.material}
                          onChange={e => setNrForm({...nrForm, wireInfo:{...nrForm.wireInfo, upper:{...nrForm.wireInfo.upper, material:e.target.value}}})}
                          options={[{value:"",label:"Selecione..."}, ...WIRE_MATERIALS.map(m=>({value:m,label:m}))]} />
                        <Select label="Formato" value={nrForm.wireInfo.upper.format}
                          onChange={e => setNrForm({...nrForm, wireInfo:{...nrForm.wireInfo, upper:{...nrForm.wireInfo.upper, format:e.target.value}}})}
                          options={[{value:"",label:"Selecione..."}, ...WIRE_FORMATS.map(f=>({value:f,label:f}))]} />
                        <Select label="Calibre" value={nrForm.wireInfo.upper.gauge}
                          onChange={e => setNrForm({...nrForm, wireInfo:{...nrForm.wireInfo, upper:{...nrForm.wireInfo.upper, gauge:e.target.value}}})}
                          options={[{value:"",label:"Selecione..."}, ...WIRE_GAUGES.map(g=>({value:g,label:g}))]} />
                      </div>
                    </div>
                    
                    {/* Arcada Inferior */}
                    <div>
                      <div style={{ fontSize:13, fontWeight:600, color:"#0369A1", marginBottom:8 }}>Arcada Inferior</div>
                      <div style={{ display:"grid", gridTemplateColumns:"1fr 1fr 1fr", gap:10 }}>
                        <Select label="Material" value={nrForm.wireInfo.lower.material}
                          onChange={e => setNrForm({...nrForm, wireInfo:{...nrForm.wireInfo, lower:{...nrForm.wireInfo.lower, material:e.target.value}}})}
                          options={[{value:"",label:"Selecione..."}, ...WIRE_MATERIALS.map(m=>({value:m,label:m}))]} />
                        <Select label="Formato" value={nrForm.wireInfo.lower.format}
                          onChange={e => setNrForm({...nrForm, wireInfo:{...nrForm.wireInfo, lower:{...nrForm.wireInfo.lower, format:e.target.value}}})}
                          options={[{value:"",label:"Selecione..."}, ...WIRE_FORMATS.map(f=>({value:f,label:f}))]} />
                        <Select label="Calibre" value={nrForm.wireInfo.lower.gauge}
                          onChange={e => setNrForm({...nrForm, wireInfo:{...nrForm.wireInfo, lower:{...nrForm.wireInfo.lower, gauge:e.target.value}}})}
                          options={[{value:"",label:"Selecione..."}, ...WIRE_GAUGES.map(g=>({value:g,label:g}))]} />
                      </div>
                    </div>
                  </div>
                )}

                <ToothChart selected={nrForm.teeth} onToggle={toggleTooth} />
                <Textarea label="Observa√ß√µes" value={nrForm.notes} onChange={e => setNrForm({...nrForm, notes:e.target.value})} placeholder="Detalhes do procedimento..." style={{ minHeight:80 }} />
                <Input label="Pr√≥xima Consulta" type="date" value={nrForm.nextAppointment} onChange={e => setNrForm({...nrForm, nextAppointment:e.target.value})} />

                {/* Photos */}
                <div style={{ marginTop:8, paddingTop:16, borderTop:"2px dashed #E2E8F0" }}>
                  <div style={{ fontSize:14, fontWeight:700, color:"#334155", marginBottom:8 }}>Fotos Cl√≠nicas</div>
                  <input ref={photoInputRef} type="file" accept="image/*" multiple onChange={handlePhotoUpload} style={{ display:"none" }} />
                  <button onClick={() => photoInputRef.current?.click()} style={{ ...btnSecondary, fontSize:13, padding:"8px 16px", marginBottom:8 }}>Anexar Foto</button>
                  {nrForm.photos.length > 0 && (
                    <div style={{ display:"flex", flexWrap:"wrap", gap:8, marginTop:8 }}>
                      {nrForm.photos.map(ph => (
                        <div key={ph.id} style={{ position:"relative", width:80, height:80, borderRadius:10, overflow:"hidden", border:"1.5px solid #CBD5E1" }}>
                          <FileThumb fileId={ph.id} cache={fileCache} loadFn={loadFile} type={ph.type || "image/jpeg"} name={ph.name} style={{ borderRadius:10 }} />
                          <button onClick={async () => { try { await FileDB.del(ph.id); } catch(e) {} setFileCache(prev => { const n={...prev}; delete n[ph.id]; return n; }); setNrForm(prev => ({...prev, photos:prev.photos.filter(p=>p.id!==ph.id)})); }} style={{ position:"absolute", top:2, right:2, background:"rgba(239,68,68,0.9)", border:"none", borderRadius:"50%", width:18, height:18, color:"#fff", fontSize:11, cursor:"pointer", display:"flex", alignItems:"center", justifyContent:"center", padding:0 }}>√ó</button>
                        </div>
                      ))}
                    </div>
                  )}
                </div>

                {/* Signature */}
                <div style={{ marginTop:8, paddingTop:16, borderTop:"2px dashed #E2E8F0" }}>
                  <div style={{ fontSize:14, fontWeight:700, color:"#334155", marginBottom:4 }}>Assinatura do Paciente</div>
                  <p style={{ fontSize:12, color:"#64748B", marginBottom:10 }}>O paciente declara ci√™ncia e autoriza o tratamento.</p>
                  <SignaturePad value={nrForm.signature} onChange={(sig) => setNrForm({...nrForm, signature:sig})} label="Desenhe a assinatura" />
                </div>

                <div style={{ display:"flex", gap:10, justifyContent:"flex-end", marginTop:16 }}>
                  <button onClick={() => { setShowNewRecord(false); setNrForm({...emptyNrForm}); }} style={btnSecondary}>Cancelar</button>
                  <button onClick={tryAddRecord} style={{ ...btnPrimary, opacity:(!nrForm.specialty||nrForm.procedures.length===0)?0.5:1 }}>Registrar Atendimento</button>
                </div>
              </>
            )}
          </Modal>

          {/* ‚ïê‚ïê‚ïê RESPONSIBILITY CHECK POPUP ‚ïê‚ïê‚ïê */}
          <Modal isOpen={showRespCheck} onClose={() => { setShowRespCheck(false); setPendingRecord(null); }} title="Aten√ß√£o: Paciente com Respons√°vel">
            {pendingRecord && (() => {
              const respField = pendingRecord.tipo_atendimento === "ORTODONTIA" ? "responsavel_orto_id" : "responsavel_clinico_id";
              const respName = getUserName(selectedPatient?.[respField]);
              const tipoLabel = pendingRecord.tipo_atendimento === "ORTODONTIA" ? "Ortodontia" : "Cl√≠nico";
              return (
                <div>
                  <div style={{ background:"#FEF3C7", border:"1px solid #FDE68A", borderRadius:12, padding:16, marginBottom:16 }}>
                    <div style={{ fontSize:14, fontWeight:700, color:"#92400E", marginBottom:4 }}>Este paciente possui respons√°vel de {tipoLabel}:</div>
                    <div style={{ fontSize:18, fontWeight:800, color:"#78350F" }}>{respName}</div>
                  </div>
                  <p style={{ fontSize:13, color:"#475569", marginBottom:12 }}>Voc√™ ({currentUser.name}) n√£o √© o respons√°vel vigente. Deseja prosseguir com o atendimento mesmo assim?</p>
                  <Select label="Motivo (obrigat√≥rio)" value={respCheckMotivo}
                    onChange={e => setRespCheckMotivo(e.target.value)}
                    options={[{value:"",label:"Selecione o motivo..."},{value:"Cobertura",label:"Cobertura"},{value:"Urg√™ncia",label:"Urg√™ncia"},{value:"Encaixe",label:"Encaixe"},{value:"Substitui√ß√£o",label:"Substitui√ß√£o"},{value:"Outro",label:"Outro"}]} />
                  <div style={{ display:"flex", gap:10, justifyContent:"flex-end", marginTop:16 }}>
                    <button onClick={() => { setShowRespCheck(false); setPendingRecord(null); }} style={btnSecondary}>Cancelar</button>
                    <button onClick={confirmOutOfResp} style={{ ...btnPrimary, background:"#D97706", opacity:!respCheckMotivo?0.5:1 }} disabled={!respCheckMotivo}>Confirmar Atendimento</button>
                  </div>
                </div>
              );
            })()}
          </Modal>

          {/* ‚ïê‚ïê‚ïê CHANGE RESPONSIBLE MODAL ‚ïê‚ïê‚ïê */}
          <Modal isOpen={showChangeResp} onClose={() => setShowChangeResp(false)} title="Alterar Respons√°veis" wide>
            {selectedPatient && (
              <div>
                <div style={{ display:"grid", gridTemplateColumns:"1fr 1fr", gap:12 }}>
                  <Select label="Respons√°vel Cl√≠nico" value={respForm.responsavel_clinico_id}
                    onChange={e => setRespForm({...respForm, responsavel_clinico_id:e.target.value})} options={allUserOpts} />
                  <Select label="Respons√°vel Ortodontia" value={respForm.responsavel_orto_id}
                    onChange={e => setRespForm({...respForm, responsavel_orto_id:e.target.value})} options={allUserOpts} />
                </div>
                {selectedPatient.responsavelHistory?.length > 0 && (
                  <div style={{ marginTop:16, paddingTop:16, borderTop:"1px solid #E2E8F0" }}>
                    <div style={{ fontSize:13, fontWeight:700, color:"#334155", marginBottom:8 }}>Hist√≥rico de Altera√ß√µes</div>
                    {selectedPatient.responsavelHistory.map((h, i) => (
                      <div key={i} style={{ fontSize:12, color:"#64748B", padding:"6px 0", borderBottom:"1px solid #F1F5F9" }}>
                        <strong>{formatDateTime(h.date)}</strong> ‚Äî {h.changedByName} alterou {h.field==="responsavel_clinico_id"?"Resp. Cl√≠nico":"Resp. Orto"}: {h.fromName || "‚Äî"} ‚Üí {h.toName}
                      </div>
                    ))}
                  </div>
                )}
                <div style={{ display:"flex", gap:10, justifyContent:"flex-end", marginTop:16 }}>
                  <button onClick={() => setShowChangeResp(false)} style={btnSecondary}>Cancelar</button>
                  <button onClick={saveResponsible} style={btnPrimary}>Salvar</button>
                </div>
              </div>
            )}
          </Modal>

          {/* ‚ïê‚ïê‚ïê USER FORM MODAL ‚ïê‚ïê‚ïê */}
          <Modal isOpen={showUserForm} onClose={() => { setShowUserForm(false); setEditingUserId(null); }} title={editingUserId ? "Editar Usu√°rio" : "Novo Usu√°rio"}>
            <Input label="Nome Completo *" value={userForm.name} onChange={e => setUserForm({...userForm, name:e.target.value})} placeholder="Nome do profissional" />
            <Input label="Login *" value={userForm.login} onChange={e => setUserForm({...userForm, login:e.target.value})} placeholder="Login de acesso" />
            <Input label={editingUserId ? "Nova Senha (deixe vazio para manter)" : "Senha *"} type="password" value={userForm.password} onChange={e => setUserForm({...userForm, password:e.target.value})} placeholder="Senha" />
            <Select label="Perfil *" value={userForm.role} onChange={e => setUserForm({...userForm, role:e.target.value})}
              options={[{value:"PROFESSIONAL",label:"Profissional"},{value:"RECEPTION",label:"Recepcionista"},{value:"MANAGER",label:"Gerente"},{value:"ADMIN",label:"Administrador"}]} />
            {editingUserId && (
              <Select label="Status" value={userForm.active?"true":"false"} onChange={e => setUserForm({...userForm, active:e.target.value==="true"})}
                options={[{value:"true",label:"Ativo"},{value:"false",label:"Inativo"}]} />
            )}
            <div style={{ display:"flex", gap:10, justifyContent:"flex-end", marginTop:16 }}>
              <button onClick={() => { setShowUserForm(false); setEditingUserId(null); }} style={btnSecondary}>Cancelar</button>
              <button onClick={saveUser} style={btnPrimary}>{editingUserId ? "Salvar" : "Criar Usu√°rio"}</button>
            </div>
          </Modal>

          {/* ‚ïê‚ïê‚ïê ANAMNESIS MODAL ‚ïê‚ïê‚ïê */}
          <Modal isOpen={showAnamnesis} onClose={() => setShowAnamnesis(false)} title="Anamnese Cl√≠nica" wide>
            {!editingAnamnesis ? (
              <div>
                <div style={{ display:"flex", justifyContent:"flex-end", marginBottom:16 }}>
                  <button onClick={() => setEditingAnamnesis(true)} style={btnPrimary}>Editar</button>
                </div>
                {[["Alergias",anamnesisForm.allergies],["Medicamentos",anamnesisForm.medications],["Doen√ßas",anamnesisForm.diseases],["Cirurgias",anamnesisForm.surgeries],["Hist√≥rico familiar",anamnesisForm.familyHistory],["Press√£o arterial",anamnesisForm.bloodPressure]].map(([l,v]) => (
                  <div key={l} style={{ marginBottom:12 }}>
                    <div style={{ fontSize:12, fontWeight:700, color:"#64748B", textTransform:"uppercase", letterSpacing:0.5 }}>{l}</div>
                    <div style={{ fontSize:14, color:v?"#0F172A":"#CBD5E1", marginTop:2 }}>{v||"N√£o informado"}</div>
                  </div>
                ))}
                <div style={{ display:"grid", gridTemplateColumns:"repeat(auto-fill,minmax(160px,1fr))", gap:8, marginTop:12 }}>
                  {[["Tabagismo",anamnesisForm.smoker],["Etilismo",anamnesisForm.drinker],["Gestante",anamnesisForm.pregnant],["Diabetes",anamnesisForm.diabetes],["Cardiopatia",anamnesisForm.heartDisease],["Hepatite",anamnesisForm.hepatitis],["HIV",anamnesisForm.hiv],["Sangramento",anamnesisForm.bleeding],["Cicatriza√ß√£o",anamnesisForm.healing],["Rea√ß√£o anestesia",anamnesisForm.anesthesiaReaction]].map(([l,v]) => (
                    <div key={l} style={{ padding:"8px 12px", borderRadius:10, background:v==="Sim"||v==="Alterada"?"#FEF2F2":"#F0FDF4", border:`1px solid ${v==="Sim"||v==="Alterada"?"#FECACA":"#BBF7D0"}` }}>
                      <div style={{ fontSize:11, color:"#64748B", fontWeight:600 }}>{l}</div>
                      <div style={{ fontSize:14, fontWeight:700, color:v==="Sim"||v==="Alterada"?"#DC2626":"#16A34A" }}>{v}</div>
                    </div>
                  ))}
                </div>
                {anamnesisForm.observations && (
                  <div style={{ marginTop:16, padding:14, background:"#FFFBEB", borderRadius:10, border:"1px solid #FDE68A" }}>
                    <div style={{ fontSize:12, fontWeight:700, color:"#92400E", marginBottom:4 }}>Observa√ß√µes</div>
                    <div style={{ fontSize:14, color:"#78350F", whiteSpace:"pre-wrap" }}>{anamnesisForm.observations}</div>
                  </div>
                )}
              </div>
            ) : (
              <div>
                <Textarea label="Alergias" value={anamnesisForm.allergies} onChange={e => setAnamnesisForm({...anamnesisForm, allergies:e.target.value})} placeholder="Alergias conhecidas..." />
                <Textarea label="Medicamentos" value={anamnesisForm.medications} onChange={e => setAnamnesisForm({...anamnesisForm, medications:e.target.value})} placeholder="Medicamentos em uso..." />
                <Textarea label="Doen√ßas" value={anamnesisForm.diseases} onChange={e => setAnamnesisForm({...anamnesisForm, diseases:e.target.value})} placeholder="Condi√ß√µes de sa√∫de..." />
                <div style={{ display:"grid", gridTemplateColumns:"1fr 1fr", gap:12 }}>
                  <Textarea label="Cirurgias" value={anamnesisForm.surgeries} onChange={e => setAnamnesisForm({...anamnesisForm, surgeries:e.target.value})} placeholder="Cirurgias realizadas..." />
                  <Textarea label="Hist√≥rico familiar" value={anamnesisForm.familyHistory} onChange={e => setAnamnesisForm({...anamnesisForm, familyHistory:e.target.value})} placeholder="Doen√ßas na fam√≠lia..." />
                </div>
                <Input label="Press√£o Arterial" value={anamnesisForm.bloodPressure} onChange={e => setAnamnesisForm({...anamnesisForm, bloodPressure:e.target.value})} placeholder="Ex: 120x80 mmHg" />
                <div style={{ display:"grid", gridTemplateColumns:"repeat(auto-fill,minmax(200px,1fr))", gap:10, marginTop:8 }}>
                  {[["smoker","Tabagismo"],["drinker","Etilismo"],["pregnant","Gestante"],["diabetes","Diabetes"],["heartDisease","Cardiopatia"],["hepatitis","Hepatite"],["hiv","HIV"],["bleeding","Sangramento"],["anesthesiaReaction","Rea√ß√£o anestesia"]].map(([k,l]) => (
                    <Select key={k} label={l} value={anamnesisForm[k]} onChange={e => setAnamnesisForm({...anamnesisForm, [k]:e.target.value})} options={[{value:"N√£o",label:"N√£o"},{value:"Sim",label:"Sim"}]} />
                  ))}
                  <Select label="Cicatriza√ß√£o" value={anamnesisForm.healing} onChange={e => setAnamnesisForm({...anamnesisForm, healing:e.target.value})} options={[{value:"Normal",label:"Normal"},{value:"Alterada",label:"Alterada"}]} />
                </div>
                <Textarea label="Observa√ß√µes" value={anamnesisForm.observations} onChange={e => setAnamnesisForm({...anamnesisForm, observations:e.target.value})} placeholder="Anota√ß√µes adicionais..." style={{ minHeight:100 }} />
                <div style={{ display:"flex", gap:10, justifyContent:"flex-end", marginTop:16 }}>
                  <button onClick={() => setEditingAnamnesis(false)} style={btnSecondary}>Cancelar</button>
                  <button onClick={saveAnamnesis} style={btnPrimary}>Salvar Anamnese</button>
                </div>
              </div>
            )}
          </Modal>

          {/* ‚ïê‚ïê‚ïê VIEW SIGNATURE MODAL ‚ïê‚ïê‚ïê */}
          <Modal isOpen={!!viewingSignature} onClose={() => setViewingSignature(null)} title="Assinatura do Paciente">
            {viewingSignature && (<div style={{ textAlign:"center" }}><div style={{ background:"#FAFBFC", borderRadius:12, border:"1px solid #E2E8F0", padding:16, display:"inline-block" }}><img src={viewingSignature} alt="Assinatura" style={{ maxWidth:"100%", height:"auto" }} /></div></div>)}
          </Modal>

          {/* ‚ïê‚ïê‚ïê VIEW PHOTO MODAL ‚ïê‚ïê‚ïê */}
          <Modal isOpen={!!viewingPhoto} onClose={() => setViewingPhoto(null)} title="Visualizar Imagem">
            {viewingPhoto && (<div style={{ textAlign:"center" }}><img src={viewingPhoto} alt="Foto" style={{ maxWidth:"100%", maxHeight:"70vh", borderRadius:12, border:"1px solid #E2E8F0" }} /></div>)}
          </Modal>

          {/* ‚ïê‚ïê‚ïê FINANCEIRO MODAL ‚ïê‚ïê‚ïê */}
          <Modal isOpen={showFinanceiro} onClose={() => { setShowFinanceiro(false); setFinanceiroForm({ data: formatDateISO(new Date()), valor: "", forma_pagamento: "avista", observacao: "" }); }} title="Financeiro - Controle de Pagamentos" wide>
            {selectedPatient && (
              <div>
                {/* Or√ßamento Total - Sincronizado automaticamente dos or√ßamentos aprovados */}
                {(() => {
                  const approvedBudgets = loadBudgets(selectedPatient.id).filter(b => b.status === "aprovado");
                  const orcTotal = approvedBudgets.reduce((sum, b) => sum + (parseFloat(b.total) || 0), 0);
                  return (
                    <div style={{ ...cardStyle, marginBottom:16, background:"linear-gradient(135deg,#EFF6FF,#DBEAFE)", borderColor:"#3B82F6" }}>
                      <div style={{ display:"flex", justifyContent:"space-between", alignItems:"center", marginBottom:10 }}>
                        <div style={{ fontSize:16, fontWeight:700, color:"#1E40AF" }}>üíµ Or√ßamento Total</div>
                        <span style={{ fontSize:11, color:"#64748B", fontStyle:"italic" }}>Soma dos or√ßamentos aprovados</span>
                      </div>
                      <div style={{ fontSize:28, fontWeight:800, color:"#1E40AF", marginBottom: approvedBudgets.length > 0 ? 10 : 0 }}>
                        R$ {orcTotal.toFixed(2).replace(".", ",")}
                      </div>
                      {approvedBudgets.length > 0 && (
                        <div style={{ borderTop:"1px solid #BFDBFE", paddingTop:8 }}>
                          {approvedBudgets.map(ab => (
                            <div key={ab.id} style={{ display:"flex", justifyContent:"space-between", alignItems:"center", fontSize:12, color:"#1E40AF", padding:"3px 0" }}>
                              <span>{formatDate(ab.budget_date)} - {ab.professional_name || "‚Äî"} ({(ab.items||[]).length} itens)</span>
                              <span style={{ fontWeight:700 }}>R$ {(ab.total||0).toFixed(2).replace(".",",")}</span>
                            </div>
                          ))}
                        </div>
                      )}
                      {approvedBudgets.length === 0 && (
                        <div style={{ fontSize:12, color:"#94A3B8", marginTop:4 }}>Nenhum or√ßamento aprovado. Aprove or√ßamentos na aba de Or√ßamentos.</div>
                      )}
                    </div>
                  );
                })()}

                {/* Resumo Financeiro */}
                <div style={{ display:"grid", gridTemplateColumns:"repeat(auto-fit, minmax(200px, 1fr))", gap:12, marginBottom:16 }}>
                  <div style={{ ...cardStyle, background:"#F0FDF4", borderColor:"#10B981" }}>
                    <div style={{ fontSize:12, fontWeight:600, color:"#059669", marginBottom:4 }}>‚úì Total Pago</div>
                    <div style={{ fontSize:22, fontWeight:800, color:"#10B981" }}>
                      R$ {selectedPatient.financeiro.pagamentos.reduce((sum, p) => sum + (parseFloat(p.valor) || 0), 0).toFixed(2).replace(".", ",")}
                    </div>
                  </div>
                  <div style={{ ...cardStyle, background: selectedPatient.financeiro.orcamento_total - selectedPatient.financeiro.pagamentos.reduce((sum, p) => sum + (parseFloat(p.valor) || 0), 0) > 0 ? "#FEF2F2" : "#F0FDF4", borderColor: selectedPatient.financeiro.orcamento_total - selectedPatient.financeiro.pagamentos.reduce((sum, p) => sum + (parseFloat(p.valor) || 0), 0) > 0 ? "#EF4444" : "#10B981" }}>
                    <div style={{ fontSize:12, fontWeight:600, color: selectedPatient.financeiro.orcamento_total - selectedPatient.financeiro.pagamentos.reduce((sum, p) => sum + (parseFloat(p.valor) || 0), 0) > 0 ? "#DC2626" : "#059669", marginBottom:4 }}>
                      {selectedPatient.financeiro.orcamento_total - selectedPatient.financeiro.pagamentos.reduce((sum, p) => sum + (parseFloat(p.valor) || 0), 0) > 0 ? "‚ö†Ô∏è Saldo Devedor" : "‚úì Quitado"}
                    </div>
                    <div style={{ fontSize:22, fontWeight:800, color: selectedPatient.financeiro.orcamento_total - selectedPatient.financeiro.pagamentos.reduce((sum, p) => sum + (parseFloat(p.valor) || 0), 0) > 0 ? "#EF4444" : "#10B981" }}>
                      R$ {Math.abs(selectedPatient.financeiro.orcamento_total - selectedPatient.financeiro.pagamentos.reduce((sum, p) => sum + (parseFloat(p.valor) || 0), 0)).toFixed(2).replace(".", ",")}
                    </div>
                  </div>
                </div>

                {/* Novo Pagamento */}
                <div style={{ ...cardStyle, marginBottom:16 }}>
                  <div style={{ fontSize:16, fontWeight:700, color:"#0F172A", marginBottom:12 }}>üí≥ Registrar Novo Pagamento</div>
                  <div style={{ display:"grid", gridTemplateColumns:"repeat(auto-fit, minmax(200px, 1fr))", gap:12, marginBottom:12 }}>
                    <Input label="Data *" type="date" value={financeiroForm.data} onChange={e => setFinanceiroForm({...financeiroForm, data: e.target.value})} />
                    <Input label="Valor (R$) *" type="number" step="0.01" value={financeiroForm.valor} onChange={e => setFinanceiroForm({...financeiroForm, valor: e.target.value})} placeholder="0.00" />
                    <Select label="Forma de Pagamento *" value={financeiroForm.forma_pagamento} onChange={e => setFinanceiroForm({...financeiroForm, forma_pagamento: e.target.value})}
                      options={[{value:"avista",label:"√Ä Vista"},{value:"parcelado",label:"Parcelado"}]} />
                  </div>
                  <Input label="Observa√ß√£o" value={financeiroForm.observacao} onChange={e => setFinanceiroForm({...financeiroForm, observacao: e.target.value})} placeholder="Ex: Parcela 1/12, Cart√£o, etc." />
                  <div style={{ display:"flex", justifyContent:"flex-end", marginTop:12 }}>
                    <button onClick={() => addPagamento(selectedPatient.id)} style={btnPrimary}>‚úì Adicionar Pagamento</button>
                  </div>
                </div>

                {/* Hist√≥rico de Pagamentos */}
                <div style={{ ...cardStyle }}>
                  <div style={{ fontSize:16, fontWeight:700, color:"#0F172A", marginBottom:12 }}>üìä Hist√≥rico de Pagamentos ({selectedPatient.financeiro.pagamentos.length})</div>
                  {selectedPatient.financeiro.pagamentos.length === 0 ? (
                    <div style={{ textAlign:"center", padding:40, color:"#94A3B8" }}>Nenhum pagamento registrado</div>
                  ) : (
                    <div style={{ maxHeight:400, overflowY:"auto" }}>
                      {[...selectedPatient.financeiro.pagamentos].sort((a, b) => new Date(b.data) - new Date(a.data)).map(pg => (
                        <div key={pg.id} style={{ padding:12, background:"#F8FAFC", borderRadius:8, marginBottom:8, border:"1px solid #E2E8F0" }}>
                          <div style={{ display:"flex", justifyContent:"space-between", alignItems:"start", marginBottom:6 }}>
                            <div style={{ flex:1 }}>
                              <div style={{ display:"flex", alignItems:"center", gap:8, marginBottom:4 }}>
                                <span style={{ fontSize:18, fontWeight:800, color:"#10B981" }}>R$ {(parseFloat(pg.valor) || 0).toFixed(2).replace(".", ",")}</span>
                                <span style={{ fontSize:11, fontWeight:700, color:pg.forma_pagamento === "avista" ? "#0EA5E9" : "#F59E0B", background:pg.forma_pagamento === "avista" ? "#EFF6FF" : "#FEF3C7", border:`1px solid ${pg.forma_pagamento === "avista" ? "#BFDBFE" : "#FDE68A"}`, borderRadius:6, padding:"2px 8px" }}>
                                  {pg.forma_pagamento === "avista" ? "√Ä Vista" : "Parcelado"}
                                </span>
                              </div>
                              <div style={{ fontSize:12, color:"#64748B" }}>
                                üìÖ {formatDate(pg.data)}
                                {pg.observacao && ` ¬∑ ${pg.observacao}`}
                              </div>
                              <div style={{ fontSize:11, color:"#94A3B8", marginTop:4 }}>
                                Registrado por: {pg.registrado_por || "‚Äî"} em {pg.registrado_em ? new Date(pg.registrado_em).toLocaleString("pt-BR") : "‚Äî"}
                              </div>
                            </div>
                            <button onClick={() => removePagamento(selectedPatient.id, pg.id)} style={{...btnSecondary, fontSize:11, padding:"4px 8px", background:"#FEE2E2", color:"#DC2626", border:"1px solid #FCA5A5"}}>üóëÔ∏è</button>
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              </div>
            )}
          </Modal>

          {/* ‚ïê‚ïê‚ïê OR√áAMENTOS MODAL ‚ïê‚ïê‚ïê */}
          <Modal isOpen={showOrcamentos} onClose={() => { setShowOrcamentos(false); setOrcamentoView("list"); setEditingBudget(null); setPrintingBudget(null); }} title={orcamentoView === "list" ? "üìã Or√ßamentos do Paciente" : orcamentoView === "form" ? (editingBudget ? "‚úèÔ∏è Editar Or√ßamento" : "üìã Novo Or√ßamento") : "üñ®Ô∏è Imprimir Or√ßamento"} wide>
            {selectedPatient && orcamentoView === "list" && (() => {
              void budgetListKey; // trigger re-render on budget list changes
              const budgets = loadBudgets(selectedPatient.id);
              return (
                <div>
                  <div style={{ display:"flex", justifyContent:"space-between", alignItems:"center", marginBottom:16 }}>
                    <div style={{ fontSize:14, color:"#64748B" }}>{budgets.length} or√ßamento(s) registrado(s)</div>
                    <button onClick={() => { initBudgetForm(null); setOrcamentoView("form"); }} style={btnPrimary}>+ Novo Or√ßamento</button>
                  </div>
                  {budgets.length === 0 ? (
                    <div style={{ textAlign:"center", padding:60, color:"#94A3B8" }}>
                      <div style={{ fontSize:48, marginBottom:12 }}>üìã</div>
                      <div style={{ fontSize:16, fontWeight:600 }}>Nenhum or√ßamento cadastrado</div>
                      <div style={{ fontSize:13, marginTop:4 }}>Clique em "+ Novo Or√ßamento" para come√ßar</div>
                    </div>
                  ) : (
                    <div style={{ display:"flex", flexDirection:"column", gap:10 }}>
                      {[...budgets].sort((a, b) => new Date(b.budget_date) - new Date(a.budget_date)).map(b => {
                        const st = BUDGET_STATUSES[b.status] || BUDGET_STATUSES.rascunho;
                        return (
                          <div key={b.id} style={{ ...cardStyle, marginBottom:0, border:`1.5px solid ${st.color}30` }}>
                            <div style={{ display:"flex", justifyContent:"space-between", alignItems:"start", gap:12, flexWrap:"wrap" }}>
                              <div style={{ flex:1, minWidth:200 }}>
                                <div style={{ display:"flex", alignItems:"center", gap:10, marginBottom:6 }}>
                                  <span style={{ fontSize:20, fontWeight:800, color:"#0F172A" }}>R$ {(b.total || 0).toFixed(2).replace(".", ",")}</span>
                                  <span style={{ fontSize:11, fontWeight:700, color:st.color, background:st.bg, border:`1px solid ${st.color}40`, borderRadius:6, padding:"2px 10px" }}>{st.label}</span>
                                </div>
                                <div style={{ fontSize:12, color:"#64748B", marginBottom:2 }}>
                                  üìÖ {formatDate(b.budget_date)} ¬∑ üë®‚Äç‚öïÔ∏è {b.professional_name || "‚Äî"} ¬∑ {(b.items || []).length} item(ns)
                                </div>
                                {b.notes && <div style={{ fontSize:11, color:"#94A3B8", fontStyle:"italic" }}>{b.notes}</div>}
                              </div>
                              <div style={{ display:"flex", gap:6, flexWrap:"wrap" }}>
                                <button onClick={() => { setPrintingBudget(b); setOrcamentoView("print"); }} style={{...btnSecondary, fontSize:11, padding:"6px 10px"}} title="Imprimir">üñ®Ô∏è</button>
                                <button onClick={() => { initBudgetForm(b); setOrcamentoView("form"); }} style={{...btnSecondary, fontSize:11, padding:"6px 10px"}} title="Editar">‚úèÔ∏è</button>
                                <button onClick={() => {
                                  const dup = duplicateBudget(selectedPatient.id, b.id);
                                  if (dup) { addAudit("DUPLICAR_ORCAMENTO","paciente",selectedPatient.id,selectedPatient.name,"Or√ßamento duplicado"); setBudgetListKey(k => k+1); }
                                }} style={{...btnSecondary, fontSize:11, padding:"6px 10px"}} title="Duplicar">üìÑ</button>
                                <button onClick={() => {
                                  if (confirm("Excluir este or√ßamento permanentemente?")) {
                                    deleteBudget(selectedPatient.id, b.id);
                                    addAudit("EXCLUIR_ORCAMENTO","paciente",selectedPatient.id,selectedPatient.name,`Or√ßamento R$ ${(b.total||0).toFixed(2)} exclu√≠do`);
                                    setBudgetListKey(k => k+1);
                                  }
                                }} style={{...btnSecondary, fontSize:11, padding:"6px 10px", background:"#FEE2E2", color:"#DC2626", border:"1px solid #FCA5A5"}} title="Excluir">üóëÔ∏è</button>
                              </div>
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  )}
                </div>
              );
            })()}

            {selectedPatient && orcamentoView === "form" && (
              <div>
                <button onClick={() => { setOrcamentoView("list"); setEditingBudget(null); }} style={{...btnSecondary, fontSize:12, padding:"6px 14px", marginBottom:16}}>‚Üê Voltar √† lista</button>

                {/* Cabe√ßalho do or√ßamento */}
                <div style={{ ...cardStyle, background:"linear-gradient(135deg,#F5F3FF,#EDE9FE)", borderColor:"#8B5CF6" }}>
                  <div style={{ fontSize:16, fontWeight:700, color:"#6D28D9", marginBottom:12 }}>Dados do Or√ßamento</div>
                  <div style={{ display:"grid", gridTemplateColumns:"repeat(auto-fit, minmax(200px, 1fr))", gap:12 }}>
                    <Input label="Data do Or√ßamento *" type="date" value={budgetForm.budget_date} onChange={e => setBudgetForm(prev => ({...prev, budget_date: e.target.value}))} />
                    <Select label="Profissional Respons√°vel *" value={budgetForm.professional_id} onChange={e => setBudgetForm(prev => ({...prev, professional_id: e.target.value}))}
                      options={[{value:"", label:"Selecione..."}, ...users.filter(u => u.active !== false).map(u => ({value:u.id, label:u.name}))]} />
                    <Select label="Status" value={budgetForm.status} onChange={e => setBudgetForm(prev => ({...prev, status: e.target.value}))}
                      options={Object.entries(BUDGET_STATUSES).map(([k, v]) => ({value:k, label:v.label}))} />
                  </div>
                  <Input label="Observa√ß√µes" value={budgetForm.notes} onChange={e => setBudgetForm(prev => ({...prev, notes: e.target.value}))} placeholder="Observa√ß√µes gerais do or√ßamento..." />
                </div>

                {/* Adicionar procedimento */}
                <div style={{ ...cardStyle }}>
                  <div style={{ fontSize:16, fontWeight:700, color:"#0F172A", marginBottom:12 }}>Adicionar Procedimentos</div>
                  <div style={{ position:"relative" }}>
                    <input
                      value={procSearch}
                      onChange={e => { setProcSearch(e.target.value); setProcSearchResults(searchProcedures(e.target.value)); }}
                      placeholder="Buscar por nome, c√≥digo ou especialidade..."
                      style={{ width:"100%", padding:"10px 14px", borderRadius:10, border:"1.5px solid #CBD5E1", fontSize:14, outline:"none", background:"#F8FAFC", boxSizing:"border-box" }}
                    />
                    {procSearchResults.length > 0 && (
                      <div style={{ position:"absolute", top:"100%", left:0, right:0, zIndex:10, background:"#fff", border:"1px solid #E2E8F0", borderRadius:10, boxShadow:"0 8px 24px rgba(0,0,0,0.12)", maxHeight:250, overflowY:"auto", marginTop:4 }}>
                        {procSearchResults.map(proc => (
                          <div key={proc.code} onClick={() => addBudgetItem(proc)}
                            style={{ padding:"10px 14px", cursor:"pointer", borderBottom:"1px solid #F1F5F9", display:"flex", justifyContent:"space-between", alignItems:"center" }}
                            onMouseEnter={e => e.currentTarget.style.background="#F8FAFC"}
                            onMouseLeave={e => e.currentTarget.style.background="#fff"}>
                            <div>
                              <div style={{ fontSize:13, fontWeight:600, color:"#0F172A" }}>{proc.name}</div>
                              <div style={{ fontSize:11, color:"#94A3B8" }}>{proc.code} ¬∑ {proc.specialty}</div>
                            </div>
                            <div style={{ fontSize:13, fontWeight:700, color:"#10B981", whiteSpace:"nowrap" }}>R$ {(proc.unit_value || 0).toFixed(2).replace(".",",")}</div>
                          </div>
                        ))}
                      </div>
                    )}
                  </div>
                </div>

                {/* Itens do or√ßamento */}
                {budgetForm.items.length > 0 && (
                  <div style={{ ...cardStyle }}>
                    <div style={{ fontSize:16, fontWeight:700, color:"#0F172A", marginBottom:12 }}>Itens do Or√ßamento ({budgetForm.items.length})</div>
                    <div style={{ overflowX:"auto" }}>
                      <table style={{ width:"100%", borderCollapse:"collapse", fontSize:13 }}>
                        <thead>
                          <tr style={{ background:"#F8FAFC" }}>
                            <th style={{ padding:"8px 10px", textAlign:"left", fontWeight:700, color:"#475569", borderBottom:"2px solid #E2E8F0", minWidth:180 }}>Procedimento</th>
                            <th style={{ padding:"8px 10px", textAlign:"left", fontWeight:700, color:"#475569", borderBottom:"2px solid #E2E8F0", minWidth:140 }}>Dente/Regi√£o *</th>
                            <th style={{ padding:"8px 10px", textAlign:"center", fontWeight:700, color:"#475569", borderBottom:"2px solid #E2E8F0", width:60 }}>Qtd</th>
                            <th style={{ padding:"8px 10px", textAlign:"right", fontWeight:700, color:"#475569", borderBottom:"2px solid #E2E8F0", width:100 }}>Vlr Unit.</th>
                            <th style={{ padding:"8px 10px", textAlign:"right", fontWeight:700, color:"#475569", borderBottom:"2px solid #E2E8F0", width:90 }}>Desc.</th>
                            <th style={{ padding:"8px 10px", textAlign:"right", fontWeight:700, color:"#475569", borderBottom:"2px solid #E2E8F0", width:100 }}>Total</th>
                            <th style={{ padding:"8px 10px", textAlign:"center", fontWeight:700, color:"#475569", borderBottom:"2px solid #E2E8F0", width:40 }}></th>
                          </tr>
                        </thead>
                        <tbody>
                          {budgetForm.items.map(item => (
                            <tr key={item.id} style={{ borderBottom:"1px solid #F1F5F9" }}>
                              <td style={{ padding:"8px 10px" }}>
                                <div style={{ fontWeight:600, color:"#0F172A" }}>{item.procedure_name}</div>
                                <div style={{ fontSize:10, color:"#94A3B8" }}>{item.procedure_code} ¬∑ {item.specialty}</div>
                              </td>
                              <td style={{ padding:"8px 10px" }}>
                                <input value={item.dente_ou_regiao} onChange={e => updateBudgetItem(item.id, "dente_ou_regiao", e.target.value)}
                                  placeholder="Ex: 11, Arcada sup..."
                                  style={{ width:"100%", padding:"6px 8px", borderRadius:6, border: !item.dente_ou_regiao.trim() ? "2px solid #EF4444" : "1px solid #CBD5E1", fontSize:12, outline:"none", background: !item.dente_ou_regiao.trim() ? "#FEF2F2" : "#F8FAFC", boxSizing:"border-box" }} />
                              </td>
                              <td style={{ padding:"8px 10px", textAlign:"center" }}>
                                <input type="number" min="1" value={item.qty} onChange={e => updateBudgetItem(item.id, "qty", e.target.value)}
                                  style={{ width:50, padding:"6px 4px", borderRadius:6, border:"1px solid #CBD5E1", fontSize:12, outline:"none", textAlign:"center", background:"#F8FAFC" }} />
                              </td>
                              <td style={{ padding:"8px 10px", textAlign:"right" }}>
                                <input type="number" step="0.01" value={item.unit_price} onChange={e => updateBudgetItem(item.id, "unit_price", e.target.value)}
                                  style={{ width:85, padding:"6px 4px", borderRadius:6, border:"1px solid #CBD5E1", fontSize:12, outline:"none", textAlign:"right", background:"#F8FAFC" }} />
                              </td>
                              <td style={{ padding:"8px 10px", textAlign:"right" }}>
                                <input type="number" step="0.01" value={item.line_discount} onChange={e => updateBudgetItem(item.id, "line_discount", e.target.value)}
                                  style={{ width:75, padding:"6px 4px", borderRadius:6, border:"1px solid #CBD5E1", fontSize:12, outline:"none", textAlign:"right", background:"#F8FAFC" }} />
                              </td>
                              <td style={{ padding:"8px 10px", textAlign:"right", fontWeight:700, color:"#10B981" }}>
                                R$ {(parseFloat(item.line_total) || 0).toFixed(2).replace(".",",")}
                              </td>
                              <td style={{ padding:"8px 10px", textAlign:"center" }}>
                                <button onClick={() => removeBudgetItem(item.id)}
                                  style={{ background:"#FEE2E2", border:"1px solid #FCA5A5", borderRadius:6, color:"#DC2626", cursor:"pointer", fontSize:12, padding:"4px 6px" }}>√ó</button>
                              </td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  </div>
                )}

                {/* Totais */}
                {budgetForm.items.length > 0 && (() => {
                  const subtotal = calcBudgetSubtotal(budgetForm.items);
                  const discountTotal = parseFloat(budgetForm.discount_total) || 0;
                  const total = Math.max(0, subtotal - discountTotal);
                  return (
                    <div style={{ ...cardStyle, background:"linear-gradient(135deg,#F0FDF4,#DCFCE7)", borderColor:"#10B981" }}>
                      <div style={{ display:"flex", justifyContent:"space-between", alignItems:"center", marginBottom:8 }}>
                        <span style={{ fontSize:14, fontWeight:600, color:"#475569" }}>Subtotal:</span>
                        <span style={{ fontSize:16, fontWeight:700, color:"#0F172A" }}>R$ {subtotal.toFixed(2).replace(".",",")}</span>
                      </div>
                      <div style={{ display:"flex", justifyContent:"space-between", alignItems:"center", marginBottom:8, gap:12 }}>
                        <span style={{ fontSize:14, fontWeight:600, color:"#475569" }}>Desconto geral (R$):</span>
                        <input type="number" step="0.01" value={budgetForm.discount_total}
                          onChange={e => setBudgetForm(prev => ({...prev, discount_total: e.target.value}))}
                          style={{ width:120, padding:"6px 10px", borderRadius:8, border:"1px solid #CBD5E1", fontSize:14, outline:"none", textAlign:"right", background:"#fff" }} />
                      </div>
                      <div style={{ borderTop:"2px solid #10B981", paddingTop:10, display:"flex", justifyContent:"space-between", alignItems:"center" }}>
                        <span style={{ fontSize:18, fontWeight:800, color:"#059669" }}>TOTAL:</span>
                        <span style={{ fontSize:24, fontWeight:800, color:"#059669" }}>R$ {total.toFixed(2).replace(".",",")}</span>
                      </div>
                    </div>
                  );
                })()}

                {/* Bot√µes de a√ß√£o */}
                <div style={{ display:"flex", justifyContent:"flex-end", gap:10, marginTop:8 }}>
                  <button onClick={() => { setOrcamentoView("list"); setEditingBudget(null); }} style={btnSecondary}>Cancelar</button>
                  <button onClick={() => {
                    if (handleSaveBudget(selectedPatient.id)) {
                      setBudgetListKey(k => k+1);
                      setOrcamentoView("list");
                      setEditingBudget(null);
                    }
                  }} style={btnPrimary}>{editingBudget ? "‚úì Salvar Altera√ß√µes" : "‚úì Salvar Or√ßamento"}</button>
                </div>
              </div>
            )}

            {selectedPatient && orcamentoView === "print" && printingBudget && (() => {
              const b = printingBudget;
              const st = BUDGET_STATUSES[b.status] || BUDGET_STATUSES.rascunho;
              return (
                <div>
                  <div style={{ display:"flex", gap:10, marginBottom:16 }}>
                    <button onClick={() => { setOrcamentoView("list"); setPrintingBudget(null); }} style={{...btnSecondary, fontSize:12, padding:"6px 14px"}}>‚Üê Voltar</button>
                    <button onClick={() => {
                      const printContent = document.getElementById("budget-print-area");
                      if (!printContent) return;
                      const w = window.open("", "_blank", "width=800,height=600");
                      w.document.write(`<!DOCTYPE html><html><head><title>Or√ßamento - ${selectedPatient.name}</title>
                        <style>
                          body { font-family: 'Segoe UI', Arial, sans-serif; margin: 30px; color: #333; }
                          h1 { font-size: 22px; margin-bottom: 4px; }
                          h2 { font-size: 16px; color: #666; margin-bottom: 20px; font-weight: normal; }
                          .info { margin-bottom: 20px; font-size: 14px; line-height: 1.8; }
                          table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                          th { background: #f5f5f5; padding: 10px 8px; text-align: left; font-size: 12px; border-bottom: 2px solid #ddd; }
                          td { padding: 8px; border-bottom: 1px solid #eee; font-size: 13px; }
                          .total-row { font-size: 18px; font-weight: bold; text-align: right; padding: 16px 0; border-top: 2px solid #333; }
                          .footer { margin-top: 60px; text-align: center; font-size: 11px; color: #999; }
                          .sign-line { margin-top: 80px; border-top: 1px solid #333; width: 250px; text-align: center; padding-top: 8px; font-size: 12px; }
                          @media print { body { margin: 15px; } }
                        </style>
                      </head><body>`);
                      w.document.write(printContent.innerHTML);
                      w.document.write(`</body></html>`);
                      w.document.close();
                      w.focus();
                      setTimeout(() => w.print(), 300);
                    }} style={{...btnPrimary, fontSize:12, padding:"6px 14px"}}>üñ®Ô∏è Imprimir / PDF</button>
                  </div>

                  <div id="budget-print-area" style={{ background:"#fff", padding:24, border:"1px solid #E2E8F0", borderRadius:12 }}>
                    <h1 style={{ fontSize:22, fontWeight:800, color:"#0F172A", marginBottom:4 }}>O+ Fichas ‚Äî Or√ßamento Odontol√≥gico</h1>
                    <h2 style={{ fontSize:14, color:"#64748B", fontWeight:400, marginBottom:20 }}>Or√ßamento #{b.id?.slice(-6).toUpperCase()}</h2>

                    <div style={{ fontSize:14, lineHeight:"1.8", marginBottom:20 }}>
                      <div><strong>Paciente:</strong> {selectedPatient.name}</div>
                      <div><strong>Data:</strong> {formatDate(b.budget_date)}</div>
                      <div><strong>Profissional:</strong> {b.professional_name || "‚Äî"}</div>
                      <div><strong>Status:</strong> {st.label}</div>
                      {b.notes && <div><strong>Obs:</strong> {b.notes}</div>}
                    </div>

                    <table style={{ width:"100%", borderCollapse:"collapse", margin:"20px 0" }}>
                      <thead>
                        <tr style={{ background:"#F8FAFC" }}>
                          <th style={{ padding:"10px 8px", textAlign:"left", fontSize:12, fontWeight:700, borderBottom:"2px solid #E2E8F0" }}>Procedimento</th>
                          <th style={{ padding:"10px 8px", textAlign:"left", fontSize:12, fontWeight:700, borderBottom:"2px solid #E2E8F0" }}>Dente/Regi√£o</th>
                          <th style={{ padding:"10px 8px", textAlign:"center", fontSize:12, fontWeight:700, borderBottom:"2px solid #E2E8F0" }}>Qtd</th>
                          <th style={{ padding:"10px 8px", textAlign:"right", fontSize:12, fontWeight:700, borderBottom:"2px solid #E2E8F0" }}>Vlr Unit.</th>
                          <th style={{ padding:"10px 8px", textAlign:"right", fontSize:12, fontWeight:700, borderBottom:"2px solid #E2E8F0" }}>Total</th>
                        </tr>
                      </thead>
                      <tbody>
                        {(b.items || []).map((item, idx) => (
                          <tr key={idx} style={{ borderBottom:"1px solid #F1F5F9" }}>
                            <td style={{ padding:"8px", fontSize:13 }}>
                              <div style={{ fontWeight:600 }}>{item.procedure_name}</div>
                              <div style={{ fontSize:10, color:"#94A3B8" }}>{item.procedure_code} ¬∑ {item.specialty}</div>
                            </td>
                            <td style={{ padding:"8px", fontSize:13 }}>{item.dente_ou_regiao}</td>
                            <td style={{ padding:"8px", fontSize:13, textAlign:"center" }}>{item.qty}</td>
                            <td style={{ padding:"8px", fontSize:13, textAlign:"right" }}>R$ {(parseFloat(item.unit_price)||0).toFixed(2).replace(".",",")}</td>
                            <td style={{ padding:"8px", fontSize:13, textAlign:"right", fontWeight:600 }}>R$ {(parseFloat(item.line_total)||0).toFixed(2).replace(".",",")}</td>
                          </tr>
                        ))}
                      </tbody>
                    </table>

                    <div style={{ textAlign:"right", marginTop:16, fontSize:14, lineHeight:"1.8" }}>
                      <div>Subtotal: <strong>R$ {(b.subtotal || 0).toFixed(2).replace(".",",")}</strong></div>
                      {(b.discount_total || 0) > 0 && <div>Desconto: <strong style={{ color:"#EF4444" }}>- R$ {(b.discount_total).toFixed(2).replace(".",",")}</strong></div>}
                      <div style={{ fontSize:20, fontWeight:800, borderTop:"2px solid #0F172A", paddingTop:8, marginTop:8 }}>
                        TOTAL: R$ {(b.total || 0).toFixed(2).replace(".",",")}
                      </div>
                    </div>

                    <div style={{ marginTop:80, display:"flex", justifyContent:"space-between" }}>
                      <div style={{ textAlign:"center" }}>
                        <div style={{ borderTop:"1px solid #333", width:250, paddingTop:8, fontSize:12 }}>Profissional Respons√°vel</div>
                      </div>
                      <div style={{ textAlign:"center" }}>
                        <div style={{ borderTop:"1px solid #333", width:250, paddingTop:8, fontSize:12 }}>Paciente</div>
                      </div>
                    </div>

                    <div style={{ marginTop:40, textAlign:"center", fontSize:11, color:"#94A3B8" }}>
                      Documento gerado em {new Date().toLocaleString("pt-BR")} ¬∑ O+ Fichas ‚Äî Prontu√°rio Eletr√¥nico
                    </div>
                  </div>
                </div>
              );
            })()}
          </Modal>

          {/* ‚ïê‚ïê‚ïê ARRIVAL CONTROL MODAL ‚ïê‚ïê‚ïê */}
          <Modal isOpen={showArrivalControl} onClose={() => { setShowArrivalControl(false); setArrivalPatientId(null); }} title="Marcar Chegada do Paciente">
            <div style={{ marginBottom:16, padding:14, background:"#F0F9FF", borderRadius:12, border:"1.5px solid #BAE6FD" }}>
              <div style={{ fontSize:14, fontWeight:700, color:"#0369A1", marginBottom:4 }}>
                Paciente: {patients.find(p => p.id === arrivalPatientId)?.name}
              </div>
              <div style={{ fontSize:12, color:"#64748B" }}>
                Selecione o dentista ou ortodontista que ir√° atender este paciente.
              </div>
            </div>
            <Select 
              label="Dentista/Ortodontista *" 
              value={arrivalForm.dentista_id}
              onChange={e => setArrivalForm({...arrivalForm, dentista_id: e.target.value})}
              options={dentistOpts}
            />
            <div style={{ display:"flex", gap:10, justifyContent:"flex-end", marginTop:16 }}>
              <button onClick={() => { setShowArrivalControl(false); setArrivalPatientId(null); }} style={btnSecondary}>Cancelar</button>
              <button onClick={confirmArrival} style={btnPrimary}>üëã Confirmar Chegada</button>
            </div>
          </Modal>

          {/* ‚ïê‚ïê‚ïê RELAT√ìRIO ORTODONTIA ‚ïê‚ïê‚ïê */}
          <Modal isOpen={showRelatorioOrtho} onClose={() => setShowRelatorioOrtho(false)} title="ü¶∑ Relat√≥rio de Ortodontia" wide>
            {(() => {
              const orthoPatients = patients.filter(p => p.is_orthodontic_patient);
              const filtered = orthoPatients.filter(p => {
                if (orthoReportFilters.busca) {
                  const q = orthoReportFilters.busca.toLowerCase();
                  if (!p.name.toLowerCase().includes(q) && !(p.codigo||"").toLowerCase().includes(q) && !(p.phone||"").toLowerCase().includes(q)) return false;
                }
                if (orthoReportFilters.status.length > 0 && !orthoReportFilters.status.includes(p.ortho_status)) return false;
                if (orthoReportFilters.profissional_id && p.responsavel_orto_id !== orthoReportFilters.profissional_id) return false;
                return true;
              });
              return (
                <div>
                  {/* Filtros */}
                  <div style={{ ...cardStyle, marginBottom:16 }}>
                    <div style={{ display:"grid", gridTemplateColumns:"repeat(auto-fit, minmax(200px, 1fr))", gap:12 }}>
                      <div>
                        <label style={{ fontSize:12, fontWeight:600, color:"#334155", marginBottom:4, display:"block" }}>Buscar Paciente</label>
                        <input value={orthoReportFilters.busca} onChange={e => setOrthoReportFilters(f => ({...f, busca: e.target.value}))} placeholder="Nome, c√≥digo ou telefone..."
                          style={{ width:"100%", padding:"8px 12px", borderRadius:8, border:"1px solid #CBD5E1", fontSize:13, outline:"none", boxSizing:"border-box" }} />
                      </div>
                      <div>
                        <label style={{ fontSize:12, fontWeight:600, color:"#334155", marginBottom:4, display:"block" }}>Status Ortodontia (multi-select)</label>
                        <div style={{ display:"flex", flexWrap:"wrap", gap:4 }}>
                          {ORTHO_STATUSES.map(s => {
                            const active = orthoReportFilters.status.includes(s);
                            const sc = ORTHO_STATUS_COLORS[s];
                            return (
                              <button key={s} onClick={() => setOrthoReportFilters(f => ({...f, status: active ? f.status.filter(x=>x!==s) : [...f.status, s]}))}
                                style={{ fontSize:10, fontWeight:700, padding:"3px 8px", borderRadius:6, border:`1px solid ${active ? sc.color : "#CBD5E1"}`, background: active ? sc.bg : "#fff", color: active ? sc.color : "#64748B", cursor:"pointer" }}>
                                {s}
                              </button>
                            );
                          })}
                        </div>
                      </div>
                      <Select label="Profissional Orto" value={orthoReportFilters.profissional_id} onChange={e => setOrthoReportFilters(f => ({...f, profissional_id: e.target.value}))}
                        options={[{value:"",label:"Todos"}, ...users.filter(u=>u.active).map(u=>({value:u.id,label:u.name}))]} />
                    </div>
                  </div>

                  {/* Resumo */}
                  <div style={{ display:"grid", gridTemplateColumns:"repeat(auto-fit, minmax(140px, 1fr))", gap:10, marginBottom:16 }}>
                    <div style={{ ...cardStyle, background:"#F5F3FF", borderColor:"#C4B5FD", textAlign:"center" }}>
                      <div style={{ fontSize:11, fontWeight:700, color:"#7C3AED" }}>Total Ortodontia</div>
                      <div style={{ fontSize:24, fontWeight:800, color:"#5B21B6" }}>{orthoPatients.length}</div>
                    </div>
                    {ORTHO_STATUSES.slice(0,5).map(s => {
                      const count = orthoPatients.filter(p => p.ortho_status === s).length;
                      const sc = ORTHO_STATUS_COLORS[s];
                      return (
                        <div key={s} style={{ ...cardStyle, background:sc.bg, borderColor:sc.color+"40", textAlign:"center" }}>
                          <div style={{ fontSize:10, fontWeight:700, color:sc.color }}>{s}</div>
                          <div style={{ fontSize:20, fontWeight:800, color:sc.color }}>{count}</div>
                        </div>
                      );
                    })}
                  </div>

                  {/* Tabela */}
                  <div style={{ ...cardStyle }}>
                    <div style={{ fontSize:14, fontWeight:700, color:"#0F172A", marginBottom:10 }}>Pacientes de Ortodontia ({filtered.length})</div>
                    {filtered.length === 0 ? (
                      <div style={{ textAlign:"center", padding:40, color:"#94A3B8" }}>Nenhum paciente encontrado com os filtros selecionados.</div>
                    ) : (
                      <div style={{ overflowX:"auto" }}>
                        <table style={{ width:"100%", borderCollapse:"collapse", fontSize:12 }}>
                          <thead>
                            <tr style={{ background:"#F8FAFC", borderBottom:"2px solid #E2E8F0" }}>
                              <th style={{ padding:"8px 10px", textAlign:"left", fontWeight:700, color:"#334155" }}>C√≥digo</th>
                              <th style={{ padding:"8px 10px", textAlign:"left", fontWeight:700, color:"#334155" }}>Paciente</th>
                              <th style={{ padding:"8px 10px", textAlign:"left", fontWeight:700, color:"#334155" }}>Telefone</th>
                              <th style={{ padding:"8px 10px", textAlign:"left", fontWeight:700, color:"#334155" }}>Status Ortodontia</th>
                              <th style={{ padding:"8px 10px", textAlign:"left", fontWeight:700, color:"#334155" }}>Profissional Orto</th>
                              <th style={{ padding:"8px 10px", textAlign:"left", fontWeight:700, color:"#334155" }}>Cadastro</th>
                            </tr>
                          </thead>
                          <tbody>
                            {filtered.map(p => {
                              const sc = ORTHO_STATUS_COLORS[p.ortho_status] || { color:"#64748B", bg:"#F1F5F9" };
                              return (
                                <tr key={p.id} style={{ borderBottom:"1px solid #F1F5F9", cursor:"pointer" }} onClick={() => { openPatient(p); setShowRelatorioOrtho(false); }}
                                  onMouseEnter={e => e.currentTarget.style.background="#F8FAFC"} onMouseLeave={e => e.currentTarget.style.background=""}>
                                  <td style={{ padding:"8px 10px", fontWeight:600, color:"#0EA5E9" }}>{p.codigo || "‚Äî"}</td>
                                  <td style={{ padding:"8px 10px", fontWeight:600 }}>{p.name}</td>
                                  <td style={{ padding:"8px 10px", color:"#64748B" }}>{p.phone || "‚Äî"}</td>
                                  <td style={{ padding:"8px 10px" }}>
                                    <span style={{ fontSize:11, fontWeight:700, color:sc.color, background:sc.bg, border:`1px solid ${sc.color}30`, borderRadius:6, padding:"2px 8px" }}>{p.ortho_status || "‚Äî"}</span>
                                  </td>
                                  <td style={{ padding:"8px 10px", color:"#64748B" }}>{getUserName(p.responsavel_orto_id)}</td>
                                  <td style={{ padding:"8px 10px", color:"#94A3B8" }}>{formatDate(p.createdAt)}</td>
                                </tr>
                              );
                            })}
                          </tbody>
                        </table>
                      </div>
                    )}
                  </div>

                  {/* Exportar */}
                  {filtered.length > 0 && (
                    <div style={{ display:"flex", justifyContent:"flex-end", marginTop:12 }}>
                      <button onClick={() => {
                        const headers = ["C√≥digo","Paciente","Telefone","Email","Status Ortodontia","Profissional Orto","Data Cadastro"];
                        const rows = filtered.map(p => [p.codigo||"",p.name,p.phone||"",p.email||"",p.ortho_status||"",getUserName(p.responsavel_orto_id),formatDate(p.createdAt)]);
                        const csv = [headers.join(";"), ...rows.map(r => r.join(";"))].join("\n");
                        const blob = new Blob(["\uFEFF"+csv], {type:"text/csv;charset=utf-8;"});
                        const a = document.createElement("a");
                        a.href = URL.createObjectURL(blob);
                        a.download = `relatorio_ortodontia_${formatDateISO(new Date())}.csv`;
                        a.click();
                      }} style={{...btnSecondary, fontSize:12}}>üì• Exportar CSV</button>
                    </div>
                  )}
                </div>
              );
            })()}
          </Modal>

          {/* ‚ïê‚ïê‚ïê RELAT√ìRIO DE ATENDIMENTOS ‚ïê‚ïê‚ïê */}
          <Modal isOpen={showRelatorio} onClose={() => setShowRelatorio(false)} title="üìä Relat√≥rio de Atendimentos por Per√≠odo" wide>
            <div>
              {/* Filtros */}
              <div style={{ ...cardStyle, marginBottom:16 }}>
                <div style={{ fontSize:16, fontWeight:700, color:"#0F172A", marginBottom:12 }}>üîç Filtros</div>
                <div style={{ display:"grid", gridTemplateColumns:"repeat(auto-fit, minmax(200px, 1fr))", gap:12, marginBottom:12 }}>
                  <Select 
                    label="Profissional" 
                    value={relatorioFilters.profissional_id}
                    onChange={e => setRelatorioFilters({...relatorioFilters, profissional_id: e.target.value})}
                    options={[{value:"",label:"Todos"}, ...dentistOpts]}
                  />
                  <Input 
                    label="Data In√≠cio" 
                    type="date" 
                    value={relatorioFilters.data_inicio}
                    onChange={e => setRelatorioFilters({...relatorioFilters, data_inicio: e.target.value})}
                  />
                  <Input 
                    label="Data Fim" 
                    type="date" 
                    value={relatorioFilters.data_fim}
                    onChange={e => setRelatorioFilters({...relatorioFilters, data_fim: e.target.value})}
                  />
                </div>
                <Input 
                  label="Buscar Paciente" 
                  value={relatorioFilters.busca}
                  onChange={e => setRelatorioFilters({...relatorioFilters, busca: e.target.value})}
                  placeholder="Digite o nome do paciente..."
                />
              </div>

              {/* Tabela de Resultados */}
              <div style={{ ...cardStyle, marginBottom:16 }}>
                <div style={{ display:"flex", justifyContent:"space-between", alignItems:"center", marginBottom:12 }}>
                  <div style={{ fontSize:16, fontWeight:700, color:"#0F172A" }}>üìä Resultados ({getRelatorioData().length} atendimentos)</div>
                  <button onClick={exportToExcel} style={{...btnPrimary, fontSize:13, padding:"8px 16px"}}>üìÑ Exportar Excel</button>
                </div>
                
                <div style={{ overflowX:"auto" }}>
                  <table style={{ width:"100%", borderCollapse:"collapse", fontSize:12 }}>
                    <thead>
                      <tr style={{ background:"#F8FAFC", borderBottom:"2px solid #E2E8F0" }}>
                        <th onClick={() => setRelatorioSort({field:"paciente_nome", direction: relatorioSort.field==="paciente_nome" && relatorioSort.direction==="asc"?"desc":"asc"})} style={{ padding:"10px 8px", textAlign:"left", fontWeight:700, color:"#475569", cursor:"pointer", whiteSpace:"nowrap" }}>üë§ Paciente {relatorioSort.field==="paciente_nome" && (relatorioSort.direction==="asc"?"‚Üë":"‚Üì")}</th>
                        <th onClick={() => setRelatorioSort({field:"data", direction: relatorioSort.field==="data" && relatorioSort.direction==="asc"?"desc":"asc"})} style={{ padding:"10px 8px", textAlign:"left", fontWeight:700, color:"#475569", cursor:"pointer", whiteSpace:"nowrap" }}>üìÖ Data {relatorioSort.field==="data" && (relatorioSort.direction==="asc"?"‚Üë":"‚Üì")}</th>
                        <th onClick={() => setRelatorioSort({field:"profissional", direction: relatorioSort.field==="profissional" && relatorioSort.direction==="asc"?"desc":"asc"})} style={{ padding:"10px 8px", textAlign:"left", fontWeight:700, color:"#475569", cursor:"pointer", whiteSpace:"nowrap" }}>üë®‚Äç‚öïÔ∏è Profissional {relatorioSort.field==="profissional" && (relatorioSort.direction==="asc"?"‚Üë":"‚Üì")}</th>
                        <th onClick={() => setRelatorioSort({field:"tipo_atendimento", direction: relatorioSort.field==="tipo_atendimento" && relatorioSort.direction==="asc"?"desc":"asc"})} style={{ padding:"10px 8px", textAlign:"left", fontWeight:700, color:"#475569", cursor:"pointer", whiteSpace:"nowrap" }}>üéØ Tipo {relatorioSort.field==="tipo_atendimento" && (relatorioSort.direction==="asc"?"‚Üë":"‚Üì")}</th>
                        <th style={{ padding:"10px 8px", textAlign:"left", fontWeight:700, color:"#475569", whiteSpace:"nowrap" }}>üîß Procedimentos</th>
                        <th onClick={() => setRelatorioSort({field:"valor_total", direction: relatorioSort.field==="valor_total" && relatorioSort.direction==="asc"?"desc":"asc"})} style={{ padding:"10px 8px", textAlign:"right", fontWeight:700, color:"#475569", cursor:"pointer", whiteSpace:"nowrap" }}>üíµ Valor Total {relatorioSort.field==="valor_total" && (relatorioSort.direction==="asc"?"‚Üë":"‚Üì")}</th>
                        <th onClick={() => setRelatorioSort({field:"valor_pago", direction: relatorioSort.field==="valor_pago" && relatorioSort.direction==="asc"?"desc":"asc"})} style={{ padding:"10px 8px", textAlign:"right", fontWeight:700, color:"#475569", cursor:"pointer", whiteSpace:"nowrap" }}>‚úì Pago {relatorioSort.field==="valor_pago" && (relatorioSort.direction==="asc"?"‚Üë":"‚Üì")}</th>
                        <th onClick={() => setRelatorioSort({field:"valor_aberto", direction: relatorioSort.field==="valor_aberto" && relatorioSort.direction==="asc"?"desc":"asc"})} style={{ padding:"10px 8px", textAlign:"right", fontWeight:700, color:"#475569", cursor:"pointer", whiteSpace:"nowrap" }}>‚ö†Ô∏è Em Aberto {relatorioSort.field==="valor_aberto" && (relatorioSort.direction==="asc"?"‚Üë":"‚Üì")}</th>
                        <th onClick={() => setRelatorioSort({field:"status_financeiro", direction: relatorioSort.field==="status_financeiro" && relatorioSort.direction==="asc"?"desc":"asc"})} style={{ padding:"10px 8px", textAlign:"center", fontWeight:700, color:"#475569", cursor:"pointer", whiteSpace:"nowrap" }}>üü¢ Status {relatorioSort.field==="status_financeiro" && (relatorioSort.direction==="asc"?"‚Üë":"‚Üì")}</th>
                      </tr>
                    </thead>
                    <tbody>
                      {getRelatorioData().length === 0 ? (
                        <tr>
                          <td colSpan="9" style={{ padding:40, textAlign:"center", color:"#94A3B8" }}>Nenhum atendimento encontrado no per√≠odo</td>
                        </tr>
                      ) : (
                        getRelatorioData().map(row => (
                          <tr key={row.id} style={{ borderBottom:"1px solid #F1F5F9" }}>
                            <td style={{ padding:"10px 8px", color:"#334155", fontWeight:600 }}>{row.paciente_nome}</td>
                            <td style={{ padding:"10px 8px", color:"#64748B" }}>{formatDate(row.data)}</td>
                            <td style={{ padding:"10px 8px", color:"#64748B" }}>{row.profissional}</td>
                            <td style={{ padding:"10px 8px" }}>
                              <span style={{ fontSize:10, fontWeight:700, color:row.tipo_atendimento==="ORTODONTIA"?"#0EA5E9":"#10B981", background:row.tipo_atendimento==="ORTODONTIA"?"#EFF6FF":"#F0FDF4", border:`1px solid ${row.tipo_atendimento==="ORTODONTIA"?"#BFDBFE":"#BBF7D0"}`, borderRadius:6, padding:"2px 8px" }}>
                                {row.tipo_atendimento}
                              </span>
                            </td>
                            <td style={{ padding:"10px 8px", color:"#64748B", fontSize:11, maxWidth:200, overflow:"hidden", textOverflow:"ellipsis", whiteSpace:"nowrap" }} title={row.procedimentos}>{row.procedimentos}</td>
                            <td style={{ padding:"10px 8px", textAlign:"right", fontWeight:700, color:"#334155" }}>R$ {row.valor_total.toFixed(2).replace(".", ",")}</td>
                            <td style={{ padding:"10px 8px", textAlign:"right", fontWeight:600, color:"#10B981" }}>R$ {row.valor_pago.toFixed(2).replace(".", ",")}</td>
                            <td style={{ padding:"10px 8px", textAlign:"right", fontWeight:600, color:row.valor_aberto>0?"#EF4444":"#10B981" }}>R$ {row.valor_aberto.toFixed(2).replace(".", ",")}</td>
                            <td style={{ padding:"10px 8px", textAlign:"center" }}>
                              {row.status_financeiro === "pago" && <span style={{ fontSize:10, fontWeight:700, color:"#10B981", background:"#D1FAE5", border:"1px solid #BBF7D0", borderRadius:6, padding:"3px 10px" }}>‚úÖ Pago</span>}
                              {row.status_financeiro === "parcial" && <span style={{ fontSize:10, fontWeight:700, color:"#F59E0B", background:"#FEF3C7", border:"1px solid #FDE68A", borderRadius:6, padding:"3px 10px" }}>üü° Parcial</span>}
                              {row.status_financeiro === "aberto" && <span style={{ fontSize:10, fontWeight:700, color:"#EF4444", background:"#FEE2E2", border:"1px solid #FCA5A5", borderRadius:6, padding:"3px 10px" }}>üî¥ Aberto</span>}
                              {row.status_financeiro === "sem_orcamento" && <span style={{ fontSize:10, fontWeight:700, color:"#94A3B8", background:"#F1F5F9", border:"1px solid #E2E8F0", borderRadius:6, padding:"3px 10px" }}>‚ö™ Sem Or√ß.</span>}
                            </td>
                          </tr>
                        ))
                      )}
                    </tbody>
                  </table>
                </div>
              </div>

              {/* Totalizadores */}
              {getRelatorioData().length > 0 && (
                <div style={{ display:"grid", gridTemplateColumns:"repeat(auto-fit, minmax(200px, 1fr))", gap:12 }}>
                  <div style={{ ...cardStyle, background:"#EFF6FF", borderColor:"#3B82F6" }}>
                    <div style={{ fontSize:12, fontWeight:600, color:"#1E40AF", marginBottom:4 }}>üíµ Total Geral</div>
                    <div style={{ fontSize:22, fontWeight:800, color:"#3B82F6" }}>
                      R$ {getRelatorioData().reduce((sum, r) => sum + r.valor_total, 0).toFixed(2).replace(".", ",")}
                    </div>
                  </div>
                  <div style={{ ...cardStyle, background:"#F0FDF4", borderColor:"#10B981" }}>
                    <div style={{ fontSize:12, fontWeight:600, color:"#059669", marginBottom:4 }}>‚úì Total Recebido</div>
                    <div style={{ fontSize:22, fontWeight:800, color:"#10B981" }}>
                      R$ {getRelatorioData().reduce((sum, r) => sum + r.valor_pago, 0).toFixed(2).replace(".", ",")}
                    </div>
                  </div>
                  <div style={{ ...cardStyle, background:"#FEF2F2", borderColor:"#EF4444" }}>
                    <div style={{ fontSize:12, fontWeight:600, color:"#DC2626", marginBottom:4 }}>‚ö†Ô∏è Total em Aberto</div>
                    <div style={{ fontSize:22, fontWeight:800, color:"#EF4444" }}>
                      R$ {getRelatorioData().reduce((sum, r) => sum + r.valor_aberto, 0).toFixed(2).replace(".", ",")}
                    </div>
                  </div>
                </div>
              )}
            </div>
          </Modal>
          
          {/* Sistema de Notifica√ß√µes */}
          <div style={{ position:"fixed", top:80, right:20, zIndex:9999, display:"flex", flexDirection:"column", gap:10, maxWidth:350 }}>
            {notifications.map(notif => (
              <div key={notif.id} style={{
                background: notif.type === 'success' ? '#ECFDF5' : notif.type === 'warning' ? '#FEF3C7' : '#EFF6FF',
                border: `1px solid ${notif.type === 'success' ? '#A7F3D0' : notif.type === 'warning' ? '#FDE68A' : '#BFDBFE'}`,
                borderRadius:10,
                padding:"12px 16px",
                fontSize:13,
                color: notif.type === 'success' ? '#065F46' : notif.type === 'warning' ? '#92400E' : '#1E40AF',
                fontWeight:600,
                boxShadow:"0 4px 12px rgba(0,0,0,0.1)",
                animation:"slideInRight 0.3s ease-out",
                display:"flex",
                alignItems:"center",
                gap:8
              }}>
                <span>{notif.type === 'success' ? '‚úì' : notif.type === 'warning' ? '‚ö†Ô∏è' : 'üîî'}</span>
                {notif.message}
              </div>
            ))}
          </div>
        </div>
      );
    }
    ReactDOM.createRoot(document.getElementById("root")).render(<App />);;
  </script>
</body>
</html>